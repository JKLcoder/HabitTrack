<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能日程管理 - 日历视图版</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        // 检查Supabase是否成功加载的函数
        function checkSupabaseLoaded() {
            return new Promise((resolve) => {
                if (typeof supabase !== 'undefined' && supabase.createClient) {
                    resolve(true);
                } else {
                    // 等待一段时间再检查
                    setTimeout(() => {
                        if (typeof supabase !== 'undefined' && supabase.createClient) {
                            resolve(true);
                        } else {
                            console.warn('Supabase库加载失败，将使用离线模式');
                            resolve(false);
                        }
                    }, 3000); // 等待3秒
                }
            });
        }
    </script>
    <script src="https://unpkg.com/@supabase/supabase-js@2" 
            onerror="console.error('Supabase库加载失败，网络连接问题')"
            onload="console.log('Supabase库加载成功')"></script>
    <style>
        :root {
            /* 主色调升级 */
            --primary-50: #f0f4ff;
            --primary-100: #e0edff;
            --primary-400: #6366f1;
            --primary-500: #4361ee;
            --primary-600: #3f37c9;
            --primary-700: #2d1b69;
            
            /* 语义化色彩 */
            --success-light: #e8f5e9;
            --success-main: #4caf50;
            --success-dark: #2e7d32;
            --warning-light: #fff3cd;
            --warning-main: #ff9800;
            --danger-main: #f44336;
            
            /* 中性色调优化 */
            --gray-50: #fafafa;
            --gray-100: #f5f5f5;
            --gray-200: #eeeeee;
            --gray-300: #e0e0e0;
            --gray-400: #bdbdbd;
            --gray-500: #9e9e9e;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-900: #212529;
            
            /* 兼容旧变量 */
            --primary-color: var(--primary-500);
            --secondary-color: var(--primary-600);
            --accent-color: #4cc9f0;
            --success-color: var(--success-main);
            --completed-bg: var(--success-light);
            --recurring-bg: var(--primary-50);
            --master-bg: #fff9e6;
            --danger-color: var(--danger-main);
            --light-color: var(--gray-50);
            --dark-color: var(--gray-900);
            --gray-color: var(--gray-600);
            --border-radius: 8px;
            --box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: '等线', sans-serif;
            line-height: 1.4;
            background-color: #f0f2f5;
            color: var(--dark-color);
            padding: 12px;
            margin: 0;
            min-height: 100vh;
            width: 100%;
        }

        html {
            margin: 0;
            padding: 0;
            width: 100%;
            min-height: 100vh;
            background-color: #f0f2f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* 主要布局容器 */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            height: calc(100vh - 40px);
            min-height: 600px;
        }

        /* 左侧日历面板 */
        .calendar-panel {
            background: linear-gradient(145deg, #ffffff 0%, #fafbff 100%);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(67, 97, 238, 0.08);
            overflow-y: auto;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .month-year {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: var(--primary-50);
            transform: scale(1.1);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 20px;
        }

        .calendar-header-cell {
            text-align: center;
            padding: 8px 4px;
            font-weight: 600;
            color: var(--gray-600);
            font-size: 0.85rem;
        }

        .calendar-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            position: relative;
            min-height: 36px;
        }

        .calendar-cell:hover {
            background: var(--primary-50);
        }

        .calendar-cell.other-month {
            color: var(--gray-400);
        }

        .calendar-cell.today {
            background: var(--primary-500);
            color: white;
            font-weight: 600;
            position: relative;
        }

        /* 今日任务完成度颜色覆盖 */
        .calendar-cell.today.completion-0 { 
            background: #dc2626; /* 红色：今日无任务或0%完成 */
            color: white;
        }
        
        .calendar-cell.today.completion-low { 
            background: #ea580c; /* 橙红色：今日1-30%完成 */
            color: white;
        }
        
        .calendar-cell.today.completion-medium { 
            background: #ca8a04; /* 黄色：今日31-70%完成 */
            color: white;
        }
        
        .calendar-cell.today.completion-high { 
            background: #9333ea; /* 紫色：今日71-99%完成 */
            color: white;
        }
        
        .calendar-cell.today.completion-full { 
            background: #16a34a; /* 绿色：今日100%完成 */
            color: white;
        }

        .calendar-cell.selected {
            background: var(--primary-600);
            color: white;
            font-weight: 600;
        }

        /* 日历单元格完成度颜色 */
        .calendar-cell.completion-0 { /* 无任务或0%完成 */
            background: var(--gray-100);
        }
        
        .calendar-cell.completion-low { /* 1-30%完成 */
            background: #fee2e2;
            color: #dc2626;
        }
        
        .calendar-cell.completion-medium { /* 31-70%完成 */
            background: #fef3c7;
            color: #d97706;
        }
        
        .calendar-cell.completion-high { /* 71-99%完成 */
            background: #ddd6fe;
            color: #7c3aed;
        }
        
        .calendar-cell.completion-full { /* 100%完成 */
            background: #dcfce7;
            color: #16a34a;
        }

        /* 快速操作按钮 */
        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            letter-spacing: 0.02em;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(67, 97, 238, 0.3);
        }

        .btn-outline {
            background: rgba(255, 255, 255, 0.9);
            color: var(--primary-500);
            border: 1.5px solid rgba(67, 97, 238, 0.2);
            backdrop-filter: blur(10px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--gray-600) 0%, var(--gray-700) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-main) 0%, #d32f2f 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
        }
        
        .btn-danger-outline {
            background: transparent;
            color: var(--danger-main);
            border: 1px solid var(--danger-main);
        }
        
        .btn-danger-outline:hover {
            background: var(--danger-main);
            color: white;
            transform: translateY(-1px);
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 0.75rem;
            border-radius: 4px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* 模板管理样式 */
        .template-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--gray-200);
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .template-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .template-actions {
            display: flex;
            gap: 5px;
        }

        /* 模板设置窗口样式 */
        .template-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .template-modal.show {
            display: flex;
        }

        .template-modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .template-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
        }

        .template-modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .template-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-500);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .template-close:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .template-modal-body {
            padding: 24px;
        }

        .template-tabs {
            display: flex;
            margin-bottom: 24px;
            border-radius: var(--border-radius);
            background: var(--gray-100);
            padding: 4px;
        }

        .template-tab {
            flex: 1;
            padding: 8px 16px;
            border: none;
            background: none;
            border-radius: calc(var(--border-radius) - 2px);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            color: var(--gray-600);
        }

        .template-tab.active {
            background: var(--primary-500);
            color: white;
            box-shadow: 0 2px 4px rgba(67, 97, 238, 0.3);
        }

        .template-content {
            display: none;
        }

        .template-content.active {
            display: block;
        }

        .template-time-list {
            display: grid;
            gap: 8px;
        }

        .template-time-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            background: var(--gray-50);
            border-radius: 6px;
            border: 1px solid var(--gray-200);
        }

        .template-time-label {
            width: 60px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.9rem;
        }

        .template-task-input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .template-task-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
        }

        .template-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 20px 24px;
            border-top: 1px solid var(--gray-200);
        }

        /* 暗色模式适配 */
        body[data-theme="dark"] .template-modal-content {
            background: var(--gray-100);
            color: white;
        }

        body[data-theme="dark"] .template-modal-header,
        body[data-theme="dark"] .template-modal-footer {
            border-color: rgba(255, 255, 255, 0.1);
        }

        body[data-theme="dark"] .template-tabs {
            background: var(--gray-200);
        }

        body[data-theme="dark"] .template-time-item {
            background: var(--gray-200);
            border-color: rgba(255, 255, 255, 0.1);
        }

        body[data-theme="dark"] .template-task-input {
            background: var(--gray-300);
            border-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        body[data-theme="dark"] .template-task-input:focus {
            border-color: var(--primary-400);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .template-list {
            display: none;
            background: var(--gray-50);
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
        }

        .template-list.show {
            display: block;
        }

        .template-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 8px;
            border-radius: 4px;
            margin: 2px 0;
            background: white;
            font-size: 0.8rem;
        }

        .template-item:hover {
            background: var(--primary-50);
        }

        /* 右侧任务面板 */
        .schedule-panel {
            background: linear-gradient(145deg, #ffffff 0%, #fafbff 100%);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(67, 97, 238, 0.08);
            overflow-y: auto;
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-100);
        }

        .selected-date {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .date-weekday {
            color: var(--gray-600);
            font-size: 0.9rem;
            font-weight: 400;
            margin-left: 8px;
        }

        .progress-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-text {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray-color);
        }

        .progress-bar {
            width: 120px;
            height: 6px;
            background: var(--gray-100);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-500) 0%, var(--primary-400) 50%, var(--accent-color) 100%);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* 时间任务列表 */
        .schedule-list {
            flex: 1;
            overflow-y: auto;
        }

        .schedule-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
            border-radius: 6px;
            margin: 3px 0;
            transition: all 0.2s ease;
            min-height: 42px;
        }

        .schedule-item:hover {
            background: var(--primary-50);
        }

        .time {
            width: 55px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .task {
            flex-grow: 1;
            margin: 0 8px;
            border: none;
            font-size: 0.85rem;
            font-weight: 400;
            padding: 8px 10px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
            border: 1px solid var(--gray-200);
            transition: all 0.2s ease;
            min-height: 32px;
            line-height: 1.3;
        }

        .task:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid var(--primary-500);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .checkbox-container {
            position: relative;
            width: 22px;
            height: 22px;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .checkbox-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 22px;
            width: 22px;
            background-color: #ffffff;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .checkbox-container input:checked ~ .checkmark {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            border-color: var(--primary-500);
        }

        .checkbox-container input:disabled ~ .checkmark {
            background-color: #f8f8f8;
            border-color: #d4d4d4;
            opacity: 0.7;
            cursor: not-allowed;
        }

        .checkbox-container input:disabled {
            cursor: not-allowed;
        }

        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .checkbox-container input:checked ~ .checkmark:after {
            display: block;
        }

        .checkbox-container .checkmark:after {
            left: 7px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .task.completed {
            text-decoration: line-through;
            color: var(--gray-500);
            background-color: var(--completed-bg);
        }

        /* 暗色模式下已完成任务的背景色 */
        body[data-theme="dark"] .task.completed {
            background-color: rgba(34, 197, 94, 0.15);
            color: var(--gray-400);
            border-color: rgba(34, 197, 94, 0.3);
        }

        /* 空状态样式 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-color);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.6;
        }

        .empty-state h3 {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--gray-700);
        }

        .empty-state p {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* 通知样式 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 1000;
            display: none;
            animation: slideInRight 0.3s ease;
        }

        .notification.show {
            display: block;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* 设置按钮 */
        .settings-toggle {
            position: fixed;
            bottom: 90px; /* 增加与主题按钮的距离 */
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-500);
            border: none;
            cursor: pointer;
            color: white;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
            transition: all 0.3s ease;
            z-index: 1100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
        }

        /* 设置按钮tooltip */
        .settings-tooltip {
            position: absolute;
            bottom: 65px; /* 调整位置，确保不被遮挡 */
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 1300; /* 提高层级，确保在主题按钮之上 */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            min-width: 200px; /* 确保有足够宽度显示完整邮箱 */
            text-align: center;
        }

        .settings-toggle:hover .settings-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-8px); /* 增加向上的偏移 */
        }

        .tooltip-content {
            text-align: center;
        }

        .tooltip-user-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }

        .tooltip-email {
            font-weight: 500;
            color: #e5e7eb;
            word-break: break-all; /* 允许长邮箱地址换行 */
            max-width: 180px; /* 限制最大宽度 */
            margin: 0 auto; /* 居中显示 */
        }

        .tooltip-logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 16px; /* 增加按钮内边距 */
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 4px; /* 增加与邮箱的间距 */
        }

        .tooltip-logout-btn:hover {
            background: #dc2626;
        }

        .tooltip-offline {
            color: #9ca3af;
            font-style: italic;
        }

        /* 暗色模式适配 */
        body[data-theme="dark"] .settings-tooltip {
            background: rgba(255, 255, 255, 0.95); /* 提高透明度，确保可读性 */
            color: #1f2937;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        body[data-theme="dark"] .tooltip-email {
            color: #374151;
        }

        body[data-theme="dark"] .tooltip-offline {
            color: #6b7280;
        }

        /* 主题切换按钮 */
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-500);
            border: none;
            cursor: pointer;
            color: white;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
            transition: all 0.3s ease;
            z-index: 1100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
        }

        /* 暗色主题适配 */
        body[data-theme="dark"] {
            --primary-50: #1a1d29;
            --primary-100: #252941;
            --primary-400: #818cf8;
            --primary-500: #6366f1;
            --primary-600: #4f46e5;
            --gray-50: #1a1a1a;
            --gray-100: #2d2d2d;
            --gray-200: #404040;
            --gray-300: #525252;
            --gray-400: #737373;
            --gray-500: #a3a3a3;
            --gray-600: #d4d4d4;
            --light-color: #1a1a1a;
            --dark-color: #ffffff;
            --success-light: rgba(34, 197, 94, 0.1);
            --success-main: #22c55e;
            --warning-light: rgba(251, 146, 60, 0.1);
            --warning-main: #fb923c;
            --danger-main: #ef4444;
            
            /* 确保整体背景色 */
            background-color: #1a1a1a !important;
            color: #ffffff !important;
        }

        /* 为html元素也设置暗色背景 */
        html:has(body[data-theme="dark"]) {
            background-color: #1a1a1a !important;
        }

        /* 备用方案：使用CSS变量控制 */
        html {
            background-color: var(--page-bg, #f0f2f5);
        }

        body[data-theme="dark"] {
            --page-bg: #1a1a1a;
        }

        /* 最强制的方案：直接设置html和body */
        body[data-theme="dark"],
        body[data-theme="dark"] html {
            background: #1a1a1a !important;
            background-color: #1a1a1a !important;
        }

        /* 为了确保viewport完全覆盖，添加一个全屏背景层 */
        body[data-theme="dark"]::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            background: #1a1a1a;
            z-index: -9999;
            pointer-events: none;
        }

        [data-theme="dark"] html {
            background: #1a1a1a !important;
            background-color: #1a1a1a !important;
        }

        [data-theme="dark"] body {
            background: #1a1a1a !important;
            background-color: #1a1a1a !important;
            color: #ffffff !important;
        }

        [data-theme="dark"] * {
            scrollbar-color: #4a4a4a #1a1a1a;
        }

        [data-theme="dark"]::before,
        [data-theme="dark"]::after {
            background-color: #1a1a1a !important;
        }

        body[data-theme="dark"] .calendar-panel,
        body[data-theme="dark"] .schedule-panel {
            background: linear-gradient(145deg, var(--gray-100) 0%, #363636 100%);
            border-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        body[data-theme="dark"] .task {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--gray-300);
            color: white;
        }

        body[data-theme="dark"] .task:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15) !important;
            color: #ffffff !important;
            border: 2px solid var(--primary-500);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        body[data-theme="dark"] .calendar-cell:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        body[data-theme="dark"] .calendar-cell.completion-0 {
            background: var(--gray-200);
        }
        
        body[data-theme="dark"] .calendar-cell.completion-low {
            background: rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }
        
        body[data-theme="dark"] .calendar-cell.completion-medium {
            background: rgba(245, 158, 11, 0.3);
            color: #fcd34d;
        }
        
        body[data-theme="dark"] .calendar-cell.completion-high {
            background: rgba(139, 92, 246, 0.3);
            color: #c4b5fd;
        }
        
        body[data-theme="dark"] .calendar-cell.completion-full {
            background: rgba(34, 197, 94, 0.3);
            color: #86efac;
        }

        body[data-theme="dark"] .template-section {
            border-top-color: var(--gray-400);
        }

        body[data-theme="dark"] .template-list {
            background: var(--gray-200);
        }

        body[data-theme="dark"] .template-item {
            background: var(--gray-300);
            color: white;
        }

        body[data-theme="dark"] .template-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* 暗色模式下勾选框样式 */
        body[data-theme="dark"] .checkmark {
            background-color: #3a3a3a;
            border-color: var(--primary-400);
        }

        body[data-theme="dark"] .checkbox-container input:disabled ~ .checkmark {
            background-color: #2d2d2d;
            border-color: #4a4a4a;
            opacity: 0.6;
        }

        /* 暗色模式下今日任务完成度颜色 */
        body[data-theme="dark"] .calendar-cell.today.completion-0 { 
            background: #dc2626; /* 红色：今日无任务或0%完成 */
            color: white;
        }
        
        body[data-theme="dark"] .calendar-cell.today.completion-low { 
            background: #ea580c; /* 橙红色：今日1-30%完成 */
            color: white;
        }
        
        body[data-theme="dark"] .calendar-cell.today.completion-medium { 
            background: #ca8a04; /* 黄色：今日31-70%完成 */
            color: white;
        }
        
        body[data-theme="dark"] .calendar-cell.today.completion-high { 
            background: #9333ea; /* 紫色：今日71-99%完成 */
            color: white;
        }
        
        body[data-theme="dark"] .calendar-cell.today.completion-full { 
            background: #16a34a; /* 绿色：今日100%完成 */
            color: white;
        }

        /* 移动端适配 */
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
                height: auto;
            }

            .calendar-panel {
                height: auto;
                max-height: 400px;
            }

            .calendar-grid {
                margin-bottom: 15px;
            }

            .quick-actions {
                flex-direction: row;
                gap: 6px;
            }

            .btn {
                flex: 1;
                font-size: 0.8rem;
                padding: 6px 10px;
            }

            /* 移动端下调整tooltip宽度 */
            .settings-tooltip {
                min-width: 180px;
                max-width: 250px;
                left: auto;
                right: 20px;
                transform: none;
            }

            .settings-toggle:hover .settings-tooltip {
                transform: translateY(-8px);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 8px;
            }

            .main-layout {
                gap: 15px;
            }

            .calendar-panel,
            .schedule-panel {
                padding: 15px;
            }

            .calendar-header,
            .schedule-header {
                margin-bottom: 15px;
            }

            .month-year,
            .selected-date {
                font-size: 1.1rem;
            }

            .progress-bar {
                width: 80px;
            }

            .task {
                padding: 8px 10px;
                font-size: 0.85rem;
            }

            .time {
                width: 60px;
                font-size: 0.8rem;
            }
        }

        /* 认证界面样式 */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-modal.hidden {
            display: none;
        }

        .auth-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 32px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        body[data-theme="dark"] .auth-card {
            background: var(--gray-100);
            color: white;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .auth-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .auth-subtitle {
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .auth-input {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid var(--gray-300);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        body[data-theme="dark"] .auth-input {
            background: var(--gray-200);
            border-color: var(--gray-400);
            color: white;
        }

        .auth-button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .auth-button-primary {
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
            color: white;
        }

        .auth-button-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        .auth-button-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .auth-button-secondary:hover {
            background: var(--gray-200);
        }

        body[data-theme="dark"] .auth-button-secondary {
            background: var(--gray-200);
            color: white;
            border-color: var(--gray-400);
        }

        body[data-theme="dark"] .auth-button-secondary:hover {
            background: var(--gray-300);
        }

        .auth-divider {
            text-align: center;
            margin: 20px 0;
            color: var(--gray-500);
            position: relative;
        }

        .auth-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--gray-300);
        }

        .auth-divider span {
            background: white;
            padding: 0 16px;
        }

        body[data-theme="dark"] .auth-divider span {
            background: var(--gray-100);
        }

        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            font-size: 0.85rem;
            color: var(--gray-600);
        }

        .auth-toggle a {
            color: var(--primary-500);
            text-decoration: none;
            cursor: pointer;
        }

        .auth-toggle a:hover {
            text-decoration: underline;
        }

        .auth-error {
            background: #fee2e2;
            color: #dc2626;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-bottom: 16px;
            display: none;
        }

        body[data-theme="dark"] .auth-error {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 80px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            color: var(--gray-600);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(67, 97, 238, 0.2);
            z-index: 1000;
            display: none;
        }

        body[data-theme="dark"] .sync-status {
            background: rgba(45, 45, 45, 0.9);
            color: white;
            border-color: rgba(255, 255, 255, 0.2);
        }

        .sync-status.show {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-main);
        }

        .sync-indicator.syncing {
            background: var(--warning-main);
            animation: pulse 1s infinite;
        }

        .sync-indicator.offline {
            background: var(--danger-main);
        }
        
        .sync-indicator.editing {
            background: #fbbf24;
            animation: pulse 1.5s infinite;
        }
        
        .sync-indicator.pending {
            background: #f97316;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>
    
    <!-- 用户认证模态框 -->
    <div class="auth-modal" id="authModal">
        <div class="auth-card">
            <div class="auth-header">
                <h2 class="auth-title">智能日程管理</h2>
                <p class="auth-subtitle">登录以同步您的数据</p>
            </div>
            
            <div class="auth-error" id="authError"></div>
            
            <form class="auth-form" id="authForm" autocomplete="on">
                <input type="email" class="auth-input" id="authEmail" placeholder="邮箱地址" required autocomplete="email">
                <input type="password" class="auth-input" id="authPassword" placeholder="密码" required minlength="6" autocomplete="current-password">
                <button type="submit" class="auth-button auth-button-primary" id="authSubmit">登录</button>
            </form>
            
            <div class="auth-divider">
                <span>或</span>
            </div>
            
            <button class="auth-button auth-button-secondary" id="googleAuth">
                <svg width="18" height="18" viewBox="0 0 24 24" style="margin-right: 8px;">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                使用 Google 登录
            </button>
            
            <div class="auth-toggle">
                <span id="authToggleText">还没有账号？</span>
                <a href="#" id="authToggleLink">注册</a>
            </div>
        </div>
    </div>
    
    <!-- 同步状态指示器 -->
    <div class="sync-status" id="syncStatus">
        <div class="sync-indicator" id="syncIndicator"></div>
        <span id="syncText">已同步</span>
    </div>
    
    <div class="container">
        <div class="main-layout">
            <!-- 左侧任务面板 -->
            <div class="schedule-panel">
                <div class="schedule-header">
                    <div>
                        <span class="selected-date" id="selectedDate">请选择日期</span>
                        <span class="date-weekday" id="selectedWeekday"></span>
                    </div>
                    <div class="progress-info">
                        <span class="progress-text" id="progressText">0/0 (0%)</span>
                        <div class="progress-bar">
                            <div class="progress" id="progressBar" style="width: 0%"></div>
                        </div>
                        <button class="btn btn-danger btn-sm" id="deleteSchedule" style="display: none;">删除日程</button>
                    </div>
                </div>

                <div class="schedule-list" id="scheduleList">
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        <h3>选择日期查看任务</h3>
                        <p>点击右侧日历中的日期<br>来查看和管理该日的时间安排</p>
                    </div>
                </div>
            </div>

            <!-- 右侧日历面板 -->
            <div class="calendar-panel">
                <div class="calendar-header">
                    <button class="nav-btn" id="prevMonth" title="上一月">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15,18 9,12 15,6"></polyline>
                        </svg>
                    </button>
                    <div class="month-year" id="monthYear">2024年12月</div>
                    <button class="nav-btn" id="nextMonth" title="下一月">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9,18 15,12 9,6"></polyline>
                        </svg>
                    </button>
                </div>

                <div class="calendar-grid" id="calendarGrid">
                    <div class="calendar-header-cell">日</div>
                    <div class="calendar-header-cell">一</div>
                    <div class="calendar-header-cell">二</div>
                    <div class="calendar-header-cell">三</div>
                    <div class="calendar-header-cell">四</div>
                    <div class="calendar-header-cell">五</div>
                    <div class="calendar-header-cell">六</div>
                </div>

                <div class="quick-actions">
                    <button class="btn btn-primary" id="addTodaySchedule">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12,6 12,12 16,14"></polyline>
                        </svg>
                        今日日程
                    </button>
                    <button class="btn btn-outline" id="addTomorrowSchedule">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        明日日程
                    </button>
                    <button class="btn btn-secondary" id="addWeekSchedule">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                            <line x1="8" y1="14" x2="16" y2="14"></line>
                        </svg>
                        本周日程
                    </button>
                    <button class="btn btn-secondary" id="addNextWeekSchedule">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                            <line x1="8" y1="14" x2="16" y2="14"></line>
                            <path d="M16 3l4 4-4 4"></path>
                        </svg>
                        下周日程
                    </button>
                    <button class="btn btn-danger" id="clearCache">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                            <polyline points="3,6 5,6 21,6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        清空日程
                    </button>
                    <button class="btn btn-danger-outline btn-sm" id="clearAll" title="清空所有数据包括模板" style="margin-left: 8px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;">
                            <polyline points="3,6 5,6 21,6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            <line x1="8" y1="11" x2="8" y2="17"></line>
                            <line x1="12" y1="11" x2="12" y2="17"></line>
                            <line x1="16" y1="11" x2="16" y2="17"></line>
                        </svg>
                        完全清空
                    </button>
                </div>

                <!-- 数据备份恢复区域 -->
                <div class="backup-section" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--gray-200);">
                    <div class="backup-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span class="backup-title" style="font-size: 0.9rem; font-weight: 600; color: var(--primary-color);">数据管理</span>
                    </div>
                    <div class="backup-actions" style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary btn-sm" id="restoreBackup">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;">
                                <polyline points="23,4 23,10 17,10"></polyline>
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                            </svg>
                            恢复备份
                        </button>
                        <button class="btn btn-outline btn-sm" id="createBackup">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                <polyline points="17,21 17,13 7,13 7,21"></polyline>
                                <polyline points="7,3 7,8 15,8"></polyline>
                            </svg>
                            创建备份
                        </button>
                        <button class="btn btn-primary btn-sm" id="forceSyncAll" title="立即同步所有数据到云端">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;">
                                <polyline points="23,4 23,10 17,10"></polyline>
                                <polyline points="1,20 1,14 7,14"></polyline>
                                <path d="m20.49 9a9 9 0 1 1-2.12-3.36L23 10"></path>
                                <path d="m3.51 15a9 9 0 1 1 2.13 3.36L1 14"></path>
                            </svg>
                            强制同步
                        </button>
                    </div>
                </div>

                <!-- 模板管理 -->
                <div class="template-section">
                    <div class="template-header">
                        <span class="template-title">日程模板</span>
                        <div class="template-actions">
                            <button class="btn btn-sm btn-outline" id="toggleTemplate" title="显示/隐藏模板">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M9 12l2 2 4-4"></path>
                                    <path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3"></path>
                                    <path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3"></path>
                                </svg>
                            </button>
                            <button class="btn btn-sm btn-primary" id="openTemplateModal" title="模板设置">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="template-list" id="templateList">
                        <div class="empty-state" style="padding: 20px; text-align: center; font-size: 0.8rem; color: var(--gray-500);">
                            暂无模板，点击+号添加
                        </div>
                    </div>
                </div>
            </div>

            <!-- 模板设置窗口 -->
            <div class="template-modal" id="templateModal">
                <div class="template-modal-content">
                    <div class="template-modal-header">
                        <h3 class="template-modal-title">日程模板设置</h3>
                        <button class="template-close" id="templateModalClose">×</button>
                    </div>
                    
                    <div class="template-modal-body">
                        <div class="template-tabs">
                            <button class="template-tab active" id="workdayTab">工作日模板</button>
                            <button class="template-tab" id="nonWorkdayTab">非工作日模板</button>
                        </div>
                        
                        <!-- 工作日模板 -->
                        <div class="template-content active" id="workdayContent">
                            <div class="template-time-list" id="workdayTimeList">
                                <!-- 时间段将由JavaScript动态生成 -->
                            </div>
                        </div>
                        
                        <!-- 非工作日模板 -->
                        <div class="template-content" id="nonWorkdayContent">
                            <div class="template-time-list" id="nonWorkdayTimeList">
                                <!-- 时间段将由JavaScript动态生成 -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="template-modal-footer">
                        <button class="btn btn-outline" id="templateModalCancel">取消</button>
                        <button class="btn btn-primary" id="templateModalSave">保存模板</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 设置按钮 -->
    <button class="settings-toggle" id="settingsToggle" title="设置">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
            <circle cx="12" cy="12" r="3"></circle>
        </svg>
        
        <!-- 悬浮显示的用户信息 -->
        <div class="settings-tooltip" id="settingsTooltip">
            <div class="tooltip-content">
                <div class="tooltip-user-info" id="tooltipUserInfo" style="display: none;">
                    <div class="tooltip-email" id="tooltipUserEmail">用户邮箱</div>
                    <button class="tooltip-logout-btn" id="tooltipLogoutBtn">退出登录</button>
                </div>
                <div class="tooltip-offline" id="tooltipOffline">
                    <div class="tooltip-text">离线模式</div>
                </div>
            </div>
        </div>
    </button>

    <!-- 主题切换按钮 -->
    <button class="theme-toggle" id="themeToggle" title="切换主题 (T)">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
    </button>

    <script>
        // ==================== Supabase 配置 ====================
        
        const supabaseUrl = 'https://jpkqzqlajatekscukcre.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impwa3F6cWxhamF0ZWtzY3VrY3JlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTE1ODgsImV4cCI6MjA3MDU4NzU4OH0.bXjCO0gqcCZ3GjQMl7uE8COAwo7LgYBRMoiaHkiVe7s';
        
        // 安全初始化Supabase客户端
        let supabaseClient = null;
        let isSupabaseAvailable = false;
        
        async function initializeSupabase() {
            try {
                // 检查Supabase库是否加载成功
                const supabaseLoaded = await checkSupabaseLoaded();
                
                if (supabaseLoaded && typeof supabase !== 'undefined') {
                    const { createClient } = supabase;
                    supabaseClient = createClient(supabaseUrl, supabaseAnonKey);
                    isSupabaseAvailable = true;
                    console.log('Supabase客户端初始化成功');
                    return true;
                } else {
                    console.warn('Supabase库未加载，使用离线模式');
                    isSupabaseAvailable = false;
                    return false;
                }
            } catch (error) {
                console.error('Supabase初始化失败:', error);
                isSupabaseAvailable = false;
                return false;
            }
        }
        
        // ==================== 全局变量 ====================
        
        let schedules = [];
        let currentDate = new Date();
        let selectedDate = null;
        let selectedSchedule = null;
        let currentUser = null;
        let isOnline = navigator.onLine;
        let isAuthMode = false; // 是否为注册模式
        
        // 离线数据缓存
        let offlineSchedules = [];
        let offlinePendingChanges = []; // 重命名以避免与新的同步系统冲突
        
        // ==================== 认证管理 ====================
        
        async function initializeAuth() {
            console.log('初始化认证系统...');
            
            // 初始化tooltip状态为离线模式
            document.getElementById('tooltipUserInfo').style.display = 'none';
            document.getElementById('tooltipOffline').style.display = 'block';
            
            // 如果Supabase不可用，跳过认证直接使用离线模式
            if (!isSupabaseAvailable || !supabaseClient) {
                console.log('Supabase不可用，跳过认证，使用离线模式');
                showNotification('网络连接问题，使用离线模式', false);
                loadFromLocalStorage();
                loadTemplatesFromStorage();
                renderCalendar();
                renderScheduleForDate();
                updateTemplateListDisplay();
                return;
            }
            
            try {
                // 检查现有会话
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (session?.user) {
                    console.log('发现现有会话:', session.user.email);
                    await handleAuthSuccess(session.user);
                } else {
                    showAuthModal();
                    // 如果没有用户会话，加载本地数据作为fallback
                    loadFromLocalStorage();
                    loadTemplatesFromStorage();
                    renderCalendar();
                    renderScheduleForDate();
                    updateTemplateListDisplay();
                }
                
                // 监听认证状态变化
                supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    console.log('认证状态变化:', event, session?.user?.email);
                    
                    if (event === 'SIGNED_IN' && session?.user) {
                        await handleAuthSuccess(session.user);
                    } else if (event === 'SIGNED_OUT') {
                        handleAuthLogout();
                    }
                });
            } catch (error) {
                console.error('认证系统初始化失败:', error);
                showNotification('认证系统异常，使用离线模式', false);
                // Fallback到离线模式
                loadFromLocalStorage();
                loadTemplatesFromStorage();
                renderCalendar();
                renderScheduleForDate();
                updateTemplateListDisplay();
            }
        }
        
        function showAuthModal() {
            document.getElementById('authModal').classList.remove('hidden');
            document.getElementById('tooltipUserInfo').style.display = 'none';
            document.getElementById('tooltipOffline').style.display = 'block';
            document.getElementById('syncStatus').classList.remove('show');
        }
        
        function hideAuthModal() {
            document.getElementById('authModal').classList.add('hidden');
        }
        
        async function handleAuthSuccess(user) {
            console.log('认证成功:', user.email);
            currentUser = user;
            
            // 隐藏认证窗口，更新tooltip用户信息
            hideAuthModal();
            document.getElementById('tooltipUserEmail').textContent = user.email;
            document.getElementById('tooltipUserInfo').style.display = 'flex';
            document.getElementById('tooltipOffline').style.display = 'none';
            document.getElementById('syncStatus').classList.add('show');
            
            // 同步数据
            await syncDataFromServer();
            
            // 认证成功后执行任务流转
            setTimeout(() => {
                console.log('用户认证完成，执行任务流转检查');
                processUnfinishedTasks();
            }, 500);
            
            // 显示成功消息
            showNotification(`欢迎回来，${user.email.split('@')[0]}！`, true);
        }
        
        function handleAuthLogout() {
            console.log('用户登出');
            currentUser = null;
            
            // 清空本地数据
            schedules = [];
            selectedSchedule = null;
            
            // 重置界面
            showAuthModal();
            renderCalendar();
            renderScheduleForDate();
            
            showNotification('已退出登录', false);
        }
        
        function toggleAuthMode() {
            isAuthMode = !isAuthMode;
            
            if (isAuthMode) {
                document.getElementById('authSubmit').textContent = '注册';
                document.getElementById('authToggleText').textContent = '已有账号？';
                document.getElementById('authToggleLink').textContent = '登录';
            } else {
                document.getElementById('authSubmit').textContent = '登录';
                document.getElementById('authToggleText').textContent = '还没有账号？';
                document.getElementById('authToggleLink').textContent = '注册';
            }
        }
        
        function showAuthError(message) {
            const errorEl = document.getElementById('authError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            
            // 确保输入框不会因为错误显示而被清空
            setTimeout(() => {
                const emailInput = document.getElementById('authEmail');
                const passwordInput = document.getElementById('authPassword');
                
                // 如果输入框为空但应该有值，则保持之前的值
                if (emailInput && !emailInput.value && emailInput.dataset.lastValue) {
                    emailInput.value = emailInput.dataset.lastValue;
                }
            }, 100);
            
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }
        
        async function handleEmailAuth(email, password) {
            console.log('开始处理邮箱认证:', email);
            
            // 检查Supabase是否可用
            if (!isSupabaseAvailable || !supabaseClient) {
                showAuthError('网络连接异常，无法进行在线认证');
                return;
            }
            
            // 获取输入框元素以便在需要时恢复值
            const emailInput = document.getElementById('authEmail');
            const passwordInput = document.getElementById('authPassword');
            const originalEmail = email;
            const originalPassword = password;
            
            try {
                const authEl = document.getElementById('authSubmit');
                authEl.textContent = '处理中...';
                authEl.disabled = true;
                
                let result;
                
                if (isAuthMode) {
                    // 注册
                    console.log('执行注册操作');
                    result = await supabaseClient.auth.signUp({
                        email,
                        password,
                    });
                    
                    if (result.error) throw result.error;
                    
                    if (result.data.user && !result.data.session) {
                        showNotification('请检查您的邮箱并确认注册', true);
                        toggleAuthMode(); // 切换回登录模式
                        // 注册成功后保留邮箱，清空密码
                        emailInput.value = originalEmail;
                        passwordInput.value = '';
                    }
                } else {
                    // 登录
                    console.log('执行登录操作');
                    result = await supabaseClient.auth.signInWithPassword({
                        email,
                        password,
                    });
                    
                    if (result.error) throw result.error;
                    
                    console.log('登录成功，用户信息:', result.data.user);
                    // 登录成功，清空输入框
                    emailInput.value = '';
                    passwordInput.value = '';
                }
                
            } catch (error) {
                console.error('认证错误:', error);
                let errorMessage = '认证失败，请重试';
                
                if (error.message.includes('Invalid login credentials')) {
                    errorMessage = '邮箱或密码错误';
                } else if (error.message.includes('Email not confirmed')) {
                    errorMessage = '请先确认您的邮箱';
                } else if (error.message.includes('User already registered')) {
                    errorMessage = '该邮箱已注册，请直接登录';
                    toggleAuthMode();
                } else if (error.message.includes('fetch')) {
                    errorMessage = '网络连接异常，请检查网络';
                } else {
                    errorMessage = error.message;
                }
                
                // 认证失败时恢复输入框的值
                console.log('认证失败，恢复输入框值');
                emailInput.value = originalEmail;
                passwordInput.value = originalPassword;
                
                showAuthError(errorMessage);
            } finally {
                const authEl = document.getElementById('authSubmit');
                authEl.textContent = isAuthMode ? '注册' : '登录';
                authEl.disabled = false;
            }
        }
        
        async function handleGoogleAuth() {
            try {
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin
                    }
                });
                
                if (error) throw error;
                
            } catch (error) {
                console.error('Google认证错误:', error);
                showAuthError('Google登录失败：' + error.message);
            }
        }
        
        async function logout() {
            try {
                await supabaseClient.auth.signOut();
            } catch (error) {
                console.error('登出错误:', error);
                showNotification('登出失败', false);
            }
        }
        
        // ==================== 数据同步管理 ====================
        
        // 安全检查Supabase是否可用
        function checkSupabaseAvailable() {
            if (!isSupabaseAvailable || !supabaseClient) {
                console.warn('Supabase不可用，跳过云端操作');
                return false;
            }
            return true;
        }
        
        function updateSyncStatus(status, text) {
            const indicator = document.getElementById('syncIndicator');
            const textEl = document.getElementById('syncText');
            
            if (indicator && textEl) {
                indicator.className = `sync-indicator ${status}`;
                textEl.textContent = text;
            }
        }
        
        async function syncDataFromServer() {
            if (!currentUser || !checkSupabaseAvailable()) {
                console.log('用户未登录或Supabase不可用，跳过数据同步');
                return;
            }
            
            updateSyncStatus('syncing', '同步中...');
            
            try {
                // 1. 备份当前本地数据
                const localBackup = {
                    schedules: JSON.parse(JSON.stringify(schedules)),
                    workdayTemplate: JSON.parse(JSON.stringify(workdayTemplate)),
                    nonWorkdayTemplate: JSON.parse(JSON.stringify(nonWorkdayTemplate))
                };
                
                console.log('本地数据备份完成，本地日程数量:', localBackup.schedules.length);
                
                // 2. 获取服务器数据
                const { data: schedulesData, error: schedulesError } = await supabaseClient
                    .from('schedules')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('day_id', { ascending: false });
                
                if (schedulesError) {
                    if (schedulesError.message.includes('relation') && schedulesError.message.includes('does not exist')) {
                        console.error('数据库表不存在，请先创建数据库表');
                        showNotification('数据库未初始化，请先创建数据库表', false);
                        updateSyncStatus('offline', '需要初始化');
                        return;
                    }
                    throw schedulesError;
                }
                
                console.log('服务器数据获取完成，服务器日程数量:', schedulesData ? schedulesData.length : 0);
                
                // 3. 智能合并数据
                const mergedSchedules = mergeScheduleData(localBackup.schedules, schedulesData || []);
                
                console.log('数据合并完成，最终日程数量:', mergedSchedules.length);
                
                // 4. 获取其他数据（模板、设置）
                const { data: templatesData } = await supabaseClient
                    .from('templates')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                const { data: settingsData } = await supabaseClient
                    .from('user_settings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                // 5. 更新本地数据
                schedules = mergedSchedules;
                
                // 更新模板
                if (templatesData && templatesData.length > 0) {
                    templatesData.forEach(template => {
                        if (template.template_type === 'workday') {
                            workdayTemplate = template.template_data || {};
                        } else if (template.template_type === 'nonworkday') {
                            nonWorkdayTemplate = template.template_data || {};
                        }
                    });
                }
                
                // 更新用户设置
                if (settingsData) {
                    if (settingsData.theme) {
                        const newTheme = settingsData.theme;
                        document.body.setAttribute('data-theme', newTheme);
                        updateThemeIcon(newTheme);
                        localStorage.setItem('calendarTheme', newTheme);
                    }
                    
                    if (settingsData.current_date_data) {
                        const dateData = settingsData.current_date_data;
                        currentDate = new Date(dateData.year, dateData.month, dateData.day);
                    }
                }
                
                // 6. 保存合并后的数据到本地存储
                saveToLocalStorage();
                
                // 7. 重新渲染界面
                renderCalendar();
                renderScheduleForDate();
                updateTemplateListDisplay();
                
                updateSyncStatus('', '已同步');
                console.log('数据同步完成');
                
                // 8. 如果有数据合并，提示用户
                const addedCount = mergedSchedules.length - Math.max(localBackup.schedules.length, schedulesData?.length || 0);
                if (addedCount > 0) {
                    showNotification(`数据同步完成，合并了 ${addedCount} 条新数据`, true);
                }
                
            } catch (error) {
                console.error('数据同步失败:', error);
                updateSyncStatus('offline', '同步失败');
                showNotification('数据同步失败，已保留本地数据: ' + error.message, false);
            }
        }
        
        // 改进的保存函数 - 增加重试机制
        async function saveToSupabaseWithRetry(maxRetries = 3) {
            // 总是先保存到本地存储，确保数据不丢失
            saveToLocalStorage();
            
            if (!currentUser || !isOnline || !checkSupabaseAvailable()) {
                console.log('用户未登录、离线或Supabase不可用，数据已保存到本地');
                return;
            }
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    updateSyncStatus('syncing', `保存中...${attempt}/${maxRetries}`);
                    
                    // 保存前验证数据完整性
                    if (!validateDataIntegrity()) {
                        throw new Error('数据完整性验证失败');
                    }
                    
                    await saveSchedulesToSupabase();
                    await saveUserSettingsToSupabase();
                    
                    updateSyncStatus('', '已同步');
                    console.log(`数据保存成功 (尝试 ${attempt}/${maxRetries})`);
                    return; // 成功后退出
                    
                } catch (error) {
                    console.error(`保存失败 (尝试 ${attempt}/${maxRetries}):`, error);
                    
                    if (attempt === maxRetries) {
                        // 最后一次尝试失败
                        updateSyncStatus('offline', '同步失败');
                        showNotification(`数据保存失败（已尝试${maxRetries}次），已保存到本地`, false);
                    } else {
                        // 等待后重试
                        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                    }
                }
            }
        }

        // 保持原函数向后兼容
        async function saveToSupabase() {
            return await saveToSupabaseWithRetry();
        }
        
        async function saveSchedulesToSupabase() {
            if (!currentUser) return;
            
            console.log('开始保存日程到Supabase，当前日程数量:', schedules.length);
            
            // 获取所有需要同步的日程
            for (const schedule of schedules) {
                try {
                    console.log('正在保存日程:', schedule);
                    
                    // 检查必要字段
                    if (!schedule.dayId) {
                        console.error('日程缺少dayId字段:', schedule);
                        continue;
                    }
                    
                    const scheduleData = {
                        user_id: currentUser.id,
                        day_id: schedule.dayId,
                        date: schedule.date,
                        weekday: schedule.weekday,
                        items: schedule.items || []
                    };
                    
                    console.log('准备保存的数据:', scheduleData);
                    
                    // 先尝试插入，如果失败则更新
                    let { error: insertError } = await supabaseClient
                        .from('schedules')
                        .insert([scheduleData]);
                    
                    if (insertError) {
                        if (insertError.code === '23505') {
                            // 唯一约束冲突，说明记录已存在，执行更新操作
                            console.log('记录已存在，执行更新操作');
                            const { error: updateError } = await supabaseClient
                                .from('schedules')
                                .update(scheduleData)
                                .eq('user_id', currentUser.id)
                                .eq('day_id', schedule.dayId);
                            
                            if (updateError) {
                                console.error('更新操作失败:', updateError);
                                throw updateError;
                            }
                        } else {
                            console.error('插入操作失败:', insertError);
                            throw insertError;
                        }
                    }
                    
                    console.log('日程保存成功:', schedule.dayId);
                    
                } catch (error) {
                    console.error(`保存日程 ${schedule.dayId} 失败:`, error);
                    throw error;
                }
            }
            
            console.log('所有日程保存完成');
        }
        
        async function saveUserSettingsToSupabase() {
            if (!currentUser) return;
            
            try {
                const settingsData = {
                    user_id: currentUser.id,
                    theme: document.body.getAttribute('data-theme') || 'light',
                    current_date_data: {
                        year: currentDate.getFullYear(),
                        month: currentDate.getMonth(),
                        day: currentDate.getDate()
                    }
                };
                
                // 先尝试插入，如果失败则更新
                let { error: insertError } = await supabaseClient
                    .from('user_settings')
                    .insert([settingsData]);
                
                if (insertError) {
                    if (insertError.code === '23505') {
                        // 唯一约束冲突，说明记录已存在，执行更新操作
                        const { error: updateError } = await supabaseClient
                            .from('user_settings')
                            .update(settingsData)
                            .eq('user_id', currentUser.id);
                        
                        if (updateError) throw updateError;
                    } else {
                        throw insertError;
                    }
                }
                
            } catch (error) {
                console.error('保存用户设置失败:', error);
                throw error;
            }
        }
        
        async function saveTemplatesToSupabase() {
            if (!currentUser) return;
            
            try {
                // 保存工作日模板
                if (Object.keys(workdayTemplate).length > 0) {
                    const workdayData = {
                        user_id: currentUser.id,
                        template_type: 'workday',
                        template_data: workdayTemplate
                    };
                    
                    let { error: insertError } = await supabaseClient
                        .from('templates')
                        .insert([workdayData]);
                    
                    if (insertError) {
                        if (insertError.code === '23505') {
                            // 记录已存在，执行更新
                            const { error: updateError } = await supabaseClient
                                .from('templates')
                                .update(workdayData)
                                .eq('user_id', currentUser.id)
                                .eq('template_type', 'workday');
                            
                            if (updateError) throw updateError;
                        } else {
                            throw insertError;
                        }
                    }
                }
                
                // 保存非工作日模板
                if (Object.keys(nonWorkdayTemplate).length > 0) {
                    const nonWorkdayData = {
                        user_id: currentUser.id,
                        template_type: 'nonworkday',
                        template_data: nonWorkdayTemplate
                    };
                    
                    let { error: insertError } = await supabaseClient
                        .from('templates')
                        .insert([nonWorkdayData]);
                    
                    if (insertError) {
                        if (insertError.code === '23505') {
                            // 记录已存在，执行更新
                            const { error: updateError } = await supabaseClient
                                .from('templates')
                                .update(nonWorkdayData)
                                .eq('user_id', currentUser.id)
                                .eq('template_type', 'nonworkday');
                            
                            if (updateError) throw updateError;
                        } else {
                            throw insertError;
                        }
                    }
                }
                
            } catch (error) {
                console.error('保存模板失败:', error);
                throw error;
            }
        }
        
        async function deleteScheduleFromSupabase(dayId) {
            if (!currentUser || !isOnline) return;
            
            try {
                const { error } = await supabaseClient
                    .from('schedules')
                    .delete()
                    .eq('user_id', currentUser.id)
                    .eq('day_id', dayId);
                
                if (error) throw error;
                
            } catch (error) {
                console.error('删除Supabase日程失败:', error);
                throw error;
            }
        }
        
        async function processPendingChanges() {
            // 处理离线期间累积的变更
            if (offlinePendingChanges.length > 0) {
                console.log('处理离线期间的变更:', offlinePendingChanges.length);
                // 这里将实现冲突解决逻辑
                offlinePendingChanges = []; // 临时清空
            }
        }
        
        // ==================== 性能监控和统计 ====================
        
        let syncStats = {
            totalSyncs: 0,
            incrementalSyncs: 0,
            fullSyncs: 0,
            failedSyncs: 0,
            savedBytes: 0,
            lastSyncTime: null
        };

        function updateSyncStats(type, success = true, dataSize = 0) {
            syncStats.totalSyncs++;
            
            if (success) {
                if (type === 'incremental') {
                    syncStats.incrementalSyncs++;
                } else if (type === 'full') {
                    syncStats.fullSyncs++;
                }
                syncStats.savedBytes += dataSize;
                syncStats.lastSyncTime = new Date().toISOString();
            } else {
                syncStats.failedSyncs++;
            }
            
            // 显示统计信息到控制台
            console.log('同步统计:', {
                总同步次数: syncStats.totalSyncs,
                增量同步: syncStats.incrementalSyncs,
                全量同步: syncStats.fullSyncs,
                失败次数: syncStats.failedSyncs,
                成功率: ((syncStats.totalSyncs - syncStats.failedSyncs) / syncStats.totalSyncs * 100).toFixed(1) + '%',
                已保存数据: (syncStats.savedBytes / 1024).toFixed(2) + 'KB',
                最后同步: syncStats.lastSyncTime ? new Date(syncStats.lastSyncTime).toLocaleString() : '无'
            });
        }

        // 获取同步统计信息
        function getSyncStats() {
            return {
                ...syncStats,
                successRate: ((syncStats.totalSyncs - syncStats.failedSyncs) / syncStats.totalSyncs * 100).toFixed(1) + '%',
                savedKB: (syncStats.savedBytes / 1024).toFixed(2) + 'KB'
            };
        }

        // ==================== 优化的数据同步系统 ====================
        
        let pendingChanges = new Set(); // 记录待提交的日程ID
        let saveTimer = null; // 防抖定时器
        let updateTimer = null; // 任务更新防抖定时器
        
        // 防抖保存函数
        function saveToSupabaseDebounced(changedDayId) {
            // 记录需要保存的日程
            if (changedDayId) {
                pendingChanges.add(changedDayId);
                console.log('添加到待同步列表:', changedDayId, '待同步数量:', pendingChanges.size);
            }
            
            // 先保存到本地存储（立即）
            saveToLocalStorage();
            updateSyncIndicator('pending');
            
            // 清除之前的定时器
            if (saveTimer) {
                clearTimeout(saveTimer);
            }
            
            // 设置新的定时器，2秒后提交到云端
            saveTimer = setTimeout(async () => {
                try {
                    updateSyncIndicator('syncing');
                    await saveChangedSchedulesToSupabase();
                    updateSyncIndicator('synced');
                } catch (error) {
                    console.error('防抖保存失败:', error);
                    updateSyncIndicator('error');
                }
            }, 2000); // 2秒防抖延迟
        }

        // 增量保存函数：只保存修改过的数据
        async function saveChangedSchedulesToSupabase() {
            if (!currentUser || pendingChanges.size === 0) return;
            
            const startTime = Date.now();
            console.log('开始增量保存，待保存数量:', pendingChanges.size);
            
            const changedScheduleIds = Array.from(pendingChanges);
            const changedSchedules = schedules.filter(s => changedScheduleIds.includes(s.dayId));
            
            let totalDataSize = 0;
            
            for (const schedule of changedSchedules) {
                try {
                    const scheduleData = {
                        user_id: currentUser.id,
                        day_id: schedule.dayId,
                        date: schedule.date,
                        weekday: schedule.weekday,
                        items: schedule.items || [],
                        updated_at: new Date().toISOString()
                    };
                    
                    // 计算数据大小
                    totalDataSize += JSON.stringify(scheduleData).length;
                    
                    // 先尝试插入，如果失败则更新
                    let { error: insertError } = await supabaseClient
                        .from('schedules')
                        .insert([scheduleData]);
                    
                    if (insertError) {
                        if (insertError.code === '23505') {
                            // 唯一约束冲突，说明记录已存在，执行更新操作
                            console.log('记录已存在，执行更新操作:', schedule.date);
                            const { error: updateError } = await supabaseClient
                                .from('schedules')
                                .update(scheduleData)
                                .eq('user_id', currentUser.id)
                                .eq('day_id', schedule.dayId);
                            
                            if (updateError) {
                                console.error('更新操作失败:', updateError);
                                throw updateError;
                            }
                            console.log('更新成功:', schedule.date);
                        } else {
                            console.error('插入操作失败:', insertError);
                            throw insertError;
                        }
                    } else {
                        console.log('插入成功:', schedule.date);
                    }
                    
                } catch (error) {
                    console.error('增量保存失败:', schedule.date, error);
                    // 更新失败统计
                    updateSyncStats('incremental', false);
                    throw error;
                }
            }
            
            // 清空待提交列表
            pendingChanges.clear();
            
            const duration = Date.now() - startTime;
            console.log(`增量保存完成，耗时 ${duration}ms，数据量 ${(totalDataSize/1024).toFixed(2)}KB`);
            
            // 更新成功统计
            updateSyncStats('incremental', true, totalDataSize);
        }

        // 更新同步状态指示器
        function updateSyncIndicator(status) {
            const syncIndicator = document.getElementById('syncIndicator');
            const syncText = document.getElementById('syncText');
            
            if (!syncIndicator || !syncText) return;
            
            switch(status) {
                case 'editing':
                    syncIndicator.className = 'sync-indicator editing';
                    syncText.textContent = '编辑中';
                    syncIndicator.style.background = '#fbbf24';
                    break;
                case 'pending':
                    syncIndicator.className = 'sync-indicator pending';
                    syncText.textContent = `待同步(${pendingChanges.size})`;
                    syncIndicator.style.background = '#f97316';
                    break;
                case 'syncing':
                    syncIndicator.className = 'sync-indicator syncing';
                    syncText.textContent = '同步中';
                    syncIndicator.style.background = '#3b82f6';
                    break;
                case 'synced':
                    syncIndicator.className = 'sync-indicator';
                    syncText.textContent = '已同步';
                    syncIndicator.style.background = '#10b981';
                    break;
                case 'error':
                    syncIndicator.className = 'sync-indicator offline';
                    syncText.textContent = '同步失败';
                    syncIndicator.style.background = '#ef4444';
                    break;
            }
        }

        // 强制同步所有数据
        async function forceSyncAll() {
            try {
                const startTime = Date.now();
                updateSyncIndicator('syncing');
                
                // 将所有日程加入待提交列表
                schedules.forEach(s => pendingChanges.add(s.dayId));
                
                console.log(`开始强制同步 ${schedules.length} 条日程`);
                
                await saveChangedSchedulesToSupabase();
                
                const duration = Date.now() - startTime;
                
                updateSyncIndicator('synced');
                showNotification(`已强制同步${schedules.length}条日程 (${duration}ms)`, true);
                
                // 更新全量同步统计
                updateSyncStats('full', true, JSON.stringify(schedules).length);
                
            } catch (error) {
                console.error('强制同步失败:', error);
                updateSyncIndicator('error');
                showNotification('强制同步失败：' + error.message, false);
                
                // 更新失败统计
                updateSyncStats('full', false);
            }
        }

        // ==================== 数据同步辅助函数 ====================
        
        // 智能数据合并函数
        function mergeScheduleData(localSchedules, serverSchedules) {
            console.log('开始合并数据...');
            console.log('本地数据:', localSchedules.length, '条');
            console.log('服务器数据:', serverSchedules.length, '条');
            
            // 创建合并结果的Map，使用dayId作为key
            const mergedMap = new Map();
            
            // 1. 先添加本地数据
            localSchedules.forEach(schedule => {
                if (schedule.dayId) {
                    mergedMap.set(schedule.dayId, {
                        ...schedule,
                        source: 'local',
                        lastModified: schedule.createdAt || new Date().toISOString()
                    });
                }
            });
            
            // 2. 合并服务器数据
            serverSchedules.forEach(serverSchedule => {
                const dayId = serverSchedule.day_id;
                const localSchedule = mergedMap.get(dayId);
                
                const serverData = {
                    dayId: serverSchedule.day_id,
                    date: serverSchedule.date,
                    weekday: serverSchedule.weekday,
                    items: serverSchedule.items || [],
                    createdAt: serverSchedule.created_at,
                    source: 'server',
                    lastModified: serverSchedule.updated_at || serverSchedule.created_at
                };
                
                if (!localSchedule) {
                    // 服务器有，本地没有 -> 直接添加
                    mergedMap.set(dayId, serverData);
                    console.log(`添加服务器数据: ${serverSchedule.date}`);
                } else {
                    // 两边都有 -> 需要决定使用哪个
                    const localTime = new Date(localSchedule.lastModified).getTime();
                    const serverTime = new Date(serverData.lastModified).getTime();
                    
                    if (serverTime > localTime) {
                        // 服务器数据更新 -> 使用服务器数据
                        mergedMap.set(dayId, serverData);
                        console.log(`使用服务器较新数据: ${serverSchedule.date}`);
                    } else if (localTime > serverTime) {
                        // 本地数据更新 -> 保持本地数据
                        console.log(`保持本地较新数据: ${localSchedule.date}`);
                    } else {
                        // 时间相同 -> 合并任务内容
                        const mergedItems = mergeTaskItems(localSchedule.items, serverData.items);
                        mergedMap.set(dayId, {
                            ...localSchedule,
                            items: mergedItems,
                            source: 'merged'
                        });
                        console.log(`合并同时间数据: ${localSchedule.date}`);
                    }
                }
            });
            
            // 转换为数组并排序
            const result = Array.from(mergedMap.values())
                .sort((a, b) => b.dayId - a.dayId); // 按日期倒序
            
            console.log('合并完成，最终数据量:', result.length);
            return result;
        }

        // 合并任务项目
        function mergeTaskItems(localItems, serverItems) {
            const merged = {};
            
            // 先添加本地任务
            localItems.forEach(item => {
                merged[item.time] = item;
            });
            
            // 合并服务器任务
            serverItems.forEach(serverItem => {
                const localItem = merged[serverItem.time];
                if (!localItem) {
                    // 本地没有该时间段 -> 直接添加
                    merged[serverItem.time] = serverItem;
                } else {
                    // 本地有该时间段 -> 选择有内容的任务
                    if (!localItem.task || localItem.task.trim() === '') {
                        // 本地任务为空 -> 使用服务器任务
                        merged[serverItem.time] = serverItem;
                    }
                    // 否则保持本地任务（本地优先原则）
                }
            });
            
            // 转换为数组并排序
            return Object.values(merged).sort((a, b) => a.time.localeCompare(b.time));
        }

        // 数据完整性验证
        function validateDataIntegrity() {
            // 检查schedules数组是否存在
            if (!Array.isArray(schedules)) {
                console.error('schedules不是数组');
                return false;
            }
            
            // 检查是否有重复的dayId
            const dayIds = schedules.map(s => s.dayId).filter(id => id);
            const uniqueDayIds = new Set(dayIds);
            if (dayIds.length !== uniqueDayIds.size) {
                console.error('发现重复的dayId');
                return false;
            }
            
            // 检查每个schedule是否有必要字段
            for (const schedule of schedules) {
                if (!schedule.dayId || !schedule.date || !schedule.items) {
                    console.error('发现缺少必要字段的schedule:', schedule);
                    return false;
                }
            }
            
            console.log('数据完整性验证通过');
            return true;
        }

        // 数据恢复函数
        function restoreFromBackup() {
            const backup = localStorage.getItem('calendarSchedulesBackup');
            const backupTime = localStorage.getItem('calendarSchedulesBackupTime');
            
            if (backup) {
                try {
                    const backupData = JSON.parse(backup);
                    const backupDate = backupTime ? new Date(backupTime).toLocaleString() : '未知时间';
                    
                    const confirmRestore = confirm(`发现备份数据（${backupData.length}条记录，备份时间：${backupDate}），确定要恢复吗？这将覆盖当前数据。`);
                    
                    if (confirmRestore) {
                        schedules = backupData;
                        saveToLocalStorage();
                        renderCalendar();
                        renderScheduleForDate();
                        showNotification(`已从备份恢复${backupData.length}条数据`, true);
                        console.log('数据恢复成功，恢复了', backupData.length, '条记录');
                        
                        // 如果用户已登录，立即强制同步所有数据
                        if (currentUser) {
                            forceSyncAll();
                        }
                    }
                } catch (error) {
                    console.error('数据恢复失败:', error);
                    showNotification('数据恢复失败：备份数据损坏', false);
                }
            } else {
                showNotification('没有找到备份数据', false);
            }
        }

        // 创建数据备份
        function createDataBackup() {
            try {
                localStorage.setItem('calendarSchedulesBackup', JSON.stringify(schedules));
                localStorage.setItem('calendarSchedulesBackupTime', new Date().toISOString());
                showNotification(`已创建数据备份（${schedules.length}条记录）`, true);
                console.log('数据备份已创建，备份了', schedules.length, '条记录');
            } catch (error) {
                console.error('创建数据备份失败:', error);
                showNotification('创建备份失败：' + error.message, false);
            }
        }

        // 自动备份机制
        function enableAutoBackup() {
            // 每30分钟自动备份一次
            setInterval(() => {
                if (schedules.length > 0) {
                    createDataBackup();
                    console.log('自动备份已创建');
                }
            }, 30 * 60 * 1000);
            
            // 页面卸载前备份
            window.addEventListener('beforeunload', () => {
                if (schedules.length > 0) {
                    createDataBackup();
                }
            });
        }

        // ==================== 数据迁移功能 ====================
        
        async function migrateFromLocalStorage() {
            if (!currentUser) {
                showNotification('请先登录才能迁移数据', false);
                return;
            }
            
            console.log('开始数据迁移...');
            updateSyncStatus('syncing', '迁移数据中...');
            
            try {
                // 检查是否有本地数据需要迁移
                const localSchedules = localStorage.getItem('calendarSchedules');
                const localWorkdayTemplate = localStorage.getItem('calendarWorkdayTemplate');
                const localNonWorkdayTemplate = localStorage.getItem('calendarNonWorkdayTemplate');
                const localTheme = localStorage.getItem('calendarTheme');
                
                let migratedCount = 0;
                
                // 迁移日程数据
                if (localSchedules) {
                    const parsedSchedules = JSON.parse(localSchedules);
                    console.log('发现本地日程数据:', parsedSchedules.length, '条');
                    
                    if (parsedSchedules.length > 0) {
                        // 检查云端是否已有数据
                        const { data: existingSchedules, error: checkError } = await supabaseClient
                            .from('schedules')
                            .select('day_id')
                            .eq('user_id', currentUser.id);
                        
                        if (checkError) {
                            if (checkError.message.includes('relation') && checkError.message.includes('does not exist')) {
                                showNotification('数据库表未创建，无法迁移数据', false);
                                console.error('请先在Supabase控制台运行SQL脚本创建数据库表');
                                updateSyncStatus('offline', '迁移失败');
                                return;
                            }
                            throw checkError;
                        }
                        
                        const existingDayIds = new Set(existingSchedules?.map(s => s.day_id) || []);
                        
                        // 只迁移云端没有的数据
                        const schedulesToMigrate = parsedSchedules.filter(s => !existingDayIds.has(s.dayId));
                        
                        if (schedulesToMigrate.length > 0) {
                            console.log('需要迁移的日程:', schedulesToMigrate.length, '条');
                            console.log('迁移数据详情:', schedulesToMigrate);
                            
                            const scheduleData = schedulesToMigrate.map(schedule => {
                                // 确保所有必需字段都存在
                                if (!schedule.dayId) {
                                    console.error('日程缺少dayId:', schedule);
                                }
                                return {
                                    user_id: currentUser.id,
                                    day_id: schedule.dayId,
                                    date: schedule.date,
                                    weekday: schedule.weekday,
                                    items: schedule.items || []
                                };
                            });
                            
                            console.log('准备插入的数据:', scheduleData);
                            
                            const { error } = await supabaseClient
                                .from('schedules')
                                .insert(scheduleData);
                            
                            if (error) throw error;
                            migratedCount += schedulesToMigrate.length;
                        }
                    }
                }
                
                // 迁移模板数据
                if (localWorkdayTemplate || localNonWorkdayTemplate) {
                    const templatesData = [];
                    
                    if (localWorkdayTemplate) {
                        const workdayData = JSON.parse(localWorkdayTemplate);
                        if (Object.keys(workdayData).length > 0) {
                            templatesData.push({
                                user_id: currentUser.id,
                                template_type: 'workday',
                                template_data: workdayData
                            });
                        }
                    }
                    
                    if (localNonWorkdayTemplate) {
                        const nonWorkdayData = JSON.parse(localNonWorkdayTemplate);
                        if (Object.keys(nonWorkdayData).length > 0) {
                            templatesData.push({
                                user_id: currentUser.id,
                                template_type: 'nonworkday',
                                template_data: nonWorkdayData
                            });
                        }
                    }
                    
                    if (templatesData.length > 0) {
                        // 逐个插入模板数据
                        for (const templateData of templatesData) {
                            try {
                                let { error: insertError } = await supabaseClient
                                    .from('templates')
                                    .insert([templateData]);
                                
                                if (insertError) {
                                    if (insertError.code === '23505') {
                                        // 记录已存在，执行更新
                                        const { error: updateError } = await supabaseClient
                                            .from('templates')
                                            .update(templateData)
                                            .eq('user_id', currentUser.id)
                                            .eq('template_type', templateData.template_type);
                                        
                                        if (updateError && !updateError.message.includes('does not exist')) {
                                            console.warn('模板更新失败:', updateError);
                                        }
                                    } else if (!insertError.message.includes('does not exist')) {
                                        console.warn('模板插入失败:', insertError);
                                    }
                                }
                            } catch (error) {
                                console.warn('模板迁移失败:', error);
                            }
                        }
                        console.log('模板数据迁移完成');
                    }
                }
                
                // 迁移用户设置
                const settingsData = {
                    user_id: currentUser.id,
                    theme: localTheme || 'light',
                    current_date_data: {
                        year: currentDate.getFullYear(),
                        month: currentDate.getMonth(),
                        day: currentDate.getDate()
                    }
                };
                
                try {
                    let { error: insertError } = await supabaseClient
                        .from('user_settings')
                        .insert([settingsData]);
                    
                    if (insertError) {
                        if (insertError.code === '23505') {
                            // 记录已存在，执行更新
                            const { error: updateError } = await supabaseClient
                                .from('user_settings')
                                .update(settingsData)
                                .eq('user_id', currentUser.id);
                            
                            if (updateError && !updateError.message.includes('does not exist')) {
                                console.warn('用户设置更新失败:', updateError);
                            }
                        } else if (!insertError.message.includes('does not exist')) {
                            console.warn('用户设置插入失败:', insertError);
                        }
                    }
                } catch (error) {
                    console.warn('用户设置迁移失败:', error);
                }
                
                if (migratedCount > 0) {
                    showNotification(`数据迁移完成！迁移了${migratedCount}条日程`, true);
                    // 迁移成功后重新同步数据
                    await syncDataFromServer();
                } else {
                    showNotification('没有需要迁移的数据', true);
                }
                
                updateSyncStatus('', '迁移完成');
                
            } catch (error) {
                console.error('数据迁移失败:', error);
                updateSyncStatus('offline', '迁移失败');
                
                if (error.message.includes('relation') && error.message.includes('does not exist')) {
                    showNotification('数据库表未创建，请先运行SQL脚本', false);
                } else if (error.message.includes('new row violates row-level security policy')) {
                    showNotification('数据库权限配置错误，请检查RLS策略', false);
                } else {
                    showNotification('数据迁移失败：' + error.message, false);
                }
            }
        }
        
        // 数据迁移提醒功能已移除

        // ==================== 数据管理 ====================
        
        function saveToLocalStorage() {
            try {
                // 在保存前先创建备份
                const currentData = localStorage.getItem('calendarSchedules');
                if (currentData && JSON.parse(currentData).length > 0) {
                    localStorage.setItem('calendarSchedulesBackup', currentData);
                    localStorage.setItem('calendarSchedulesBackupTime', new Date().toISOString());
                }
                
                localStorage.setItem('calendarSchedules', JSON.stringify(schedules));
                localStorage.setItem('calendarCurrentDate', JSON.stringify({
                    year: currentDate.getFullYear(),
                    month: currentDate.getMonth(),
                    day: currentDate.getDate()
                }));
                
                console.log('数据已保存到localStorage，包含', schedules.length, '条记录');
            } catch (error) {
                console.error('保存数据失败:', error);
                showNotification('保存失败，可能是存储空间不足', false);
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedSchedules = localStorage.getItem('calendarSchedules');
                const savedDate = localStorage.getItem('calendarCurrentDate');
                
                if (savedSchedules) {
                    schedules = JSON.parse(savedSchedules);
                }
                
                if (savedDate) {
                    const dateData = JSON.parse(savedDate);
                    currentDate = new Date(dateData.year, dateData.month, dateData.day);
                }
                
                // 设置今天为选中日期
                selectedDate = new Date();
                
                // 延迟执行每日任务流转，确保认证状态已稳定
                setTimeout(() => {
                    // 只有在不是登录过程中才执行任务流转
                    if (!document.getElementById('authModal').classList.contains('hidden')) {
                        console.log('检测到登录窗口显示，跳过任务流转');
                        return;
                    }
                    processUnfinishedTasks();
                }, 1000); // 增加延迟时间，确保登录流程完成
            } catch (error) {
                console.error('加载数据失败:', error);
                schedules = [];
                currentDate = new Date();
                selectedDate = new Date();
            }
        }

        // ==================== 任务流转功能 ====================
        
        function processUnfinishedTasks() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const todayId = formatDateToId(today);
            const yesterdayId = formatDateToId(yesterday);
            
            console.log('检查任务流转 - 今天ID:', todayId, '昨天ID:', yesterdayId);
            
            const yesterdaySchedule = schedules.find(s => s.dayId == yesterdayId);
            let todaySchedule = schedules.find(s => s.dayId == todayId);
            
            console.log('昨天的日程:', yesterdaySchedule);
            console.log('今天的日程:', todaySchedule);
            
            // 如果昨天有日程但今天没有，不进行流转
            if (!yesterdaySchedule) {
                console.log('昨天没有日程，无需流转');
                return;
            }
            
            // 如果今天没有日程，先创建今天的日程
            if (!todaySchedule) {
                console.log('今天没有日程，先创建今天的日程模板');
                const todayDate = formatDate(today);
                const todayWeekday = getWeekday(today);
                
                todaySchedule = {
                    dayId: todayId,
                    date: todayDate,
                    weekday: todayWeekday,
                    items: generateTimeSlotsWithTemplate(today),
                    createdAt: new Date().toISOString()
                };
                
                schedules.unshift(todaySchedule);
            }
            
            let transferredCount = 0;
            
            // 检查是否应该进行任务流转
            const shouldTransfer = shouldTransferTasks(yesterday, today);
            
            if (!shouldTransfer) {
                console.log('跨工作日/非工作日边界，跳过任务流转');
                return;
            }
            
            // 遍历昨天的任务，将未完成的任务流转到今天
            yesterdaySchedule.items.forEach(item => {
                if (!item.completed && item.task && item.task.trim() !== '') {
                    // 查找今天相同时间点的任务
                    const todayItem = todaySchedule.items.find(t => t.time === item.time);
                    if (todayItem) {
                        // 只有当今天这个时间点没有任务内容时才流转
                        if (!todayItem.task || todayItem.task.trim() === '') {
                            todayItem.task = item.task;
                            todayItem.completed = false;
                            transferredCount++;
                            console.log(`流转任务: ${item.time} - ${item.task}`);
                        } else {
                            console.log(`${item.time} 时间段今天已有任务，跳过流转: ${todayItem.task}`);
                        }
                    }
                }
            });
            
            if (transferredCount > 0) {
                console.log(`成功流转 ${transferredCount} 个任务`);
                
                // 如果当前选中的是今天，更新选中的日程数据
                const today = new Date();
                const todayId = formatDateToId(today);
                if (selectedDate && formatDateToId(selectedDate) === todayId) {
                    selectedSchedule = todaySchedule;
                    console.log('更新当前选中的今日日程数据');
                }
                
                // 只有在用户已登录的情况下才保存到云端
                if (currentUser) {
                    saveToSupabaseWithRetry();
                } else {
                    // 如果用户未登录，只保存到本地
                    saveToLocalStorage();
                    console.log('用户未登录，任务流转结果仅保存到本地');
                }
                
                showNotification(`已将${transferredCount}个未完成任务转移到今天`, true);
            } else {
                console.log('没有需要流转的任务');
            }
        }

        // 判断是否应该进行任务流转
        function shouldTransferTasks(fromDate, toDate) {
            const fromIsWorkday = isWorkday(fromDate);
            const toIsWorkday = isWorkday(toDate);
            
            const dayNames = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
            console.log(`任务流转检查: ${formatDate(fromDate)}(${dayNames[fromDate.getDay()]},${fromIsWorkday ? '工作日' : '非工作日'}) -> ${formatDate(toDate)}(${dayNames[toDate.getDay()]},${toIsWorkday ? '工作日' : '非工作日'})`);
            
            // 规则1: 工作日到工作日 - 允许流转
            if (fromIsWorkday && toIsWorkday) {
                console.log('✅ 工作日到工作日，允许任务流转');
                return true;
            }
            
            // 规则2: 非工作日到非工作日 - 允许流转
            if (!fromIsWorkday && !toIsWorkday) {
                console.log('✅ 非工作日到非工作日，允许任务流转');
                return true;
            }
            
            // 规则3: 工作日到非工作日 - 不允许流转（周五到周六）
            if (fromIsWorkday && !toIsWorkday) {
                console.log('❌ 工作日到非工作日，禁止任务流转（避免工作任务流转到休息日）');
                return false;
            }
            
            // 规则4: 非工作日到工作日 - 不允许流转（周日到周一）
            if (!fromIsWorkday && toIsWorkday) {
                console.log('❌ 非工作日到工作日，禁止任务流转（避免休闲任务流转到工作日）');
                return false;
            }
            
            return false;
        }

        // ==================== 日历渲染 ====================
        
        function renderCalendar() {
            console.log('开始渲染日历...');
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // 更新月份年份显示
            document.getElementById('monthYear').textContent = `${year}年${month + 1}月`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            const calendarGrid = document.getElementById('calendarGrid');
            
            // 清除现有的日期单元格
            const existingCells = calendarGrid.querySelectorAll('.calendar-cell');
            existingCells.forEach(cell => cell.remove());
            
            const today = new Date();
            const isCurrentMonth = year === today.getFullYear() && month === today.getMonth();
            
            console.log(`渲染日历: ${year}年${month + 1}月, 当前月份: ${isCurrentMonth}`);
            
            // 添加上个月的尾部日期
            const prevMonth = new Date(year, month - 1, 0);
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonth.getDate() - i;
                const cell = createCalendarCell(day, true, new Date(year, month - 1, day));
                calendarGrid.appendChild(cell);
            }
            
            // 添加当前月的日期
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const cell = createCalendarCell(day, false, date);
                
                // 检查是否是今天
                if (isCurrentMonth && day === today.getDate()) {
                    cell.classList.add('today');
                }
                
                // 检查是否被选中
                if (selectedDate && 
                    date.getFullYear() === selectedDate.getFullYear() &&
                    date.getMonth() === selectedDate.getMonth() &&
                    date.getDate() === selectedDate.getDate()) {
                    cell.classList.add('selected');
                }
                
                // 设置完成度颜色
                setCompletionColor(cell, date);
                
                calendarGrid.appendChild(cell);
            }
            
            // 添加下个月的开始日期
            const cellsAdded = startingDayOfWeek + daysInMonth;
            const cellsNeeded = Math.ceil(cellsAdded / 7) * 7;
            for (let day = 1; day <= cellsNeeded - cellsAdded; day++) {
                const cell = createCalendarCell(day, true, new Date(year, month + 1, day));
                calendarGrid.appendChild(cell);
            }
            
            console.log('日历渲染完成');
        }

        function createCalendarCell(day, isOtherMonth, date) {
            const cell = document.createElement('div');
            cell.className = 'calendar-cell';
            cell.textContent = day;
            
            if (isOtherMonth) {
                cell.classList.add('other-month');
            }
            
            cell.addEventListener('click', () => {
                selectDate(date);
            });
            
            return cell;
        }

        function setCompletionColor(cell, date) {
            // 首先清除所有可能的completion类
            cell.classList.remove('completion-0', 'completion-low', 'completion-medium', 'completion-high', 'completion-full');
            
            const dayId = formatDateToId(date);
            const schedule = schedules.find(s => s.dayId == dayId);
            
            // 检查是否是今天
            const today = new Date();
            const isToday = date.getFullYear() === today.getFullYear() &&
                           date.getMonth() === today.getMonth() &&
                           date.getDate() === today.getDate();
            
            console.log(`设置日期 ${formatDate(date)} (dayId: ${dayId}) 的颜色, 是否今天: ${isToday}`);
            
            if (!schedule || schedule.items.length === 0) {
                console.log('没有找到日程或日程为空，设置为completion-0');
                cell.classList.add('completion-0');
                return;
            }
            
            const completedCount = schedule.items.filter(item => item.completed).length;
            const totalTasks = schedule.items.filter(item => item.task && item.task.trim() !== '').length;
            
            console.log(`日程统计: 已完成任务 ${completedCount}, 有内容的任务 ${totalTasks}`);
            console.log('任务详情:', schedule.items.map(item => ({
                time: item.time,
                task: item.task,
                completed: item.completed,
                hasContent: item.task && item.task.trim() !== ''
            })));
            
            if (totalTasks === 0) {
                console.log('没有有内容的任务，设置为completion-0');
                cell.classList.add('completion-0');
            } else {
                const completionRate = (completedCount / totalTasks) * 100;
                console.log(`完成率: ${completionRate.toFixed(1)}%`);
                
                let colorClass = '';
                if (completionRate === 0) {
                    colorClass = 'completion-0';
                } else if (completionRate <= 30) {
                    colorClass = 'completion-low';
                } else if (completionRate <= 70) {
                    colorClass = 'completion-medium';
                } else if (completionRate < 100) {
                    colorClass = 'completion-high';
                } else {
                    colorClass = 'completion-full';
                }
                
                console.log(`应用颜色类: ${colorClass}`);
                cell.classList.add(colorClass);
            }
        }

        function selectDate(date) {
            console.log('选择日期:', formatDate(date));
            selectedDate = new Date(date);
            
            // 如果选择的是今天，先执行任务流转
            const today = new Date();
            const isToday = date.getFullYear() === today.getFullYear() &&
                           date.getMonth() === today.getMonth() &&
                           date.getDate() === today.getDate();
            
            if (isToday) {
                console.log('选择的是今天，执行任务流转');
                processUnfinishedTasks();
            }
            
            // 重新渲染日历以更新选中状态
            renderCalendar();
            
            // 查找并显示选中日期的日程
            const dayId = formatDateToId(date);
            selectedSchedule = schedules.find(s => s.dayId == dayId);
            console.log('选中日期的日程:', selectedSchedule);
            
            renderScheduleForDate();
        }

        // ==================== 日程渲染 ====================
        
        function renderScheduleForDate() {
            if (!selectedDate) {
                showEmptyState();
                return;
            }
            
            const dateStr = formatDate(selectedDate);
            const weekdayStr = getWeekday(selectedDate);
            
            document.getElementById('selectedDate').textContent = dateStr;
            document.getElementById('selectedWeekday').textContent = weekdayStr;
            
            if (!selectedSchedule) {
                showEmptySchedule();
                return;
            }
            
            // 显示删除按钮
            document.getElementById('deleteSchedule').style.display = 'inline-flex';
            
            // 更新进度信息
            const tasksWithContent = selectedSchedule.items.filter(item => item.task.trim() !== '');
            const completedCount = tasksWithContent.filter(item => item.completed).length;
            const totalItems = tasksWithContent.length;
            const progressPercent = totalItems > 0 ? Math.round((completedCount / totalItems) * 100) : 0;
            
            document.getElementById('progressText').textContent = `${completedCount}/${totalItems} (${progressPercent}%)`;
            document.getElementById('progressBar').style.width = `${progressPercent}%`;
            
            // 渲染时间任务列表
            const scheduleList = document.getElementById('scheduleList');
            scheduleList.innerHTML = '';
            
            const today = new Date();
            const isToday = selectedDate.getFullYear() === today.getFullYear() &&
                           selectedDate.getMonth() === today.getMonth() &&
                           selectedDate.getDate() === today.getDate();
            
            selectedSchedule.items.forEach((item, index) => {
                const scheduleItem = document.createElement('div');
                scheduleItem.className = 'schedule-item';
                
                // 只允许今天的任务被勾选
                const checkboxDisabled = !isToday ? 'disabled' : '';
                const checkboxTitle = !isToday ? 'title="只能勾选今天的任务"' : '';
                
                scheduleItem.innerHTML = `
                    <label class="checkbox-container">
                        <input type="checkbox" ${item.completed ? 'checked' : ''} 
                               ${checkboxDisabled}
                               ${checkboxTitle}
                               ${(!item.task || item.task.trim() === '') ? 'disabled' : ''}
                               onchange="toggleCompleted(${index})">
                        <span class="checkmark"></span>
                    </label>
                    <span class="time">${item.time}</span>
                    <input type="text" class="task ${item.completed ? 'completed' : ''}" 
                           value="${item.task}" 
                           placeholder=""
                           data-index="${index}"
                           ${item.completed ? 'readonly' : ''}
                           oninput="updateTask(${index}, this.value)"
                           onkeydown="handleTaskKeyDown(event, ${index})">
                `;
                scheduleList.appendChild(scheduleItem);
            });
        }

        function showEmptyState() {
            document.getElementById('selectedDate').textContent = '请选择日期';
            document.getElementById('selectedWeekday').textContent = '';
            document.getElementById('progressText').textContent = '0/0 (0%)';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('deleteSchedule').style.display = 'none';
            
            const scheduleList = document.getElementById('scheduleList');
            scheduleList.innerHTML = `
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <h3>选择日期查看任务</h3>
                    <p>点击左侧日历中的日期<br>来查看和管理该日的时间安排</p>
                </div>
            `;
        }

        function showEmptySchedule() {
            document.getElementById('progressText').textContent = '0/0 (0%)';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('deleteSchedule').style.display = 'none';
            
            const scheduleList = document.getElementById('scheduleList');
            scheduleList.innerHTML = `
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12,6 12,12 16,14"></polyline>
                    </svg>
                    <h3>该日期暂无安排</h3>
                    <p>点击左侧的按钮为该日期<br>创建时间任务安排</p>
                </div>
            `;
        }

        // ==================== 任务操作 ====================
        
        function toggleCompleted(index) {
            if (selectedSchedule && selectedSchedule.items[index]) {
                const today = new Date();
                const isToday = selectedDate.getFullYear() === today.getFullYear() &&
                               selectedDate.getMonth() === today.getMonth() &&
                               selectedDate.getDate() === today.getDate();
                
                if (!isToday) {
                    showNotification('只能勾选今天的任务', false);
                    return;
                }
                
                // 检查任务内容是否为空
                const task = selectedSchedule.items[index].task;
                if (!task || task.trim() === '') {
                    showNotification('请先输入任务内容再勾选', false);
                    return;
                }
                
                console.log('切换任务完成状态:', index, '当前状态:', selectedSchedule.items[index].completed);
                
                // 显示编辑状态
                updateSyncIndicator('editing');
                
                selectedSchedule.items[index].completed = !selectedSchedule.items[index].completed;
                
                console.log('新状态:', selectedSchedule.items[index].completed);
                console.log('当前日程数据:', selectedSchedule);
                
                // 先更新任务列表显示
                renderScheduleForDate();
                
                // 使用防抖保存，只提交当前修改的日程
                saveToSupabaseDebounced(selectedSchedule.dayId);
                
                // 强制更新日历颜色
                console.log('开始更新日历颜色...');
                setTimeout(() => {
                    renderCalendar();
                    console.log('日历颜色更新完成');
                }, 100);
                
                const action = selectedSchedule.items[index].completed ? '已完成' : '未完成';
                const time = selectedSchedule.items[index].time;
                showNotification(`任务${time}标记为${action}`, selectedSchedule.items[index].completed);
            }
        }

        function updateTask(index, task) {
            if (selectedSchedule && selectedSchedule.items[index]) {
                console.log('更新任务内容:', index, '原内容:', selectedSchedule.items[index].task, '新内容:', task);
                
                // 显示编辑状态
                updateSyncIndicator('editing');
                
                selectedSchedule.items[index].task = task;
                
                // 如果任务内容变为空，自动取消勾选状态
                if (!task || task.trim() === '') {
                    selectedSchedule.items[index].completed = false;
                }
                
                // 使用防抖保存，只提交当前修改的日程
                saveToSupabaseDebounced(selectedSchedule.dayId);
                
                // 只更新对应的复选框状态，而不重新渲染整个列表
                updateCheckboxState(index, task);
                
                // 任务内容变化会影响完成度计算，需要更新日历颜色
                console.log('任务内容更新，开始更新日历颜色...');
                setTimeout(() => {
                    renderCalendar();
                    console.log('任务内容更新后日历颜色更新完成');
                }, 100);
            }
        }

        function updateCheckboxState(index, task) {
            // 找到对应的复选框
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const checkbox = checkboxes[index];
            
            if (checkbox) {
                const isEmpty = !task || task.trim() === '';
                
                // 更新复选框的禁用状态
                checkbox.disabled = isEmpty;
                
                // 如果任务内容为空，取消勾选状态
                if (isEmpty) {
                    checkbox.checked = false;
                }
                
                console.log(`更新复选框 ${index} 状态: 禁用=${isEmpty}, 勾选=${checkbox.checked}`);
            }
        }

        function handleTaskKeyDown(event, currentIndex) {
            if (event.key === 'Tab') {
                event.preventDefault(); // 阻止默认的Tab行为
                
                if (!selectedSchedule || !selectedSchedule.items) return;
                
                // 查找下一个可用的输入框（跳过只读的输入框）
                let nextIndex = currentIndex + 1;
                let attempts = 0;
                
                while (attempts < selectedSchedule.items.length) {
                    if (nextIndex >= selectedSchedule.items.length) {
                        nextIndex = 0; // 循环到第一个
                    }
                    
                    const nextItem = selectedSchedule.items[nextIndex];
                    // 如果不是只读状态，就可以跳转
                    if (!nextItem.completed) {
                        break;
                    }
                    
                    nextIndex++;
                    attempts++;
                }
                
                // 查找下一个输入框元素并聚焦
                const nextInput = document.querySelector(`input.task[data-index="${nextIndex}"]`);
                if (nextInput && !nextInput.readOnly) {
                    nextInput.focus();
                    nextInput.select(); // 选中文本以便快速编辑
                }
            }
        }

        // ==================== 日程创建 ====================
        
        function goToToday() {
            console.log('跳转到今天');
            const today = new Date();
            selectedDate = new Date(today);
            currentDate = new Date(today);
            
            // 主动执行任务流转
            console.log('点击今日日程，执行任务流转');
            processUnfinishedTasks();
            
            // 查找今日的日程安排（和selectDate函数一样的逻辑）
            const dayId = formatDateToId(today);
            selectedSchedule = schedules.find(s => s.dayId == dayId);
            console.log('今日的日程安排:', selectedSchedule);
            
            // 重新渲染日历和任务列表
            renderCalendar();
            renderScheduleForDate();
            
            showNotification('已切换到今日', true);
        }

        function addDaySchedule(dateOffset = 0) {
            const date = new Date();
            date.setDate(date.getDate() + dateOffset);
            
            const dateStr = formatDate(date);
            const weekdayStr = getWeekday(date);
            const dayId = formatDateToId(date);
            
            // 检查是否已存在
            const exists = schedules.some(s => s.dayId == dayId);
            if (exists) {
                showNotification(`${dateStr}的日程已存在!`, false);
                // 选择该日期
                selectDate(date);
                return;
            }
            
            const newSchedule = {
                dayId: dayId,
                date: dateStr,
                weekday: weekdayStr,
                items: generateTimeSlotsWithTemplate(date),
                createdAt: new Date().toISOString()
            };
            
            schedules.unshift(newSchedule);
            
            // 使用防抖保存新创建的日程
            saveToSupabaseDebounced(newSchedule.dayId);
            
            // 选择新创建的日期
            selectDate(date);
            renderCalendar();
            
            showNotification(`已添加${dateStr}日程`, true);
        }

        function addWeekSchedules(isNextWeek = false) {
            const today = new Date();
            const currentDay = today.getDay();
            const mondayOffset = currentDay === 0 ? -6 : 1 - currentDay;
            
            // 如果是下周，再加7天
            const weekOffset = isNextWeek ? 7 : 0;
            const monday = new Date(today.getTime() + (mondayOffset + weekOffset) * 24 * 60 * 60 * 1000);
            
            let addedCount = 0;
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday.getTime() + i * 24 * 60 * 60 * 1000);
                const dayId = formatDateToId(date);
                
                if (!schedules.some(s => s.dayId == dayId)) {
                    const newSchedule = {
                        dayId: dayId,
                        date: formatDate(date),
                        weekday: getWeekday(date),
                        items: generateTimeSlotsWithTemplate(date),
                        createdAt: new Date().toISOString()
                    };
                    
                    schedules.push(newSchedule);
                    addedCount++;
                }
            }
            
            if (addedCount > 0) {
                schedules.sort((a, b) => b.dayId - a.dayId);
                
                // 批量保存所有新创建的日程
                const newScheduleIds = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(monday.getTime() + i * 24 * 60 * 60 * 1000);
                    const dayId = formatDateToId(date);
                    if (schedules.some(s => s.dayId == dayId)) {
                        newScheduleIds.push(dayId);
                    }
                }
                
                // 将新日程加入待同步列表
                newScheduleIds.forEach(id => pendingChanges.add(id));
                saveToSupabaseDebounced();
                
                renderCalendar();
                renderScheduleForDate();
                const weekText = isNextWeek ? '下周' : '本周';
                showNotification(`已添加${weekText}${addedCount}天日程`, true);
            } else {
                const weekText = isNextWeek ? '下周' : '本周';
                showNotification(`${weekText}日程已全部存在`, false);
            }
        }

        function deleteCurrentSchedule() {
            if (!selectedSchedule) return;
            
            if (confirm(`确定要删除${selectedSchedule.date}的日程吗？`)) {
                const index = schedules.findIndex(s => s.dayId === selectedSchedule.dayId);
                if (index !== -1) {
                    const deletedDate = schedules[index].date;
                    const dayId = schedules[index].dayId;
                    
                    // 从本地数组中删除
                    schedules.splice(index, 1);
                    
                    // 从Supabase中删除（异步，不阻塞UI）
                    if (currentUser && isOnline) {
                        deleteScheduleFromSupabase(dayId).catch(error => {
                            console.error('删除云端数据失败:', error);
                            showNotification('本地删除成功，云端删除失败', false);
                        });
                    } else {
                        // 离线时保存到本地
                        saveToLocalStorage();
                    }
                    
                    selectedSchedule = null;
                    renderCalendar();
                    renderScheduleForDate();
                    
                    showNotification(`已删除${deletedDate}日程`, false);
                }
            }
        }

        // ==================== 模板管理 ====================
        
        let workdayTemplate = {}; // 工作日模板
        let nonWorkdayTemplate = {}; // 非工作日模板
        let currentTemplateTab = 'workday'; // 当前编辑的模板类型
        
        function openTemplateModal() {
            console.log('打开模板设置窗口');
            
            // 显示模板窗口
            document.getElementById('templateModal').classList.add('show');
            
            // 初始化模板内容
            renderTemplateTimeSlots();
            
            // 设置默认选中工作日tab
            switchTemplateTab('workday');
        }
        
        function closeTemplateModal() {
            console.log('关闭模板设置窗口');
            document.getElementById('templateModal').classList.remove('show');
        }
        
        function switchTemplateTab(tabType) {
            console.log('切换模板标签页:', tabType);
            
            currentTemplateTab = tabType;
            
            // 更新tab按钮状态
            document.querySelectorAll('.template-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.template-content').forEach(content => content.classList.remove('active'));
            
            if (tabType === 'workday') {
                document.getElementById('workdayTab').classList.add('active');
                document.getElementById('workdayContent').classList.add('active');
            } else {
                document.getElementById('nonWorkdayTab').classList.add('active');
                document.getElementById('nonWorkdayContent').classList.add('active');
            }
            
            // 更新模板内容
            loadTemplateData(tabType);
        }
        
        function renderTemplateTimeSlots() {
            console.log('渲染模板时间段');
            
            const workdayContainer = document.getElementById('workdayTimeList');
            const nonWorkdayContainer = document.getElementById('nonWorkdayTimeList');
            
            // 生成时间段HTML
            const timeSlotHTML = [];
            for (let hour = 7; hour <= 23; hour++) {
                const timeSlot = `${hour}:00`;
                timeSlotHTML.push(`
                    <div class="template-time-item">
                        <div class="template-time-label">${timeSlot}</div>
                        <input type="text" class="template-task-input" 
                               data-time="${timeSlot}" 
                               placeholder="输入默认任务..."
                               onchange="updateTemplateTask('${timeSlot}', this.value)">
                    </div>
                `);
            }
            
            workdayContainer.innerHTML = timeSlotHTML.join('');
            nonWorkdayContainer.innerHTML = timeSlotHTML.join('');
        }
        
        function loadTemplateData(templateType) {
            console.log('加载模板数据:', templateType);
            
            const template = templateType === 'workday' ? workdayTemplate : nonWorkdayTemplate;
            const container = templateType === 'workday' 
                ? document.getElementById('workdayTimeList') 
                : document.getElementById('nonWorkdayTimeList');
            
            // 填入已保存的模板数据
            const inputs = container.querySelectorAll('.template-task-input');
            inputs.forEach(input => {
                const time = input.getAttribute('data-time');
                input.value = template[time] || '';
            });
        }
        
        function updateTemplateTask(time, task) {
            console.log('更新模板任务:', currentTemplateTab, time, task);
            
            if (currentTemplateTab === 'workday') {
                if (task.trim()) {
                    workdayTemplate[time] = task.trim();
                } else {
                    delete workdayTemplate[time];
                }
            } else {
                if (task.trim()) {
                    nonWorkdayTemplate[time] = task.trim();
                } else {
                    delete nonWorkdayTemplate[time];
                }
            }
        }
        
        function saveTemplates() {
            console.log('保存模板');
            
            try {
                // 保存到本地存储
                localStorage.setItem('calendarWorkdayTemplate', JSON.stringify(workdayTemplate));
                localStorage.setItem('calendarNonWorkdayTemplate', JSON.stringify(nonWorkdayTemplate));
                
                // 保存到Supabase（异步）
                if (currentUser && isOnline) {
                    saveTemplatesToSupabase().then(() => {
                        console.log('模板已同步到云端');
                    }).catch(error => {
                        console.error('模板云端保存失败:', error);
                        showNotification('模板已保存到本地，云端同步失败', false);
                    });
                }
                
                console.log('模板已保存到localStorage');
                showNotification('模板已保存', true);
                
                closeTemplateModal();
                updateTemplateListDisplay();
                
            } catch (error) {
                console.error('保存模板失败:', error);
                showNotification('保存模板失败', false);
            }
        }
        
        function loadTemplatesFromStorage() {
            console.log('从存储加载模板');
            
            try {
                const savedWorkdayTemplate = localStorage.getItem('calendarWorkdayTemplate');
                const savedNonWorkdayTemplate = localStorage.getItem('calendarNonWorkdayTemplate');
                
                if (savedWorkdayTemplate) {
                    workdayTemplate = JSON.parse(savedWorkdayTemplate);
                }
                
                if (savedNonWorkdayTemplate) {
                    nonWorkdayTemplate = JSON.parse(savedNonWorkdayTemplate);
                }
                
                updateTemplateListDisplay();
                
            } catch (error) {
                console.error('加载模板失败:', error);
                workdayTemplate = {};
                nonWorkdayTemplate = {};
            }
        }
        
        function updateTemplateListDisplay() {
            console.log('更新模板列表显示');
            
            const templateList = document.getElementById('templateList');
            
            const workdayCount = Object.keys(workdayTemplate).length;
            const nonWorkdayCount = Object.keys(nonWorkdayTemplate).length;
            const totalCount = workdayCount + nonWorkdayCount;
            
            if (totalCount === 0) {
                templateList.innerHTML = `
                    <div class="empty-state" style="padding: 20px; text-align: center; font-size: 0.8rem; color: var(--gray-500);">
                        暂无模板，点击设置按钮添加
                    </div>
                `;
            } else {
                let html = `
                    <div class="template-item">
                        <span>📼 工作日模板: ${workdayCount}个任务</span>
                    </div>
                    <div class="template-item">
                        <span>🎉 非工作日模板: ${nonWorkdayCount}个任务</span>
                    </div>
                `;
                templateList.innerHTML = html;
            }
        }
        
        function isWorkday(date) {
            const dayOfWeek = date.getDay();
            const isWork = dayOfWeek >= 1 && dayOfWeek <= 5;
            
            // 添加详细的调试日志
            const dayNames = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
            console.log(`日期: ${formatDate(date)}, 星期: ${dayNames[dayOfWeek]} (${dayOfWeek}), 是否工作日: ${isWork}`);
            
            return isWork;
        }
        
        function generateTimeSlotsWithTemplate(date) {
            console.log('使用模板生成时间段:', formatDate(date));
            
            const slots = [];
            const isWork = isWorkday(date);
            const template = isWork ? workdayTemplate : nonWorkdayTemplate;
            const templateType = isWork ? '工作日' : '非工作日';
            
            console.log(`使用${templateType}模板:`, template);
            console.log(`工作日模板任务数: ${Object.keys(workdayTemplate).length}`);
            console.log(`非工作日模板任务数: ${Object.keys(nonWorkdayTemplate).length}`);
            
            for (let hour = 7; hour <= 23; hour++) {
                const timeSlot = `${hour}:00`;
                const taskContent = template[timeSlot] || '';
                
                slots.push({
                    time: timeSlot,
                    task: taskContent,
                    completed: false
                });
            }
            
            console.log(`生成了 ${slots.length} 个时间段，其中 ${slots.filter(s => s.task).length} 个有任务内容`);
            
            return slots;
        }

        // ==================== 日历导航 ====================
        
        function navigateMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
            
            // 导航操作不需要频繁同步，仅保存到本地
            saveToLocalStorage();
        }

        // ==================== 工具函数 ====================
        
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}年${month}月${day}日`;
        }

        function formatDateToId(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return year + month + day;
        }

        function getWeekday(date) {
            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            return weekdays[date.getDay()];
        }

        function showNotification(message, isSuccess = true) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = isSuccess ? 'var(--primary-color)' : 'var(--danger-color)';
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function clearCache() {
            if (confirm('确定要清空日程数据吗？（模板数据将被保留）')) {
                // 备份模板数据
                const workdayTemplateBackup = { ...workdayTemplate };
                const nonWorkdayTemplateBackup = { ...nonWorkdayTemplate };
                
                // 清空日程相关的本地存储（保留模板）
                localStorage.removeItem('calendarSchedules');
                localStorage.removeItem('calendarCurrentDate');
                localStorage.removeItem('calendarSchedulesBackup');
                localStorage.removeItem('calendarSchedulesBackupTime');
                
                // 重置日程相关的本地变量（保留模板）
                schedules = [];
                selectedSchedule = null;
                currentDate = new Date();
                selectedDate = new Date();
                
                // 恢复模板数据
                workdayTemplate = workdayTemplateBackup;
                nonWorkdayTemplate = nonWorkdayTemplateBackup;
                
                // 清空同步系统的待提交列表
                if (typeof pendingChanges !== 'undefined') {
                    pendingChanges.clear();
                }
                
                // 如果用户已登录，询问是否清空云端日程数据
                if (currentUser && confirm('是否同时清空云端日程数据？（云端模板数据将被保留）')) {
                    clearSupabaseSchedulesOnly();
                }
                
                renderCalendar();
                renderScheduleForDate();
                updateTemplateListDisplay();
                showNotification('日程数据已清空，模板数据已保留', true);
            }
        }

        // 新增：只清空云端日程数据的函数
        async function clearSupabaseSchedulesOnly() {
            try {
                updateSyncIndicator('syncing');
                
                // 只删除日程数据，保留模板和设置
                const { error } = await supabaseClient
                    .from('schedules')
                    .delete()
                    .eq('user_id', currentUser.id);
                
                if (error) throw error;
                
                updateSyncIndicator('synced');
                console.log('云端日程数据已清空');
                
            } catch (error) {
                console.error('清空云端日程数据失败:', error);
                updateSyncIndicator('error');
                showNotification('清空云端数据失败: ' + error.message, false);
            }
        }
        
        // 完全清空所有数据（包括模板）
        function clearAllData() {
            if (confirm('⚠️ 警告：此操作将清空所有数据（包括日程和模板），确定要继续吗？')) {
                if (confirm('🔥 最后确认：所有数据将被永久删除，包括您精心设置的模板，确定要继续吗？')) {
                    // 清空所有本地存储
                    localStorage.removeItem('calendarSchedules');
                    localStorage.removeItem('calendarCurrentDate');
                    localStorage.removeItem('calendarWorkdayTemplate');
                    localStorage.removeItem('calendarNonWorkdayTemplate');
                    localStorage.removeItem('calendarSchedulesBackup');
                    localStorage.removeItem('calendarSchedulesBackupTime');
                    
                    // 重置所有本地变量
                    schedules = [];
                    workdayTemplate = {};
                    nonWorkdayTemplate = {};
                    selectedSchedule = null;
                    currentDate = new Date();
                    selectedDate = new Date();
                    
                    // 清空同步系统的待提交列表
                    if (typeof pendingChanges !== 'undefined') {
                        pendingChanges.clear();
                    }
                    
                    // 如果用户已登录，也清空云端所有数据
                    if (currentUser && confirm('是否同时清空云端所有数据（包括模板）？')) {
                        clearSupabaseData();
                    }
                    
                    renderCalendar();
                    renderScheduleForDate();
                    updateTemplateListDisplay();
                    showNotification('所有数据已清空', false);
                }
            }
        }
        
        async function clearSupabaseData() {
            if (!currentUser) return;
            
            updateSyncStatus('syncing', '清理中...');
            
            try {
                // 删除所有日程
                const { error: schedulesError } = await supabaseClient
                    .from('schedules')
                    .delete()
                    .eq('user_id', currentUser.id);
                
                if (schedulesError) throw schedulesError;
                
                // 删除所有模板
                const { error: templatesError } = await supabaseClient
                    .from('templates')
                    .delete()
                    .eq('user_id', currentUser.id);
                
                if (templatesError) throw templatesError;
                
                // 删除用户设置
                const { error: settingsError } = await supabaseClient
                    .from('user_settings')
                    .delete()
                    .eq('user_id', currentUser.id);
                
                if (settingsError) throw settingsError;
                
                updateSyncStatus('', '已清理');
                showNotification('云端数据已清空', true);
                
            } catch (error) {
                console.error('清理云端数据失败:', error);
                updateSyncStatus('offline', '清理失败');
                showNotification('云端数据清理失败：' + error.message, false);
            }
        }

        // ==================== 主题切换 ====================
        
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('calendarTheme', newTheme);
            updateThemeIcon(newTheme);
            
            // 同步主题设置到Supabase
            if (currentUser && isOnline) {
                saveUserSettingsToSupabase().catch(error => {
                    console.error('主题设置同步失败:', error);
                });
            }
            
            // 强制设置html背景色
            if (newTheme === 'dark') {
                document.documentElement.style.backgroundColor = '#1a1a1a';
                document.documentElement.style.background = '#1a1a1a';
            } else {
                document.documentElement.style.backgroundColor = '#f0f2f5';
                document.documentElement.style.background = '#f0f2f5';
            }
            
            showNotification(`已切换到${newTheme === 'dark' ? '暗色' : '亮色'}主题`, true);
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('calendarTheme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            // 强制设置html背景色
            if (savedTheme === 'dark') {
                document.documentElement.style.backgroundColor = '#1a1a1a';
                document.documentElement.style.background = '#1a1a1a';
            } else {
                document.documentElement.style.backgroundColor = '#f0f2f5';
                document.documentElement.style.background = '#f0f2f5';
            }
        }

        function updateThemeIcon(theme) {
            const themeToggle = document.getElementById('themeToggle');
            const icon = theme === 'dark' 
                ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                     <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                   </svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                     <circle cx="12" cy="12" r="5"></circle>
                     <line x1="12" y1="1" x2="12" y2="3"></line>
                     <line x1="12" y1="21" x2="12" y2="23"></line>
                     <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                     <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                     <line x1="1" y1="12" x2="3" y2="12"></line>
                     <line x1="21" y1="12" x2="23" y2="12"></line>
                     <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                     <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                   </svg>`;
            themeToggle.innerHTML = icon;
        }

        // ==================== 开发者调试工具 ====================
        
        // 在浏览器控制台中可用的调试函数
        window.debugCalendar = {
            // 查看同步统计
            stats: () => {
                console.table(getSyncStats());
                return getSyncStats();
            },
            
            // 查看待同步列表
            pending: () => {
                console.log('待同步的日程ID:', Array.from(pendingChanges));
                return Array.from(pendingChanges);
            },
            
            // 强制同步
            sync: forceSyncAll,
            
            // 查看本地数据
            data: () => {
                console.log('本地日程数据:', schedules);
                return schedules;
            },
            
            // 测试模板逻辑
            testTemplate: () => {
                console.log('🧪 测试模板逻辑：');
                
                // 测试本周每一天
                const today = new Date();
                const thisWeekDates = [];
                
                // 获取本周的周一
                const monday = new Date(today);
                monday.setDate(today.getDate() - today.getDay() + 1);
                
                // 生成本周7天
                for (let i = 0; i < 7; i++) {
                    const date = new Date(monday);
                    date.setDate(monday.getDate() + i);
                    thisWeekDates.push(date);
                }
                
                console.log('📅 本周各天的模板选择：');
                thisWeekDates.forEach(date => {
                    const dayOfWeek = date.getDay();
                    const dayNames = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
                    const isWork = isWorkday(date);
                    const templateType = isWork ? '工作日模板' : '非工作日模板';
                    
                    console.log(`${formatDate(date)} (${dayNames[dayOfWeek]}) -> ${templateType}`);
                });
                
                console.log('\n📊 模板内容：');
                console.log('工作日模板任务数:', Object.keys(workdayTemplate).length, workdayTemplate);
                console.log('非工作日模板任务数:', Object.keys(nonWorkdayTemplate).length, nonWorkdayTemplate);
                
                return {
                    weekDates: thisWeekDates.map(date => ({
                        date: formatDate(date),
                        dayOfWeek: date.getDay(),
                        isWorkday: isWorkday(date),
                        templateType: isWorkday(date) ? 'workday' : 'nonworkday'
                    })),
                    templates: {
                        workday: workdayTemplate,
                        nonworkday: nonWorkdayTemplate
                    }
                };
            },
            
            // 测试任务流转逻辑
            testTaskTransfer: () => {
                console.log('🔄 测试任务流转逻辑：');
                
                const testCases = [
                    { from: '2025-08-14', to: '2025-08-15', desc: '周四到周五（工作日到工作日）' },
                    { from: '2025-08-15', to: '2025-08-16', desc: '周五到周六（工作日到非工作日）' },
                    { from: '2025-08-16', to: '2025-08-17', desc: '周六到周日（非工作日到非工作日）' },
                    { from: '2025-08-17', to: '2025-08-18', desc: '周日到周一（非工作日到工作日）' },
                    { from: '2025-08-18', to: '2025-08-19', desc: '周一到周二（工作日到工作日）' }
                ];
                
                testCases.forEach(testCase => {
                    const fromDate = new Date(testCase.from);
                    const toDate = new Date(testCase.to);
                    const shouldTransfer = shouldTransferTasks(fromDate, toDate);
                    
                    console.log(`${testCase.desc}: ${shouldTransfer ? '✅ 允许流转' : '❌ 禁止流转'}`);
                });
                
                return testCases.map(testCase => ({
                    ...testCase,
                    shouldTransfer: shouldTransferTasks(new Date(testCase.from), new Date(testCase.to))
                }));
            },
            
            // 测试登录流程
            testLogin: () => {
                console.log('🔐 登录流程诊断：');
                
                // 检查关键元素
                const authForm = document.getElementById('authForm');
                const authEmail = document.getElementById('authEmail');
                const authPassword = document.getElementById('authPassword');
                const authSubmit = document.getElementById('authSubmit');
                const authModal = document.getElementById('authModal');
                
                console.log('📋 关键元素检查：');
                console.log('authForm:', authForm ? '✅ 存在' : '❌ 缺失');
                console.log('authEmail:', authEmail ? '✅ 存在' : '❌ 缺失');
                console.log('authPassword:', authPassword ? '✅ 存在' : '❌ 缺失');
                console.log('authSubmit:', authSubmit ? '✅ 存在' : '❌ 缺失');
                console.log('authModal:', authModal ? '✅ 存在' : '❌ 缺失');
                
                // 检查Supabase客户端
                console.log('🔌 Supabase客户端:', typeof supabaseClient !== 'undefined' ? '✅ 已初始化' : '❌ 未初始化');
                
                // 检查认证状态
                console.log('👤 当前用户:', currentUser ? `✅ 已登录 (${currentUser.email})` : '❌ 未登录');
                
                // 检查模态框状态
                const isModalHidden = authModal ? authModal.classList.contains('hidden') : 'unknown';
                console.log('🪟 登录窗口状态:', isModalHidden ? '隐藏' : '显示');
                
                // 检查表单值
                if (authEmail && authPassword) {
                    console.log('📝 表单内容:');
                    console.log('  邮箱:', authEmail.value || '(空)');
                    console.log('  密码:', authPassword.value ? '***' : '(空)');
                }
                
                return {
                    elementsExist: {
                        authForm: !!authForm,
                        authEmail: !!authEmail,
                        authPassword: !!authPassword,
                        authSubmit: !!authSubmit,
                        authModal: !!authModal
                    },
                    supabaseReady: typeof supabaseClient !== 'undefined',
                    currentUser: currentUser,
                    modalVisible: !isModalHidden
                };
            },
            
            // 查看模板
            templates: () => {
                console.log('工作日模板:', workdayTemplate);
                console.log('非工作日模板:', nonWorkdayTemplate);
                return { workday: workdayTemplate, nonworkday: nonWorkdayTemplate };
            },
            
            // 清除统计
            clearStats: () => {
                syncStats = {
                    totalSyncs: 0,
                    incrementalSyncs: 0,
                    fullSyncs: 0,
                    failedSyncs: 0,
                    savedBytes: 0,
                    lastSyncTime: null
                };
                console.log('统计数据已清除');
            },
            
            // 模拟网络错误
            simulateError: () => {
                const originalClient = supabaseClient;
                supabaseClient = {
                    ...originalClient,
                    from: () => ({
                        upsert: () => Promise.reject(new Error('模拟网络错误'))
                    })
                };
                setTimeout(() => {
                    supabaseClient = originalClient;
                    console.log('网络错误模拟结束');
                }, 5000);
                console.log('开始模拟网络错误，5秒后恢复');
            }
        };
        
        console.log('🚀 数据同步优化完成！');
        console.log('📊 在控制台输入 debugCalendar.stats() 查看同步统计');
        console.log('🔧 可用调试命令:', Object.keys(window.debugCalendar));

        // ==================== 初始化 ====================
        
        document.addEventListener('DOMContentLoaded', async function() {
            // 首先初始化Supabase
            console.log('开始初始化Supabase...');
            await initializeSupabase();
            
            // 初始化主题
            initializeTheme();
            
            // 监听网络状态
            window.addEventListener('online', () => {
                isOnline = true;
                updateSyncStatus('', '已连接');
                if (currentUser && isSupabaseAvailable) {
                    syncDataFromServer();
                }
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateSyncStatus('offline', '离线模式');
            });
            
            // 初始化认证系统
            try {
                await initializeAuth();
            } catch (error) {
                console.error('认证系统初始化失败:', error);
                // Fallback到离线模式
                showNotification('认证系统异常，使用离线模式', false);
                loadFromLocalStorage();
                loadTemplatesFromStorage();
                renderCalendar();
                renderScheduleForDate();
                updateTemplateListDisplay();
            }
            
            // 事件监听器
            setupEventListeners();
            
            // 启用自动备份机制
            enableAutoBackup();
        });
        
        function setupEventListeners() {
            // 日历导航
            document.getElementById('prevMonth').addEventListener('click', () => navigateMonth(-1));
            document.getElementById('nextMonth').addEventListener('click', () => navigateMonth(1));
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // 快速操作按钮
            document.getElementById('addTodaySchedule').addEventListener('click', goToToday);
            document.getElementById('addTomorrowSchedule').addEventListener('click', () => addDaySchedule(1));
            document.getElementById('addWeekSchedule').addEventListener('click', () => addWeekSchedules(false));
            document.getElementById('addNextWeekSchedule').addEventListener('click', () => addWeekSchedules(true));
            document.getElementById('clearCache').addEventListener('click', clearCache);
            document.getElementById('clearAll').addEventListener('click', clearAllData);
            
            // 数据备份恢复按钮
            document.getElementById('restoreBackup').addEventListener('click', restoreFromBackup);
            document.getElementById('createBackup').addEventListener('click', createDataBackup);
            document.getElementById('forceSyncAll').addEventListener('click', forceSyncAll);
            
            // 删除日程按钮
            document.getElementById('deleteSchedule').addEventListener('click', deleteCurrentSchedule);
            
            // 模板管理按钮
            document.getElementById('toggleTemplate').addEventListener('click', function() {
                const templateList = document.getElementById('templateList');
                templateList.classList.toggle('show');
            });
            document.getElementById('openTemplateModal').addEventListener('click', openTemplateModal);
            
            // 模板窗口事件监听器
            document.getElementById('templateModalClose').addEventListener('click', closeTemplateModal);
            document.getElementById('templateModalCancel').addEventListener('click', closeTemplateModal);
            document.getElementById('templateModalSave').addEventListener('click', saveTemplates);
            
            // 模板标签页切换
            document.getElementById('workdayTab').addEventListener('click', () => switchTemplateTab('workday'));
            document.getElementById('nonWorkdayTab').addEventListener('click', () => switchTemplateTab('nonworkday'));
            
            // 点击模板窗口外部关闭窗口
            document.getElementById('templateModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeTemplateModal();
                }
            });
            
            // 认证相关事件监听器
            document.getElementById('authForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                e.stopPropagation(); // 阻止事件冒泡
                console.log('表单提交事件触发');
                
                // 保存输入框的值，防止被清空
                const emailInput = document.getElementById('authEmail');
                const passwordInput = document.getElementById('authPassword');
                const email = emailInput.value.trim();
                const password = passwordInput.value;
                
                // 保存到data属性以备恢复
                emailInput.dataset.lastValue = email;
                passwordInput.dataset.lastValue = password;
                
                console.log('获取到表单数据:', { email: email, password: password ? '***' : '空' });
                
                if (!email || !password) {
                    showAuthError('请填写邮箱和密码');
                    return;
                }
                
                // 在处理认证前保存值，防止被清空
                const savedEmail = email;
                const savedPassword = password;
                
                try {
                    await handleEmailAuth(email, password);
                } catch (error) {
                    // 如果认证失败，恢复输入框的值
                    console.log('认证处理失败，恢复输入框值');
                    emailInput.value = savedEmail;
                    passwordInput.value = savedPassword;
                    throw error;
                }
            });
            
            // 添加输入框值自动保存
            document.getElementById('authEmail').addEventListener('input', function(e) {
                e.target.dataset.lastValue = e.target.value;
            });
            
            document.getElementById('authPassword').addEventListener('input', function(e) {
                e.target.dataset.lastValue = e.target.value;
            });
            
            document.getElementById('googleAuth').addEventListener('click', handleGoogleAuth);
            document.getElementById('authToggleLink').addEventListener('click', function(e) {
                e.preventDefault();
                toggleAuthMode();
            });
            
            document.getElementById('tooltipLogoutBtn').addEventListener('click', logout);
            
            // 快捷键支持
            document.addEventListener('keydown', function(event) {
                if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                if (event.key.toLowerCase() === 't' && !event.ctrlKey && !event.altKey) {
                    event.preventDefault();
                    toggleTheme();
                }
                
                // 方向键导航日历
                if (selectedDate) {
                    let newDate = null;
                    switch(event.key) {
                        case 'ArrowLeft':
                            event.preventDefault();
                            newDate = new Date(selectedDate);
                            newDate.setDate(newDate.getDate() - 1);
                            selectDate(newDate);
                            break;
                        case 'ArrowRight':
                            event.preventDefault();
                            newDate = new Date(selectedDate);
                            newDate.setDate(newDate.getDate() + 1);
                            selectDate(newDate);
                            break;
                        case 'ArrowUp':
                            event.preventDefault();
                            newDate = new Date(selectedDate);
                            newDate.setDate(newDate.getDate() - 7);
                            selectDate(newDate);
                            break;
                        case 'ArrowDown':
                            event.preventDefault();
                            newDate = new Date(selectedDate);
                            newDate.setDate(newDate.getDate() + 7);
                            selectDate(newDate);
                            break;
                    }
                }
            });
        }
    </script>
</body>
</html>