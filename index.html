<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ—¥ç¨‹ç®¡ç† - æ—¥å†è§†å›¾ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        // æ£€æŸ¥Supabaseæ˜¯å¦æˆåŠŸåŠ è½½çš„å‡½æ•°
        function checkSupabaseLoaded() {
            return new Promise((resolve) => {
                if (typeof supabase !== 'undefined' && supabase.createClient) {
                    resolve(true);
                } else {
                    // ç­‰å¾…ä¸€æ®µæ—¶é—´å†æ£€æŸ¥
                    setTimeout(() => {
                        if (typeof supabase !== 'undefined' && supabase.createClient) {
                            resolve(true);
                        } else {
                            console.warn('Supabaseåº“åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨ç¦»çº¿æ¨¡å¼');
                            resolve(false);
                        }
                    }, 3000); // ç­‰å¾…3ç§’
                }
            });
        }
    </script>
    <script src="https://unpkg.com/@supabase/supabase-js@2" 
            onerror="console.error('Supabaseåº“åŠ è½½å¤±è´¥ï¼Œç½‘ç»œè¿æ¥é—®é¢˜')"
            onload="console.log('Supabaseåº“åŠ è½½æˆåŠŸ')"></script>
    
    <!-- å¢å¼ºåŒæ­¥ç³»ç»Ÿ -->
    <script>
        // ==================== å¢å¼ºåŒæ­¥ç³»ç»Ÿ ====================
        
        // åŒæ­¥çŠ¶æ€æšä¸¾
        const SYNC_STATUS = {
            IDLE: 'idle',
            SYNCING: 'syncing',
            SUCCESS: 'success',
            ERROR: 'error',
            TIMEOUT: 'timeout',
            OFFLINE: 'offline'
        };

        // åŒæ­¥é…ç½®
        const SYNC_CONFIG = {
            DEFAULT_TIMEOUT: 15000,
            MAX_RETRIES: 3,
            RETRY_DELAY: 2000,
            DEBOUNCE_DELAY: 1000,  // å‡å°‘åˆ°1ç§’ï¼Œå› ä¸ºç°åœ¨æ˜¯å¤±ç„¦åæ‰è§¦å‘
            FEEDBACK_DURATION: 3000
        };

        // å¢å¼ºåŒæ­¥ç³»ç»Ÿç±»
        class EnhancedSyncSystem {
            constructor() {
                this.syncState = {
                    status: SYNC_STATUS.IDLE,
                    message: '',
                    lastSyncTime: null,
                    failureCount: 0
                };
                
                this.currentSyncPromise = null;
                this.debounceTimer = null;
                this.feedbackTimer = null;
                
                this.initializeUI();
            }
            
            initializeUI() {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.createSyncUI());
                } else {
                    this.createSyncUI();
                }
            }
            
            createSyncUI() {
                // æŸ¥æ‰¾reportviewé¢æ¿ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ç­‰å¾…DOMåŠ è½½å®Œæˆ
                const reportviewPanel = document.querySelector('.reportview-panel');
                if (!reportviewPanel) {
                    console.log('[å¢å¼ºåŒæ­¥] ReportViewé¢æ¿æœªæ‰¾åˆ°ï¼Œç¨åé‡è¯•...');
                    setTimeout(() => this.createSyncUI(), 1000);
                    return;
                }
                
                // è·å–æ—¥å¿—å®¹å™¨
                this.syncLogContainer = document.getElementById('syncLogContainer');
                
                // ç»‘å®šreportviewäº‹ä»¶
                this.bindReportViewEvents();
                
                console.log('[å¢å¼ºåŒæ­¥] æ—¥å¿—UIå·²è¿æ¥');
                
                // æ·»åŠ åˆå§‹æ—¥å¿—
                this.addLogEntry('ç³»ç»Ÿå·²åŠ è½½ï¼Œç­‰å¾…åŒæ­¥æ“ä½œ...', 'info');
            }
            
            bindReportViewEvents() {
            }
            
            // æ·»åŠ æ—¥å¿—æ¡ç›®
            addLogEntry(message, type = 'info') {
                if (!this.syncLogContainer) {
                    console.warn('[å¢å¼ºåŒæ­¥] æ—¥å¿—å®¹å™¨ä¸å­˜åœ¨ï¼Œè·³è¿‡æ—¥å¿—è®°å½•:', message);
                    return;
                }
                
                try {
                    const now = new Date();
                    const timestamp = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
                    
                    const logEntry = document.createElement('div');
                    logEntry.className = `log-entry log-${type}`;
                    logEntry.innerHTML = `
                        <span class="log-timestamp">${timestamp}</span>
                        <span class="log-message">${message}</span>
                    `;
                    
                    // å®‰å…¨åœ°æ·»åŠ åˆ°å®¹å™¨åº•éƒ¨
                    if (this.syncLogContainer && this.syncLogContainer.appendChild) {
                        this.syncLogContainer.appendChild(logEntry);
                        
                        // ç§»é™¤åˆå§‹å ä½æ¡ç›®
                        const placeholderEntry = this.syncLogContainer.querySelector('.log-entry[style*="--:--:--"]');
                        if (placeholderEntry && this.syncLogContainer.children.length > 1) {
                            placeholderEntry.remove();
                        }
                        
                        // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡ï¼Œä¿ç•™æœ€è¿‘50æ¡
                        while (this.syncLogContainer.children.length > 50) {
                            this.syncLogContainer.removeChild(this.syncLogContainer.firstChild);
                        }
                        
                        // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€ä¸‹é¢æ˜¾ç¤ºæœ€æ–°æ—¥å¿—
                        setTimeout(() => {
                            if (this.syncLogContainer && this.syncLogContainer.scrollTop !== undefined) {
                                this.syncLogContainer.scrollTop = this.syncLogContainer.scrollHeight;
                            }
                        }, 50);
                    }
                } catch (error) {
                    console.error('[å¢å¼ºåŒæ­¥] æ·»åŠ æ—¥å¿—æ¡ç›®å¤±è´¥:', error.message, 'æ¶ˆæ¯:', message);
                }
            }
            
            adaptToDarkTheme() {
                // ReportViewå·²ç»é€šè¿‡CSSå¤„ç†æš—è‰²ä¸»é¢˜ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–çš„JavaScriptå¤„ç†
                console.log('[å¢å¼ºåŒæ­¥] æš—è‰²ä¸»é¢˜é€‚é…å·²é€šè¿‡CSSå¤„ç†');
            }
            
            async withTimeout(operation, timeout = SYNC_CONFIG.DEFAULT_TIMEOUT) {
                return new Promise(async (resolve, reject) => {
                    const timeoutId = setTimeout(() => {
                        reject(new Error(`æ“ä½œè¶…æ—¶ (${timeout / 1000}ç§’)`));
                    }, timeout);
                    
                    try {
                        const result = await operation();
                        clearTimeout(timeoutId);
                        resolve(result);
                    } catch (error) {
                        clearTimeout(timeoutId);
                        reject(error);
                    }
                });
            }
            
            updateSyncState(status, message = '', progress = 0) {
                console.log(`[å¢å¼ºåŒæ­¥] ${status}: ${message} (${progress}%)`);
                
                this.syncState = { ...this.syncState, status, message, progress };
                
                if (status === SYNC_STATUS.SUCCESS) {
                    this.syncState.lastSyncTime = new Date().toLocaleString();
                    this.syncState.failureCount = 0;
                } else if (status === SYNC_STATUS.ERROR || status === SYNC_STATUS.TIMEOUT) {
                    this.syncState.failureCount++;
                }
                
                this.updateUI();
            }
            
            updateUI() {
                // æ·»åŠ æ—¥å¿—æ¡ç›®
                this.logCurrentState();
                
                // ä¿æŒæ—§çš„æµ®åŠ¨é¢æ¿å…¼å®¹æ€§ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                this.updateLegacyFloatingPanel();
                
                // æ›´æ–°åŸæœ‰çš„åŒæ­¥æŒ‡ç¤ºå™¨
                this.updateLegacySyncIndicator();
            }
            
            logCurrentState() {
                if (!this.syncLogContainer) {
                    console.warn('[å¢å¼ºåŒæ­¥] æ—¥å¿—å®¹å™¨ä¸å­˜åœ¨ï¼Œè·³è¿‡çŠ¶æ€æ—¥å¿—è®°å½•');
                    return;
                }
                
                try {
                    const { status, message } = this.syncState;
                    
                    // æ ¹æ®çŠ¶æ€é€‰æ‹©æ—¥å¿—ç±»å‹å’Œæ¶ˆæ¯
                    let logType = 'info';
                    let logMessage = message || this.getDefaultMessage(status);
                    
                    switch (status) {
                        case SYNC_STATUS.SYNCING:
                            logType = 'syncing';
                            logMessage = message || 'å¼€å§‹åŒæ­¥æ“ä½œ...';
                            break;
                        case SYNC_STATUS.SUCCESS:
                            logType = 'success';
                            logMessage = message || 'åŒæ­¥æˆåŠŸå®Œæˆ';
                            break;
                        case SYNC_STATUS.ERROR:
                            logType = 'error';
                            logMessage = message || 'åŒæ­¥å¤±è´¥';
                            break;
                        case SYNC_STATUS.TIMEOUT:
                            logType = 'warning';
                            logMessage = message || 'åŒæ­¥è¶…æ—¶';
                            break;
                        case SYNC_STATUS.OFFLINE:
                            logType = 'warning';
                            logMessage = message || 'å½“å‰ç¦»çº¿æ¨¡å¼';
                            break;
                        default:
                            // IDLEçŠ¶æ€ä¸è®°å½•æ—¥å¿—ï¼Œé¿å…åˆ·å±
                            return;
                    }
                    
                    // é¿å…é‡å¤è®°å½•ç›¸åŒæ¶ˆæ¯
                    if (this.syncLogContainer.firstElementChild) {
                        const lastEntry = this.syncLogContainer.firstElementChild;
                        if (lastEntry) {
                            const lastMessage = lastEntry.querySelector('.log-message')?.textContent;
                            if (lastMessage === logMessage) {
                                return;
                            }
                        }
                    }
                    
                    this.addLogEntry(logMessage, logType);
                } catch (error) {
                    console.error('[å¢å¼ºåŒæ­¥] è®°å½•çŠ¶æ€æ—¥å¿—å¤±è´¥:', error.message);
                }
            }
            
            updateLegacyFloatingPanel() {
                // å¦‚æœæ—§çš„æµ®åŠ¨é¢æ¿è¿˜å­˜åœ¨ï¼Œæ›´æ–°å®ƒï¼ˆå‘åå…¼å®¹ï¼‰
                const oldPanel = document.getElementById('enhanced-sync-panel');
                if (!oldPanel) return;
                
                const { status, message, progress } = this.syncState;
                
                const syncIcon = document.getElementById('sync-icon');
                const syncText = document.getElementById('sync-text');
                const lastSync = document.getElementById('last-sync');
                const retryInfo = document.getElementById('retry-info');
                const progressBar = document.getElementById('progress-bar');
                const progressFill = document.getElementById('progress-fill');
                
                if (syncIcon && syncText) {
                    const iconMap = {
                        [SYNC_STATUS.IDLE]: { icon: 'â—', color: '#9e9e9e' },
                        [SYNC_STATUS.SYNCING]: { icon: 'â†»', color: '#2196f3' },
                        [SYNC_STATUS.SUCCESS]: { icon: 'âœ“', color: '#4caf50' },
                        [SYNC_STATUS.ERROR]: { icon: 'âœ—', color: '#f44336' },
                        [SYNC_STATUS.TIMEOUT]: { icon: 'â±', color: '#ff9800' },
                        [SYNC_STATUS.OFFLINE]: { icon: 'âš¡', color: '#607d8b' }
                    };
                    
                    const iconConfig = iconMap[status] || iconMap[SYNC_STATUS.IDLE];
                    syncIcon.textContent = iconConfig.icon;
                    syncIcon.style.color = iconConfig.color;
                    
                    if (status === SYNC_STATUS.SYNCING) {
                        syncIcon.style.animation = 'spin 1s linear infinite';
                    } else {
                        syncIcon.style.animation = '';
                    }
                    
                    syncText.textContent = message || this.getDefaultMessage(status);
                }
                
                if (progressBar && progressFill) {
                    if (status === SYNC_STATUS.SYNCING && progress > 0) {
                        progressBar.style.display = 'block';
                        progressFill.style.width = `${progress}%`;
                    } else {
                        progressBar.style.display = 'none';
                    }
                }
                
                if (lastSync && this.syncState.lastSyncTime) {
                    lastSync.textContent = `æœ€ååŒæ­¥: ${this.syncState.lastSyncTime}`;
                }
                
                if (retryInfo) {
                    if (this.syncState.failureCount > 0 && status !== SYNC_STATUS.SUCCESS) {
                        retryInfo.style.display = 'block';
                        retryInfo.textContent = `å¤±è´¥æ¬¡æ•°: ${this.syncState.failureCount}`;
                    } else {
                        retryInfo.style.display = 'none';
                    }
                }
            }
            
            updateLegacySyncIndicator() {
                // æ—§çš„åŒæ­¥æŒ‡ç¤ºå™¨å·²è¢«ç§»é™¤ï¼Œè¿™ä¸ªå‡½æ•°ä¸å†éœ€è¦æ‰§è¡Œä»»ä½•æ“ä½œ
                // æ‰€æœ‰çŠ¶æ€ç°åœ¨éƒ½é€šè¿‡reportviewæ—¥å¿—æ˜¾ç¤º
            }
            
            getDefaultMessage(status) {
                const messages = {
                    [SYNC_STATUS.IDLE]: 'å°±ç»ª',
                    [SYNC_STATUS.SYNCING]: 'åŒæ­¥ä¸­...',
                    [SYNC_STATUS.SUCCESS]: 'å·²åŒæ­¥',
                    [SYNC_STATUS.ERROR]: 'åŒæ­¥å¤±è´¥',
                    [SYNC_STATUS.TIMEOUT]: 'åŒæ­¥è¶…æ—¶',
                    [SYNC_STATUS.OFFLINE]: 'ç¦»çº¿æ¨¡å¼'
                };
                return messages[status] || 'æœªçŸ¥çŠ¶æ€';
            }
            
            showSyncDetails() {
                // å±•å¼€reportviewé¢æ¿ï¼ˆå¦‚æœå·²æŠ˜å ï¼‰
                const reportviewContent = document.getElementById('reportviewContent');
                const reportviewToggle = document.getElementById('reportviewToggle');
                
                if (reportviewContent && reportviewContent.classList.contains('collapsed')) {
                    reportviewContent.classList.remove('collapsed');
                    if (reportviewToggle) {
                        reportviewToggle.classList.remove('collapsed');
                    }
                }
                
                // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯é€šçŸ¥
                const details = [
                    `çŠ¶æ€: ${this.syncState.status}`,
                    `æ¶ˆæ¯: ${this.syncState.message}`,
                    `æœ€ååŒæ­¥: ${this.syncState.lastSyncTime || 'ä»æœª'}`,
                    `å¤±è´¥æ¬¡æ•°: ${this.syncState.failureCount}`,
                    `è¿›åº¦: ${this.syncState.progress || 0}%`
                ].join('\\n');
                
                this.showNotification('åŒæ­¥çŠ¶æ€è¯¦æƒ…', details, 'info');
            }
            
            showNotification(title, message, type = 'info', duration = 4000) {
                // å°†é€šçŸ¥å†…å®¹åˆå¹¶ä¸ºä¸€æ¡æ—¥å¿—æ¶ˆæ¯å¹¶å‘é€åˆ°reportview
                const logMessage = title ? `${title}: ${message}` : message;
                this.addLogEntry(logMessage, type);
            }
            
            async saveWithRetry(saveOperation, options = {}) {
                const {
                    maxRetries = SYNC_CONFIG.MAX_RETRIES,
                    timeout = SYNC_CONFIG.DEFAULT_TIMEOUT,
                    retryDelay = SYNC_CONFIG.RETRY_DELAY,
                    description = 'ä¿å­˜æ•°æ®'
                } = options;
                
                // æ¸…ç†ä¹‹å‰çš„å¤±è´¥çŠ¶æ€ï¼Œç»™æ–°çš„åŒæ­¥ä¸€ä¸ªå¹²å‡€çš„å¼€å§‹
                if (this.syncState.status === SYNC_STATUS.ERROR || this.syncState.status === SYNC_STATUS.TIMEOUT) {
                    console.log('[å¢å¼ºåŒæ­¥] æ£€æµ‹åˆ°ä¹‹å‰çš„å¤±è´¥çŠ¶æ€ï¼Œé‡ç½®ä¸ºç©ºé—²çŠ¶æ€');
                    this.syncState.status = SYNC_STATUS.IDLE;
                    this.syncState.message = '';
                }
                
                if (this.currentSyncPromise) {
                    console.log('[å¢å¼ºåŒæ­¥] ç­‰å¾…å½“å‰åŒæ­¥æ“ä½œå®Œæˆ...');
                    try {
                        await this.currentSyncPromise;
                    } catch (error) {
                        console.log('[å¢å¼ºåŒæ­¥] ç­‰å¾…çš„åŒæ­¥æ“ä½œå¤±è´¥ï¼Œç»§ç»­æ–°çš„åŒæ­¥');
                    }
                }
                
                this.currentSyncPromise = this.performSyncWithRetry(saveOperation, {
                    maxRetries, timeout, retryDelay, description
                });
                
                try {
                    return await this.currentSyncPromise;
                } finally {
                    this.currentSyncPromise = null;
                }
            }
            
            async performSyncWithRetry(saveOperation, { maxRetries, timeout, retryDelay, description }) {
                let lastError = null;
                
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        this.updateSyncState(
                            SYNC_STATUS.SYNCING,
                            `${description}ä¸­... (${attempt}/${maxRetries})`,
                            Math.round((attempt - 1) / maxRetries * 50)
                        );
                        
                        console.log(`[å¢å¼ºåŒæ­¥] ç¬¬ ${attempt} æ¬¡å°è¯•: ${description}`);
                        
                        const result = await this.withTimeout(saveOperation, timeout);
                        
                        this.updateSyncState(SYNC_STATUS.SUCCESS, `${description}æˆåŠŸ`, 100);
                        
                        this.showNotification('åŒæ­¥æˆåŠŸ', `${description}å·²å®Œæˆ`, 'success');
                        
                        return result;
                        
                    } catch (error) {
                        lastError = error;
                        const isTimeout = error.message.includes('è¶…æ—¶');
                        
                        console.error(`[å¢å¼ºåŒæ­¥] ç¬¬ ${attempt} æ¬¡å°è¯•å¤±è´¥:`, error.message);
                        
                        if (attempt < maxRetries) {
                            const statusMessage = isTimeout ? 
                                `${description}è¶…æ—¶ï¼Œ${retryDelay/1000}ç§’åé‡è¯•...` :
                                `${description}å¤±è´¥ï¼Œ${retryDelay/1000}ç§’åé‡è¯•...`;
                            
                            this.updateSyncState(
                                isTimeout ? SYNC_STATUS.TIMEOUT : SYNC_STATUS.ERROR,
                                statusMessage,
                                Math.round(attempt / maxRetries * 100)
                            );
                            
                            await new Promise(resolve => setTimeout(resolve, retryDelay));
                        } else {
                            const finalStatus = isTimeout ? SYNC_STATUS.TIMEOUT : SYNC_STATUS.ERROR;
                            const finalMessage = isTimeout ? 
                                `${description}è¶…æ—¶` : 
                                `${description}å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥`;
                            
                            this.updateSyncState(finalStatus, finalMessage, 0);
                            
                            const errorSuggestion = this.getErrorSuggestion(error, isTimeout);
                            this.showNotification(
                                isTimeout ? 'åŒæ­¥è¶…æ—¶' : 'åŒæ­¥å¤±è´¥',
                                errorSuggestion,
                                'error',
                                6000
                            );
                            
                            throw new Error(`${description}å¤±è´¥ (å°è¯•äº† ${maxRetries} æ¬¡): ${error.message}`);
                        }
                    }
                }
            }
            
            getErrorSuggestion(error, isTimeout) {
                if (isTimeout) {
                    return `æ“ä½œè¶…æ—¶ï¼Œå»ºè®®:\\nâ€¢ æ£€æŸ¥ç½‘ç»œè¿æ¥\\nâ€¢ ç¨åé‡è¯•\\nâ€¢ è”ç³»ç®¡ç†å‘˜`;
                }
                
                if (error.message.includes('ç½‘ç»œ') || error.message.includes('fetch')) {
                    return `ç½‘ç»œè¿æ¥é—®é¢˜ï¼Œå»ºè®®:\\nâ€¢ æ£€æŸ¥ç½‘ç»œè¿æ¥\\nâ€¢ ç¡®è®¤æ˜¯å¦èƒ½è®¿é—®äº’è”ç½‘\\nâ€¢ å°è¯•åˆ·æ–°é¡µé¢`;
                }
                
                if (error.message.includes('403') || error.message.includes('unauthorized')) {
                    return `è®¤è¯å¤±è´¥ï¼Œå»ºè®®:\\nâ€¢ é‡æ–°ç™»å½•\\nâ€¢ æ£€æŸ¥è´¦æˆ·æƒé™`;
                }
                
                return `åŒæ­¥å‡ºç°é—®é¢˜: ${error.message}\\nå»ºè®®åˆ·æ–°é¡µé¢æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ`;
            }
            
            debouncedSave(saveOperation, description = 'ä¿å­˜æ›´æ”¹') {
                if (this.debounceTimer) {
                    clearTimeout(this.debounceTimer);
                }
                
                if (typeof saveToLocalStorage === 'function') {
                    saveToLocalStorage();
                }
                
                this.updateSyncState(SYNC_STATUS.IDLE, 'ç¼–è¾‘ä¸­...');
                
                this.debounceTimer = setTimeout(() => {
                    this.saveWithRetry(saveOperation, { description }).catch(error => {
                        console.error('[é˜²æŠ–ä¿å­˜] å¤±è´¥:', error);
                    });
                }, SYNC_CONFIG.DEBOUNCE_DELAY);
            }
        }

        // åˆ›å»ºå…¨å±€å®ä¾‹
        const enhancedSyncSystem = new EnhancedSyncSystem();

        // æ·»åŠ CSSæ ·å¼
        const syncStyles = document.createElement('style');
        syncStyles.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(syncStyles);

        // å¯¼å‡ºå¢å¼ºåŒæ­¥æ¥å£
        window.enhancedSync = {
            updateStatus: (status, message) => enhancedSyncSystem.updateSyncState(status, message),
            showNotification: (title, message, type) => enhancedSyncSystem.showNotification(title, message, type),
            saveWithRetry: (operation, options) => enhancedSyncSystem.saveWithRetry(operation, options),
            debouncedSave: (operation, description) => enhancedSyncSystem.debouncedSave(operation, description)
        };

        console.log('âœ… å¢å¼ºåŒæ­¥ç³»ç»Ÿå·²åŠ è½½');
        
        // æ·»åŠ è°ƒè¯•å·¥å…·
        window.syncDebug = {
            // æµ‹è¯•åŒæ­¥åŠŸèƒ½
            async testSync() {
                console.log('ğŸ§ª æµ‹è¯•åŒæ­¥åŠŸèƒ½...');
                try {
                    await window.enhancedSync.saveWithRetry(async () => {
                        console.log('æµ‹è¯•ä¿å­˜æ“ä½œ...');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        return { success: true, test: true };
                    }, { description: 'æµ‹è¯•åŒæ­¥' });
                    console.log('âœ… åŒæ­¥åŠŸèƒ½æµ‹è¯•é€šè¿‡');
                    window.enhancedSync.showNotification('æµ‹è¯•å®Œæˆ', 'åŒæ­¥åŠŸèƒ½æ­£å¸¸å·¥ä½œ', 'success');
                } catch (error) {
                    console.error('âŒ åŒæ­¥åŠŸèƒ½æµ‹è¯•å¤±è´¥:', error);
                    window.enhancedSync.showNotification('æµ‹è¯•å¤±è´¥', error.message, 'error');
                }
            },
            
            // æŸ¥çœ‹åŒæ­¥ç»Ÿè®¡
            showStats() {
                const stats = {
                    status: enhancedSyncSystem.syncState.status,
                    message: enhancedSyncSystem.syncState.message,
                    lastSyncTime: enhancedSyncSystem.syncState.lastSyncTime,
                    failureCount: enhancedSyncSystem.syncState.failureCount,
                    isActive: enhancedSyncSystem.currentSyncPromise !== null
                };
                console.table(stats);
                window.enhancedSync.showNotification(
                    'åŒæ­¥ç»Ÿè®¡ä¿¡æ¯',
                    `çŠ¶æ€: ${stats.status}\\næ¶ˆæ¯: ${stats.message}\\næœ€ååŒæ­¥: ${stats.lastSyncTime || 'ä»æœª'}\\nå¤±è´¥æ¬¡æ•°: ${stats.failureCount}`,
                    'info'
                );
                return stats;
            },
            
            // é‡ç½®åŒæ­¥çŠ¶æ€
            resetSyncState() {
                enhancedSyncSystem.syncState = {
                    status: 'idle',
                    message: 'å·²é‡ç½®',
                    lastSyncTime: null,
                    failureCount: 0
                };
                enhancedSyncSystem.updateUI();
                console.log('ğŸ”„ åŒæ­¥çŠ¶æ€å·²é‡ç½®');
            },
            
            // æ¨¡æ‹Ÿç½‘ç»œé”™è¯¯
            simulateNetworkError() {
                const originalFetch = window.fetch;
                let errorCount = 0;
                
                window.fetch = function(...args) {
                    errorCount++;
                    if (errorCount <= 2) {
                        return Promise.reject(new Error('æ¨¡æ‹Ÿç½‘ç»œé”™è¯¯'));
                    } else {
                        window.fetch = originalFetch;
                        return originalFetch.apply(this, args);
                    }
                };
                
                console.log('ğŸ”¥ å·²æ¿€æ´»ç½‘ç»œé”™è¯¯æ¨¡æ‹Ÿ (å‰2æ¬¡è¯·æ±‚å°†å¤±è´¥)');
                window.enhancedSync.showNotification('è°ƒè¯•æ¨¡å¼', 'ç½‘ç»œé”™è¯¯æ¨¡æ‹Ÿå·²æ¿€æ´»', 'info');
            },
            
            // æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
            help() {
                const helpText = `
å¢å¼ºåŒæ­¥ç³»ç»Ÿè°ƒè¯•å·¥å…·:
â€¢ syncDebug.testSync() - æµ‹è¯•åŒæ­¥åŠŸèƒ½
â€¢ syncDebug.showStats() - æŸ¥çœ‹åŒæ­¥ç»Ÿè®¡
â€¢ syncDebug.resetSyncState() - é‡ç½®åŒæ­¥çŠ¶æ€
â€¢ syncDebug.simulateNetworkError() - æ¨¡æ‹Ÿç½‘ç»œé”™è¯¯

å¿«æ·é”®:
â€¢ Ctrl/Cmd + S - å¼ºåˆ¶ä¿å­˜
â€¢ Ctrl/Cmd + Shift + R - é‡æ–°åŒæ­¥

ç‚¹å‡»å³ä¸‹è§’çš„åŒæ­¥é¢æ¿å¯æŸ¥çœ‹è¯¦ç»†çŠ¶æ€ä¿¡æ¯ã€‚
                `;
                console.log(helpText);
                window.enhancedSync.showNotification('è°ƒè¯•å·¥å…·å¸®åŠ©', helpText.trim(), 'info');
            }
        };
        
        // æ˜¾ç¤ºç³»ç»ŸåŠ è½½å®Œæˆçš„é€šçŸ¥
        setTimeout(() => {
            if (window.enhancedSync) {
                window.enhancedSync.showNotification(
                    'åŒæ­¥ç³»ç»Ÿå·²å‡çº§', 
                    'ç°åœ¨æ”¯æŒè¶…æ—¶æ£€æµ‹ã€æ™ºèƒ½é‡è¯•å’Œè¯¦ç»†çŠ¶æ€åé¦ˆ\\n\\nâ€¢ Ctrl+S: å¼ºåˆ¶ä¿å­˜\\nâ€¢ ç‚¹å‡»å³ä¸‹è§’é¢æ¿æŸ¥çœ‹è¯¦æƒ…\\nâ€¢ æ§åˆ¶å°è¾“å…¥ syncDebug.help() æŸ¥çœ‹æ›´å¤šåŠŸèƒ½',
                    'success',
                    5000
                );
            }
        }, 2000);
    </script>
    <style>
        :root {
            /* ä¸»è‰²è°ƒå‡çº§ */
            --primary-50: #f0f4ff;
            --primary-100: #e0edff;
            --primary-400: #6366f1;
            --primary-500: #4361ee;
            --primary-600: #3f37c9;
            --primary-700: #2d1b69;
            
            /* è¯­ä¹‰åŒ–è‰²å½© */
            --success-light: #e8f5e9;
            --success-main: #4caf50;
            --success-dark: #2e7d32;
            --warning-light: #fff3cd;
            --warning-main: #ff9800;
            --danger-main: #f44336;
            
            /* ä¸­æ€§è‰²è°ƒä¼˜åŒ– */
            --gray-50: #fafafa;
            --gray-100: #f5f5f5;
            --gray-200: #eeeeee;
            --gray-300: #e0e0e0;
            --gray-400: #bdbdbd;
            --gray-500: #9e9e9e;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-900: #212529;
            
            /* å…¼å®¹æ—§å˜é‡ */
            --primary-color: var(--primary-500);
            --secondary-color: var(--primary-600);
            --accent-color: #4cc9f0;
            --success-color: var(--success-main);
            --completed-bg: var(--success-light);
            --recurring-bg: var(--primary-50);
            --master-bg: #fff9e6;
            --danger-color: var(--danger-main);
            --light-color: var(--gray-50);
            --dark-color: var(--gray-900);
            --gray-color: var(--gray-600);
            --border-radius: 8px;
            --box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'ç­‰çº¿', sans-serif;
            line-height: 1.4;
            background-color: #f0f2f5;
            color: var(--dark-color);
            padding: 12px;
            margin: 0;
            min-height: 100vh;
            width: 100%;
        }

        html {
            margin: 0;
            padding: 0;
            width: 100%;
            min-height: 100vh;
            background-color: #f0f2f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ==================== åº”ç”¨å¸ƒå±€æ ·å¼ ==================== */
        .app-layout {
            display: flex;
            gap: 20px;
            min-height: calc(100vh - 40px);
        }

        /* å·¦ä¾§å¯¼èˆªæ  */
        .nav-sidebar {
            position: fixed;
            left: 20px;
            top: 20px;
            width: 60px;
            z-index: 100;
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 12px;
            margin-bottom: 8px;
            font-size: 10px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }

        .nav-btn svg {
            width: 20px;
            height: 20px;
            margin-bottom: 4px;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .nav-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 20px rgba(67, 97, 238, 0.4);
        }

        .nav-btn.active:hover {
            background: #5b7cfa;
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(67, 97, 238, 0.5);
        }

        /* å†…å®¹åŒºåŸŸ */
        .content-area {
            flex: 1;
            min-width: 0;
            margin-left: 100px; /* ä¸ºå›ºå®šå¯¼èˆªæ ç•™å‡ºç©ºé—´ */
        }

        /* Tabå†…å®¹å®¹å™¨ */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ==================== ç›®æ ‡ç®¡ç†æ ·å¼ ==================== */
        /* é¡¶éƒ¨é¡µé¢æ ‡é¢˜å’Œæ“ä½œåŒº */
        .goal-page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: linear-gradient(145deg, #ffffff 0%, #fafbff 100%);
            border-radius: var(--border-radius);
            margin-bottom: 16px;
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(67, 97, 238, 0.08);
        }

        .goal-page-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .goal-page-actions {
            display: flex;
            gap: 12px;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .goal-main-content {
            height: calc(100vh - 200px);
        }

        /* å·¦ä¾§ç›®æ ‡åˆ—è¡¨åŒºåŸŸ */
        .goal-section {
            background: linear-gradient(145deg, #ffffff 0%, #fafbff 100%);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(67, 97, 238, 0.08);
            overflow-y: auto;
        }

        .goal-list {
            padding: 20px;
        }

        /* ç›®æ ‡é¡¹ */
        .goal-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .goal-item-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            gap: 8px;
        }

        .goal-expand-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 20px;
            text-align: left;
        }

        .goal-name {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            flex: 1;
        }

        .goal-meta {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .goal-date {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .goal-action-btn {
            padding: 4px 8px;
            font-size: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            background: #f9fafb;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .goal-action-btn:hover {
            background: #e5e7eb;
            color: var(--text-primary);
        }

        .goal-action-btn.goal-import {
            background: #f0f9ff;
            color: #0369a1;
            border-color: #0ea5e9;
        }

        .goal-action-btn.goal-import:hover {
            background: #e0f2fe;
            border-color: #0369a1;
        }

        .goal-action-btn.goal-tag {
            background: #dbeafe;
            color: #1d4ed8;
            border-color: #3b82f6;
        }

        .goal-action-btn.goal-status {
            background: #dcfce7;
            color: #166534;
            border-color: #22c55e;
        }

        .goal-action-btn.goal-delete {
            color: #dc2626;
        }

        .goal-action-btn.goal-delete:hover {
            background: #fecaca;
            border-color: #dc2626;
        }

        /* è¿›åº¦æ¡ */
        .goal-progress {
            padding: 0 16px 8px 44px;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: #f3f4f6;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* å­ä»»åŠ¡åŒºåŸŸ */
        .goal-subtasks {
            padding: 0 16px 16px 44px;
        }

        .subtask-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            gap: 12px;
            border-bottom: 1px solid #f3f4f6;
        }

        .subtask-item:last-child {
            border-bottom: none;
        }

        .subtask-item.completed .subtask-text {
            text-decoration: line-through;
            color: var(--text-secondary);
        }

        .subtask-checkbox {
            width: 16px;
            height: 16px;
        }

        .subtask-text {
            flex: 1;
            font-size: 14px;
            color: var(--text-primary);
        }

        .subtask-delete {
            padding: 4px 8px;
            font-size: 12px;
            background: none;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            color: #dc2626;
            cursor: pointer;
        }

        .subtask-delete:hover {
            background: #fecaca;
            border-color: #dc2626;
        }

        .subtask-hint {
            font-size: 12px;
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 8px;
            padding: 8px;
            background: #f9fafb;
            border-radius: 4px;
        }

        /* ç©ºç›®æ ‡åˆ—è¡¨æç¤º */
        .empty-goals {
            text-align: center;
            color: var(--text-secondary);
            font-size: 16px;
            padding: 60px 20px;
            background: white;
            border-radius: 8px;
            border: 2px dashed #e5e7eb;
            margin: 20px 0;
        }

        /* ä¸»è¦å¸ƒå±€å®¹å™¨ */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            height: calc(100vh - 40px);
            min-height: 600px;
        }

        /* å·¦ä¾§æ—¥å†é¢æ¿ */
        .calendar-panel {
            background: linear-gradient(145deg, #ffffff 0%, #fafbff 100%);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(67, 97, 238, 0.08);
            overflow-y: auto;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .month-year {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: var(--primary-50);
            transform: scale(1.1);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 20px;
        }

        .calendar-header-cell {
            text-align: center;
            padding: 8px 4px;
            font-weight: 600;
            color: var(--gray-600);
            font-size: 0.85rem;
        }

        .calendar-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            position: relative;
            min-height: 36px;
        }

        .calendar-cell:hover {
            background: var(--primary-50);
        }

        .calendar-cell.other-month {
            color: var(--gray-400);
        }

        .calendar-cell.today {
            background: var(--primary-500);
            color: white;
            font-weight: 600;
            position: relative;
        }

        /* ä»Šæ—¥ä»»åŠ¡å®Œæˆåº¦é¢œè‰²è¦†ç›– */
        .calendar-cell.today.completion-0 { 
            background: #dc2626; /* çº¢è‰²ï¼šä»Šæ—¥æ— ä»»åŠ¡æˆ–0%å®Œæˆ */
            color: white;
        }
        
        .calendar-cell.today.completion-low { 
            background: #ea580c; /* æ©™çº¢è‰²ï¼šä»Šæ—¥1-30%å®Œæˆ */
            color: white;
        }
        
        .calendar-cell.today.completion-medium { 
            background: #ca8a04; /* é»„è‰²ï¼šä»Šæ—¥31-70%å®Œæˆ */
            color: white;
        }
        
        .calendar-cell.today.completion-high { 
            background: #9333ea; /* ç´«è‰²ï¼šä»Šæ—¥71-99%å®Œæˆ */
            color: white;
        }
        
        .calendar-cell.today.completion-full { 
            background: #16a34a; /* ç»¿è‰²ï¼šä»Šæ—¥100%å®Œæˆ */
            color: white;
        }

        .calendar-cell.selected {
            background: var(--primary-600);
            color: white;
            font-weight: 600;
        }

        /* æ—¥å†å•å…ƒæ ¼å®Œæˆåº¦é¢œè‰² */
        .calendar-cell.completion-0 { /* æ— ä»»åŠ¡æˆ–0%å®Œæˆ */
            background: var(--gray-100);
        }
        
        .calendar-cell.completion-low { /* 1-30%å®Œæˆ */
            background: #fee2e2;
            color: #dc2626;
        }
        
        .calendar-cell.completion-medium { /* 31-70%å®Œæˆ */
            background: #fef3c7;
            color: #d97706;
        }
        
        .calendar-cell.completion-high { /* 71-99%å®Œæˆ */
            background: #ddd6fe;
            color: #7c3aed;
        }
        
        .calendar-cell.completion-full { /* 100%å®Œæˆ */
            background: #dcfce7;
            color: #16a34a;
        }

        /* å¿«é€Ÿæ“ä½œæŒ‰é’® */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
            gap: 8px;
            margin-top: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        /* æš—è‰²æ¨¡å¼ä¸‹çš„å¿«é€Ÿæ“ä½œåŒºåŸŸ */
        [data-theme="dark"] .quick-actions {
            background: rgba(45, 45, 45, 0.8);
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            letter-spacing: 0.02em;
            position: relative;
            overflow: hidden;
            transition: all 0.25s ease;
            white-space: nowrap;
            min-width: auto;
            min-height: 36px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(67, 97, 238, 0.3);
        }

        .btn-outline {
            background: rgba(255, 255, 255, 0.9);
            color: var(--primary-500);
            border: 1.5px solid rgba(67, 97, 238, 0.2);
            backdrop-filter: blur(10px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--gray-600) 0%, var(--gray-700) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-main) 0%, #d32f2f 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
        }
        
        .btn-danger-outline {
            background: transparent;
            color: var(--danger-main);
            border: 1px solid var(--danger-main);
        }
        
        .btn-danger-outline:hover {
            background: var(--danger-main);
            color: white;
            transform: translateY(-1px);
        }

        .btn-sync {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-sync:hover {
            background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .btn-sync:disabled {
            background: var(--gray-400);
            color: var(--gray-600);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-sync.syncing {
            background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
        }

        .btn-sync.syncing::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 0.75rem;
            border-radius: 4px;
        }

        /* æ¨¡æ¿ç®¡ç†æ ·å¼ */
        .template-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--gray-200);
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .template-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .template-actions {
            display: flex;
            gap: 5px;
        }

        /* æ¨¡æ¿è®¾ç½®çª—å£æ ·å¼ */
        .template-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .template-modal.show {
            display: flex;
        }

        .template-modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .template-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
        }

        .template-modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .template-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-500);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .template-close:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .template-modal-body {
            padding: 24px;
        }

        .template-tabs {
            display: flex;
            margin-bottom: 24px;
            border-radius: var(--border-radius);
            background: var(--gray-100);
            padding: 4px;
        }

        .template-tab {
            flex: 1;
            padding: 8px 16px;
            border: none;
            background: none;
            border-radius: calc(var(--border-radius) - 2px);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            color: var(--gray-600);
        }

        .template-tab.active {
            background: var(--primary-500);
            color: white;
            box-shadow: 0 2px 4px rgba(67, 97, 238, 0.3);
        }

        .template-content {
            display: none;
        }

        .template-content.active {
            display: block;
        }

        .template-time-list {
            display: grid;
            gap: 8px;
        }

        .template-time-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            background: var(--gray-50);
            border-radius: 6px;
            border: 1px solid var(--gray-200);
        }

        .template-time-label {
            width: 60px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.9rem;
        }

        .template-task-input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            margin-right: 8px;
        }

        .template-goal-select {
            min-width: 150px;
            padding: 6px 8px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 0.85rem;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.2s ease;
        }

        .template-task-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
        }

        .template-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 20px 24px;
            border-top: 1px solid var(--gray-200);
        }

        /* æš—è‰²æ¨¡å¼é€‚é… */
        body[data-theme="dark"] .template-modal-content {
            background: var(--gray-100);
            color: white;
        }

        body[data-theme="dark"] .template-modal-header,
        body[data-theme="dark"] .template-modal-footer {
            border-color: rgba(255, 255, 255, 0.1);
        }

        body[data-theme="dark"] .template-tabs {
            background: var(--gray-200);
        }

        body[data-theme="dark"] .template-time-item {
            background: var(--gray-200);
            border-color: rgba(255, 255, 255, 0.1);
        }

        body[data-theme="dark"] .template-task-input {
            background: var(--gray-300);
            border-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        body[data-theme="dark"] .template-task-input:focus {
            border-color: var(--primary-400);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        body[data-theme="dark"] .template-goal-select {
            background: var(--gray-300);
            border-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        body[data-theme="dark"] .template-goal-select:focus {
            border-color: var(--primary-400);
        }

        .template-list {
            display: none;
            background: var(--gray-50);
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
        }

        .template-list.show {
            display: block;
        }

        .template-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 8px;
            border-radius: 4px;
            margin: 2px 0;
            background: white;
            font-size: 0.8rem;
        }

        .template-item:hover {
            background: var(--primary-50);
        }

        /* å³ä¾§ä»»åŠ¡é¢æ¿ */
        .schedule-panel {
            background: linear-gradient(145deg, #ffffff 0%, #fafbff 100%);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(67, 97, 238, 0.08);
            overflow-y: auto;
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-100);
        }

        .selected-date {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .date-weekday {
            color: var(--gray-600);
            font-size: 0.9rem;
            font-weight: 400;
            margin-left: 8px;
        }

        .progress-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-text {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray-color);
        }

        .progress-bar {
            width: 120px;
            height: 6px;
            background: var(--gray-100);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-500) 0%, var(--primary-400) 50%, var(--accent-color) 100%);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* æ—¶é—´ä»»åŠ¡åˆ—è¡¨ */
        .schedule-list {
            flex: 1;
            overflow-y: auto;
        }

        .schedule-item {
            display: flex;
            flex-direction: column;
            padding: 6px 8px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
            border-radius: 6px;
            margin: 3px 0;
            transition: all 0.2s ease;
            min-height: 42px;
        }

        .main-task-row {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .task-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
            min-width: 48px; /* è°ƒæ•´ä¸ºæ›´åˆé€‚çš„å®½åº¦ */
            justify-content: flex-end;
        }

        .add-subtask-btn {
            background: var(--primary-100);
            color: var(--primary-600);
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            opacity: 0.7;
        }

        .add-subtask-btn:hover {
            background: var(--primary-200);
            opacity: 1;
            transform: scale(1.1);
        }

        .subtask-toggle {
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            padding: 4px 6px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            min-width: 20px;
        }

        .subtask-toggle:hover {
            background: var(--gray-200);
        }

        .subtask-toggle.expanded {
            background: var(--primary-100);
            color: var(--primary-700);
        }

        .toggle-icon {
            font-size: 10px;
            transition: transform 0.2s ease;
        }

        .subtask-count {
            font-size: 10px;
            font-weight: 500;
        }

        /* åªä¼˜åŒ–å­ä»»åŠ¡å®¹å™¨çš„æ˜¾ç¤º */
        .subtasks-container {
            margin: 12px 0 8px 40px;
            border-left: 3px solid var(--primary-color-light);
            padding-left: 16px;
            position: relative;
            animation: slideDown 0.3s ease;
            background: linear-gradient(90deg, 
                rgba(67, 97, 238, 0.02) 0%, 
                transparent 50%
            );
            border-radius: 0 6px 6px 0;
        }

        .subtasks-container::before {
            content: '';
            position: absolute;
            left: -3px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, 
                var(--primary-color), 
                var(--primary-color-light)
            );
            border-radius: 2px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
                max-height: 0;
            }
            to {
                opacity: 1;
                transform: translateY(0);
                max-height: 500px;
            }
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            min-height: 32px;
            background: var(--card-bg);
            border-radius: 6px;
            margin-bottom: 6px;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
        }

        .subtask-item:hover {
            background: var(--hover-bg);
            border-color: var(--primary-color-light);
            transform: translateX(2px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        }

        .subtask-item:last-child {
            margin-bottom: 0;
        }

        .subtask-checkbox {
            margin: 0;
            transform: scale(0.9);
        }

        .subtask-input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 13px;
            color: var(--text-color);
            transition: all 0.2s ease;
        }

        .subtask-input:focus {
            outline: none;
            background: rgba(67, 97, 238, 0.05);
            box-shadow: inset 0 0 0 1px var(--primary-color-light);
        }

        .subtask-input::placeholder {
            color: var(--text-secondary);
            font-style: italic;
        }

        .subtask-input.completed {
            text-decoration: line-through;
            opacity: 0.6;
            color: var(--text-secondary);
        }

        .delete-subtask-btn {
            background: transparent;
            border: none;
            color: var(--danger-color);
            width: 22px;
            height: 22px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            opacity: 0.6;
        }

        .delete-subtask-btn:hover {
            background: rgba(244, 67, 54, 0.1);
            color: var(--danger-color);
            opacity: 1;
            transform: scale(1.05);
        }

        /* æš—è‰²ä¸»é¢˜é€‚é… */
        [data-theme="dark"] .add-subtask-btn {
            background: rgba(67, 97, 238, 0.2);
            color: var(--primary-300);
        }

        [data-theme="dark"] .subtask-toggle {
            background: rgba(255, 255, 255, 0.1);
            color: var(--gray-300);
        }

        [data-theme="dark"] .subtask-toggle.expanded {
            background: rgba(67, 97, 238, 0.2);
            color: var(--primary-300);
        }

        [data-theme="dark"] .subtasks-container {
            background: linear-gradient(90deg, 
                rgba(67, 97, 238, 0.04) 0%, 
                transparent 50%
            );
        }

        [data-theme="dark"] .subtask-item {
            background: rgba(255, 255, 255, 0.02);
            border-color: rgba(255, 255, 255, 0.08);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] .subtask-item:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: var(--primary-color-light);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        [data-theme="dark"] .subtask-input:focus {
            background: rgba(67, 97, 238, 0.06);
        }

        /* ==================== é€¼çœŸå°æ©˜çŒ«æ ·å¼ ==================== */
        .pet-container {
            position: fixed;
            width: 120px;
            height: 120px;
            transition: all 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 1500;
            bottom: 20px;
            right: 20px;
            pointer-events: none;
        }

        .pet-sprite {
            position: relative;
            width: 100%;
            height: 100%;
            cursor: pointer;
            pointer-events: all;
            transform-origin: center bottom;
        }

        .pet-main-body {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* ========== å¤´éƒ¨æ ·å¼ ========== */
        .pet-head {
            position: absolute;
            bottom: 60px;
            left: 35px;
            width: 50px;
            height: 45px;
        }

        .pet-head-main {
            position: relative;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff9500 0%, #ff7b00 50%, #e55100 100%);
            border-radius: 50% 50% 45% 45%;
            box-shadow: 
                inset -3px -3px 8px rgba(0,0,0,0.1),
                inset 3px 3px 8px rgba(255,255,255,0.3),
                0 2px 8px rgba(0,0,0,0.15);
        }

        /* é¢å¤´èŠ±çº¹ */
        .pet-forehead-pattern {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 15px;
            background: #d84315;
            border-radius: 50% 50% 80% 80%;
            opacity: 0.6;
        }

        .pet-forehead-pattern::before {
            content: '';
            position: absolute;
            top: 5px;
            left: -8px;
            width: 6px;
            height: 8px;
            background: #d84315;
            border-radius: 50%;
            opacity: 0.7;
        }

        .pet-forehead-pattern::after {
            content: '';
            position: absolute;
            top: 5px;
            right: -8px;
            width: 6px;
            height: 8px;
            background: #d84315;
            border-radius: 50%;
            opacity: 0.7;
        }

        /* ========== è€³æœµæ ·å¼ ========== */
        .pet-ears {
            position: absolute;
            top: -8px;
            left: 0;
            right: 0;
        }

        .pet-ear {
            position: absolute;
            width: 18px;
            height: 20px;
            background: linear-gradient(135deg, #ff9500 0%, #e55100 100%);
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .pet-ear-left {
            top: 0;
            left: 8px;
            transform: rotate(-15deg);
        }

        .pet-ear-right {
            top: 0;
            right: 8px;
            transform: rotate(15deg);
        }

        .pet-ear-inner {
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 10px;
            height: 12px;
            background: #ffab40;
            clip-path: polygon(50% 0%, 20% 100%, 80% 100%);
        }

        /* ========== çœ¼ç›æ ·å¼ ========== */
        .pet-eyes {
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 12px;
        }

        .pet-eye {
            width: 12px;
            height: 10px;
            position: relative;
        }

        .pet-eyeball {
            position: absolute;
            width: 100%;
            height: 100%;
            background: #2e7d32;
            border-radius: 50%;
            box-shadow: 
                inset 0 -2px 3px rgba(0,0,0,0.2),
                0 1px 2px rgba(0,0,0,0.1);
        }

        .pet-pupil {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 8px;
            background: #000;
            border-radius: 50%;
        }

        .pet-eye-shine {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 3px;
            height: 3px;
            background: #fff;
            border-radius: 50%;
            opacity: 0.9;
        }

        .pet-eyelid {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 0%;
            background: linear-gradient(135deg, #ff9500 0%, #e55100 100%);
            border-radius: 50%;
            transition: height 0.15s ease;
            overflow: hidden;
        }

        /* ========== é¼»å­æ ·å¼ ========== */
        .pet-nose {
            position: absolute;
            top: 22px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 6px;
        }

        .pet-nose-tip {
            position: absolute;
            width: 6px;
            height: 4px;
            background: #ff1744;
            border-radius: 50% 50% 50% 50% / 70% 70% 30% 30%;
            box-shadow: 
                inset 0 -1px 2px rgba(0,0,0,0.2),
                0 1px 1px rgba(0,0,0,0.1);
        }

        .pet-nose-line {
            position: absolute;
            top: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 1px;
            height: 4px;
            background: #d84315;
            border-radius: 1px;
        }

        /* ========== å˜´å·´æ ·å¼ ========== */
        .pet-mouth {
            position: absolute;
            top: 28px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 6px;
        }

        .pet-mouth-left {
            position: absolute;
            left: 0;
            width: 6px;
            height: 3px;
            border: 1px solid #d84315;
            border-top: none;
            border-radius: 0 0 0 8px;
            border-right: none;
        }

        .pet-mouth-right {
            position: absolute;
            right: 0;
            width: 6px;
            height: 3px;
            border: 1px solid #d84315;
            border-top: none;
            border-radius: 0 0 8px 0;
            border-left: none;
        }

        /* ========== èƒ¡é¡»æ ·å¼ ========== */
        .pet-whiskers {
            position: absolute;
            top: 20px;
        }

        .pet-whiskers-left {
            left: -8px;
        }

        .pet-whiskers-right {
            right: -8px;
        }

        .pet-whisker {
            position: absolute;
            width: 12px;
            height: 1px;
            background: #424242;
            border-radius: 1px;
            opacity: 0.8;
        }

        .pet-whiskers-left .pet-whisker:nth-child(1) {
            top: 0;
            transform: rotate(-10deg);
        }

        .pet-whiskers-left .pet-whisker:nth-child(2) {
            top: 4px;
            transform: rotate(0deg);
        }

        .pet-whiskers-left .pet-whisker:nth-child(3) {
            top: 8px;
            transform: rotate(10deg);
        }

        .pet-whiskers-right .pet-whisker:nth-child(1) {
            top: 0;
            transform: rotate(10deg);
        }

        .pet-whiskers-right .pet-whisker:nth-child(2) {
            top: 4px;
            transform: rotate(0deg);
        }

        .pet-whiskers-right .pet-whisker:nth-child(3) {
            top: 8px;
            transform: rotate(-10deg);
        }

        /* ========== è„¸é¢Šæ ·å¼ ========== */
        .pet-cheeks {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
        }

        .pet-cheek {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #ffab40;
            border-radius: 50%;
            opacity: 0.6;
        }

        .pet-cheek-left {
            left: 2px;
        }

        .pet-cheek-right {
            right: 2px;
        }

        /* ========== èº«ä½“æ ·å¼ ========== */
        .pet-body-main {
            position: absolute;
            bottom: 20px;
            left: 30px;
            width: 60px;
            height: 50px;
            background: linear-gradient(135deg, #ff9500 0%, #ff7b00 50%, #e55100 100%);
            border-radius: 50% 50% 60% 40%;
            box-shadow: 
                inset -2px -2px 6px rgba(0,0,0,0.1),
                inset 2px 2px 6px rgba(255,255,255,0.3),
                0 2px 8px rgba(0,0,0,0.15);
        }

        /* èƒ¸éƒ¨ç™½æ¯› */
        .pet-chest {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 25px;
            height: 30px;
            background: #fff;
            border-radius: 50% 50% 70% 30%;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
        }

        /* èº«ä½“èŠ±çº¹ */
        .pet-body-stripes {
            position: absolute;
            top: 5px;
            left: 8px;
            right: 8px;
            height: 35px;
        }

        .pet-stripe {
            position: absolute;
            height: 3px;
            background: #d84315;
            border-radius: 2px;
            opacity: 0.5;
        }

        .pet-stripe:nth-child(1) {
            top: 5px;
            left: 5px;
            width: 15px;
            transform: rotate(-10deg);
        }

        .pet-stripe:nth-child(2) {
            top: 12px;
            left: 8px;
            width: 12px;
            transform: rotate(5deg);
        }

        .pet-stripe:nth-child(3) {
            top: 19px;
            left: 6px;
            width: 14px;
            transform: rotate(-5deg);
        }

        /* ========== å‰è…¿æ ·å¼ ========== */
        .pet-front-legs {
            position: absolute;
            bottom: 5px;
            left: 35px;
            width: 50px;
            height: 25px;
        }

        .pet-leg {
            position: absolute;
            width: 12px;
            height: 20px;
            background: linear-gradient(180deg, #ff9500 0%, #ff7b00 100%);
            border-radius: 8px 8px 6px 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .pet-front-leg-left {
            left: 8px;
        }

        .pet-front-leg-right {
            right: 8px;
        }

        .pet-paw {
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 14px;
            height: 8px;
            background: #ffab40;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
        }

        .pet-paw::before {
            content: '';
            position: absolute;
            top: 1px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 4px;
            background: #ff7043;
            border-radius: 50%;
            opacity: 0.6;
        }

        /* ========== å°¾å·´æ ·å¼ ========== */
        .pet-tail {
            position: absolute;
            bottom: 35px;
            right: 10px;
            width: 40px;
            height: 60px;
            transform-origin: bottom left;
        }

        .pet-tail-base {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 12px;
            height: 25px;
            background: linear-gradient(135deg, #ff9500 0%, #e55100 100%);
            border-radius: 8px;
            transform: rotate(-20deg);
        }

        .pet-tail-middle {
            position: absolute;
            bottom: 20px;
            left: 8px;
            width: 10px;
            height: 20px;
            background: linear-gradient(135deg, #ff9500 0%, #e55100 100%);
            border-radius: 6px;
            transform: rotate(10deg);
        }

        .pet-tail-tip {
            position: absolute;
            bottom: 35px;
            left: 15px;
            width: 8px;
            height: 15px;
            background: linear-gradient(135deg, #ff9500 0%, #e55100 100%);
            border-radius: 50% 50% 60% 60%;
            transform: rotate(30deg);
        }

        /* å°¾å·´èŠ±çº¹ */
        .pet-tail-stripes {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100%;
        }

        .pet-tail-stripe {
            position: absolute;
            width: 8px;
            height: 2px;
            background: #d84315;
            border-radius: 1px;
            opacity: 0.6;
        }

        .pet-tail-stripe:nth-child(1) {
            bottom: 8px;
            left: 2px;
            transform: rotate(-20deg);
        }

        .pet-tail-stripe:nth-child(2) {
            bottom: 25px;
            left: 10px;
            transform: rotate(10deg);
        }

        .pet-tail-stripe:nth-child(3) {
            bottom: 40px;
            left: 17px;
            transform: rotate(30deg);
        }

        /* ========== UI å…ƒç´ æ ·å¼ ========== */
        .pet-level-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 25px;
            height: 25px;
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border: 2px solid #fff;
        }

        .pet-xp-bar {
            position: absolute;
            bottom: -8px;
            left: 10px;
            right: 10px;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            overflow: hidden;
        }

        .pet-xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            border-radius: 2px;
            transition: width 0.3s ease;
            box-shadow: 0 0 6px rgba(76,175,80,0.5);
        }

        /* ========== å® ç‰©åŠ¨ç”»æ•ˆæœ ========== */
        .pet-sprite.bouncing {
            animation: petBounce 0.6s ease-in-out;
        }

        .pet-sprite.leveling {
            animation: petLevelUp 1s ease-in-out;
        }

        @keyframes petBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-8px) scale(1.05); }
        }

        @keyframes petLevelUp {
            0% { transform: scale(1) rotate(0deg); filter: hue-rotate(0deg); }
            25% { transform: scale(1.1) rotate(-3deg); filter: hue-rotate(90deg); }
            50% { transform: scale(0.95) rotate(3deg); filter: hue-rotate(180deg); }
            75% { transform: scale(1.05) rotate(-1deg); filter: hue-rotate(270deg); }
            100% { transform: scale(1) rotate(0deg); filter: hue-rotate(360deg); }
        }

        /* çœ¨çœ¼åŠ¨ç”» */
        .pet-sprite.idle-blink .pet-eyelid {
            height: 100%;
            animation: blinkLid 0.3s ease-in-out;
        }

        @keyframes blinkLid {
            0%, 100% { height: 0%; }
            50% { height: 100%; }
        }

        /* è€³æœµåŠ¨ç”» */
        .pet-sprite.idle-ear-wiggle .pet-ear-left {
            animation: earWiggleLeft 0.8s ease-in-out;
        }

        .pet-sprite.idle-ear-wiggle .pet-ear-right {
            animation: earWiggleRight 0.8s ease-in-out;
        }

        @keyframes earWiggleLeft {
            0%, 100% { transform: rotate(-15deg); }
            50% { transform: rotate(-25deg); }
        }

        @keyframes earWiggleRight {
            0%, 100% { transform: rotate(15deg); }
            50% { transform: rotate(25deg); }
        }

        /* å°¾å·´æ‘†åŠ¨åŠ¨ç”» */
        .pet-sprite.idle-tail-wag .pet-tail {
            animation: tailWagRealistic 1s ease-in-out;
        }

        @keyframes tailWagRealistic {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        /* ç§»åŠ¨åŠ¨ç”» */
        .pet-sprite.moving .pet-main-body {
            animation: catWalk 0.4s ease-in-out infinite alternate;
        }

        @keyframes catWalk {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-2px); }
        }

        /* å‘¼å¸åŠ¨ç”» */
        .pet-main-body {
            animation: catBreathe 3s ease-in-out infinite;
        }

        @keyframes catBreathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* æš—è‰²ä¸»é¢˜é€‚é… */
        [data-theme="dark"] .pet-head-main,
        [data-theme="dark"] .pet-body-main {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #5e35b1 100%);
        }

        [data-theme="dark"] .pet-ear {
            background: linear-gradient(135deg, #667eea 0%, #5e35b1 100%);
        }

        [data-theme="dark"] .pet-tail-base,
        [data-theme="dark"] .pet-tail-middle,
        [data-theme="dark"] .pet-tail-tip {
            background: linear-gradient(135deg, #667eea 0%, #5e35b1 100%);
        }

        [data-theme="dark"] .pet-leg {
            background: linear-gradient(180deg, #667eea 0%, #5e35b1 100%);
        }

        /* é¢å¤–çš„äº¤äº’åŠ¨ç”» */
        .pet-static {
            pointer-events: auto !important;
        }

        @keyframes petTeleport {
            0% { 
                transform: scale(1) rotateY(0deg);
                filter: hue-rotate(0deg);
            }
            50% { 
                transform: scale(0.8) rotateY(180deg);
                filter: hue-rotate(180deg);
            }
            100% { 
                transform: scale(1) rotateY(360deg);
                filter: hue-rotate(360deg);
            }
        }

        /* æµ®åŠ¨ç»éªŒå€¼ç‰¹æ•ˆ */
        .pet-floating-xp {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            color: #4caf50;
            font-size: 12px;
            font-weight: bold;
            pointer-events: none;
            animation: floatUpXP 1.5s ease-out forwards;
        }

        @keyframes floatUpXP {
            0% { 
                opacity: 1; 
                transform: translateX(-50%) translateY(0px) scale(1); 
            }
            20% { 
                opacity: 1; 
                transform: translateX(-50%) translateY(-10px) scale(1.2); 
            }
            100% { 
                opacity: 0; 
                transform: translateX(-50%) translateY(-40px) scale(0.8); 
            }
        }

        /* å® ç‰©å³é”®èœå• */
        .pet-context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            min-width: 140px;
            font-size: 14px;
        }

        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item:hover {
            background-color: #f5f5f5;
        }

        [data-theme="dark"] .pet-context-menu {
            background: #333;
            border-color: #555;
        }

        [data-theme="dark"] .context-menu-item {
            border-bottom-color: #444;
            color: #fff;
        }

        [data-theme="dark"] .context-menu-item:hover {
            background-color: #444;
        }

        .schedule-item:hover {
            background: var(--primary-50);
        }

        .time {
            width: 55px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .task {
            flex-grow: 1;
            margin: 0 8px;
            border: none;
            font-size: 0.85rem;
            font-weight: 400;
            padding: 8px 10px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
            border: 1px solid var(--gray-200);
            transition: all 0.2s ease;
            min-height: 32px;
            line-height: 1.3;
        }

        .task:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid var(--primary-500);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .checkbox-container {
            position: relative;
            width: 22px;
            height: 22px;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .checkbox-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 22px;
            width: 22px;
            background-color: #ffffff;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .checkbox-container input:checked ~ .checkmark {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            border-color: var(--primary-500);
        }

        .checkbox-container input:disabled ~ .checkmark {
            background-color: #f8f8f8;
            border-color: #d4d4d4;
            opacity: 0.7;
            cursor: not-allowed;
        }

        .checkbox-container input:disabled {
            cursor: not-allowed;
        }

        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .checkbox-container input:checked ~ .checkmark:after {
            display: block;
        }

        .checkbox-container .checkmark:after {
            left: 7px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .task.completed {
            text-decoration: line-through;
            color: var(--gray-500);
            background-color: var(--completed-bg);
        }

        /* æš—è‰²æ¨¡å¼ä¸‹å·²å®Œæˆä»»åŠ¡çš„èƒŒæ™¯è‰² */
        body[data-theme="dark"] .task.completed {
            background-color: rgba(34, 197, 94, 0.15);
            color: var(--gray-400);
            border-color: rgba(34, 197, 94, 0.3);
        }

        /* ç©ºçŠ¶æ€æ ·å¼ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-color);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.6;
        }

        .empty-state h3 {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--gray-700);
        }

        .empty-state p {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* é€šçŸ¥æ ·å¼ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 1000;
            display: none;
            animation: slideInRight 0.3s ease;
        }

        .notification.show {
            display: block;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* è®¾ç½®æŒ‰é’® */
        .settings-toggle {
            position: fixed;
            bottom: 90px; /* å¢åŠ ä¸ä¸»é¢˜æŒ‰é’®çš„è·ç¦» */
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-500);
            border: none;
            cursor: pointer;
            color: white;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
            transition: all 0.3s ease;
            z-index: 1100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
        }

        /* è®¾ç½®æŒ‰é’®tooltip */
        .settings-tooltip {
            position: absolute;
            bottom: 65px; /* è°ƒæ•´ä½ç½®ï¼Œç¡®ä¿ä¸è¢«é®æŒ¡ */
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 1300; /* æé«˜å±‚çº§ï¼Œç¡®ä¿åœ¨ä¸»é¢˜æŒ‰é’®ä¹‹ä¸Š */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            min-width: 200px; /* ç¡®ä¿æœ‰è¶³å¤Ÿå®½åº¦æ˜¾ç¤ºå®Œæ•´é‚®ç®± */
            text-align: center;
        }

        .settings-toggle:hover .settings-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-8px); /* å¢åŠ å‘ä¸Šçš„åç§» */
        }

        .tooltip-content {
            text-align: center;
        }

        .tooltip-user-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }

        .tooltip-email {
            font-weight: 500;
            color: #e5e7eb;
            word-break: break-all; /* å…è®¸é•¿é‚®ç®±åœ°å€æ¢è¡Œ */
            max-width: 180px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
            margin: 0 auto; /* å±…ä¸­æ˜¾ç¤º */
        }

        .tooltip-logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 16px; /* å¢åŠ æŒ‰é’®å†…è¾¹è· */
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 4px; /* å¢åŠ ä¸é‚®ç®±çš„é—´è· */
        }

        .tooltip-logout-btn:hover {
            background: #dc2626;
        }

        .tooltip-offline {
            color: #9ca3af;
            font-style: italic;
        }

        /* æš—è‰²æ¨¡å¼é€‚é… */
        body[data-theme="dark"] .settings-tooltip {
            background: rgba(255, 255, 255, 0.95); /* æé«˜é€æ˜åº¦ï¼Œç¡®ä¿å¯è¯»æ€§ */
            color: #1f2937;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        body[data-theme="dark"] .tooltip-email {
            color: #374151;
        }

        body[data-theme="dark"] .tooltip-offline {
            color: #6b7280;
        }

        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-500);
            border: none;
            cursor: pointer;
            color: white;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
            transition: all 0.3s ease;
            z-index: 1100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
        }

        /* æš—è‰²ä¸»é¢˜é€‚é… */
        body[data-theme="dark"] {
            --primary-50: #1a1d29;
            --primary-100: #252941;
            --primary-400: #818cf8;
            --primary-500: #6366f1;
            --primary-600: #4f46e5;
            --gray-50: #1a1a1a;
            --gray-100: #2d2d2d;
            --gray-200: #404040;
            --gray-300: #525252;
            --gray-400: #737373;
            --gray-500: #a3a3a3;
            --gray-600: #d4d4d4;
            --light-color: #1a1a1a;
            --dark-color: #ffffff;
            --success-light: rgba(34, 197, 94, 0.1);
            --success-main: #22c55e;
            --warning-light: rgba(251, 146, 60, 0.1);
            --warning-main: #fb923c;
            --danger-main: #ef4444;
            
            /* ç¡®ä¿æ•´ä½“èƒŒæ™¯è‰² */
            background-color: #1a1a1a !important;
            color: #ffffff !important;
        }

        /* ä¸ºhtmlå…ƒç´ ä¹Ÿè®¾ç½®æš—è‰²èƒŒæ™¯ */
        html:has(body[data-theme="dark"]) {
            background-color: #1a1a1a !important;
        }

        /* å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨CSSå˜é‡æ§åˆ¶ */
        html {
            background-color: var(--page-bg, #f0f2f5);
        }

        body[data-theme="dark"] {
            --page-bg: #1a1a1a;
        }

        /* æœ€å¼ºåˆ¶çš„æ–¹æ¡ˆï¼šç›´æ¥è®¾ç½®htmlå’Œbody */
        body[data-theme="dark"],
        body[data-theme="dark"] html {
            background: #1a1a1a !important;
            background-color: #1a1a1a !important;
        }

        /* ä¸ºäº†ç¡®ä¿viewportå®Œå…¨è¦†ç›–ï¼Œæ·»åŠ ä¸€ä¸ªå…¨å±èƒŒæ™¯å±‚ */
        body[data-theme="dark"]::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            background: #1a1a1a;
            z-index: -9999;
            pointer-events: none;
        }

        [data-theme="dark"] html {
            background: #1a1a1a !important;
            background-color: #1a1a1a !important;
        }

        [data-theme="dark"] body {
            background: #1a1a1a !important;
            background-color: #1a1a1a !important;
            color: #ffffff !important;
        }

        [data-theme="dark"] * {
            scrollbar-color: #4a4a4a #1a1a1a;
        }

        [data-theme="dark"]::before,
        [data-theme="dark"]::after {
            background-color: #1a1a1a !important;
        }

        body[data-theme="dark"] .calendar-panel,
        body[data-theme="dark"] .schedule-panel {
            background: linear-gradient(145deg, var(--gray-100) 0%, #363636 100%);
            border-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        body[data-theme="dark"] .task {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--gray-300);
            color: white;
        }

        body[data-theme="dark"] .task:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15) !important;
            color: #ffffff !important;
            border: 2px solid var(--primary-500);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        body[data-theme="dark"] .calendar-cell:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        body[data-theme="dark"] .calendar-cell.completion-0 {
            background: var(--gray-200);
        }
        
        body[data-theme="dark"] .calendar-cell.completion-low {
            background: rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }
        
        body[data-theme="dark"] .calendar-cell.completion-medium {
            background: rgba(245, 158, 11, 0.3);
            color: #fcd34d;
        }
        
        body[data-theme="dark"] .calendar-cell.completion-high {
            background: rgba(139, 92, 246, 0.3);
            color: #c4b5fd;
        }
        
        body[data-theme="dark"] .calendar-cell.completion-full {
            background: rgba(34, 197, 94, 0.3);
            color: #86efac;
        }

        body[data-theme="dark"] .template-section {
            border-top-color: var(--gray-400);
        }

        body[data-theme="dark"] .template-list {
            background: var(--gray-200);
        }

        body[data-theme="dark"] .template-item {
            background: var(--gray-300);
            color: white;
        }

        body[data-theme="dark"] .template-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* æš—è‰²æ¨¡å¼ä¸‹å‹¾é€‰æ¡†æ ·å¼ */
        body[data-theme="dark"] .checkmark {
            background-color: #3a3a3a;
            border-color: var(--primary-400);
        }

        body[data-theme="dark"] .checkbox-container input:disabled ~ .checkmark {
            background-color: #2d2d2d;
            border-color: #4a4a4a;
            opacity: 0.6;
        }

        /* æš—è‰²æ¨¡å¼ä¸‹ä»Šæ—¥ä»»åŠ¡å®Œæˆåº¦é¢œè‰² */
        body[data-theme="dark"] .calendar-cell.today.completion-0 { 
            background: #dc2626; /* çº¢è‰²ï¼šä»Šæ—¥æ— ä»»åŠ¡æˆ–0%å®Œæˆ */
            color: white;
        }
        
        body[data-theme="dark"] .calendar-cell.today.completion-low { 
            background: #ea580c; /* æ©™çº¢è‰²ï¼šä»Šæ—¥1-30%å®Œæˆ */
            color: white;
        }
        
        body[data-theme="dark"] .calendar-cell.today.completion-medium { 
            background: #ca8a04; /* é»„è‰²ï¼šä»Šæ—¥31-70%å®Œæˆ */
            color: white;
        }
        
        body[data-theme="dark"] .calendar-cell.today.completion-high { 
            background: #9333ea; /* ç´«è‰²ï¼šä»Šæ—¥71-99%å®Œæˆ */
            color: white;
        }
        
        body[data-theme="dark"] .calendar-cell.today.completion-full { 
            background: #16a34a; /* ç»¿è‰²ï¼šä»Šæ—¥100%å®Œæˆ */
            color: white;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
                height: auto;
            }

            .calendar-panel {
                height: auto;
                max-height: 400px;
            }

            .calendar-grid {
                margin-bottom: 15px;
            }

            .quick-actions {
                flex-direction: row;
                gap: 6px;
            }

            .btn {
                flex: 1;
                font-size: 0.8rem;
                padding: 6px 10px;
            }

            /* ç§»åŠ¨ç«¯ä¸‹è°ƒæ•´tooltipå®½åº¦ */
            .settings-tooltip {
                min-width: 180px;
                max-width: 250px;
                left: auto;
                right: 20px;
                transform: none;
            }

            .settings-toggle:hover .settings-tooltip {
                transform: translateY(-8px);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 8px;
            }

            .main-layout {
                gap: 15px;
            }

            .calendar-panel,
            .schedule-panel {
                padding: 15px;
            }

            .calendar-header,
            .schedule-header {
                margin-bottom: 15px;
            }

            /* ç§»åŠ¨ç«¯å¿«é€Ÿæ“ä½œæŒ‰é’®ä¼˜åŒ– */
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
                padding: 8px;
                margin-top: 8px;
            }

            .btn {
                padding: 6px 8px;
                font-size: 0.75rem;
                min-height: 32px;
            }

            .month-year,
            .selected-date {
                font-size: 1.1rem;
            }

            .progress-bar {
                width: 80px;
            }

            .task {
                padding: 8px 10px;
                font-size: 0.85rem;
            }

            .time {
                width: 60px;
                font-size: 0.8rem;
            }
        }

        /* è®¤è¯ç•Œé¢æ ·å¼ */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-modal.hidden {
            display: none;
        }

        .auth-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 32px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        body[data-theme="dark"] .auth-card {
            background: var(--gray-100);
            color: white;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .auth-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .auth-subtitle {
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .auth-input {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid var(--gray-300);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        body[data-theme="dark"] .auth-input {
            background: var(--gray-200);
            border-color: var(--gray-400);
            color: white;
        }

        .auth-button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .auth-button-primary {
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
            color: white;
        }

        .auth-button-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        .auth-button-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .auth-button-secondary:hover {
            background: var(--gray-200);
        }

        body[data-theme="dark"] .auth-button-secondary {
            background: var(--gray-200);
            color: white;
            border-color: var(--gray-400);
        }

        body[data-theme="dark"] .auth-button-secondary:hover {
            background: var(--gray-300);
        }

        .auth-divider {
            text-align: center;
            margin: 20px 0;
            color: var(--gray-500);
            position: relative;
        }

        .auth-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--gray-300);
        }

        .auth-divider span {
            background: white;
            padding: 0 16px;
        }

        body[data-theme="dark"] .auth-divider span {
            background: var(--gray-100);
        }

        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            font-size: 0.85rem;
            color: var(--gray-600);
        }

        .auth-toggle a {
            color: var(--primary-500);
            text-decoration: none;
            cursor: pointer;
        }

        .auth-toggle a:hover {
            text-decoration: underline;
        }

        .auth-error {
            background: #fee2e2;
            color: #dc2626;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-bottom: 16px;
            display: none;
        }

        body[data-theme="dark"] .auth-error {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        /* ==================== ä¸»å¯¼èˆªTabæš—è‰²ä¸»é¢˜æ ·å¼ ==================== */
        body[data-theme="dark"] .main-tabs {
            background: linear-gradient(145deg, var(--gray-100) 0%, #363636 100%);
            border-color: rgba(255, 255, 255, 0.1);
        }

        body[data-theme="dark"] .main-tab {
            color: rgba(255, 255, 255, 0.7);
        }

        body[data-theme="dark"] .main-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--primary-400);
        }

        body[data-theme="dark"] .main-tab.active {
            background: linear-gradient(135deg, var(--primary-500) 0%, #818cf8 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
        }

        body[data-theme="dark"] .main-tab.active:hover {
            background: linear-gradient(135deg, #818cf8 0%, var(--primary-500) 100%);
            color: white;
        }

        /* ==================== ä¸»å¯¼èˆªæŒ‰é’®æš—è‰²ä¸»é¢˜æ ·å¼ ==================== */
        body[data-theme="dark"] .nav-btn {
            background: rgba(45, 45, 45, 0.9);
            backdrop-filter: blur(10px);
            color: rgba(255, 255, 255, 0.7);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
        }

        body[data-theme="dark"] .nav-btn:hover {
            background: rgba(60, 60, 60, 0.95);
            color: var(--primary-400);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        body[data-theme="dark"] .nav-btn.active {
            background: var(--primary-500);
            color: white;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        }

        body[data-theme="dark"] .nav-btn.active:hover {
            background: #818cf8;
            box-shadow: 0 6px 24px rgba(99, 102, 241, 0.5);
        }

        /* ==================== ç›®æ ‡ç®¡ç†æš—è‰²ä¸»é¢˜æ ·å¼ ==================== */
        body[data-theme="dark"] .goal-page-header,
        body[data-theme="dark"] .goal-section {
            background: linear-gradient(145deg, var(--gray-100) 0%, #363636 100%);
            border-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        body[data-theme="dark"] .goal-page-title {
            color: white;
        }

        body[data-theme="dark"] .goal-item {
            background: var(--gray-200);
            border-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        body[data-theme="dark"] .goal-name,
        body[data-theme="dark"] .subtask-text {
            color: white;
        }

        body[data-theme="dark"] .goal-action-btn {
            background: var(--gray-300);
            border-color: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
        }

        body[data-theme="dark"] .goal-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        body[data-theme="dark"] .goal-action-btn.goal-import {
            background: rgba(14, 165, 233, 0.3);
            color: #7dd3fc;
            border-color: #0ea5e9;
        }

        body[data-theme="dark"] .goal-action-btn.goal-import:hover {
            background: rgba(14, 165, 233, 0.4);
            border-color: #0369a1;
        }

        body[data-theme="dark"] .goal-action-btn.goal-tag {
            background: rgba(59, 130, 246, 0.3);
            color: #93c5fd;
            border-color: #3b82f6;
        }

        body[data-theme="dark"] .goal-action-btn.goal-status {
            background: rgba(34, 197, 94, 0.3);
            color: #86efac;
            border-color: #22c55e;
        }

        body[data-theme="dark"] .goal-action-btn.goal-delete {
            color: #fca5a5;
        }

        body[data-theme="dark"] .goal-action-btn.goal-delete:hover {
            background: rgba(220, 38, 38, 0.3);
            border-color: #dc2626;
        }

        body[data-theme="dark"] .progress-bar-container {
            background: var(--gray-300);
        }

        body[data-theme="dark"] .subtask-item {
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        body[data-theme="dark"] .subtask-item.completed .subtask-text {
            color: rgba(255, 255, 255, 0.5);
        }

        body[data-theme="dark"] .subtask-delete {
            background: var(--gray-300);
            border-color: rgba(255, 255, 255, 0.2);
            color: #fca5a5;
        }

        body[data-theme="dark"] .subtask-delete:hover {
            background: rgba(220, 38, 38, 0.3);
            border-color: #dc2626;
        }

        body[data-theme="dark"] .subtask-hint {
            background: var(--gray-300);
            color: rgba(255, 255, 255, 0.7);
        }

        body[data-theme="dark"] .empty-goals {
            background: var(--gray-200);
            border-color: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
        }

        
        /* ==================== ReportView åŒæ­¥æ—¥å¿—é¢æ¿æ ·å¼ ==================== */
        
        .reportview-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-top: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .reportview-content {
            max-height: 200px;
        }
        
        /* æ—¥å¿—å®¹å™¨æ ·å¼ */
        .sync-log-container {
            max-height: 200px;
            overflow-y: auto;
            padding: 12px 16px;
            background: rgba(248, 249, 250, 0.8);
            backdrop-filter: blur(5px);
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .log-entry {
            display: flex;
            padding: 6px 12px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            align-items: flex-start;
            gap: 10px;
        }
        
        .log-entry:hover {
            background: rgba(0, 0, 0, 0.02);
        }
        
        .log-timestamp {
            color: var(--gray-500);
            font-weight: 500;
            min-width: 70px;
            flex-shrink: 0;
        }
        
        .log-message {
            flex: 1;
            color: var(--gray-700);
        }
        
        /* ä¸åŒç±»å‹æ—¥å¿—çš„é¢œè‰² */
        .log-info .log-message {
            color: var(--gray-700);
        }
        
        .log-success .log-message {
            color: var(--success-dark);
        }
        
        .log-success .log-timestamp {
            color: var(--success-main);
        }
        
        .log-error .log-message {
            color: var(--danger-main);
        }
        
        .log-error .log-timestamp {
            color: var(--danger-main);
        }
        
        .log-warning .log-message {
            color: var(--warning-main);
        }
        
        .log-warning .log-timestamp {
            color: var(--warning-main);
        }
        
        .log-syncing .log-message {
            color: var(--primary-600);
        }
        
        .log-syncing .log-timestamp {
            color: var(--primary-500);
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        .sync-log-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .sync-log-container::-webkit-scrollbar-track {
            background: var(--gray-200);
        }
        
        .sync-log-container::-webkit-scrollbar-thumb {
            background: var(--gray-400);
            border-radius: 3px;
        }
        
        .sync-log-container::-webkit-scrollbar-thumb:hover {
            background: var(--gray-500);
        }
        
        /* æš—è‰²ä¸»é¢˜é€‚é… */
        [data-theme="dark"] .reportview-panel {
            background: rgba(45, 45, 45, 0.8);
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            color: white;
        }
        
        [data-theme="dark"] .sync-log-container {
            background: rgba(45, 45, 45, 0.9);
        }
        
        [data-theme="dark"] .log-entry {
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }
        
        [data-theme="dark"] .log-entry:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* æš—è‰²æ¨¡å¼ä¸‹æ‰€æœ‰æ—¥å¿—æ–‡æœ¬é»˜è®¤ä¸ºç™½è‰² */
        [data-theme="dark"] .log-message {
            color: #ffffff !important;
        }
        
        [data-theme="dark"] .log-timestamp {
            color: #cccccc !important;
        }
        
        /* æš—è‰²æ¨¡å¼ä¸‹ä¸åŒç±»å‹æ—¥å¿—çš„é¢œè‰²è¦†ç›– */
        [data-theme="dark"] .log-info .log-message {
            color: #ffffff !important;
        }
        
        [data-theme="dark"] .log-info .log-timestamp {
            color: #cccccc !important;
        }
        
        [data-theme="dark"] .log-success .log-message {
            color: #81c784 !important;
        }
        
        [data-theme="dark"] .log-success .log-timestamp {
            color: #66bb6a !important;
        }
        
        [data-theme="dark"] .log-error .log-message {
            color: #ef5350 !important;
        }
        
        [data-theme="dark"] .log-error .log-timestamp {
            color: #ef5350 !important;
        }
        
        [data-theme="dark"] .log-warning .log-message {
            color: #ffb74d !important;
        }
        
        [data-theme="dark"] .log-warning .log-timestamp {
            color: #ffa726 !important;
        }
        
        [data-theme="dark"] .log-syncing .log-message {
            color: #64b5f6 !important;
        }
        
        [data-theme="dark"] .log-syncing .log-timestamp {
            color: #42a5f5 !important;
        }
        
        [data-theme="dark"] .sync-log-container::-webkit-scrollbar-track {
            background: var(--gray-700);
        }
        
        [data-theme="dark"] .sync-log-container::-webkit-scrollbar-thumb {
            background: var(--gray-500);
        }
        
        [data-theme="dark"] .sync-log-container::-webkit-scrollbar-thumb:hover {
            background: var(--gray-400);
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .reportview-content {
                max-height: 120px;
            }
            
            .sync-log-container {
                max-height: 120px;
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .log-entry {
                padding: 4px 8px;
            }
            
            .log-timestamp {
                min-width: 60px;
                font-size: 12px;
            }
            
            .log-message {
                font-size: 12px;
            }
        }
    </style>
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>
    
    <!-- é€¼çœŸè™šæ‹Ÿå® ç‰© - å°æ©˜çŒ« -->
    <div class="pet-container" id="petContainer">
        <div class="pet-sprite" onclick="petInteraction()" oncontextmenu="showPetContextMenu(event)">
            <!-- å® ç‰©ä¸»ä½“ -->
            <div class="pet-main-body">
                <!-- å¤´éƒ¨ -->
                <div class="pet-head">
                    <!-- è€³æœµ -->
                    <div class="pet-ears">
                        <div class="pet-ear pet-ear-left">
                            <div class="pet-ear-inner"></div>
                        </div>
                        <div class="pet-ear pet-ear-right">
                            <div class="pet-ear-inner"></div>
                        </div>
                    </div>
                    
                    <!-- å¤´éƒ¨ä¸»ä½“ -->
                    <div class="pet-head-main">
                        <!-- é¢å¤´èŠ±çº¹ -->
                        <div class="pet-forehead-pattern"></div>
                        
                        <!-- çœ¼ç› -->
                        <div class="pet-eyes">
                            <div class="pet-eye pet-eye-left">
                                <div class="pet-eyeball">
                                    <div class="pet-pupil"></div>
                                    <div class="pet-eye-shine"></div>
                                </div>
                                <div class="pet-eyelid"></div>
                            </div>
                            <div class="pet-eye pet-eye-right">
                                <div class="pet-eyeball">
                                    <div class="pet-pupil"></div>
                                    <div class="pet-eye-shine"></div>
                                </div>
                                <div class="pet-eyelid"></div>
                            </div>
                        </div>
                        
                        <!-- é¼»å­ -->
                        <div class="pet-nose">
                            <div class="pet-nose-tip"></div>
                            <div class="pet-nose-line"></div>
                        </div>
                        
                        <!-- å˜´å·´ -->
                        <div class="pet-mouth">
                            <div class="pet-mouth-left"></div>
                            <div class="pet-mouth-right"></div>
                        </div>
                        
                        <!-- èƒ¡é¡» -->
                        <div class="pet-whiskers pet-whiskers-left">
                            <div class="pet-whisker"></div>
                            <div class="pet-whisker"></div>
                            <div class="pet-whisker"></div>
                        </div>
                        <div class="pet-whiskers pet-whiskers-right">
                            <div class="pet-whisker"></div>
                            <div class="pet-whisker"></div>
                            <div class="pet-whisker"></div>
                        </div>
                        
                        <!-- è„¸é¢Š -->
                        <div class="pet-cheeks">
                            <div class="pet-cheek pet-cheek-left"></div>
                            <div class="pet-cheek pet-cheek-right"></div>
                        </div>
                    </div>
                </div>
                
                <!-- èº«ä½“ -->
                <div class="pet-body-main">
                    <!-- èƒ¸éƒ¨ç™½æ¯› -->
                    <div class="pet-chest"></div>
                    <!-- èº«ä½“èŠ±çº¹ -->
                    <div class="pet-body-stripes">
                        <div class="pet-stripe"></div>
                        <div class="pet-stripe"></div>
                        <div class="pet-stripe"></div>
                    </div>
                </div>
                
                <!-- å‰è…¿ -->
                <div class="pet-front-legs">
                    <div class="pet-leg pet-front-leg-left">
                        <div class="pet-paw"></div>
                    </div>
                    <div class="pet-leg pet-front-leg-right">
                        <div class="pet-paw"></div>
                    </div>
                </div>
                
                <!-- å°¾å·´ -->
                <div class="pet-tail">
                    <div class="pet-tail-base"></div>
                    <div class="pet-tail-middle"></div>
                    <div class="pet-tail-tip"></div>
                    <!-- å°¾å·´èŠ±çº¹ -->
                    <div class="pet-tail-stripes">
                        <div class="pet-tail-stripe"></div>
                        <div class="pet-tail-stripe"></div>
                        <div class="pet-tail-stripe"></div>
                    </div>
                </div>
            </div>
            
            <!-- UI å…ƒç´  -->
            <div class="pet-level-badge" id="petLevel">1</div>
            <div class="pet-xp-bar">
                <div class="pet-xp-fill" id="petXPFill" style="width: 0%"></div>
            </div>
        </div>
    </div>
    
    <!-- å® ç‰©å³é”®èœå• -->
    <div class="pet-context-menu" id="petContextMenu" style="display: none;">
        <div class="context-menu-item" onclick="togglePetFollowing()">
            <span id="followText">ğŸ‘† æ™ºèƒ½è·Ÿéš</span>
        </div>
        <div class="context-menu-item" onclick="petTeleport()">
            âš¡ ç¬ç§»è¿‡æ¥
        </div>
        <div class="context-menu-item" onclick="petStats()">
            ğŸ“Š æŸ¥çœ‹çŠ¶æ€
        </div>
        <div class="context-menu-item" onclick="togglePetCollapse()">
            ğŸ“¦ æ”¶èµ·/å±•å¼€
        </div>
        <div class="context-menu-item" onclick="resetPet()">
            ğŸ”„ é‡ç½®å® ç‰©
        </div>
    </div>
    
    <!-- ç”¨æˆ·è®¤è¯æ¨¡æ€æ¡† -->
    <div class="auth-modal" id="authModal">
        <div class="auth-card">
            <div class="auth-header">
                <h2 class="auth-title">æ™ºèƒ½æ—¥ç¨‹ç®¡ç†</h2>
                <p class="auth-subtitle">ç™»å½•ä»¥åŒæ­¥æ‚¨çš„æ•°æ®</p>
            </div>
            
            <div class="auth-error" id="authError"></div>
            
            <form class="auth-form" id="authForm" autocomplete="on">
                <input type="email" class="auth-input" id="authEmail" placeholder="é‚®ç®±åœ°å€" required autocomplete="email">
                <input type="password" class="auth-input" id="authPassword" placeholder="å¯†ç " required minlength="6" autocomplete="current-password">
                <button type="submit" class="auth-button auth-button-primary" id="authSubmit">ç™»å½•</button>
            </form>
            
            <div class="auth-divider">
                <span>æˆ–</span>
            </div>
            
            <button class="auth-button auth-button-secondary" id="googleAuth">
                <svg width="18" height="18" viewBox="0 0 24 24" style="margin-right: 8px;">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                ä½¿ç”¨ Google ç™»å½•
            </button>
            
            <div class="auth-toggle">
                <span id="authToggleText">è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span>
                <a href="#" id="authToggleLink">æ³¨å†Œ</a>
            </div>
        </div>
    </div>
    
    
    <div class="container">
        <!-- åº”ç”¨ä¸»ä½“å¸ƒå±€ -->
        <div class="app-layout">
            <!-- å·¦ä¾§å¯¼èˆªæŒ‰é’® -->
            <div class="nav-sidebar">
                <button class="nav-btn active" id="scheduleTab" data-tab="schedule">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    æ—¥ç¨‹ç®¡ç†
                </button>
                <button class="nav-btn" id="goalTab" data-tab="goal">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M9 12l2 2 4-4"></path>
                        <circle cx="12" cy="12" r="10"></circle>
                    </svg>
                    ç›®æ ‡ç®¡ç†
                </button>
            </div>

            <!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
            <div class="content-area">
                <!-- æ—¥ç¨‹ç®¡ç†å†…å®¹ -->
                <div class="tab-content active" id="scheduleContent">
            <div class="main-layout">
            <!-- å·¦ä¾§ä»»åŠ¡é¢æ¿ -->
            <div class="schedule-panel">
                <div class="schedule-header">
                    <div>
                        <span class="selected-date" id="selectedDate">è¯·é€‰æ‹©æ—¥æœŸ</span>
                        <span class="date-weekday" id="selectedWeekday"></span>
                    </div>
                    <div class="progress-info">
                        <span class="progress-text" id="progressText">0/0 (0%)</span>
                        <div class="progress-bar">
                            <div class="progress" id="progressBar" style="width: 0%"></div>
                        </div>
                        <button class="btn btn-danger btn-sm" id="deleteSchedule" style="display: none;">åˆ é™¤æ—¥ç¨‹</button>
                    </div>
                </div>

                <div class="schedule-list" id="scheduleList">
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        <h3>é€‰æ‹©æ—¥æœŸæŸ¥çœ‹ä»»åŠ¡</h3>
                        <p>ç‚¹å‡»å³ä¾§æ—¥å†ä¸­çš„æ—¥æœŸ<br>æ¥æŸ¥çœ‹å’Œç®¡ç†è¯¥æ—¥çš„æ—¶é—´å®‰æ’</p>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§æ—¥å†é¢æ¿ -->
            <div class="calendar-panel">
                <div class="calendar-header">
                    <button class="nav-btn" id="prevMonth" title="ä¸Šä¸€æœˆ">â€¹</button>
                    <div class="month-year" id="monthYear">2024å¹´12æœˆ</div>
                    <button class="nav-btn" id="nextMonth" title="ä¸‹ä¸€æœˆ">â€º</button>
                </div>

                <div class="calendar-grid" id="calendarGrid">
                    <div class="calendar-header-cell">æ—¥</div>
                    <div class="calendar-header-cell">ä¸€</div>
                    <div class="calendar-header-cell">äºŒ</div>
                    <div class="calendar-header-cell">ä¸‰</div>
                    <div class="calendar-header-cell">å››</div>
                    <div class="calendar-header-cell">äº”</div>
                    <div class="calendar-header-cell">å…­</div>
                </div>

                <div class="quick-actions">
                    <button class="btn btn-primary" id="addTodaySchedule">ä»Šæ—¥</button>
                    <button class="btn btn-outline" id="addTomorrowSchedule">æ˜æ—¥</button>
                    <button class="btn btn-secondary" id="addWeekSchedule">æœ¬å‘¨</button>
                    <button class="btn btn-secondary" id="addNextWeekSchedule">ä¸‹å‘¨</button>
                    <button class="btn btn-tertiary" id="openTemplateModal" title="æ¨¡æ¿è®¾ç½®">æ¨¡æ¿</button>
                    <button class="btn btn-sync" id="manualSyncButton" title="æ‰‹åŠ¨åŒæ­¥æ•°æ®">â†» åŒæ­¥</button>
                </div>

                <!-- åŒæ­¥çŠ¶æ€æŠ¥å‘Šè§†å›¾ -->
                <div class="reportview-panel">
                    <div class="reportview-content" id="reportviewContent">
                        <div class="sync-log-container" id="syncLogContainer">
                            <!-- æ—¥å¿—æ¡ç›®å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¨¡æ¿è®¾ç½®çª—å£ -->
            <div class="template-modal" id="templateModal">
                <div class="template-modal-content">
                    <div class="template-modal-header">
                        <h3 class="template-modal-title">æ—¥ç¨‹æ¨¡æ¿è®¾ç½®</h3>
                        <button class="template-close" id="templateModalClose">Ã—</button>
                    </div>
                    
                    <div class="template-modal-body">
                        <div class="template-tabs">
                            <button class="template-tab active" id="workdayTab">å·¥ä½œæ—¥æ¨¡æ¿</button>
                            <button class="template-tab" id="nonWorkdayTab">éå·¥ä½œæ—¥æ¨¡æ¿</button>
                        </div>
                        
                        <!-- å·¥ä½œæ—¥æ¨¡æ¿ -->
                        <div class="template-content active" id="workdayContent">
                            <div class="template-time-list" id="workdayTimeList">
                                <!-- æ—¶é—´æ®µå°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                        
                        <!-- éå·¥ä½œæ—¥æ¨¡æ¿ -->
                        <div class="template-content" id="nonWorkdayContent">
                            <div class="template-time-list" id="nonWorkdayTimeList">
                                <!-- æ—¶é—´æ®µå°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="template-modal-footer">
                        <button class="btn btn-outline" id="templateModalCancel">å–æ¶ˆ</button>
                        <button class="btn btn-primary" id="templateModalSave">ä¿å­˜æ¨¡æ¿</button>
                    </div>
                </div>
            </div>
        </div>
        </div> <!-- å…³é—­æ—¥ç¨‹ç®¡ç†å†…å®¹ -->

        <!-- ç›®æ ‡ç®¡ç†å†…å®¹ -->
        <div class="tab-content" id="goalContent">
            <!-- é¡¶éƒ¨æ ‡é¢˜å’Œæ“ä½œåŒº -->
            <div class="goal-page-header">
                <h1 class="goal-page-title">ç›®æ ‡ç®¡ç†ãƒ»åˆ—è¡¨åŸå‹</h1>
                <div class="goal-page-actions">
                    <button class="btn btn-primary" id="addGoal">+ æ–°ç›®æ ‡</button>
                </div>
            </div>

            <!-- ä¸»å†…å®¹åŒºåŸŸ -->
            <div class="goal-main-content">
                <!-- ç›®æ ‡åˆ—è¡¨ï¼ˆå…¨å®½æ˜¾ç¤ºï¼‰ -->
                <div class="goal-section">
                    <div class="goal-list" id="activeGoalsList">
                        <!-- ç›®æ ‡åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
            </div> <!-- å…³é—­å†…å®¹åŒºåŸŸ -->
        </div> <!-- å…³é—­åº”ç”¨å¸ƒå±€ -->
    </div>

    <!-- è®¾ç½®æŒ‰é’® -->
    <button class="settings-toggle" id="settingsToggle" title="è®¾ç½®">âš™</button>
        <!-- æ‚¬æµ®æ˜¾ç¤ºçš„ç”¨æˆ·ä¿¡æ¯ -->
        <div class="settings-tooltip" id="settingsTooltip">
            <div class="tooltip-content">
                <div class="tooltip-user-info" id="tooltipUserInfo" style="display: none;">
                    <div class="tooltip-email" id="tooltipUserEmail">ç”¨æˆ·é‚®ç®±</div>
                    <button class="tooltip-logout-btn" id="tooltipLogoutBtn">é€€å‡ºç™»å½•</button>
                </div>
                <div class="tooltip-offline" id="tooltipOffline">
                    <div class="tooltip-text">ç¦»çº¿æ¨¡å¼</div>
                </div>
            </div>
        </div>
    </button>

    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button class="theme-toggle" id="themeToggle" title="åˆ‡æ¢ä¸»é¢˜ (T)">â˜€</button>

    <script>
        // ==================== Supabase é…ç½® ====================
        
        const supabaseUrl = 'https://jpkqzqlajatekscukcre.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impwa3F6cWxhamF0ZWtzY3VrY3JlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMTE1ODgsImV4cCI6MjA3MDU4NzU4OH0.bXjCO0gqcCZ3GjQMl7uE8COAwo7LgYBRMoiaHkiVe7s';
        
        // å®‰å…¨åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
        let supabaseClient = null;
        let isSupabaseAvailable = false;
        
        async function initializeSupabase() {
            try {
                // æ£€æŸ¥Supabaseåº“æ˜¯å¦åŠ è½½æˆåŠŸ
                const supabaseLoaded = await checkSupabaseLoaded();
                
                if (supabaseLoaded && typeof supabase !== 'undefined') {
                    const { createClient } = supabase;
                    supabaseClient = createClient(supabaseUrl, supabaseAnonKey);
                    isSupabaseAvailable = true;
                    console.log('Supabaseå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ');
                    return true;
                } else {
                    console.warn('Supabaseåº“æœªåŠ è½½ï¼Œä½¿ç”¨ç¦»çº¿æ¨¡å¼');
                    isSupabaseAvailable = false;
                    return false;
                }
            } catch (error) {
                console.error('Supabaseåˆå§‹åŒ–å¤±è´¥:', error);
                isSupabaseAvailable = false;
                return false;
            }
        }
        
        // ==================== å…¨å±€å˜é‡ ====================
        
        let schedules = [];
        let currentDate = new Date();
        let selectedDate = null;
        let selectedSchedule = null;
        let currentUser = null;
        let isOnline = navigator.onLine;
        let isAuthMode = false; // æ˜¯å¦ä¸ºæ³¨å†Œæ¨¡å¼
        let isHandlingAuth = false; // é˜²æ­¢é‡å¤å¤„ç†è®¤è¯çŠ¶æ€å˜åŒ–
        
        // ç¦»çº¿æ•°æ®ç¼“å­˜
        let offlineSchedules = [];
        let offlinePendingChanges = []; // é‡å‘½åä»¥é¿å…ä¸æ–°çš„åŒæ­¥ç³»ç»Ÿå†²çª
        
        // ==================== è®¤è¯ç®¡ç† ====================
        
        async function initializeAuth() {
            console.log('åˆå§‹åŒ–è®¤è¯ç³»ç»Ÿ...');
            
            // åˆå§‹åŒ–tooltipçŠ¶æ€ä¸ºç¦»çº¿æ¨¡å¼
            document.getElementById('tooltipUserInfo').style.display = 'none';
            document.getElementById('tooltipOffline').style.display = 'block';
            
            // å¦‚æœSupabaseä¸å¯ç”¨ï¼Œè·³è¿‡è®¤è¯ç›´æ¥ä½¿ç”¨ç¦»çº¿æ¨¡å¼
            if (!isSupabaseAvailable || !supabaseClient) {
                console.log('Supabaseä¸å¯ç”¨ï¼Œè·³è¿‡è®¤è¯ï¼Œä½¿ç”¨ç¦»çº¿æ¨¡å¼');
                showNotification('ç½‘ç»œè¿æ¥é—®é¢˜ï¼Œä½¿ç”¨ç¦»çº¿æ¨¡å¼', false);
                loadFromLocalStorage();
                loadTemplatesFromStorage();
                renderCalendar();
                renderScheduleForDate();
                updateTemplateListDisplay();
                return;
            }
            
            try {
                // æ£€æŸ¥ç°æœ‰ä¼šè¯
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (session?.user) {
                    console.log('å‘ç°ç°æœ‰ä¼šè¯:', session.user.email);
                    await handleAuthSuccess(session.user);
                } else {
                    showAuthModal();
                    // å¦‚æœæ²¡æœ‰ç”¨æˆ·ä¼šè¯ï¼ŒåŠ è½½æœ¬åœ°æ•°æ®ä½œä¸ºfallback
                    loadFromLocalStorage();
                    loadTemplatesFromStorage();
                    renderCalendar();
                    renderScheduleForDate();
                    updateTemplateListDisplay();
                }
                
                // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
                supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    console.log('è®¤è¯çŠ¶æ€å˜åŒ–:', event, session?.user?.email);
                    
                    if (event === 'SIGNED_IN' && session?.user) {
                        await handleAuthSuccess(session.user);
                    } else if (event === 'SIGNED_OUT') {
                        handleAuthLogout();
                    }
                });
            } catch (error) {
                console.error('è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                showNotification('è®¤è¯ç³»ç»Ÿå¼‚å¸¸ï¼Œä½¿ç”¨ç¦»çº¿æ¨¡å¼', false);
                // Fallbackåˆ°ç¦»çº¿æ¨¡å¼
                loadFromLocalStorage();
                loadTemplatesFromStorage();
                renderCalendar();
                renderScheduleForDate();
                updateTemplateListDisplay();
            }
        }
        
        function showAuthModal() {
            document.getElementById('authModal').classList.remove('hidden');
            document.getElementById('tooltipUserInfo').style.display = 'none';
            document.getElementById('tooltipOffline').style.display = 'block';
            // ç§»é™¤äº†å¯¹å·²åˆ é™¤çš„syncStatuså…ƒç´ çš„å¼•ç”¨
        }
        
        function hideAuthModal() {
            document.getElementById('authModal').classList.add('hidden');
        }
        
        async function handleAuthSuccess(user) {
            if (isHandlingAuth) {
                console.log('è®¤è¯å¤„ç†ä¸­ï¼Œè·³è¿‡é‡å¤è°ƒç”¨');
                return;
            }
            
            isHandlingAuth = true;
            console.log('è®¤è¯æˆåŠŸ:', user.email);
            currentUser = user;
            
            // éšè—è®¤è¯çª—å£ï¼Œæ›´æ–°tooltipç”¨æˆ·ä¿¡æ¯
            hideAuthModal();
            document.getElementById('tooltipUserEmail').textContent = user.email;
            document.getElementById('tooltipUserInfo').style.display = 'flex';
            document.getElementById('tooltipOffline').style.display = 'none';
            // ç§»é™¤äº†å¯¹å·²åˆ é™¤çš„syncStatuså…ƒç´ çš„å¼•ç”¨
            
            // æ›´æ–°æ‰‹åŠ¨åŒæ­¥æŒ‰é’®çŠ¶æ€
            updateManualSyncButtonState();
            
            // åŒæ­¥æ•°æ®
            await syncDataFromServer();
            
            // è®¤è¯æˆåŠŸåæ‰§è¡Œä»»åŠ¡æµè½¬
            setTimeout(() => {
                console.log('ç”¨æˆ·è®¤è¯å®Œæˆï¼Œæ‰§è¡Œä»»åŠ¡æµè½¬æ£€æŸ¥');
                processUnfinishedTasks();
                // é‡ç½®æ ‡å¿—ä½
                isHandlingAuth = false;
            }, 500);
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showNotification(`æ¬¢è¿å›æ¥ï¼Œ${user.email.split('@')[0]}ï¼`, true);
        }
        
        function handleAuthLogout() {
            console.log('ç”¨æˆ·ç™»å‡º');
            currentUser = null;
            isHandlingAuth = false; // é‡ç½®è®¤è¯å¤„ç†æ ‡å¿—
            
            // æ¸…ç©ºæœ¬åœ°æ•°æ®
            schedules = [];
            selectedSchedule = null;
            
            // æ›´æ–°æ‰‹åŠ¨åŒæ­¥æŒ‰é’®çŠ¶æ€
            updateManualSyncButtonState();
            
            // é‡ç½®ç•Œé¢
            showAuthModal();
            renderCalendar();
            renderScheduleForDate();
            
            showNotification('å·²é€€å‡ºç™»å½•', false);
        }
        
        function toggleAuthMode() {
            isAuthMode = !isAuthMode;
            
            if (isAuthMode) {
                document.getElementById('authSubmit').textContent = 'æ³¨å†Œ';
                document.getElementById('authToggleText').textContent = 'å·²æœ‰è´¦å·ï¼Ÿ';
                document.getElementById('authToggleLink').textContent = 'ç™»å½•';
            } else {
                document.getElementById('authSubmit').textContent = 'ç™»å½•';
                document.getElementById('authToggleText').textContent = 'è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ';
                document.getElementById('authToggleLink').textContent = 'æ³¨å†Œ';
            }
        }
        
        function showAuthError(message) {
            const errorEl = document.getElementById('authError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            
            // ç¡®ä¿è¾“å…¥æ¡†ä¸ä¼šå› ä¸ºé”™è¯¯æ˜¾ç¤ºè€Œè¢«æ¸…ç©º
            setTimeout(() => {
                const emailInput = document.getElementById('authEmail');
                const passwordInput = document.getElementById('authPassword');
                
                // å¦‚æœè¾“å…¥æ¡†ä¸ºç©ºä½†åº”è¯¥æœ‰å€¼ï¼Œåˆ™ä¿æŒä¹‹å‰çš„å€¼
                if (emailInput && !emailInput.value && emailInput.dataset.lastValue) {
                    emailInput.value = emailInput.dataset.lastValue;
                }
            }, 100);
            
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }
        
        async function handleEmailAuth(email, password) {
            console.log('å¼€å§‹å¤„ç†é‚®ç®±è®¤è¯:', email);
            
            // æ£€æŸ¥Supabaseæ˜¯å¦å¯ç”¨
            if (!isSupabaseAvailable || !supabaseClient) {
                showAuthError('ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œæ— æ³•è¿›è¡Œåœ¨çº¿è®¤è¯');
                return;
            }
            
            // è·å–è¾“å…¥æ¡†å…ƒç´ ä»¥ä¾¿åœ¨éœ€è¦æ—¶æ¢å¤å€¼
            const emailInput = document.getElementById('authEmail');
            const passwordInput = document.getElementById('authPassword');
            const originalEmail = email;
            const originalPassword = password;
            
            try {
                const authEl = document.getElementById('authSubmit');
                authEl.textContent = 'å¤„ç†ä¸­...';
                authEl.disabled = true;
                
                let result;
                
                if (isAuthMode) {
                    // æ³¨å†Œ
                    console.log('æ‰§è¡Œæ³¨å†Œæ“ä½œ');
                    result = await supabaseClient.auth.signUp({
                        email,
                        password,
                    });
                    
                    if (result.error) throw result.error;
                    
                    if (result.data.user && !result.data.session) {
                        showNotification('è¯·æ£€æŸ¥æ‚¨çš„é‚®ç®±å¹¶ç¡®è®¤æ³¨å†Œ', true);
                        toggleAuthMode(); // åˆ‡æ¢å›ç™»å½•æ¨¡å¼
                        // æ³¨å†ŒæˆåŠŸåä¿ç•™é‚®ç®±ï¼Œæ¸…ç©ºå¯†ç 
                        emailInput.value = originalEmail;
                        passwordInput.value = '';
                    } else if (result.data.user && result.data.session) {
                        // æ³¨å†ŒæˆåŠŸå¹¶ç›´æ¥ç™»å½•
                        console.log('æ³¨å†ŒæˆåŠŸå¹¶ç›´æ¥ç™»å½•:', result.data.user);
                        emailInput.value = '';
                        passwordInput.value = '';
                        // ä¸»åŠ¨è°ƒç”¨handleAuthSuccessä»¥ç¡®ä¿ç™»å½•çª—å£è¢«éšè—
                        await handleAuthSuccess(result.data.user);
                    }
                } else {
                    // ç™»å½•
                    console.log('æ‰§è¡Œç™»å½•æ“ä½œ');
                    result = await supabaseClient.auth.signInWithPassword({
                        email,
                        password,
                    });
                    
                    if (result.error) throw result.error;
                    
                    console.log('ç™»å½•æˆåŠŸï¼Œç”¨æˆ·ä¿¡æ¯:', result.data.user);
                    // ç™»å½•æˆåŠŸï¼Œæ¸…ç©ºè¾“å…¥æ¡†
                    emailInput.value = '';
                    passwordInput.value = '';
                    
                    // ä¸»åŠ¨è°ƒç”¨handleAuthSuccessä»¥ç¡®ä¿ç™»å½•çª—å£è¢«éšè—
                    await handleAuthSuccess(result.data.user);
                }
                
            } catch (error) {
                console.error('è®¤è¯é”™è¯¯:', error);
                let errorMessage = 'è®¤è¯å¤±è´¥ï¼Œè¯·é‡è¯•';
                
                if (error.message.includes('Invalid login credentials')) {
                    errorMessage = 'é‚®ç®±æˆ–å¯†ç é”™è¯¯';
                } else if (error.message.includes('Email not confirmed')) {
                    errorMessage = 'è¯·å…ˆç¡®è®¤æ‚¨çš„é‚®ç®±';
                } else if (error.message.includes('User already registered')) {
                    errorMessage = 'è¯¥é‚®ç®±å·²æ³¨å†Œï¼Œè¯·ç›´æ¥ç™»å½•';
                    toggleAuthMode();
                } else if (error.message.includes('fetch')) {
                    errorMessage = 'ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
                } else {
                    errorMessage = error.message;
                }
                
                // è®¤è¯å¤±è´¥æ—¶æ¢å¤è¾“å…¥æ¡†çš„å€¼
                console.log('è®¤è¯å¤±è´¥ï¼Œæ¢å¤è¾“å…¥æ¡†å€¼');
                emailInput.value = originalEmail;
                passwordInput.value = originalPassword;
                
                showAuthError(errorMessage);
            } finally {
                const authEl = document.getElementById('authSubmit');
                authEl.textContent = isAuthMode ? 'æ³¨å†Œ' : 'ç™»å½•';
                authEl.disabled = false;
            }
        }
        
        async function handleGoogleAuth() {
            try {
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin
                    }
                });
                
                if (error) throw error;
                
            } catch (error) {
                console.error('Googleè®¤è¯é”™è¯¯:', error);
                showAuthError('Googleç™»å½•å¤±è´¥ï¼š' + error.message);
            }
        }
        
        async function logout() {
            try {
                await supabaseClient.auth.signOut();
            } catch (error) {
                console.error('ç™»å‡ºé”™è¯¯:', error);
                showNotification('ç™»å‡ºå¤±è´¥', false);
            }
        }
        
        // ==================== æ•°æ®åŒæ­¥ç®¡ç† ====================
        
        // å®‰å…¨æ£€æŸ¥Supabaseæ˜¯å¦å¯ç”¨
        function checkSupabaseAvailable() {
            if (!isSupabaseAvailable || !supabaseClient) {
                console.warn('Supabaseä¸å¯ç”¨ï¼Œè·³è¿‡äº‘ç«¯æ“ä½œ');
                return false;
            }
            return true;
        }
        
        function updateSyncStatus(status, text) {
            // ä»…ä½¿ç”¨å¢å¼ºåŒæ­¥ç³»ç»Ÿæ›´æ–°çŠ¶æ€ï¼Œä¸å†æ›´æ–°æ—§çš„åŒæ­¥æŒ‡ç¤ºå™¨
            if (window.enhancedSync) {
                const statusMap = {
                    'syncing': 'syncing',
                    'offline': 'error',
                    '': 'success',
                    'error': 'error'
                };
                const enhancedStatus = statusMap[status] || 'idle';
                window.enhancedSync.updateStatus(enhancedStatus, text);
            }
        }
        
        async function syncDataFromServer() {
            if (!currentUser || !checkSupabaseAvailable()) {
                console.log('ç”¨æˆ·æœªç™»å½•æˆ–Supabaseä¸å¯ç”¨ï¼Œè·³è¿‡æ•°æ®åŒæ­¥');
                return;
            }
            
            updateSyncStatus('syncing', 'åŒæ­¥ä¸­...');
            
            try {
                // 1. å¤‡ä»½å½“å‰æœ¬åœ°æ•°æ®
                const localBackup = {
                    schedules: JSON.parse(JSON.stringify(schedules)),
                    workdayTemplate: JSON.parse(JSON.stringify(workdayTemplate)),
                    nonWorkdayTemplate: JSON.parse(JSON.stringify(nonWorkdayTemplate))
                };
                
                console.log('æœ¬åœ°æ•°æ®å¤‡ä»½å®Œæˆï¼Œæœ¬åœ°æ—¥ç¨‹æ•°é‡:', localBackup.schedules.length);
                
                // 2. è·å–æœåŠ¡å™¨æ•°æ®
                const { data: schedulesData, error: schedulesError } = await supabaseClient
                    .from('schedules')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('day_id', { ascending: false });
                
                if (schedulesError) {
                    if (schedulesError.message.includes('relation') && schedulesError.message.includes('does not exist')) {
                        console.error('æ•°æ®åº“è¡¨ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»ºæ•°æ®åº“è¡¨');
                        showNotification('æ•°æ®åº“æœªåˆå§‹åŒ–ï¼Œè¯·å…ˆåˆ›å»ºæ•°æ®åº“è¡¨', false);
                        updateSyncStatus('offline', 'éœ€è¦åˆå§‹åŒ–');
                        return;
                    }
                    throw schedulesError;
                }
                
                console.log('æœåŠ¡å™¨æ•°æ®è·å–å®Œæˆï¼ŒæœåŠ¡å™¨æ—¥ç¨‹æ•°é‡:', schedulesData ? schedulesData.length : 0);
                
                // 3. æ™ºèƒ½åˆå¹¶æ•°æ®
                const mergedSchedules = mergeScheduleData(localBackup.schedules, schedulesData || []);
                
                console.log('æ•°æ®åˆå¹¶å®Œæˆï¼Œæœ€ç»ˆæ—¥ç¨‹æ•°é‡:', mergedSchedules.length);
                
                // 4. è·å–å…¶ä»–æ•°æ®ï¼ˆæ¨¡æ¿ã€è®¾ç½®ï¼‰
                const { data: templatesData } = await supabaseClient
                    .from('templates')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                const { data: settingsData } = await supabaseClient
                    .from('user_settings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                // 5. æ›´æ–°æœ¬åœ°æ•°æ®
                schedules = mergedSchedules;
                
                // æ›´æ–°æ¨¡æ¿
                if (templatesData && templatesData.length > 0) {
                    templatesData.forEach(template => {
                        if (template.template_type === 'workday') {
                            workdayTemplate = template.template_data || {};
                        } else if (template.template_type === 'nonworkday') {
                            nonWorkdayTemplate = template.template_data || {};
                        }
                    });
                }
                
                // æ›´æ–°ç”¨æˆ·è®¾ç½®
                if (settingsData) {
                    if (settingsData.theme) {
                        const newTheme = settingsData.theme;
                        document.body.setAttribute('data-theme', newTheme);
                        updateThemeIcon(newTheme);
                        localStorage.setItem('calendarTheme', newTheme);
                    }
                    
                    if (settingsData.current_date_data) {
                        const dateData = settingsData.current_date_data;
                        currentDate = new Date(dateData.year, dateData.month, dateData.day);
                    }
                }
                
                // 6. ä¿å­˜åˆå¹¶åçš„æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
                saveToLocalStorage();
                
                // 7. å®‰å…¨åœ°é‡æ–°æ¸²æŸ“ç•Œé¢
                try {
                    renderCalendar();
                    renderScheduleForDate();
                    updateTemplateListDisplay();
                } catch (renderError) {
                    console.warn('ç•Œé¢æ¸²æŸ“å‡ºç°é—®é¢˜ï¼Œä½†æ•°æ®åŒæ­¥å·²å®Œæˆ:', renderError.message);
                }
                
                updateSyncStatus('', 'å·²åŒæ­¥');
                console.log('æ•°æ®åŒæ­¥å®Œæˆ');
                
                // 8. å¦‚æœæœ‰æ•°æ®åˆå¹¶ï¼Œæç¤ºç”¨æˆ·
                const addedCount = mergedSchedules.length - Math.max(localBackup.schedules.length, schedulesData?.length || 0);
                if (addedCount > 0) {
                    showNotification(`æ•°æ®åŒæ­¥å®Œæˆï¼Œåˆå¹¶äº† ${addedCount} æ¡æ–°æ•°æ®`, true);
                }
                
            } catch (error) {
                console.error('æ•°æ®åŒæ­¥å¤±è´¥:', error);
                updateSyncStatus('offline', 'åŒæ­¥å¤±è´¥');
                showNotification('æ•°æ®åŒæ­¥å¤±è´¥ï¼Œå·²ä¿ç•™æœ¬åœ°æ•°æ®: ' + error.message, false);
            }
        }
        
        // æ”¹è¿›çš„ä¿å­˜å‡½æ•° - ä½¿ç”¨å¢å¼ºåŒæ­¥ç³»ç»Ÿ
        async function saveToSupabaseWithRetry(maxRetries = 3) {
            // æ€»æ˜¯å…ˆä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œç¡®ä¿æ•°æ®ä¸ä¸¢å¤±
            saveToLocalStorage();
            
            if (!currentUser || !isOnline || !checkSupabaseAvailable()) {
                console.log('ç”¨æˆ·æœªç™»å½•ã€ç¦»çº¿æˆ–Supabaseä¸å¯ç”¨ï¼Œæ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°');
                return;
            }
            
            // ä½¿ç”¨å¢å¼ºåŒæ­¥ç³»ç»Ÿè¿›è¡Œä¿å­˜
            return await window.enhancedSync.saveWithRetry(async () => {
                // ä¿å­˜å‰éªŒè¯æ•°æ®å®Œæ•´æ€§
                if (!validateDataIntegrity()) {
                    throw new Error('æ•°æ®å®Œæ•´æ€§éªŒè¯å¤±è´¥');
                }
                
                // å¹¶è¡Œä¿å­˜æ—¥ç¨‹å’Œç”¨æˆ·è®¾ç½®
                await Promise.all([
                    saveSchedulesToSupabase(),
                    saveUserSettingsToSupabase()
                ]);
                
                console.log('æ•°æ®ä¿å­˜æˆåŠŸ');
                return { success: true, timestamp: new Date().toISOString() };
                
            }, {
                maxRetries,
                description: 'ä¿å­˜æ—¥ç¨‹æ•°æ®',
                timeout: 15000
            });
        }

        // ä¿æŒåŸå‡½æ•°å‘åå…¼å®¹
        async function saveToSupabase() {
            return await saveToSupabaseWithRetry();
        }
        
        async function saveSchedulesToSupabase() {
            if (!currentUser) return;
            
            console.log('å¼€å§‹ä¿å­˜æ—¥ç¨‹åˆ°Supabaseï¼Œå½“å‰æ—¥ç¨‹æ•°é‡:', schedules.length);
            
            // è·å–æ‰€æœ‰éœ€è¦åŒæ­¥çš„æ—¥ç¨‹
            for (const schedule of schedules) {
                try {
                    console.log('æ­£åœ¨ä¿å­˜æ—¥ç¨‹:', schedule);
                    
                    // æ£€æŸ¥å¿…è¦å­—æ®µ
                    if (!schedule.dayId) {
                        console.error('æ—¥ç¨‹ç¼ºå°‘dayIdå­—æ®µ:', schedule);
                        continue;
                    }
                    
                    const scheduleData = {
                        user_id: currentUser.id,
                        day_id: schedule.dayId,
                        date: schedule.date,
                        weekday: schedule.weekday,
                        items: schedule.items || []
                    };
                    
                    console.log('å‡†å¤‡ä¿å­˜çš„æ•°æ®:', scheduleData);
                    
                    // å…ˆå°è¯•æ’å…¥ï¼Œå¦‚æœå¤±è´¥åˆ™æ›´æ–°
                    let { error: insertError } = await supabaseClient
                        .from('schedules')
                        .insert([scheduleData]);
                    
                    if (insertError) {
                        if (insertError.code === '23505') {
                            // å”¯ä¸€çº¦æŸå†²çªï¼Œè¯´æ˜è®°å½•å·²å­˜åœ¨ï¼Œæ‰§è¡Œæ›´æ–°æ“ä½œ
                            console.log('è®°å½•å·²å­˜åœ¨ï¼Œæ‰§è¡Œæ›´æ–°æ“ä½œ');
                            const { error: updateError } = await supabaseClient
                                .from('schedules')
                                .update(scheduleData)
                                .eq('user_id', currentUser.id)
                                .eq('day_id', schedule.dayId);
                            
                            if (updateError) {
                                console.error('æ›´æ–°æ“ä½œå¤±è´¥:', updateError);
                                throw updateError;
                            }
                        } else {
                            console.error('æ’å…¥æ“ä½œå¤±è´¥:', insertError);
                            throw insertError;
                        }
                    }
                    
                    console.log('æ—¥ç¨‹ä¿å­˜æˆåŠŸ:', schedule.dayId);
                    
                } catch (error) {
                    console.error(`ä¿å­˜æ—¥ç¨‹ ${schedule.dayId} å¤±è´¥:`, error);
                    throw error;
                }
            }
            
            console.log('æ‰€æœ‰æ—¥ç¨‹ä¿å­˜å®Œæˆ');
        }
        
        async function saveUserSettingsToSupabase() {
            if (!currentUser) return;
            
            try {
                const settingsData = {
                    user_id: currentUser.id,
                    theme: document.body.getAttribute('data-theme') || 'light',
                    current_date_data: {
                        year: currentDate.getFullYear(),
                        month: currentDate.getMonth(),
                        day: currentDate.getDate()
                    }
                };
                
                // å…ˆå°è¯•æ’å…¥ï¼Œå¦‚æœå¤±è´¥åˆ™æ›´æ–°
                let { error: insertError } = await supabaseClient
                    .from('user_settings')
                    .insert([settingsData]);
                
                if (insertError) {
                    if (insertError.code === '23505') {
                        // å”¯ä¸€çº¦æŸå†²çªï¼Œè¯´æ˜è®°å½•å·²å­˜åœ¨ï¼Œæ‰§è¡Œæ›´æ–°æ“ä½œ
                        const { error: updateError } = await supabaseClient
                            .from('user_settings')
                            .update(settingsData)
                            .eq('user_id', currentUser.id);
                        
                        if (updateError) throw updateError;
                    } else {
                        throw insertError;
                    }
                }
                
            } catch (error) {
                console.error('ä¿å­˜ç”¨æˆ·è®¾ç½®å¤±è´¥:', error);
                throw error;
            }
        }
        
        async function saveTemplatesToSupabase() {
            if (!currentUser) return;
            
            try {
                // ä¿å­˜å·¥ä½œæ—¥æ¨¡æ¿
                if (Object.keys(workdayTemplate).length > 0) {
                    const workdayData = {
                        user_id: currentUser.id,
                        template_type: 'workday',
                        template_data: workdayTemplate
                    };
                    
                    let { error: insertError } = await supabaseClient
                        .from('templates')
                        .insert([workdayData]);
                    
                    if (insertError) {
                        if (insertError.code === '23505') {
                            // è®°å½•å·²å­˜åœ¨ï¼Œæ‰§è¡Œæ›´æ–°
                            const { error: updateError } = await supabaseClient
                                .from('templates')
                                .update(workdayData)
                                .eq('user_id', currentUser.id)
                                .eq('template_type', 'workday');
                            
                            if (updateError) throw updateError;
                        } else {
                            throw insertError;
                        }
                    }
                }
                
                // ä¿å­˜éå·¥ä½œæ—¥æ¨¡æ¿
                if (Object.keys(nonWorkdayTemplate).length > 0) {
                    const nonWorkdayData = {
                        user_id: currentUser.id,
                        template_type: 'nonworkday',
                        template_data: nonWorkdayTemplate
                    };
                    
                    let { error: insertError } = await supabaseClient
                        .from('templates')
                        .insert([nonWorkdayData]);
                    
                    if (insertError) {
                        if (insertError.code === '23505') {
                            // è®°å½•å·²å­˜åœ¨ï¼Œæ‰§è¡Œæ›´æ–°
                            const { error: updateError } = await supabaseClient
                                .from('templates')
                                .update(nonWorkdayData)
                                .eq('user_id', currentUser.id)
                                .eq('template_type', 'nonworkday');
                            
                            if (updateError) throw updateError;
                        } else {
                            throw insertError;
                        }
                    }
                }
                
            } catch (error) {
                console.error('ä¿å­˜æ¨¡æ¿å¤±è´¥:', error);
                throw error;
            }
        }
        
        async function deleteScheduleFromSupabase(dayId) {
            if (!currentUser || !isOnline) return;
            
            try {
                const { error } = await supabaseClient
                    .from('schedules')
                    .delete()
                    .eq('user_id', currentUser.id)
                    .eq('day_id', dayId);
                
                if (error) throw error;
                
            } catch (error) {
                console.error('åˆ é™¤Supabaseæ—¥ç¨‹å¤±è´¥:', error);
                throw error;
            }
        }
        
        async function processPendingChanges() {
            // å¤„ç†ç¦»çº¿æœŸé—´ç´¯ç§¯çš„å˜æ›´
            if (offlinePendingChanges.length > 0) {
                console.log('å¤„ç†ç¦»çº¿æœŸé—´çš„å˜æ›´:', offlinePendingChanges.length);
                // è¿™é‡Œå°†å®ç°å†²çªè§£å†³é€»è¾‘
                offlinePendingChanges = []; // ä¸´æ—¶æ¸…ç©º
            }
        }
        
        // ==================== æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡ ====================
        
        let syncStats = {
            totalSyncs: 0,
            incrementalSyncs: 0,
            fullSyncs: 0,
            failedSyncs: 0,
            savedBytes: 0,
            lastSyncTime: null
        };

        function updateSyncStats(type, success = true, dataSize = 0) {
            syncStats.totalSyncs++;
            
            if (success) {
                if (type === 'incremental') {
                    syncStats.incrementalSyncs++;
                } else if (type === 'full') {
                    syncStats.fullSyncs++;
                }
                syncStats.savedBytes += dataSize;
                syncStats.lastSyncTime = new Date().toISOString();
            } else {
                syncStats.failedSyncs++;
            }
            
            // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯åˆ°æ§åˆ¶å°
            console.log('åŒæ­¥ç»Ÿè®¡:', {
                æ€»åŒæ­¥æ¬¡æ•°: syncStats.totalSyncs,
                å¢é‡åŒæ­¥: syncStats.incrementalSyncs,
                å…¨é‡åŒæ­¥: syncStats.fullSyncs,
                å¤±è´¥æ¬¡æ•°: syncStats.failedSyncs,
                æˆåŠŸç‡: ((syncStats.totalSyncs - syncStats.failedSyncs) / syncStats.totalSyncs * 100).toFixed(1) + '%',
                å·²ä¿å­˜æ•°æ®: (syncStats.savedBytes / 1024).toFixed(2) + 'KB',
                æœ€ååŒæ­¥: syncStats.lastSyncTime ? new Date(syncStats.lastSyncTime).toLocaleString() : 'æ— '
            });
        }

        // è·å–åŒæ­¥ç»Ÿè®¡ä¿¡æ¯
        function getSyncStats() {
            return {
                ...syncStats,
                successRate: ((syncStats.totalSyncs - syncStats.failedSyncs) / syncStats.totalSyncs * 100).toFixed(1) + '%',
                savedKB: (syncStats.savedBytes / 1024).toFixed(2) + 'KB'
            };
        }

        // ==================== ä¼˜åŒ–çš„æ•°æ®åŒæ­¥ç³»ç»Ÿ ====================
        
        let pendingChanges = new Set(); // è®°å½•å¾…æäº¤çš„æ—¥ç¨‹ID
        let saveTimer = null; // é˜²æŠ–å®šæ—¶å™¨
        let updateTimer = null; // ä»»åŠ¡æ›´æ–°é˜²æŠ–å®šæ—¶å™¨
        
        // é˜²æŠ–ä¿å­˜å‡½æ•° - ä½¿ç”¨å¢å¼ºåŒæ­¥ç³»ç»Ÿ
        function saveToSupabaseDebounced(changedDayId) {
            // è®°å½•éœ€è¦ä¿å­˜çš„æ—¥ç¨‹
            if (changedDayId) {
                pendingChanges.add(changedDayId);
                console.log('æ·»åŠ åˆ°å¾…åŒæ­¥åˆ—è¡¨:', changedDayId, 'å¾…åŒæ­¥æ•°é‡:', pendingChanges.size);
                // æ›´æ–°æ‰‹åŠ¨åŒæ­¥æŒ‰é’®çŠ¶æ€
                updateManualSyncButtonState();
            }
            
            // ä½¿ç”¨å¢å¼ºåŒæ­¥ç³»ç»Ÿçš„é˜²æŠ–ä¿å­˜
            window.enhancedSync.debouncedSave(async () => {
                // å¢é‡ä¿å­˜é€»è¾‘
                if (!currentUser || pendingChanges.size === 0) {
                    return { success: true, message: 'æ— éœ€ä¿å­˜' };
                }
                
                const changedScheduleIds = Array.from(pendingChanges);
                const changedSchedules = schedules.filter(s => changedScheduleIds.includes(s.dayId));
                
                console.log('å¼€å§‹å¢é‡ä¿å­˜ï¼Œå¾…ä¿å­˜æ•°é‡:', changedSchedules.length);
                
                for (const schedule of changedSchedules) {
                    const scheduleData = {
                        user_id: currentUser.id,
                        day_id: schedule.dayId,
                        date: schedule.date,
                        weekday: schedule.weekday,
                        items: schedule.items || [],
                        created_at: schedule.createdAt || new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    
                    // å…ˆå°è¯•æ’å…¥ï¼Œå¦‚æœå¤±è´¥åˆ™æ›´æ–°
                    let { error: insertError } = await supabaseClient
                        .from('schedules')
                        .insert([scheduleData]);
                    
                    if (insertError) {
                        if (insertError.code === '23505') {
                            // å”¯ä¸€çº¦æŸå†²çªï¼Œè¯´æ˜è®°å½•å·²å­˜åœ¨ï¼Œæ‰§è¡Œæ›´æ–°æ“ä½œ
                            console.log('è®°å½•å·²å­˜åœ¨ï¼Œæ‰§è¡Œæ›´æ–°æ“ä½œ:', schedule.dayId);
                            const { error: updateError } = await supabaseClient
                                .from('schedules')
                                .update(scheduleData)
                                .eq('user_id', currentUser.id)
                                .eq('day_id', schedule.dayId);
                            
                            if (updateError) {
                                console.error('æ›´æ–°æ“ä½œå¤±è´¥:', updateError);
                                throw updateError;
                            }
                            console.log('æ›´æ–°æˆåŠŸ:', schedule.dayId);
                        } else {
                            console.error('æ’å…¥æ“ä½œå¤±è´¥:', insertError);
                            throw insertError;
                        }
                    }
                }
                
                // æ¸…ç†å·²ä¿å­˜çš„å˜æ›´è®°å½•
                pendingChanges.clear();
                updateManualSyncButtonState();
                console.log('å¢é‡ä¿å­˜å®Œæˆ');
                
                return { 
                    success: true, 
                    savedCount: changedSchedules.length,
                    timestamp: new Date().toISOString()
                };
                
            }, `ä¿å­˜å˜æ›´ ${changedDayId || ''}`);
        }

        // å¢é‡ä¿å­˜å‡½æ•°ï¼šåªä¿å­˜ä¿®æ”¹è¿‡çš„æ•°æ®
        async function saveChangedSchedulesToSupabase() {
            if (!currentUser || pendingChanges.size === 0) return;
            
            const startTime = Date.now();
            console.log('å¼€å§‹å¢é‡ä¿å­˜ï¼Œå¾…ä¿å­˜æ•°é‡:', pendingChanges.size);
            
            const changedScheduleIds = Array.from(pendingChanges);
            const changedSchedules = schedules.filter(s => changedScheduleIds.includes(s.dayId));
            
            let totalDataSize = 0;
            
            for (const schedule of changedSchedules) {
                try {
                    const scheduleData = {
                        user_id: currentUser.id,
                        day_id: schedule.dayId,
                        date: schedule.date,
                        weekday: schedule.weekday,
                        items: schedule.items || [],
                        updated_at: new Date().toISOString()
                    };
                    
                    // è®¡ç®—æ•°æ®å¤§å°
                    totalDataSize += JSON.stringify(scheduleData).length;
                    
                    // å…ˆå°è¯•æ’å…¥ï¼Œå¦‚æœå¤±è´¥åˆ™æ›´æ–°
                    let { error: insertError } = await supabaseClient
                        .from('schedules')
                        .insert([scheduleData]);
                    
                    if (insertError) {
                        if (insertError.code === '23505') {
                            // å”¯ä¸€çº¦æŸå†²çªï¼Œè¯´æ˜è®°å½•å·²å­˜åœ¨ï¼Œæ‰§è¡Œæ›´æ–°æ“ä½œ
                            console.log('è®°å½•å·²å­˜åœ¨ï¼Œæ‰§è¡Œæ›´æ–°æ“ä½œ:', schedule.date);
                            const { error: updateError } = await supabaseClient
                                .from('schedules')
                                .update(scheduleData)
                                .eq('user_id', currentUser.id)
                                .eq('day_id', schedule.dayId);
                            
                            if (updateError) {
                                console.error('æ›´æ–°æ“ä½œå¤±è´¥:', updateError);
                                throw updateError;
                            }
                            console.log('æ›´æ–°æˆåŠŸ:', schedule.date);
                        } else {
                            console.error('æ’å…¥æ“ä½œå¤±è´¥:', insertError);
                            throw insertError;
                        }
                    } else {
                        console.log('æ’å…¥æˆåŠŸ:', schedule.date);
                    }
                    
                } catch (error) {
                    console.error('å¢é‡ä¿å­˜å¤±è´¥:', schedule.date, error);
                    // æ›´æ–°å¤±è´¥ç»Ÿè®¡
                    updateSyncStats('incremental', false);
                    throw error;
                }
            }
            
            // æ¸…ç©ºå¾…æäº¤åˆ—è¡¨
            pendingChanges.clear();
            
            const duration = Date.now() - startTime;
            console.log(`å¢é‡ä¿å­˜å®Œæˆï¼Œè€—æ—¶ ${duration}msï¼Œæ•°æ®é‡ ${(totalDataSize/1024).toFixed(2)}KB`);
            
            // æ›´æ–°æˆåŠŸç»Ÿè®¡
            updateSyncStats('incremental', true, totalDataSize);
        }

        // æ›´æ–°åŒæ­¥çŠ¶æ€æŒ‡ç¤ºå™¨ï¼ˆç°åœ¨åªæ›´æ–°reportviewæ—¥å¿—ï¼‰
        function updateSyncIndicator(status) {
            // ç§»é™¤äº†æ—§çš„æµ®åŠ¨çŠ¶æ€æŒ‡ç¤ºå™¨ï¼Œç°åœ¨æ‰€æœ‰çŠ¶æ€éƒ½é€šè¿‡reportviewæ—¥å¿—æ˜¾ç¤º
            console.log(`[åŒæ­¥æŒ‡ç¤ºå™¨] çŠ¶æ€: ${status} (é€šè¿‡reportviewæ˜¾ç¤º)`);
            
            // æ ¹æ®çŠ¶æ€æ·»åŠ ç›¸åº”çš„æ—¥å¿—
            if (window.enhancedSync) {
                let message = '';
                let logType = 'info';
                
                switch(status) {
                    case 'editing':
                        message = 'æ­£åœ¨ç¼–è¾‘ä»»åŠ¡';
                        logType = 'info';
                        break;
                    case 'pending':
                        message = `æœ‰ ${pendingChanges.size} ä¸ªå¾…åŒæ­¥çš„ä»»åŠ¡`;
                        logType = 'warning';
                        break;
                    case 'syncing':
                        message = 'å¼€å§‹åŒæ­¥ä»»åŠ¡åˆ°äº‘ç«¯';
                        logType = 'syncing';
                        break;
                    case 'synced':
                        message = 'ä»»åŠ¡åŒæ­¥å®Œæˆ';
                        logType = 'success';
                        break;
                    case 'error':
                        message = 'ä»»åŠ¡åŒæ­¥å¤±è´¥';
                        logType = 'error';
                        break;
                }
                
                if (message) {
                    window.enhancedSync.updateStatus(logType, message);
                }
            }
        }

        // å¼ºåˆ¶åŒæ­¥æ‰€æœ‰æ•°æ®
        async function forceSyncAll() {
            try {
                const startTime = Date.now();
                updateSyncIndicator('syncing');
                
                // å°†æ‰€æœ‰æ—¥ç¨‹åŠ å…¥å¾…æäº¤åˆ—è¡¨
                schedules.forEach(s => pendingChanges.add(s.dayId));
                
                console.log(`å¼€å§‹å¼ºåˆ¶åŒæ­¥ ${schedules.length} æ¡æ—¥ç¨‹`);
                
                await saveChangedSchedulesToSupabase();
                
                const duration = Date.now() - startTime;
                
                updateSyncIndicator('synced');
                showNotification(`å·²å¼ºåˆ¶åŒæ­¥${schedules.length}æ¡æ—¥ç¨‹ (${duration}ms)`, true);
                
                // æ›´æ–°å…¨é‡åŒæ­¥ç»Ÿè®¡
                updateSyncStats('full', true, JSON.stringify(schedules).length);
                
            } catch (error) {
                console.error('å¼ºåˆ¶åŒæ­¥å¤±è´¥:', error);
                updateSyncIndicator('error');
                showNotification('å¼ºåˆ¶åŒæ­¥å¤±è´¥ï¼š' + error.message, false);
                
                // æ›´æ–°å¤±è´¥ç»Ÿè®¡
                updateSyncStats('full', false);
            }
        }

        // æ‰‹åŠ¨åŒæ­¥å¤„ç†å‡½æ•°
        async function handleManualSync() {
            const syncButton = document.getElementById('manualSyncButton');
            
            // é‡ç½®åŒæ­¥çŠ¶æ€ï¼Œæ¸…ç†ä¹‹å‰çš„å¤±è´¥çŠ¶æ€
            if (window.enhancedSync) {
                window.enhancedSync.resetSyncState();
                console.log('ğŸ”„ æ‰‹åŠ¨åŒæ­¥å‰å·²é‡ç½®çŠ¶æ€');
            }
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
            if (!currentUser) {
                showNotification('è¯·å…ˆç™»å½•åå†è¿›è¡ŒåŒæ­¥', false);
                return;
            }
            
            // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
            if (!isOnline) {
                showNotification('ç½‘ç»œä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åå†è¯•', false);
                return;
            }
            
            // æ£€æŸ¥Supabaseæ˜¯å¦å¯ç”¨
            if (!checkSupabaseAvailable()) {
                showNotification('åŒæ­¥æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•', false);
                return;
            }
            
            try {
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                syncButton.disabled = true;
                syncButton.classList.add('syncing');
                syncButton.innerHTML = 'â†» åŒæ­¥ä¸­...';
                
                let syncCount = 0;
                let syncMessage = '';
                
                // ä¼˜å…ˆåŒæ­¥å¾…å¤„ç†çš„å˜æ›´
                if (pendingChanges.size > 0) {
                    console.log(`æ‰‹åŠ¨åŒæ­¥å¼€å§‹: æ£€æµ‹åˆ° ${pendingChanges.size} ä¸ªå¾…åŒæ­¥é¡¹`);
                    await saveChangedSchedulesToSupabase();
                    syncCount = pendingChanges.size;
                    syncMessage = `å·²åŒæ­¥ ${syncCount} ä¸ªå¾…å¤„ç†çš„å˜æ›´`;
                } else {
                    // å¦‚æœæ²¡æœ‰å¾…å¤„ç†å˜æ›´ï¼Œæ‰§è¡Œå®Œæ•´åŒæ­¥
                    console.log('æ‰‹åŠ¨åŒæ­¥å¼€å§‹: æ‰§è¡Œå®Œæ•´æ•°æ®åŒæ­¥');
                    await forceSyncAll();
                    syncCount = schedules.length;
                    syncMessage = `å·²å®Œæˆå®Œæ•´æ•°æ®åŒæ­¥ (${syncCount} æ¡è®°å½•)`;
                }
                
                // åŒæ­¥æˆåŠŸåï¼Œå»¶è¿Ÿæ›´æ–°æœåŠ¡å™¨æ•°æ®ä»¥é¿å…DOMç«æ€æ¡ä»¶
                try {
                    // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œç¡®ä¿ä¹‹å‰çš„DOMæ“ä½œå®Œå…¨å®Œæˆ
                    await new Promise(resolve => setTimeout(resolve, 500));
                    await syncDataFromServer();
                } catch (syncError) {
                    console.warn('æœåŠ¡å™¨æ•°æ®åŒæ­¥å‡ºç°é—®é¢˜ï¼Œä½†æœ¬åœ°åŒæ­¥å·²å®Œæˆ:', syncError.message);
                    // ä¸é˜»æ–­ä¸»æµç¨‹ï¼Œå› ä¸ºæœ¬åœ°åŒæ­¥å·²ç»æˆåŠŸ
                }
                
                showNotification(syncMessage, true);
                updateManualSyncButtonState();
                
            } catch (error) {
                console.error('æ‰‹åŠ¨åŒæ­¥å¤±è´¥:', error);
                showNotification('æ‰‹åŠ¨åŒæ­¥å¤±è´¥: ' + error.message, false);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                syncButton.disabled = false;
                syncButton.classList.remove('syncing');
                syncButton.innerHTML = 'â†» åŒæ­¥';
            }
        }

        // æ›´æ–°æ‰‹åŠ¨åŒæ­¥æŒ‰é’®çŠ¶æ€
        function updateManualSyncButtonState() {
            const syncButton = document.getElementById('manualSyncButton');
            if (!syncButton) return;
            
            const hasChanges = pendingChanges.size > 0;
            const isLoggedIn = !!currentUser;
            const isConnected = isOnline && checkSupabaseAvailable();
            
            // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
            if (hasChanges) {
                syncButton.innerHTML = `â†» åŒæ­¥ (${pendingChanges.size})`;
                syncButton.title = `æœ‰ ${pendingChanges.size} é¡¹å¾…åŒæ­¥æ•°æ®`;
                syncButton.style.opacity = '1';
            } else {
                syncButton.innerHTML = 'â†» åŒæ­¥';
                syncButton.title = 'æ‰‹åŠ¨åŒæ­¥æ•°æ®';
                syncButton.style.opacity = isLoggedIn && isConnected ? '0.7' : '0.5';
            }
            
            // è®¾ç½®æŒ‰é’®å¯ç”¨æ€§
            syncButton.disabled = !isLoggedIn || !isConnected;
        }

        // ==================== æ•°æ®åŒæ­¥è¾…åŠ©å‡½æ•° ====================
        
        // æ™ºèƒ½æ•°æ®åˆå¹¶å‡½æ•°
        function mergeScheduleData(localSchedules, serverSchedules) {
            console.log('å¼€å§‹åˆå¹¶æ•°æ®...');
            console.log('æœ¬åœ°æ•°æ®:', localSchedules.length, 'æ¡');
            console.log('æœåŠ¡å™¨æ•°æ®:', serverSchedules.length, 'æ¡');
            
            // åˆ›å»ºåˆå¹¶ç»“æœçš„Mapï¼Œä½¿ç”¨dayIdä½œä¸ºkey
            const mergedMap = new Map();
            
            // 1. å…ˆæ·»åŠ æœ¬åœ°æ•°æ®
            localSchedules.forEach(schedule => {
                if (schedule.dayId) {
                    mergedMap.set(schedule.dayId, {
                        ...schedule,
                        source: 'local',
                        lastModified: schedule.createdAt || new Date().toISOString()
                    });
                }
            });
            
            // 2. åˆå¹¶æœåŠ¡å™¨æ•°æ®
            serverSchedules.forEach(serverSchedule => {
                const dayId = serverSchedule.day_id;
                const localSchedule = mergedMap.get(dayId);
                
                const serverData = {
                    dayId: serverSchedule.day_id,
                    date: serverSchedule.date,
                    weekday: serverSchedule.weekday,
                    items: serverSchedule.items || [],
                    createdAt: serverSchedule.created_at,
                    source: 'server',
                    lastModified: serverSchedule.updated_at || serverSchedule.created_at
                };
                
                if (!localSchedule) {
                    // æœåŠ¡å™¨æœ‰ï¼Œæœ¬åœ°æ²¡æœ‰ -> ç›´æ¥æ·»åŠ 
                    mergedMap.set(dayId, serverData);
                    console.log(`æ·»åŠ æœåŠ¡å™¨æ•°æ®: ${serverSchedule.date}`);
                } else {
                    // ä¸¤è¾¹éƒ½æœ‰ -> éœ€è¦å†³å®šä½¿ç”¨å“ªä¸ª
                    const localTime = new Date(localSchedule.lastModified).getTime();
                    const serverTime = new Date(serverData.lastModified).getTime();
                    
                    if (serverTime > localTime) {
                        // æœåŠ¡å™¨æ•°æ®æ›´æ–° -> ä½¿ç”¨æœåŠ¡å™¨æ•°æ®
                        mergedMap.set(dayId, serverData);
                        console.log(`ä½¿ç”¨æœåŠ¡å™¨è¾ƒæ–°æ•°æ®: ${serverSchedule.date}`);
                    } else if (localTime > serverTime) {
                        // æœ¬åœ°æ•°æ®æ›´æ–° -> ä¿æŒæœ¬åœ°æ•°æ®
                        console.log(`ä¿æŒæœ¬åœ°è¾ƒæ–°æ•°æ®: ${localSchedule.date}`);
                    } else {
                        // æ—¶é—´ç›¸åŒ -> åˆå¹¶ä»»åŠ¡å†…å®¹
                        const mergedItems = mergeTaskItems(localSchedule.items, serverData.items);
                        mergedMap.set(dayId, {
                            ...localSchedule,
                            items: mergedItems,
                            source: 'merged'
                        });
                        console.log(`åˆå¹¶åŒæ—¶é—´æ•°æ®: ${localSchedule.date}`);
                    }
                }
            });
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
            const result = Array.from(mergedMap.values())
                .sort((a, b) => b.dayId - a.dayId); // æŒ‰æ—¥æœŸå€’åº
            
            console.log('åˆå¹¶å®Œæˆï¼Œæœ€ç»ˆæ•°æ®é‡:', result.length);
            return result;
        }

        // åˆå¹¶ä»»åŠ¡é¡¹ç›®
        function mergeTaskItems(localItems, serverItems) {
            const merged = {};
            
            // å…ˆæ·»åŠ æœ¬åœ°ä»»åŠ¡
            localItems.forEach(item => {
                merged[item.time] = item;
            });
            
            // åˆå¹¶æœåŠ¡å™¨ä»»åŠ¡
            serverItems.forEach(serverItem => {
                const localItem = merged[serverItem.time];
                if (!localItem) {
                    // æœ¬åœ°æ²¡æœ‰è¯¥æ—¶é—´æ®µ -> ç›´æ¥æ·»åŠ 
                    merged[serverItem.time] = serverItem;
                } else {
                    // æœ¬åœ°æœ‰è¯¥æ—¶é—´æ®µ -> é€‰æ‹©æœ‰å†…å®¹çš„ä»»åŠ¡
                    if (!localItem.task || localItem.task.trim() === '') {
                        // æœ¬åœ°ä»»åŠ¡ä¸ºç©º -> ä½¿ç”¨æœåŠ¡å™¨ä»»åŠ¡
                        merged[serverItem.time] = serverItem;
                    }
                    // å¦åˆ™ä¿æŒæœ¬åœ°ä»»åŠ¡ï¼ˆæœ¬åœ°ä¼˜å…ˆåŸåˆ™ï¼‰
                }
            });
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
            return Object.values(merged).sort((a, b) => a.time.localeCompare(b.time));
        }

        // æ•°æ®å®Œæ•´æ€§éªŒè¯
        function validateDataIntegrity() {
            // æ£€æŸ¥schedulesæ•°ç»„æ˜¯å¦å­˜åœ¨
            if (!Array.isArray(schedules)) {
                console.error('schedulesä¸æ˜¯æ•°ç»„');
                return false;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„dayId
            const dayIds = schedules.map(s => s.dayId).filter(id => id);
            const uniqueDayIds = new Set(dayIds);
            if (dayIds.length !== uniqueDayIds.size) {
                console.error('å‘ç°é‡å¤çš„dayId');
                return false;
            }
            
            // æ£€æŸ¥æ¯ä¸ªscheduleæ˜¯å¦æœ‰å¿…è¦å­—æ®µ
            for (const schedule of schedules) {
                if (!schedule.dayId || !schedule.date || !schedule.items) {
                    console.error('å‘ç°ç¼ºå°‘å¿…è¦å­—æ®µçš„schedule:', schedule);
                    return false;
                }
            }
            
            console.log('æ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡');
            return true;
        }

        // æ•°æ®æ¢å¤å‡½æ•°
        function restoreFromBackup() {
            const backup = localStorage.getItem('calendarSchedulesBackup');
            const backupTime = localStorage.getItem('calendarSchedulesBackupTime');
            
            if (backup) {
                try {
                    const backupData = JSON.parse(backup);
                    const backupDate = backupTime ? new Date(backupTime).toLocaleString() : 'æœªçŸ¥æ—¶é—´';
                    
                    const confirmRestore = confirm(`å‘ç°å¤‡ä»½æ•°æ®ï¼ˆ${backupData.length}æ¡è®°å½•ï¼Œå¤‡ä»½æ—¶é—´ï¼š${backupDate}ï¼‰ï¼Œç¡®å®šè¦æ¢å¤å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ•°æ®ã€‚`);
                    
                    if (confirmRestore) {
                        schedules = backupData;
                        saveToLocalStorage();
                        renderCalendar();
                        renderScheduleForDate();
                        showNotification(`å·²ä»å¤‡ä»½æ¢å¤${backupData.length}æ¡æ•°æ®`, true);
                        console.log('æ•°æ®æ¢å¤æˆåŠŸï¼Œæ¢å¤äº†', backupData.length, 'æ¡è®°å½•');
                        
                        // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œç«‹å³å¼ºåˆ¶åŒæ­¥æ‰€æœ‰æ•°æ®
                        if (currentUser) {
                            forceSyncAll();
                        }
                    }
                } catch (error) {
                    console.error('æ•°æ®æ¢å¤å¤±è´¥:', error);
                    showNotification('æ•°æ®æ¢å¤å¤±è´¥ï¼šå¤‡ä»½æ•°æ®æŸå', false);
                }
            } else {
                showNotification('æ²¡æœ‰æ‰¾åˆ°å¤‡ä»½æ•°æ®', false);
            }
        }

        // åˆ›å»ºæ•°æ®å¤‡ä»½
        function createDataBackup() {
            try {
                localStorage.setItem('calendarSchedulesBackup', JSON.stringify(schedules));
                localStorage.setItem('calendarSchedulesBackupTime', new Date().toISOString());
                showNotification(`å·²åˆ›å»ºæ•°æ®å¤‡ä»½ï¼ˆ${schedules.length}æ¡è®°å½•ï¼‰`, true);
                console.log('æ•°æ®å¤‡ä»½å·²åˆ›å»ºï¼Œå¤‡ä»½äº†', schedules.length, 'æ¡è®°å½•');
            } catch (error) {
                console.error('åˆ›å»ºæ•°æ®å¤‡ä»½å¤±è´¥:', error);
                showNotification('åˆ›å»ºå¤‡ä»½å¤±è´¥ï¼š' + error.message, false);
            }
        }

        // è‡ªåŠ¨å¤‡ä»½æœºåˆ¶
        function enableAutoBackup() {
            // æ¯30åˆ†é’Ÿè‡ªåŠ¨å¤‡ä»½ä¸€æ¬¡
            setInterval(() => {
                if (schedules.length > 0) {
                    createDataBackup();
                    console.log('è‡ªåŠ¨å¤‡ä»½å·²åˆ›å»º');
                }
            }, 30 * 60 * 1000);
            
            // é¡µé¢å¸è½½å‰å¤‡ä»½
            window.addEventListener('beforeunload', () => {
                if (schedules.length > 0) {
                    createDataBackup();
                }
            });
        }

        // ==================== æ•°æ®è¿ç§»åŠŸèƒ½ ====================
        
        async function migrateFromLocalStorage() {
            if (!currentUser) {
                showNotification('è¯·å…ˆç™»å½•æ‰èƒ½è¿ç§»æ•°æ®', false);
                return;
            }
            
            console.log('å¼€å§‹æ•°æ®è¿ç§»...');
            updateSyncStatus('syncing', 'è¿ç§»æ•°æ®ä¸­...');
            
            try {
                // æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°æ•°æ®éœ€è¦è¿ç§»
                const localSchedules = localStorage.getItem('calendarSchedules');
                const localWorkdayTemplate = localStorage.getItem('calendarWorkdayTemplate');
                const localNonWorkdayTemplate = localStorage.getItem('calendarNonWorkdayTemplate');
                const localTheme = localStorage.getItem('calendarTheme');
                
                let migratedCount = 0;
                
                // è¿ç§»æ—¥ç¨‹æ•°æ®
                if (localSchedules) {
                    const parsedSchedules = JSON.parse(localSchedules);
                    console.log('å‘ç°æœ¬åœ°æ—¥ç¨‹æ•°æ®:', parsedSchedules.length, 'æ¡');
                    
                    if (parsedSchedules.length > 0) {
                        // æ£€æŸ¥äº‘ç«¯æ˜¯å¦å·²æœ‰æ•°æ®
                        const { data: existingSchedules, error: checkError } = await supabaseClient
                            .from('schedules')
                            .select('day_id')
                            .eq('user_id', currentUser.id);
                        
                        if (checkError) {
                            if (checkError.message.includes('relation') && checkError.message.includes('does not exist')) {
                                showNotification('æ•°æ®åº“è¡¨æœªåˆ›å»ºï¼Œæ— æ³•è¿ç§»æ•°æ®', false);
                                console.error('è¯·å…ˆåœ¨Supabaseæ§åˆ¶å°è¿è¡ŒSQLè„šæœ¬åˆ›å»ºæ•°æ®åº“è¡¨');
                                updateSyncStatus('offline', 'è¿ç§»å¤±è´¥');
                                return;
                            }
                            throw checkError;
                        }
                        
                        const existingDayIds = new Set(existingSchedules?.map(s => s.day_id) || []);
                        
                        // åªè¿ç§»äº‘ç«¯æ²¡æœ‰çš„æ•°æ®
                        const schedulesToMigrate = parsedSchedules.filter(s => !existingDayIds.has(s.dayId));
                        
                        if (schedulesToMigrate.length > 0) {
                            console.log('éœ€è¦è¿ç§»çš„æ—¥ç¨‹:', schedulesToMigrate.length, 'æ¡');
                            console.log('è¿ç§»æ•°æ®è¯¦æƒ…:', schedulesToMigrate);
                            
                            const scheduleData = schedulesToMigrate.map(schedule => {
                                // ç¡®ä¿æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½å­˜åœ¨
                                if (!schedule.dayId) {
                                    console.error('æ—¥ç¨‹ç¼ºå°‘dayId:', schedule);
                                }
                                return {
                                    user_id: currentUser.id,
                                    day_id: schedule.dayId,
                                    date: schedule.date,
                                    weekday: schedule.weekday,
                                    items: schedule.items || []
                                };
                            });
                            
                            console.log('å‡†å¤‡æ’å…¥çš„æ•°æ®:', scheduleData);
                            
                            const { error } = await supabaseClient
                                .from('schedules')
                                .insert(scheduleData);
                            
                            if (error) throw error;
                            migratedCount += schedulesToMigrate.length;
                        }
                    }
                }
                
                // è¿ç§»æ¨¡æ¿æ•°æ®
                if (localWorkdayTemplate || localNonWorkdayTemplate) {
                    const templatesData = [];
                    
                    if (localWorkdayTemplate) {
                        const workdayData = JSON.parse(localWorkdayTemplate);
                        if (Object.keys(workdayData).length > 0) {
                            templatesData.push({
                                user_id: currentUser.id,
                                template_type: 'workday',
                                template_data: workdayData
                            });
                        }
                    }
                    
                    if (localNonWorkdayTemplate) {
                        const nonWorkdayData = JSON.parse(localNonWorkdayTemplate);
                        if (Object.keys(nonWorkdayData).length > 0) {
                            templatesData.push({
                                user_id: currentUser.id,
                                template_type: 'nonworkday',
                                template_data: nonWorkdayData
                            });
                        }
                    }
                    
                    if (templatesData.length > 0) {
                        // é€ä¸ªæ’å…¥æ¨¡æ¿æ•°æ®
                        for (const templateData of templatesData) {
                            try {
                                let { error: insertError } = await supabaseClient
                                    .from('templates')
                                    .insert([templateData]);
                                
                                if (insertError) {
                                    if (insertError.code === '23505') {
                                        // è®°å½•å·²å­˜åœ¨ï¼Œæ‰§è¡Œæ›´æ–°
                                        const { error: updateError } = await supabaseClient
                                            .from('templates')
                                            .update(templateData)
                                            .eq('user_id', currentUser.id)
                                            .eq('template_type', templateData.template_type);
                                        
                                        if (updateError && !updateError.message.includes('does not exist')) {
                                            console.warn('æ¨¡æ¿æ›´æ–°å¤±è´¥:', updateError);
                                        }
                                    } else if (!insertError.message.includes('does not exist')) {
                                        console.warn('æ¨¡æ¿æ’å…¥å¤±è´¥:', insertError);
                                    }
                                }
                            } catch (error) {
                                console.warn('æ¨¡æ¿è¿ç§»å¤±è´¥:', error);
                            }
                        }
                        console.log('æ¨¡æ¿æ•°æ®è¿ç§»å®Œæˆ');
                    }
                }
                
                // è¿ç§»ç”¨æˆ·è®¾ç½®
                const settingsData = {
                    user_id: currentUser.id,
                    theme: localTheme || 'light',
                    current_date_data: {
                        year: currentDate.getFullYear(),
                        month: currentDate.getMonth(),
                        day: currentDate.getDate()
                    }
                };
                
                try {
                    let { error: insertError } = await supabaseClient
                        .from('user_settings')
                        .insert([settingsData]);
                    
                    if (insertError) {
                        if (insertError.code === '23505') {
                            // è®°å½•å·²å­˜åœ¨ï¼Œæ‰§è¡Œæ›´æ–°
                            const { error: updateError } = await supabaseClient
                                .from('user_settings')
                                .update(settingsData)
                                .eq('user_id', currentUser.id);
                            
                            if (updateError && !updateError.message.includes('does not exist')) {
                                console.warn('ç”¨æˆ·è®¾ç½®æ›´æ–°å¤±è´¥:', updateError);
                            }
                        } else if (!insertError.message.includes('does not exist')) {
                            console.warn('ç”¨æˆ·è®¾ç½®æ’å…¥å¤±è´¥:', insertError);
                        }
                    }
                } catch (error) {
                    console.warn('ç”¨æˆ·è®¾ç½®è¿ç§»å¤±è´¥:', error);
                }
                
                if (migratedCount > 0) {
                    showNotification(`æ•°æ®è¿ç§»å®Œæˆï¼è¿ç§»äº†${migratedCount}æ¡æ—¥ç¨‹`, true);
                    // è¿ç§»æˆåŠŸåé‡æ–°åŒæ­¥æ•°æ®
                    await syncDataFromServer();
                } else {
                    showNotification('æ²¡æœ‰éœ€è¦è¿ç§»çš„æ•°æ®', true);
                }
                
                updateSyncStatus('', 'è¿ç§»å®Œæˆ');
                
            } catch (error) {
                console.error('æ•°æ®è¿ç§»å¤±è´¥:', error);
                updateSyncStatus('offline', 'è¿ç§»å¤±è´¥');
                
                if (error.message.includes('relation') && error.message.includes('does not exist')) {
                    showNotification('æ•°æ®åº“è¡¨æœªåˆ›å»ºï¼Œè¯·å…ˆè¿è¡ŒSQLè„šæœ¬', false);
                } else if (error.message.includes('new row violates row-level security policy')) {
                    showNotification('æ•°æ®åº“æƒé™é…ç½®é”™è¯¯ï¼Œè¯·æ£€æŸ¥RLSç­–ç•¥', false);
                } else {
                    showNotification('æ•°æ®è¿ç§»å¤±è´¥ï¼š' + error.message, false);
                }
            }
        }
        
        // æ•°æ®è¿ç§»æé†’åŠŸèƒ½å·²ç§»é™¤

        // ==================== æ•°æ®ç®¡ç† ====================
        
        function saveToLocalStorage() {
            try {
                // åœ¨ä¿å­˜å‰å…ˆåˆ›å»ºå¤‡ä»½
                const currentData = localStorage.getItem('calendarSchedules');
                if (currentData && JSON.parse(currentData).length > 0) {
                    localStorage.setItem('calendarSchedulesBackup', currentData);
                    localStorage.setItem('calendarSchedulesBackupTime', new Date().toISOString());
                }
                
                localStorage.setItem('calendarSchedules', JSON.stringify(schedules));
                localStorage.setItem('calendarCurrentDate', JSON.stringify({
                    year: currentDate.getFullYear(),
                    month: currentDate.getMonth(),
                    day: currentDate.getDate()
                }));
                
                console.log('æ•°æ®å·²ä¿å­˜åˆ°localStorageï¼ŒåŒ…å«', schedules.length, 'æ¡è®°å½•');
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                showNotification('ä¿å­˜å¤±è´¥ï¼Œå¯èƒ½æ˜¯å­˜å‚¨ç©ºé—´ä¸è¶³', false);
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedSchedules = localStorage.getItem('calendarSchedules');
                const savedDate = localStorage.getItem('calendarCurrentDate');
                
                if (savedSchedules) {
                    schedules = JSON.parse(savedSchedules);
                }
                
                if (savedDate) {
                    const dateData = JSON.parse(savedDate);
                    currentDate = new Date(dateData.year, dateData.month, dateData.day);
                }
                
                // è®¾ç½®ä»Šå¤©ä¸ºé€‰ä¸­æ—¥æœŸ
                selectedDate = new Date();
                
                // å»¶è¿Ÿæ‰§è¡Œæ¯æ—¥ä»»åŠ¡æµè½¬ï¼Œç¡®ä¿è®¤è¯çŠ¶æ€å·²ç¨³å®š
                setTimeout(() => {
                    // åªæœ‰åœ¨ä¸æ˜¯ç™»å½•è¿‡ç¨‹ä¸­æ‰æ‰§è¡Œä»»åŠ¡æµè½¬
                    if (!document.getElementById('authModal').classList.contains('hidden')) {
                        console.log('æ£€æµ‹åˆ°ç™»å½•çª—å£æ˜¾ç¤ºï¼Œè·³è¿‡ä»»åŠ¡æµè½¬');
                        return;
                    }
                    processUnfinishedTasks();
                }, 1000); // å¢åŠ å»¶è¿Ÿæ—¶é—´ï¼Œç¡®ä¿ç™»å½•æµç¨‹å®Œæˆ
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                schedules = [];
                currentDate = new Date();
                selectedDate = new Date();
            }
        }

        // ==================== ä»»åŠ¡æµè½¬åŠŸèƒ½ ====================
        
        function processUnfinishedTasks() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const todayId = formatDateToId(today);
            const yesterdayId = formatDateToId(yesterday);
            
            console.log('æ£€æŸ¥ä»»åŠ¡æµè½¬ - ä»Šå¤©ID:', todayId, 'æ˜¨å¤©ID:', yesterdayId);
            
            const yesterdaySchedule = schedules.find(s => s.dayId == yesterdayId);
            let todaySchedule = schedules.find(s => s.dayId == todayId);
            
            console.log('æ˜¨å¤©çš„æ—¥ç¨‹:', yesterdaySchedule);
            console.log('ä»Šå¤©çš„æ—¥ç¨‹:', todaySchedule);
            
            // å¦‚æœæ˜¨å¤©æœ‰æ—¥ç¨‹ä½†ä»Šå¤©æ²¡æœ‰ï¼Œä¸è¿›è¡Œæµè½¬
            if (!yesterdaySchedule) {
                console.log('æ˜¨å¤©æ²¡æœ‰æ—¥ç¨‹ï¼Œæ— éœ€æµè½¬');
                return;
            }
            
            // å¦‚æœä»Šå¤©æ²¡æœ‰æ—¥ç¨‹ï¼Œå…ˆåˆ›å»ºä»Šå¤©çš„æ—¥ç¨‹
            if (!todaySchedule) {
                console.log('ä»Šå¤©æ²¡æœ‰æ—¥ç¨‹ï¼Œå…ˆåˆ›å»ºä»Šå¤©çš„æ—¥ç¨‹æ¨¡æ¿');
                const todayDate = formatDate(today);
                const todayWeekday = getWeekday(today);
                
                todaySchedule = {
                    dayId: todayId,
                    date: todayDate,
                    weekday: todayWeekday,
                    items: generateTimeSlotsWithTemplate(today),
                    createdAt: new Date().toISOString()
                };
                
                schedules.unshift(todaySchedule);
            }
            
            let transferredCount = 0;
            
            // æ£€æŸ¥æ˜¯å¦åº”è¯¥è¿›è¡Œä»»åŠ¡æµè½¬
            const shouldTransfer = shouldTransferTasks(yesterday, today);
            
            if (!shouldTransfer) {
                console.log('è·¨å·¥ä½œæ—¥/éå·¥ä½œæ—¥è¾¹ç•Œï¼Œè·³è¿‡ä»»åŠ¡æµè½¬');
                return;
            }
            
            // éå†æ˜¨å¤©çš„ä»»åŠ¡ï¼Œå°†æœªå®Œæˆçš„ä»»åŠ¡æµè½¬åˆ°ä»Šå¤©
            yesterdaySchedule.items.forEach(item => {
                if (!item.completed && item.task && item.task.trim() !== '') {
                    // æŸ¥æ‰¾ä»Šå¤©ç›¸åŒæ—¶é—´ç‚¹çš„ä»»åŠ¡
                    const todayItem = todaySchedule.items.find(t => t.time === item.time);
                    if (todayItem) {
                        // åªæœ‰å½“ä»Šå¤©è¿™ä¸ªæ—¶é—´ç‚¹æ²¡æœ‰ä»»åŠ¡å†…å®¹æ—¶æ‰æµè½¬
                        if (!todayItem.task || todayItem.task.trim() === '') {
                            todayItem.task = item.task;
                            todayItem.completed = false;
                            transferredCount++;
                            console.log(`æµè½¬ä»»åŠ¡: ${item.time} - ${item.task}`);
                        } else {
                            console.log(`${item.time} æ—¶é—´æ®µä»Šå¤©å·²æœ‰ä»»åŠ¡ï¼Œè·³è¿‡æµè½¬: ${todayItem.task}`);
                        }
                    }
                }
            });
            
            if (transferredCount > 0) {
                console.log(`æˆåŠŸæµè½¬ ${transferredCount} ä¸ªä»»åŠ¡`);
                
                // å¦‚æœå½“å‰é€‰ä¸­çš„æ˜¯ä»Šå¤©ï¼Œæ›´æ–°é€‰ä¸­çš„æ—¥ç¨‹æ•°æ®
                const today = new Date();
                const todayId = formatDateToId(today);
                if (selectedDate && formatDateToId(selectedDate) === todayId) {
                    selectedSchedule = todaySchedule;
                    console.log('æ›´æ–°å½“å‰é€‰ä¸­çš„ä»Šæ—¥æ—¥ç¨‹æ•°æ®');
                }
                
                // åªæœ‰åœ¨ç”¨æˆ·å·²ç™»å½•çš„æƒ…å†µä¸‹æ‰ä¿å­˜åˆ°äº‘ç«¯
                if (currentUser) {
                    saveToSupabaseWithRetry();
                } else {
                    // å¦‚æœç”¨æˆ·æœªç™»å½•ï¼Œåªä¿å­˜åˆ°æœ¬åœ°
                    saveToLocalStorage();
                    console.log('ç”¨æˆ·æœªç™»å½•ï¼Œä»»åŠ¡æµè½¬ç»“æœä»…ä¿å­˜åˆ°æœ¬åœ°');
                }
                
                showNotification(`å·²å°†${transferredCount}ä¸ªæœªå®Œæˆä»»åŠ¡è½¬ç§»åˆ°ä»Šå¤©`, true);
            } else {
                console.log('æ²¡æœ‰éœ€è¦æµè½¬çš„ä»»åŠ¡');
            }
        }

        // åˆ¤æ–­æ˜¯å¦åº”è¯¥è¿›è¡Œä»»åŠ¡æµè½¬
        function shouldTransferTasks(fromDate, toDate) {
            const fromIsWorkday = isWorkday(fromDate);
            const toIsWorkday = isWorkday(toDate);
            
            const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            console.log(`ä»»åŠ¡æµè½¬æ£€æŸ¥: ${formatDate(fromDate)}(${dayNames[fromDate.getDay()]},${fromIsWorkday ? 'å·¥ä½œæ—¥' : 'éå·¥ä½œæ—¥'}) -> ${formatDate(toDate)}(${dayNames[toDate.getDay()]},${toIsWorkday ? 'å·¥ä½œæ—¥' : 'éå·¥ä½œæ—¥'})`);
            
            // è§„åˆ™1: å·¥ä½œæ—¥åˆ°å·¥ä½œæ—¥ - å…è®¸æµè½¬
            if (fromIsWorkday && toIsWorkday) {
                console.log('âœ… å·¥ä½œæ—¥åˆ°å·¥ä½œæ—¥ï¼Œå…è®¸ä»»åŠ¡æµè½¬');
                return true;
            }
            
            // è§„åˆ™2: éå·¥ä½œæ—¥åˆ°éå·¥ä½œæ—¥ - å…è®¸æµè½¬
            if (!fromIsWorkday && !toIsWorkday) {
                console.log('âœ… éå·¥ä½œæ—¥åˆ°éå·¥ä½œæ—¥ï¼Œå…è®¸ä»»åŠ¡æµè½¬');
                return true;
            }
            
            // è§„åˆ™3: å·¥ä½œæ—¥åˆ°éå·¥ä½œæ—¥ - ä¸å…è®¸æµè½¬ï¼ˆå‘¨äº”åˆ°å‘¨å…­ï¼‰
            if (fromIsWorkday && !toIsWorkday) {
                console.log('âŒ å·¥ä½œæ—¥åˆ°éå·¥ä½œæ—¥ï¼Œç¦æ­¢ä»»åŠ¡æµè½¬ï¼ˆé¿å…å·¥ä½œä»»åŠ¡æµè½¬åˆ°ä¼‘æ¯æ—¥ï¼‰');
                return false;
            }
            
            // è§„åˆ™4: éå·¥ä½œæ—¥åˆ°å·¥ä½œæ—¥ - ä¸å…è®¸æµè½¬ï¼ˆå‘¨æ—¥åˆ°å‘¨ä¸€ï¼‰
            if (!fromIsWorkday && toIsWorkday) {
                console.log('âŒ éå·¥ä½œæ—¥åˆ°å·¥ä½œæ—¥ï¼Œç¦æ­¢ä»»åŠ¡æµè½¬ï¼ˆé¿å…ä¼‘é—²ä»»åŠ¡æµè½¬åˆ°å·¥ä½œæ—¥ï¼‰');
                return false;
            }
            
            return false;
        }

        // ==================== æ—¥å†æ¸²æŸ“ ====================
        
        function renderCalendar() {
            console.log('å¼€å§‹æ¸²æŸ“æ—¥å†...');
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // æ›´æ–°æœˆä»½å¹´ä»½æ˜¾ç¤º
            document.getElementById('monthYear').textContent = `${year}å¹´${month + 1}æœˆ`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            const calendarGrid = document.getElementById('calendarGrid');
            
            // æ¸…é™¤ç°æœ‰çš„æ—¥æœŸå•å…ƒæ ¼
            const existingCells = calendarGrid.querySelectorAll('.calendar-cell');
            existingCells.forEach(cell => cell.remove());
            
            const today = new Date();
            const isCurrentMonth = year === today.getFullYear() && month === today.getMonth();
            
            console.log(`æ¸²æŸ“æ—¥å†: ${year}å¹´${month + 1}æœˆ, å½“å‰æœˆä»½: ${isCurrentMonth}`);
            
            // æ·»åŠ ä¸Šä¸ªæœˆçš„å°¾éƒ¨æ—¥æœŸ
            const prevMonth = new Date(year, month - 1, 0);
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonth.getDate() - i;
                const cell = createCalendarCell(day, true, new Date(year, month - 1, day));
                calendarGrid.appendChild(cell);
            }
            
            // æ·»åŠ å½“å‰æœˆçš„æ—¥æœŸ
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const cell = createCalendarCell(day, false, date);
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©
                if (isCurrentMonth && day === today.getDate()) {
                    cell.classList.add('today');
                }
                
                // æ£€æŸ¥æ˜¯å¦è¢«é€‰ä¸­
                if (selectedDate && 
                    date.getFullYear() === selectedDate.getFullYear() &&
                    date.getMonth() === selectedDate.getMonth() &&
                    date.getDate() === selectedDate.getDate()) {
                    cell.classList.add('selected');
                }
                
                // è®¾ç½®å®Œæˆåº¦é¢œè‰²
                setCompletionColor(cell, date);
                
                calendarGrid.appendChild(cell);
            }
            
            // æ·»åŠ ä¸‹ä¸ªæœˆçš„å¼€å§‹æ—¥æœŸ
            const cellsAdded = startingDayOfWeek + daysInMonth;
            const cellsNeeded = Math.ceil(cellsAdded / 7) * 7;
            for (let day = 1; day <= cellsNeeded - cellsAdded; day++) {
                const cell = createCalendarCell(day, true, new Date(year, month + 1, day));
                calendarGrid.appendChild(cell);
            }
            
            console.log('æ—¥å†æ¸²æŸ“å®Œæˆ');
        }

        function createCalendarCell(day, isOtherMonth, date) {
            const cell = document.createElement('div');
            cell.className = 'calendar-cell';
            cell.textContent = day;
            
            if (isOtherMonth) {
                cell.classList.add('other-month');
            }
            
            cell.addEventListener('click', () => {
                selectDate(date);
            });
            
            return cell;
        }

        function setCompletionColor(cell, date) {
            // é¦–å…ˆæ¸…é™¤æ‰€æœ‰å¯èƒ½çš„completionç±»
            cell.classList.remove('completion-0', 'completion-low', 'completion-medium', 'completion-high', 'completion-full');
            
            const dayId = formatDateToId(date);
            const schedule = schedules.find(s => s.dayId == dayId);
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©
            const today = new Date();
            const isToday = date.getFullYear() === today.getFullYear() &&
                           date.getMonth() === today.getMonth() &&
                           date.getDate() === today.getDate();
            
            console.log(`è®¾ç½®æ—¥æœŸ ${formatDate(date)} (dayId: ${dayId}) çš„é¢œè‰², æ˜¯å¦ä»Šå¤©: ${isToday}`);
            
            if (!schedule || schedule.items.length === 0) {
                console.log('æ²¡æœ‰æ‰¾åˆ°æ—¥ç¨‹æˆ–æ—¥ç¨‹ä¸ºç©ºï¼Œè®¾ç½®ä¸ºcompletion-0');
                cell.classList.add('completion-0');
                return;
            }
            
            const completedCount = schedule.items.filter(item => item.completed).length;
            const totalTasks = schedule.items.filter(item => item.task && item.task.trim() !== '').length;
            
            console.log(`æ—¥ç¨‹ç»Ÿè®¡: å·²å®Œæˆä»»åŠ¡ ${completedCount}, æœ‰å†…å®¹çš„ä»»åŠ¡ ${totalTasks}`);
            console.log('ä»»åŠ¡è¯¦æƒ…:', schedule.items.map(item => ({
                time: item.time,
                task: item.task,
                completed: item.completed,
                hasContent: item.task && item.task.trim() !== ''
            })));
            
            if (totalTasks === 0) {
                console.log('æ²¡æœ‰æœ‰å†…å®¹çš„ä»»åŠ¡ï¼Œè®¾ç½®ä¸ºcompletion-0');
                cell.classList.add('completion-0');
            } else {
                const completionRate = (completedCount / totalTasks) * 100;
                console.log(`å®Œæˆç‡: ${completionRate.toFixed(1)}%`);
                
                let colorClass = '';
                if (completionRate === 0) {
                    colorClass = 'completion-0';
                } else if (completionRate <= 30) {
                    colorClass = 'completion-low';
                } else if (completionRate <= 70) {
                    colorClass = 'completion-medium';
                } else if (completionRate < 100) {
                    colorClass = 'completion-high';
                } else {
                    colorClass = 'completion-full';
                }
                
                console.log(`åº”ç”¨é¢œè‰²ç±»: ${colorClass}`);
                cell.classList.add(colorClass);
            }
        }

        function selectDate(date) {
            console.log('é€‰æ‹©æ—¥æœŸ:', formatDate(date));
            selectedDate = new Date(date);
            
            // å¦‚æœé€‰æ‹©çš„æ˜¯ä»Šå¤©ï¼Œå…ˆæ‰§è¡Œä»»åŠ¡æµè½¬
            const today = new Date();
            const isToday = date.getFullYear() === today.getFullYear() &&
                           date.getMonth() === today.getMonth() &&
                           date.getDate() === today.getDate();
            
            if (isToday) {
                console.log('é€‰æ‹©çš„æ˜¯ä»Šå¤©ï¼Œæ‰§è¡Œä»»åŠ¡æµè½¬');
                processUnfinishedTasks();
            }
            
            // é‡æ–°æ¸²æŸ“æ—¥å†ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
            renderCalendar();
            
            // æŸ¥æ‰¾å¹¶æ˜¾ç¤ºé€‰ä¸­æ—¥æœŸçš„æ—¥ç¨‹
            const dayId = formatDateToId(date);
            selectedSchedule = schedules.find(s => s.dayId == dayId);
            console.log('é€‰ä¸­æ—¥æœŸçš„æ—¥ç¨‹:', selectedSchedule);
            
            renderScheduleForDate();
        }

        // ==================== æ—¥ç¨‹æ¸²æŸ“ ====================
        
        function renderScheduleForDate() {
            if (!selectedDate) {
                showEmptyState();
                return;
            }
            
            const dateStr = formatDate(selectedDate);
            const weekdayStr = getWeekday(selectedDate);
            
            const selectedDateEl = document.getElementById('selectedDate');
            const selectedWeekdayEl = document.getElementById('selectedWeekday');
            
            if (selectedDateEl) selectedDateEl.textContent = dateStr;
            if (selectedWeekdayEl) selectedWeekdayEl.textContent = weekdayStr;
            
            if (!selectedSchedule) {
                showEmptySchedule();
                return;
            }
            
            // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
            const deleteScheduleEl = document.getElementById('deleteSchedule');
            if (deleteScheduleEl) deleteScheduleEl.style.display = 'inline-flex';
            
            // æ›´æ–°è¿›åº¦ä¿¡æ¯ï¼ˆåŒ…å«å­ä»»åŠ¡ï¼‰
            const tasksWithContent = selectedSchedule.items.filter(item => item.task.trim() !== '');
            let completedCount = 0;
            let totalItems = 0;
            
            tasksWithContent.forEach(item => {
                // ä¸»ä»»åŠ¡è®¡æ•°
                totalItems++;
                if (item.completed) {
                    completedCount++;
                }
                
                // å­ä»»åŠ¡è®¡æ•°
                if (item.subtasks && item.subtasks.length > 0) {
                    const subtasksWithContent = item.subtasks.filter(st => st.content.trim() !== '');
                    totalItems += subtasksWithContent.length;
                    completedCount += subtasksWithContent.filter(st => st.completed).length;
                }
            });
            
            const progressPercent = totalItems > 0 ? Math.round((completedCount / totalItems) * 100) : 0;
            
            const progressTextEl = document.getElementById('progressText');
            const progressBarEl = document.getElementById('progressBar');
            
            if (progressTextEl) progressTextEl.textContent = `${completedCount}/${totalItems} (${progressPercent}%)`;
            if (progressBarEl) progressBarEl.style.width = `${progressPercent}%`;
            
            // æ¸²æŸ“æ—¶é—´ä»»åŠ¡åˆ—è¡¨
            const scheduleList = document.getElementById('scheduleList');
            if (!scheduleList) {
                console.warn('[DOM] scheduleList å…ƒç´ ä¸å­˜åœ¨ï¼Œè·³è¿‡æ—¥ç¨‹æ¸²æŸ“');
                return;
            }
            scheduleList.innerHTML = '';
            
            const today = new Date();
            const isToday = selectedDate.getFullYear() === today.getFullYear() &&
                           selectedDate.getMonth() === today.getMonth() &&
                           selectedDate.getDate() === today.getDate();
            
            selectedSchedule.items.forEach((item, index) => {
                const scheduleItem = document.createElement('div');
                scheduleItem.className = 'schedule-item';
                
                // ç¡®ä¿å­ä»»åŠ¡æ•°ç»„å’Œå±•å¼€çŠ¶æ€å­˜åœ¨
                if (!item.subtasks) item.subtasks = [];
                if (item.expanded === undefined) item.expanded = false;
                
                // è®¡ç®—ä¸»ä»»åŠ¡å’Œå­ä»»åŠ¡çš„å®ŒæˆçŠ¶æ€
                const subtaskCount = item.subtasks.length;
                const completedSubtasks = item.subtasks.filter(st => st.completed).length;
                const hasSubtasks = subtaskCount > 0;
                const allSubtasksCompleted = hasSubtasks ? completedSubtasks === subtaskCount : false;
                
                // åªå…è®¸ä»Šå¤©çš„ä»»åŠ¡è¢«å‹¾é€‰
                const checkboxDisabled = !isToday ? 'disabled' : '';
                const checkboxTitle = !isToday ? 'title="åªèƒ½å‹¾é€‰ä»Šå¤©çš„ä»»åŠ¡"' : '';
                
                scheduleItem.innerHTML = `
                    <div class="main-task-row">
                        <label class="checkbox-container">
                            <input type="checkbox" ${item.completed ? 'checked' : ''} 
                                   ${checkboxDisabled}
                                   ${checkboxTitle}
                                   ${(!item.task || item.task.trim() === '') ? 'disabled' : ''}
                                   onchange="toggleCompleted(${index})">
                            <span class="checkmark"></span>
                        </label>
                        <span class="time">${item.time}</span>
                        <input type="text" class="task ${item.completed ? 'completed' : ''}" 
                               value="${item.task}" 
                               placeholder=""
                               data-index="${index}"
                               ${item.completed ? 'readonly' : ''}
                               onblur="updateTask(${index}, this.value)"
                               onkeydown="handleTaskKeyDown(event, ${index})">
                        <div class="task-actions">
                            ${hasSubtasks ? `
                                <button class="subtask-toggle ${item.expanded ? 'expanded' : ''}" 
                                        onclick="toggleSubtasks(${index})"
                                        title="${item.expanded ? 'æ”¶èµ·' : 'å±•å¼€'}å­ä»»åŠ¡ (${completedSubtasks}/${subtaskCount})">
                                    <span class="toggle-icon">${item.expanded ? 'â–¼' : 'â–¶'}</span>
                                </button>
                            ` : ''}
                            <button class="add-subtask-btn" 
                                    onclick="addSubtask(${index})"
                                    title="æ·»åŠ å­ä»»åŠ¡">
                                ï¼‹
                            </button>
                        </div>
                    </div>
                    ${hasSubtasks && item.expanded ? `
                        <div class="subtasks-container">
                            ${item.subtasks.map((subtask, subIndex) => `
                                <div class="subtask-item" data-subtask-id="${subtask.id}">
                                    <label class="checkbox-container subtask-checkbox">
                                        <input type="checkbox" ${subtask.completed ? 'checked' : ''} 
                                               ${checkboxDisabled}
                                               onchange="toggleSubtaskCompleted(${index}, ${subIndex})">
                                        <span class="checkmark"></span>
                                    </label>
                                    <input type="text" class="subtask-input ${subtask.completed ? 'completed' : ''}" 
                                           value="${subtask.content}" 
                                           placeholder=""
                                           ${subtask.completed ? 'readonly' : ''}
                                           onblur="updateSubtask(${index}, ${subIndex}, this.value)"
                                           onkeydown="handleSubtaskKeyDown(event, ${index}, ${subIndex})">
                                    <button class="delete-subtask-btn" 
                                            onclick="deleteSubtask(${index}, ${subIndex})"
                                            title="åˆ é™¤å­ä»»åŠ¡">
                                        Ã—
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
                scheduleList.appendChild(scheduleItem);
            });
        }

        function showEmptyState() {
            const selectedDateEl = document.getElementById('selectedDate');
            const selectedWeekdayEl = document.getElementById('selectedWeekday');
            const progressTextEl = document.getElementById('progressText');
            const progressBarEl = document.getElementById('progressBar');
            const deleteScheduleEl = document.getElementById('deleteSchedule');
            const scheduleList = document.getElementById('scheduleList');
            
            if (selectedDateEl) selectedDateEl.textContent = 'è¯·é€‰æ‹©æ—¥æœŸ';
            if (selectedWeekdayEl) selectedWeekdayEl.textContent = '';
            if (progressTextEl) progressTextEl.textContent = '0/0 (0%)';
            if (progressBarEl) progressBarEl.style.width = '0%';
            if (deleteScheduleEl) deleteScheduleEl.style.display = 'none';
            
            if (scheduleList) {
                scheduleList.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        <h3>é€‰æ‹©æ—¥æœŸæŸ¥çœ‹ä»»åŠ¡</h3>
                        <p>ç‚¹å‡»å·¦ä¾§æ—¥å†ä¸­çš„æ—¥æœŸ<br>æ¥æŸ¥çœ‹å’Œç®¡ç†è¯¥æ—¥çš„æ—¶é—´å®‰æ’</p>
                    </div>
                `;
            } else {
                console.warn('[DOM] scheduleList å…ƒç´ ä¸å­˜åœ¨ï¼Œè·³è¿‡ç©ºçŠ¶æ€æ¸²æŸ“');
            }
        }

        function showEmptySchedule() {
            const progressTextEl = document.getElementById('progressText');
            const progressBarEl = document.getElementById('progressBar');
            const deleteScheduleEl = document.getElementById('deleteSchedule');
            const scheduleList = document.getElementById('scheduleList');
            
            if (progressTextEl) progressTextEl.textContent = '0/0 (0%)';
            if (progressBarEl) progressBarEl.style.width = '0%';
            if (deleteScheduleEl) deleteScheduleEl.style.display = 'none';
            
            if (scheduleList) {
                scheduleList.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12,6 12,12 16,14"></polyline>
                        </svg>
                        <h3>è¯¥æ—¥æœŸæš‚æ— å®‰æ’</h3>
                        <p>ç‚¹å‡»å·¦ä¾§çš„æŒ‰é’®ä¸ºè¯¥æ—¥æœŸ<br>åˆ›å»ºæ—¶é—´ä»»åŠ¡å®‰æ’</p>
                    </div>
                `;
            } else {
                console.warn('[DOM] scheduleList å…ƒç´ ä¸å­˜åœ¨ï¼Œè·³è¿‡ç©ºæ—¥ç¨‹æ¸²æŸ“');
            }
        }

        // ==================== ä»»åŠ¡æ“ä½œ ====================
        
        function toggleCompleted(index) {
            if (selectedSchedule && selectedSchedule.items[index]) {
                const today = new Date();
                const isToday = selectedDate.getFullYear() === today.getFullYear() &&
                               selectedDate.getMonth() === today.getMonth() &&
                               selectedDate.getDate() === today.getDate();
                
                if (!isToday) {
                    showNotification('åªèƒ½å‹¾é€‰ä»Šå¤©çš„ä»»åŠ¡', false);
                    return;
                }
                
                // æ£€æŸ¥ä»»åŠ¡å†…å®¹æ˜¯å¦ä¸ºç©º
                const task = selectedSchedule.items[index].task;
                if (!task || task.trim() === '') {
                    showNotification('è¯·å…ˆè¾“å…¥ä»»åŠ¡å†…å®¹å†å‹¾é€‰', false);
                    return;
                }
                
                console.log('åˆ‡æ¢ä»»åŠ¡å®ŒæˆçŠ¶æ€:', index, 'å½“å‰çŠ¶æ€:', selectedSchedule.items[index].completed);
                
                // æ˜¾ç¤ºç¼–è¾‘çŠ¶æ€
                updateSyncIndicator('editing');
                
                selectedSchedule.items[index].completed = !selectedSchedule.items[index].completed;
                
                console.log('æ–°çŠ¶æ€:', selectedSchedule.items[index].completed);
                console.log('å½“å‰æ—¥ç¨‹æ•°æ®:', selectedSchedule);
                
                // å® ç‰©ç³»ç»Ÿï¼šä¸»ä»»åŠ¡å®Œæˆè·å¾—ç»éªŒå€¼
                if (selectedSchedule.items[index].completed) {
                    petGainXP(5, 'å®Œæˆä¸»ä»»åŠ¡'); // ä¸»ä»»åŠ¡å¥–åŠ±5ç»éªŒ
                }
                
                // å…ˆæ›´æ–°ä»»åŠ¡åˆ—è¡¨æ˜¾ç¤º
                renderScheduleForDate();
                
                // ä½¿ç”¨é˜²æŠ–ä¿å­˜ï¼Œåªæäº¤å½“å‰ä¿®æ”¹çš„æ—¥ç¨‹
                saveToSupabaseDebounced(selectedSchedule.dayId);
                
                // å¼ºåˆ¶æ›´æ–°æ—¥å†é¢œè‰²
                console.log('å¼€å§‹æ›´æ–°æ—¥å†é¢œè‰²...');
                setTimeout(() => {
                    renderCalendar();
                    console.log('æ—¥å†é¢œè‰²æ›´æ–°å®Œæˆ');
                }, 100);
                
                const action = selectedSchedule.items[index].completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ';
                const time = selectedSchedule.items[index].time;
                showNotification(`ä»»åŠ¡${time}æ ‡è®°ä¸º${action}`, selectedSchedule.items[index].completed);
            }
        }

        function updateTask(index, task) {
            if (selectedSchedule && selectedSchedule.items[index]) {
                console.log('æ›´æ–°ä»»åŠ¡å†…å®¹:', index, 'åŸå†…å®¹:', selectedSchedule.items[index].task, 'æ–°å†…å®¹:', task);
                
                // æ˜¾ç¤ºç¼–è¾‘çŠ¶æ€
                updateSyncIndicator('editing');
                
                selectedSchedule.items[index].task = task;
                
                // å¦‚æœä»»åŠ¡å†…å®¹å˜ä¸ºç©ºï¼Œè‡ªåŠ¨å–æ¶ˆå‹¾é€‰çŠ¶æ€
                if (!task || task.trim() === '') {
                    selectedSchedule.items[index].completed = false;
                }
                
                // ä½¿ç”¨é˜²æŠ–ä¿å­˜ï¼Œåªæäº¤å½“å‰ä¿®æ”¹çš„æ—¥ç¨‹
                saveToSupabaseDebounced(selectedSchedule.dayId);
                
                // åªæ›´æ–°å¯¹åº”çš„å¤é€‰æ¡†çŠ¶æ€ï¼Œè€Œä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨
                updateCheckboxState(index, task);
                
                // ä»»åŠ¡å†…å®¹å˜åŒ–ä¼šå½±å“å®Œæˆåº¦è®¡ç®—ï¼Œéœ€è¦æ›´æ–°æ—¥å†é¢œè‰²
                console.log('ä»»åŠ¡å†…å®¹æ›´æ–°ï¼Œå¼€å§‹æ›´æ–°æ—¥å†é¢œè‰²...');
                setTimeout(() => {
                    renderCalendar();
                    console.log('ä»»åŠ¡å†…å®¹æ›´æ–°åæ—¥å†é¢œè‰²æ›´æ–°å®Œæˆ');
                }, 100);
            }
        }

        function updateCheckboxState(index, task) {
            // æ‰¾åˆ°å¯¹åº”çš„å¤é€‰æ¡†
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const checkbox = checkboxes[index];
            
            if (checkbox) {
                const isEmpty = !task || task.trim() === '';
                
                // æ›´æ–°å¤é€‰æ¡†çš„ç¦ç”¨çŠ¶æ€
                checkbox.disabled = isEmpty;
                
                // å¦‚æœä»»åŠ¡å†…å®¹ä¸ºç©ºï¼Œå–æ¶ˆå‹¾é€‰çŠ¶æ€
                if (isEmpty) {
                    checkbox.checked = false;
                }
                
                console.log(`æ›´æ–°å¤é€‰æ¡† ${index} çŠ¶æ€: ç¦ç”¨=${isEmpty}, å‹¾é€‰=${checkbox.checked}`);
            }
        }

        function handleTaskKeyDown(event, currentIndex) {
            if (event.key === 'Enter') {
                // æŒ‰ Enter é”®æ—¶ä¿å­˜å†…å®¹å¹¶å¤±å»ç„¦ç‚¹
                event.preventDefault();
                const input = event.target;
                updateTask(currentIndex, input.value);
                input.blur(); // å¤±å»ç„¦ç‚¹ï¼Œè§¦å‘ onblur äº‹ä»¶
            } else if (event.key === 'Tab') {
                event.preventDefault(); // é˜»æ­¢é»˜è®¤çš„Tabè¡Œä¸º
                
                if (!selectedSchedule || !selectedSchedule.items) return;
                
                // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå¯ç”¨çš„è¾“å…¥æ¡†ï¼ˆè·³è¿‡åªè¯»çš„è¾“å…¥æ¡†ï¼‰
                let nextIndex = currentIndex + 1;
                let attempts = 0;
                
                while (attempts < selectedSchedule.items.length) {
                    if (nextIndex >= selectedSchedule.items.length) {
                        nextIndex = 0; // å¾ªç¯åˆ°ç¬¬ä¸€ä¸ª
                    }
                    
                    const nextItem = selectedSchedule.items[nextIndex];
                    // å¦‚æœä¸æ˜¯åªè¯»çŠ¶æ€ï¼Œå°±å¯ä»¥è·³è½¬
                    if (!nextItem.completed) {
                        break;
                    }
                    
                    nextIndex++;
                    attempts++;
                }
                
                // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªè¾“å…¥æ¡†å…ƒç´ å¹¶èšç„¦
                const nextInput = document.querySelector(`input.task[data-index="${nextIndex}"]`);
                if (nextInput && !nextInput.readOnly) {
                    nextInput.focus();
                    nextInput.select(); // é€‰ä¸­æ–‡æœ¬ä»¥ä¾¿å¿«é€Ÿç¼–è¾‘
                }
            }
        }

        // ==================== å­ä»»åŠ¡æ“ä½œ ====================
        
        function addSubtask(mainTaskIndex) {
            if (!selectedSchedule || !selectedSchedule.items[mainTaskIndex]) {
                console.warn('[å­ä»»åŠ¡] æ— æ³•æ·»åŠ å­ä»»åŠ¡ï¼Œä¸»ä»»åŠ¡ä¸å­˜åœ¨');
                return;
            }
            
            const mainTask = selectedSchedule.items[mainTaskIndex];
            
            // ç¡®ä¿å­ä»»åŠ¡æ•°ç»„å­˜åœ¨
            if (!mainTask.subtasks) {
                mainTask.subtasks = [];
            }
            
            // åˆ›å»ºæ–°çš„å­ä»»åŠ¡
            const newSubtask = {
                id: generateId(),
                content: '',
                completed: false,
                createdAt: new Date().toISOString()
            };
            
            mainTask.subtasks.push(newSubtask);
            
            // è‡ªåŠ¨å±•å¼€å­ä»»åŠ¡åˆ—è¡¨
            mainTask.expanded = true;
            
            console.log(`[å­ä»»åŠ¡] ä¸ºä¸»ä»»åŠ¡ ${mainTaskIndex} æ·»åŠ äº†å­ä»»åŠ¡ï¼Œæ€»è®¡ ${mainTask.subtasks.length} ä¸ªå­ä»»åŠ¡`);
            
            // é‡æ–°æ¸²æŸ“
            renderScheduleForDate();
            
            // èšç„¦åˆ°æ–°æ·»åŠ çš„å­ä»»åŠ¡è¾“å…¥æ¡†
            setTimeout(() => {
                const newSubtaskIndex = mainTask.subtasks.length - 1;
                const newSubtaskInput = document.querySelector(`input.subtask-input[onblur*="${mainTaskIndex}, ${newSubtaskIndex}"]`);
                if (newSubtaskInput) {
                    newSubtaskInput.focus();
                }
            }, 100);
            
            // ä¿å­˜æ›´æ”¹
            saveToSupabaseDebounced(selectedSchedule.dayId);
        }
        
        function toggleSubtasks(mainTaskIndex) {
            if (!selectedSchedule || !selectedSchedule.items[mainTaskIndex]) {
                return;
            }
            
            const mainTask = selectedSchedule.items[mainTaskIndex];
            mainTask.expanded = !mainTask.expanded;
            
            console.log(`[å­ä»»åŠ¡] ä¸»ä»»åŠ¡ ${mainTaskIndex} å±•å¼€çŠ¶æ€: ${mainTask.expanded}`);
            
            // é‡æ–°æ¸²æŸ“
            renderScheduleForDate();
            
            // ä¿å­˜å±•å¼€çŠ¶æ€
            saveToSupabaseDebounced(selectedSchedule.dayId);
        }
        
        function toggleSubtaskCompleted(mainTaskIndex, subtaskIndex) {
            if (!selectedSchedule || !selectedSchedule.items[mainTaskIndex] || 
                !selectedSchedule.items[mainTaskIndex].subtasks[subtaskIndex]) {
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦åªèƒ½å‹¾é€‰ä»Šå¤©çš„ä»»åŠ¡
            const today = new Date();
            const isToday = selectedDate.getFullYear() === today.getFullYear() &&
                           selectedDate.getMonth() === today.getMonth() &&
                           selectedDate.getDate() === today.getDate();
            
            if (!isToday) {
                showNotification('åªèƒ½å‹¾é€‰ä»Šå¤©çš„ä»»åŠ¡', false);
                return;
            }
            
            const subtask = selectedSchedule.items[mainTaskIndex].subtasks[subtaskIndex];
            
            // æ£€æŸ¥å­ä»»åŠ¡å†…å®¹æ˜¯å¦ä¸ºç©º
            if (!subtask.content || subtask.content.trim() === '') {
                showNotification('è¯·å…ˆè¾“å…¥å­ä»»åŠ¡å†…å®¹å†å‹¾é€‰', false);
                return;
            }
            
            // åˆ‡æ¢å®ŒæˆçŠ¶æ€
            subtask.completed = !subtask.completed;
            
            console.log(`[å­ä»»åŠ¡] å­ä»»åŠ¡ ${mainTaskIndex}-${subtaskIndex} å®ŒæˆçŠ¶æ€: ${subtask.completed}`);
            
            // åŒå‘åŒæ­¥ï¼šå¦‚æœå­ä»»åŠ¡æ¥è‡ªç›®æ ‡ï¼Œæ›´æ–°ç›®æ ‡ä¸­çš„å­ä»»åŠ¡çŠ¶æ€
            const mainTask = selectedSchedule.items[mainTaskIndex];
            if (mainTask.goalId && subtask.goalId && window.goalsList) {
                const associatedGoal = window.goalsList.find(goal => goal.id == mainTask.goalId);
                if (associatedGoal && associatedGoal.subtasks) {
                    const originalSubtask = associatedGoal.subtasks.find(st => st.id == subtask.id);
                    if (originalSubtask) {
                        originalSubtask.completed = subtask.completed;
                        
                        // ä¿å­˜ç›®æ ‡æ•°æ®
                        saveGoalsData();
                        
                        console.log(`[åŒå‘åŒæ­¥] å·²åŒæ­¥å­ä»»åŠ¡ ${subtask.id} åˆ°ç›®æ ‡ ${associatedGoal.name}`);
                        
                        // å¦‚æœåœ¨ç›®æ ‡ç®¡ç†é¡µé¢ï¼Œåˆ·æ–°æ˜¾ç¤º
                        if (document.getElementById('goalManagement').classList.contains('active')) {
                            renderGoalsList();
                        }
                    }
                }
            }
            
            // å® ç‰©ç³»ç»Ÿï¼šå­ä»»åŠ¡å®Œæˆè·å¾—ç»éªŒå€¼
            if (subtask.completed) {
                petGainXP(3, 'å®Œæˆå­ä»»åŠ¡'); // å­ä»»åŠ¡å¥–åŠ±3ç»éªŒ
            }
            
            // é‡æ–°æ¸²æŸ“ï¼ˆæ›´æ–°è¿›åº¦å’ŒçŠ¶æ€ï¼‰
            renderScheduleForDate();
            
            // æ£€æŸ¥æ˜¯å¦åº”è¯¥è‡ªåŠ¨å®Œæˆä¸»ä»»åŠ¡
            updateMainTaskBasedOnSubtasks(mainTaskIndex);
            
            // ä¿å­˜æ›´æ”¹
            saveToSupabaseDebounced(selectedSchedule.dayId);
        }
        
        function updateSubtask(mainTaskIndex, subtaskIndex, content) {
            if (!selectedSchedule || !selectedSchedule.items[mainTaskIndex] || 
                !selectedSchedule.items[mainTaskIndex].subtasks[subtaskIndex]) {
                return;
            }
            
            const subtask = selectedSchedule.items[mainTaskIndex].subtasks[subtaskIndex];
            const oldContent = subtask.content;
            subtask.content = content.trim();
            
            console.log(`[å­ä»»åŠ¡] æ›´æ–°å­ä»»åŠ¡å†…å®¹ ${mainTaskIndex}-${subtaskIndex}: "${oldContent}" -> "${subtask.content}"`);
            
            // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€ï¼ˆç©ºå†…å®¹æ—¶ç¦ç”¨ï¼‰
            setTimeout(() => {
                const checkbox = document.querySelector(`input[onchange*="toggleSubtaskCompleted(${mainTaskIndex}, ${subtaskIndex})"]`);
                if (checkbox) {
                    const isEmpty = !subtask.content || subtask.content.trim() === '';
                    checkbox.disabled = isEmpty;
                    
                    // å¦‚æœå†…å®¹ä¸ºç©ºï¼Œå–æ¶ˆå‹¾é€‰çŠ¶æ€
                    if (isEmpty && subtask.completed) {
                        subtask.completed = false;
                        checkbox.checked = false;
                    }
                }
            }, 50);
            
            // ä¿å­˜æ›´æ”¹
            saveToSupabaseDebounced(selectedSchedule.dayId);
        }
        
        function deleteSubtask(mainTaskIndex, subtaskIndex) {
            if (!selectedSchedule || !selectedSchedule.items[mainTaskIndex] || 
                !selectedSchedule.items[mainTaskIndex].subtasks[subtaskIndex]) {
                return;
            }
            
            const mainTask = selectedSchedule.items[mainTaskIndex];
            const subtask = mainTask.subtasks[subtaskIndex];
            
            // ç¡®è®¤åˆ é™¤
            if (subtask.content && subtask.content.trim() !== '') {
                let confirmMessage = `ç¡®å®šè¦åˆ é™¤å­ä»»åŠ¡"${subtask.content}"å—ï¼Ÿ`;
                
                // å¦‚æœæ˜¯æ¥è‡ªç›®æ ‡çš„å­ä»»åŠ¡ï¼Œç»™å‡ºé¢å¤–æç¤º
                if (subtask.goalId && mainTask.goalId) {
                    const associatedGoal = window.goalsList ? window.goalsList.find(goal => goal.id == mainTask.goalId) : null;
                    if (associatedGoal) {
                        confirmMessage += `\n\næ³¨æ„ï¼šæ­¤å­ä»»åŠ¡æ¥è‡ªç›®æ ‡"${associatedGoal.name}"ï¼Œåˆ é™¤ååªä¼šä»ä»Šæ—¥æ—¥ç¨‹ä¸­ç§»é™¤ï¼Œä¸ä¼šå½±å“ç›®æ ‡ä¸­çš„åŸå§‹å­ä»»åŠ¡ã€‚`;
                    }
                }
                
                if (!confirm(confirmMessage)) {
                    return;
                }
            }
            
            console.log(`[å­ä»»åŠ¡] åˆ é™¤å­ä»»åŠ¡ ${mainTaskIndex}-${subtaskIndex}: "${subtask.content || 'ç©ºå†…å®¹'}"`);
            if (subtask.goalId) {
                console.log(`[åŒå‘åŒæ­¥] åˆ é™¤çš„å­ä»»åŠ¡æ¥è‡ªç›®æ ‡ ${subtask.goalId}ï¼Œä»…ä»æ—¥ç¨‹ä¸­ç§»é™¤`);
            }
            
            // åˆ é™¤å­ä»»åŠ¡
            mainTask.subtasks.splice(subtaskIndex, 1);
            
            console.log(`[å­ä»»åŠ¡] å‰©ä½™ ${mainTask.subtasks.length} ä¸ªå­ä»»åŠ¡`);
            
            // å¦‚æœæ²¡æœ‰å­ä»»åŠ¡äº†ï¼Œæ”¶èµ·å±•å¼€çŠ¶æ€
            if (mainTask.subtasks.length === 0) {
                mainTask.expanded = false;
            }
            
            // é‡æ–°æ¸²æŸ“
            renderScheduleForDate();
            
            // ä¿å­˜æ›´æ”¹
            saveToSupabaseDebounced(selectedSchedule.dayId);
        }
        
        function handleSubtaskKeyDown(event, mainTaskIndex, subtaskIndex) {
            if (event.key === 'Enter') {
                // æŒ‰ Enter é”®æ—¶ä¿å­˜å†…å®¹å¹¶å¤±å»ç„¦ç‚¹
                event.preventDefault();
                const input = event.target;
                updateSubtask(mainTaskIndex, subtaskIndex, input.value);
                input.blur();
            } else if (event.key === 'Tab') {
                event.preventDefault();
                
                if (!selectedSchedule || !selectedSchedule.items) return;
                
                const mainTask = selectedSchedule.items[mainTaskIndex];
                if (!mainTask.subtasks) return;
                
                // å°è¯•è·³è½¬åˆ°ä¸‹ä¸€ä¸ªå­ä»»åŠ¡
                if (subtaskIndex + 1 < mainTask.subtasks.length) {
                    const nextSubtaskInput = document.querySelector(`input.subtask-input[onblur*="${mainTaskIndex}, ${subtaskIndex + 1}"]`);
                    if (nextSubtaskInput && !nextSubtaskInput.readOnly) {
                        nextSubtaskInput.focus();
                        nextSubtaskInput.select();
                        return;
                    }
                }
                
                // å¦‚æœæ²¡æœ‰ä¸‹ä¸€ä¸ªå­ä»»åŠ¡ï¼Œè·³è½¬åˆ°ä¸‹ä¸€ä¸ªä¸»ä»»åŠ¡
                let nextMainIndex = mainTaskIndex + 1;
                let attempts = 0;
                
                while (attempts < selectedSchedule.items.length) {
                    if (nextMainIndex >= selectedSchedule.items.length) {
                        nextMainIndex = 0;
                    }
                    
                    const nextMainTask = selectedSchedule.items[nextMainIndex];
                    if (!nextMainTask.completed) {
                        const nextMainInput = document.querySelector(`input.task[data-index="${nextMainIndex}"]`);
                        if (nextMainInput && !nextMainInput.readOnly) {
                            nextMainInput.focus();
                            nextMainInput.select();
                            return;
                        }
                    }
                    
                    nextMainIndex++;
                    attempts++;
                }
            } else if (event.key === 'Delete' && event.ctrlKey) {
                // Ctrl+Delete å¿«é€Ÿåˆ é™¤å­ä»»åŠ¡
                event.preventDefault();
                deleteSubtask(mainTaskIndex, subtaskIndex);
            }
        }
        
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }
        
        // æ£€æŸ¥ä¸»ä»»åŠ¡æ˜¯å¦åº”è¯¥æ ¹æ®å­ä»»åŠ¡çŠ¶æ€è‡ªåŠ¨å®Œæˆ
        function updateMainTaskBasedOnSubtasks(mainTaskIndex) {
            if (!selectedSchedule || !selectedSchedule.items[mainTaskIndex]) {
                return;
            }
            
            const mainTask = selectedSchedule.items[mainTaskIndex];
            
            // å¦‚æœæ²¡æœ‰å­ä»»åŠ¡ï¼Œä¸éœ€è¦æ›´æ–°
            if (!mainTask.subtasks || mainTask.subtasks.length === 0) {
                return;
            }
            
            // åªè€ƒè™‘æœ‰å†…å®¹çš„å­ä»»åŠ¡
            const subtasksWithContent = mainTask.subtasks.filter(st => st.content && st.content.trim() !== '');
            
            if (subtasksWithContent.length === 0) {
                return;
            }
            
            // æ£€æŸ¥æ‰€æœ‰æœ‰å†…å®¹çš„å­ä»»åŠ¡æ˜¯å¦éƒ½å·²å®Œæˆ
            const allSubtasksCompleted = subtasksWithContent.every(st => st.completed);
            const anySubtaskCompleted = subtasksWithContent.some(st => st.completed);
            
            // æ™ºèƒ½æ›´æ–°ä¸»ä»»åŠ¡çŠ¶æ€çš„ç­–ç•¥ï¼š
            // 1. å¦‚æœæ‰€æœ‰å­ä»»åŠ¡éƒ½å®Œæˆï¼Œä¸”ä¸»ä»»åŠ¡æœ‰å†…å®¹ï¼Œåˆ™ä¸»ä»»åŠ¡ä¹Ÿæ ‡è®°ä¸ºå®Œæˆ
            // 2. å¦‚æœæœ‰å­ä»»åŠ¡ä½†æ²¡æœ‰ä¸€ä¸ªå®Œæˆï¼Œä¸”ä¸»ä»»åŠ¡ä¹‹å‰æ˜¯å®ŒæˆçŠ¶æ€ï¼Œåˆ™å–æ¶ˆä¸»ä»»åŠ¡å®Œæˆ
            const hasMainTaskContent = mainTask.task && mainTask.task.trim() !== '';
            
            if (allSubtasksCompleted && hasMainTaskContent && !mainTask.completed) {
                console.log(`[è‡ªåŠ¨å®Œæˆ] æ‰€æœ‰å­ä»»åŠ¡å·²å®Œæˆï¼Œè‡ªåŠ¨å®Œæˆä¸»ä»»åŠ¡ ${mainTaskIndex}`);
                mainTask.completed = true;
                
                // æ˜¾ç¤ºæ™ºèƒ½æç¤º
                showNotification(`ä¸»ä»»åŠ¡"${mainTask.task}"çš„æ‰€æœ‰å­ä»»åŠ¡å·²å®Œæˆï¼Œå·²è‡ªåŠ¨æ ‡è®°ä¸ºå®Œæˆ`, true);
                
                // é‡æ–°æ¸²æŸ“
                renderScheduleForDate();
                
                // ä¿å­˜æ›´æ”¹
                saveToSupabaseDebounced(selectedSchedule.dayId);
            }
        }
        
        // è®¡ç®—å­ä»»åŠ¡è¿›åº¦ç™¾åˆ†æ¯”
        function calculateSubtaskProgress(subtasks) {
            if (!subtasks || subtasks.length === 0) {
                return { completed: 0, total: 0, percentage: 0 };
            }
            
            const subtasksWithContent = subtasks.filter(st => st.content && st.content.trim() !== '');
            const completedSubtasks = subtasksWithContent.filter(st => st.completed);
            
            return {
                completed: completedSubtasks.length,
                total: subtasksWithContent.length,
                percentage: subtasksWithContent.length > 0 ? 
                    Math.round((completedSubtasks.length / subtasksWithContent.length) * 100) : 0
            };
        }

        // ==================== æ—¥ç¨‹åˆ›å»º ====================
        
        function goToToday() {
            console.log('è·³è½¬åˆ°ä»Šå¤©');
            const today = new Date();
            selectedDate = new Date(today);
            currentDate = new Date(today);
            
            // ä¸»åŠ¨æ‰§è¡Œä»»åŠ¡æµè½¬
            console.log('ç‚¹å‡»ä»Šæ—¥æ—¥ç¨‹ï¼Œæ‰§è¡Œä»»åŠ¡æµè½¬');
            processUnfinishedTasks();
            
            // æŸ¥æ‰¾ä»Šæ—¥çš„æ—¥ç¨‹å®‰æ’ï¼ˆå’ŒselectDateå‡½æ•°ä¸€æ ·çš„é€»è¾‘ï¼‰
            const dayId = formatDateToId(today);
            selectedSchedule = schedules.find(s => s.dayId == dayId);
            console.log('ä»Šæ—¥çš„æ—¥ç¨‹å®‰æ’:', selectedSchedule);
            
            // é‡æ–°æ¸²æŸ“æ—¥å†å’Œä»»åŠ¡åˆ—è¡¨
            renderCalendar();
            renderScheduleForDate();
            
            showNotification('å·²åˆ‡æ¢åˆ°ä»Šæ—¥', true);
        }

        function addDaySchedule(dateOffset = 0) {
            const date = new Date();
            date.setDate(date.getDate() + dateOffset);
            
            const dateStr = formatDate(date);
            const weekdayStr = getWeekday(date);
            const dayId = formatDateToId(date);
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const exists = schedules.some(s => s.dayId == dayId);
            if (exists) {
                showNotification(`${dateStr}çš„æ—¥ç¨‹å·²å­˜åœ¨!`, false);
                // é€‰æ‹©è¯¥æ—¥æœŸ
                selectDate(date);
                return;
            }
            
            const newSchedule = {
                dayId: dayId,
                date: dateStr,
                weekday: weekdayStr,
                items: generateTimeSlotsWithTemplate(date),
                createdAt: new Date().toISOString()
            };
            
            schedules.unshift(newSchedule);
            
            // ä½¿ç”¨é˜²æŠ–ä¿å­˜æ–°åˆ›å»ºçš„æ—¥ç¨‹
            saveToSupabaseDebounced(newSchedule.dayId);
            
            // é€‰æ‹©æ–°åˆ›å»ºçš„æ—¥æœŸ
            selectDate(date);
            renderCalendar();
            
            showNotification(`å·²æ·»åŠ ${dateStr}æ—¥ç¨‹`, true);
        }

        function addWeekSchedules(isNextWeek = false) {
            const today = new Date();
            const currentDay = today.getDay();
            const mondayOffset = currentDay === 0 ? -6 : 1 - currentDay;
            
            // å¦‚æœæ˜¯ä¸‹å‘¨ï¼Œå†åŠ 7å¤©
            const weekOffset = isNextWeek ? 7 : 0;
            const monday = new Date(today.getTime() + (mondayOffset + weekOffset) * 24 * 60 * 60 * 1000);
            
            let addedCount = 0;
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday.getTime() + i * 24 * 60 * 60 * 1000);
                const dayId = formatDateToId(date);
                
                if (!schedules.some(s => s.dayId == dayId)) {
                    const newSchedule = {
                        dayId: dayId,
                        date: formatDate(date),
                        weekday: getWeekday(date),
                        items: generateTimeSlotsWithTemplate(date),
                        createdAt: new Date().toISOString()
                    };
                    
                    schedules.push(newSchedule);
                    addedCount++;
                }
            }
            
            if (addedCount > 0) {
                schedules.sort((a, b) => b.dayId - a.dayId);
                
                // æ‰¹é‡ä¿å­˜æ‰€æœ‰æ–°åˆ›å»ºçš„æ—¥ç¨‹
                const newScheduleIds = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(monday.getTime() + i * 24 * 60 * 60 * 1000);
                    const dayId = formatDateToId(date);
                    if (schedules.some(s => s.dayId == dayId)) {
                        newScheduleIds.push(dayId);
                    }
                }
                
                // å°†æ–°æ—¥ç¨‹åŠ å…¥å¾…åŒæ­¥åˆ—è¡¨
                newScheduleIds.forEach(id => pendingChanges.add(id));
                saveToSupabaseDebounced();
                
                renderCalendar();
                renderScheduleForDate();
                const weekText = isNextWeek ? 'ä¸‹å‘¨' : 'æœ¬å‘¨';
                showNotification(`å·²æ·»åŠ ${weekText}${addedCount}å¤©æ—¥ç¨‹`, true);
            } else {
                const weekText = isNextWeek ? 'ä¸‹å‘¨' : 'æœ¬å‘¨';
                showNotification(`${weekText}æ—¥ç¨‹å·²å…¨éƒ¨å­˜åœ¨`, false);
            }
        }

        function deleteCurrentSchedule() {
            if (!selectedSchedule) return;
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤${selectedSchedule.date}çš„æ—¥ç¨‹å—ï¼Ÿ`)) {
                const index = schedules.findIndex(s => s.dayId === selectedSchedule.dayId);
                if (index !== -1) {
                    const deletedDate = schedules[index].date;
                    const dayId = schedules[index].dayId;
                    
                    // ä»æœ¬åœ°æ•°ç»„ä¸­åˆ é™¤
                    schedules.splice(index, 1);
                    
                    // ä»Supabaseä¸­åˆ é™¤ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡UIï¼‰
                    if (currentUser && isOnline) {
                        deleteScheduleFromSupabase(dayId).catch(error => {
                            console.error('åˆ é™¤äº‘ç«¯æ•°æ®å¤±è´¥:', error);
                            showNotification('æœ¬åœ°åˆ é™¤æˆåŠŸï¼Œäº‘ç«¯åˆ é™¤å¤±è´¥', false);
                        });
                    } else {
                        // ç¦»çº¿æ—¶ä¿å­˜åˆ°æœ¬åœ°
                        saveToLocalStorage();
                    }
                    
                    selectedSchedule = null;
                    renderCalendar();
                    renderScheduleForDate();
                    
                    showNotification(`å·²åˆ é™¤${deletedDate}æ—¥ç¨‹`, false);
                }
            }
        }

        // ==================== æ¨¡æ¿ç®¡ç† ====================
        
        let workdayTemplate = {}; // å·¥ä½œæ—¥æ¨¡æ¿
        let nonWorkdayTemplate = {}; // éå·¥ä½œæ—¥æ¨¡æ¿
        let currentTemplateTab = 'workday'; // å½“å‰ç¼–è¾‘çš„æ¨¡æ¿ç±»å‹
        
        function openTemplateModal() {
            console.log('æ‰“å¼€æ¨¡æ¿è®¾ç½®çª—å£');
            
            // æ˜¾ç¤ºæ¨¡æ¿çª—å£
            document.getElementById('templateModal').classList.add('show');
            
            // åˆå§‹åŒ–æ¨¡æ¿å†…å®¹
            renderTemplateTimeSlots();
            
            // è®¾ç½®é»˜è®¤é€‰ä¸­å·¥ä½œæ—¥tab
            switchTemplateTab('workday');
        }
        
        function closeTemplateModal() {
            console.log('å…³é—­æ¨¡æ¿è®¾ç½®çª—å£');
            document.getElementById('templateModal').classList.remove('show');
        }
        
        function switchTemplateTab(tabType) {
            console.log('åˆ‡æ¢æ¨¡æ¿æ ‡ç­¾é¡µ:', tabType);
            
            currentTemplateTab = tabType;
            
            // æ›´æ–°tabæŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.template-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.template-content').forEach(content => content.classList.remove('active'));
            
            if (tabType === 'workday') {
                document.getElementById('workdayTab').classList.add('active');
                document.getElementById('workdayContent').classList.add('active');
            } else {
                document.getElementById('nonWorkdayTab').classList.add('active');
                document.getElementById('nonWorkdayContent').classList.add('active');
            }
            
            // æ›´æ–°æ¨¡æ¿å†…å®¹
            loadTemplateData(tabType);
        }
        
        function renderTemplateTimeSlots() {
            console.log('æ¸²æŸ“æ¨¡æ¿æ—¶é—´æ®µ');
            
            const workdayContainer = document.getElementById('workdayTimeList');
            const nonWorkdayContainer = document.getElementById('nonWorkdayTimeList');
            
            // ç¡®ä¿ç›®æ ‡æ•°æ®å·²åŠ è½½
            if (!window.goalsList) {
                loadGoalsData();
            }
            
            // ç”Ÿæˆç›®æ ‡é€‰æ‹©é€‰é¡¹
            function generateGoalOptions() {
                let options = '<option value="">é€‰æ‹©å…³è”ç›®æ ‡ï¼ˆå¯é€‰ï¼‰</option>';
                if (window.goalsList && window.goalsList.length > 0) {
                    window.goalsList.forEach(goal => {
                        options += `<option value="${goal.id}">${goal.name}</option>`;
                    });
                }
                return options;
            }
            
            // ç”Ÿæˆæ—¶é—´æ®µHTML
            const timeSlotHTML = [];
            for (let hour = 7; hour <= 23; hour++) {
                const timeSlot = `${hour}:00`;
                timeSlotHTML.push(`
                    <div class="template-time-item">
                        <div class="template-time-label">${timeSlot}</div>
                        <input type="text" class="template-task-input" 
                               data-time="${timeSlot}" 
                               placeholder="è¾“å…¥é»˜è®¤ä»»åŠ¡..."
                               onchange="updateTemplateTask('${timeSlot}', this.value)">
                        <select class="template-goal-select" 
                                data-time="${timeSlot}"
                                onchange="updateTemplateGoalAssociation('${timeSlot}', this.value)">
                            ${generateGoalOptions()}
                        </select>
                    </div>
                `);
            }
            
            workdayContainer.innerHTML = timeSlotHTML.join('');
            nonWorkdayContainer.innerHTML = timeSlotHTML.join('');
        }
        
        function loadTemplateData(templateType) {
            console.log('åŠ è½½æ¨¡æ¿æ•°æ®:', templateType);
            
            const template = templateType === 'workday' ? workdayTemplate : nonWorkdayTemplate;
            const container = templateType === 'workday' 
                ? document.getElementById('workdayTimeList') 
                : document.getElementById('nonWorkdayTimeList');
            
            // å¡«å…¥å·²ä¿å­˜çš„æ¨¡æ¿æ•°æ®
            const inputs = container.querySelectorAll('.template-task-input');
            const selects = container.querySelectorAll('.template-goal-select');
            
            inputs.forEach(input => {
                const time = input.getAttribute('data-time');
                const templateData = template[time];
                if (templateData && typeof templateData === 'object') {
                    input.value = templateData.task || '';
                } else if (typeof templateData === 'string') {
                    // å…¼å®¹æ—§æ ¼å¼
                    input.value = templateData;
                } else {
                    input.value = '';
                }
            });

            selects.forEach(select => {
                const time = select.getAttribute('data-time');
                const templateData = template[time];
                if (templateData && typeof templateData === 'object') {
                    select.value = templateData.goalId || '';
                } else {
                    select.value = '';
                }
            });
        }
        
        function updateTemplateTask(time, task) {
            console.log('æ›´æ–°æ¨¡æ¿ä»»åŠ¡:', currentTemplateTab, time, task);
            
            if (currentTemplateTab === 'workday') {
                if (task.trim()) {
                    if (!workdayTemplate[time]) {
                        workdayTemplate[time] = {};
                    }
                    workdayTemplate[time].task = task.trim();
                } else {
                    if (workdayTemplate[time]) {
                        delete workdayTemplate[time].task;
                        if (Object.keys(workdayTemplate[time]).length === 0) {
                            delete workdayTemplate[time];
                        }
                    }
                }
            } else {
                if (task.trim()) {
                    if (!nonWorkdayTemplate[time]) {
                        nonWorkdayTemplate[time] = {};
                    }
                    nonWorkdayTemplate[time].task = task.trim();
                } else {
                    if (nonWorkdayTemplate[time]) {
                        delete nonWorkdayTemplate[time].task;
                        if (Object.keys(nonWorkdayTemplate[time]).length === 0) {
                            delete nonWorkdayTemplate[time];
                        }
                    }
                }
            }
        }

        function updateTemplateGoalAssociation(time, goalId) {
            console.log('æ›´æ–°æ¨¡æ¿ç›®æ ‡å…³è”:', currentTemplateTab, time, goalId);
            
            if (currentTemplateTab === 'workday') {
                if (goalId) {
                    if (!workdayTemplate[time]) {
                        workdayTemplate[time] = {};
                    }
                    workdayTemplate[time].goalId = goalId;
                } else {
                    if (workdayTemplate[time]) {
                        delete workdayTemplate[time].goalId;
                        if (Object.keys(workdayTemplate[time]).length === 0) {
                            delete workdayTemplate[time];
                        }
                    }
                }
            } else {
                if (goalId) {
                    if (!nonWorkdayTemplate[time]) {
                        nonWorkdayTemplate[time] = {};
                    }
                    nonWorkdayTemplate[time].goalId = goalId;
                } else {
                    if (nonWorkdayTemplate[time]) {
                        delete nonWorkdayTemplate[time].goalId;
                        if (Object.keys(nonWorkdayTemplate[time]).length === 0) {
                            delete nonWorkdayTemplate[time];
                        }
                    }
                }
            }
        }
        
        function saveTemplates() {
            console.log('ä¿å­˜æ¨¡æ¿');
            
            try {
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('calendarWorkdayTemplate', JSON.stringify(workdayTemplate));
                localStorage.setItem('calendarNonWorkdayTemplate', JSON.stringify(nonWorkdayTemplate));
                
                // ä¿å­˜åˆ°Supabaseï¼ˆå¼‚æ­¥ï¼‰
                if (currentUser && isOnline) {
                    saveTemplatesToSupabase().then(() => {
                        console.log('æ¨¡æ¿å·²åŒæ­¥åˆ°äº‘ç«¯');
                    }).catch(error => {
                        console.error('æ¨¡æ¿äº‘ç«¯ä¿å­˜å¤±è´¥:', error);
                        showNotification('æ¨¡æ¿å·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œäº‘ç«¯åŒæ­¥å¤±è´¥', false);
                    });
                }
                
                console.log('æ¨¡æ¿å·²ä¿å­˜åˆ°localStorage');
                showNotification('æ¨¡æ¿å·²ä¿å­˜', true);
                
                closeTemplateModal();
                updateTemplateListDisplay();
                
            } catch (error) {
                console.error('ä¿å­˜æ¨¡æ¿å¤±è´¥:', error);
                showNotification('ä¿å­˜æ¨¡æ¿å¤±è´¥', false);
            }
        }
        
        function loadTemplatesFromStorage() {
            console.log('ä»å­˜å‚¨åŠ è½½æ¨¡æ¿');
            
            try {
                const savedWorkdayTemplate = localStorage.getItem('calendarWorkdayTemplate');
                const savedNonWorkdayTemplate = localStorage.getItem('calendarNonWorkdayTemplate');
                
                if (savedWorkdayTemplate) {
                    workdayTemplate = JSON.parse(savedWorkdayTemplate);
                }
                
                if (savedNonWorkdayTemplate) {
                    nonWorkdayTemplate = JSON.parse(savedNonWorkdayTemplate);
                }
                
                updateTemplateListDisplay();
                
            } catch (error) {
                console.error('åŠ è½½æ¨¡æ¿å¤±è´¥:', error);
                workdayTemplate = {};
                nonWorkdayTemplate = {};
            }
        }
        
        function updateTemplateListDisplay() {
            console.log('æ›´æ–°æ¨¡æ¿åˆ—è¡¨æ˜¾ç¤º');
            
            const templateList = document.getElementById('templateList');
            
            const workdayCount = Object.keys(workdayTemplate).length;
            const nonWorkdayCount = Object.keys(nonWorkdayTemplate).length;
            const totalCount = workdayCount + nonWorkdayCount;
            
            if (totalCount === 0) {
                templateList.innerHTML = `
                    <div class="empty-state" style="padding: 20px; text-align: center; font-size: 0.8rem; color: var(--gray-500);">
                        æš‚æ— æ¨¡æ¿ï¼Œç‚¹å‡»è®¾ç½®æŒ‰é’®æ·»åŠ 
                    </div>
                `;
            } else {
                let html = `
                    <div class="template-item">
                        <span>ğŸ“¼ å·¥ä½œæ—¥æ¨¡æ¿: ${workdayCount}ä¸ªä»»åŠ¡</span>
                    </div>
                    <div class="template-item">
                        <span>ğŸ‰ éå·¥ä½œæ—¥æ¨¡æ¿: ${nonWorkdayCount}ä¸ªä»»åŠ¡</span>
                    </div>
                `;
                templateList.innerHTML = html;
            }
        }
        
        function isWorkday(date) {
            const dayOfWeek = date.getDay();
            const isWork = dayOfWeek >= 1 && dayOfWeek <= 5;
            
            // æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
            const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            console.log(`æ—¥æœŸ: ${formatDate(date)}, æ˜ŸæœŸ: ${dayNames[dayOfWeek]} (${dayOfWeek}), æ˜¯å¦å·¥ä½œæ—¥: ${isWork}`);
            
            return isWork;
        }
        
        function generateTimeSlotsWithTemplate(date) {
            console.log('ä½¿ç”¨æ¨¡æ¿ç”Ÿæˆæ—¶é—´æ®µ:', formatDate(date));
            
            const slots = [];
            const isWork = isWorkday(date);
            const template = isWork ? workdayTemplate : nonWorkdayTemplate;
            const templateType = isWork ? 'å·¥ä½œæ—¥' : 'éå·¥ä½œæ—¥';
            
            console.log(`ä½¿ç”¨${templateType}æ¨¡æ¿:`, template);
            console.log(`å·¥ä½œæ—¥æ¨¡æ¿ä»»åŠ¡æ•°: ${Object.keys(workdayTemplate).length}`);
            console.log(`éå·¥ä½œæ—¥æ¨¡æ¿ä»»åŠ¡æ•°: ${Object.keys(nonWorkdayTemplate).length}`);
            
            for (let hour = 7; hour <= 23; hour++) {
                const timeSlot = `${hour}:00`;
                const templateData = template[timeSlot];
                
                let taskContent = '';
                let goalId = null;
                let subtasks = [];
                
                if (templateData) {
                    if (typeof templateData === 'object') {
                        taskContent = templateData.task || '';
                        goalId = templateData.goalId || null;
                        
                        // å¦‚æœå…³è”äº†ç›®æ ‡ï¼Œè·å–è¯¥ç›®æ ‡çš„æœªå®Œæˆå­ä»»åŠ¡
                        if (goalId && window.goalsList) {
                            const associatedGoal = window.goalsList.find(goal => goal.id == goalId);
                            if (associatedGoal && associatedGoal.subtasks) {
                                subtasks = associatedGoal.subtasks
                                    .filter(subtask => !subtask.completed)
                                    .map(subtask => ({
                                        id: subtask.id,
                                        content: subtask.text, // ä½¿ç”¨ content å­—æ®µä»¥åŒ¹é…æ—¥ç¨‹æ ¼å¼
                                        completed: false,
                                        goalId: goalId // è®°å½•æ¥æºç›®æ ‡ID
                                    }));
                            }
                        }
                    } else if (typeof templateData === 'string') {
                        // å…¼å®¹æ—§æ ¼å¼
                        taskContent = templateData;
                    }
                }
                
                slots.push({
                    time: timeSlot,
                    task: taskContent,
                    goalId: goalId,
                    completed: false,
                    subtasks: subtasks,
                    expanded: false
                });
            }
            
            const tasksWithContent = slots.filter(s => s.task || (s.subtasks && s.subtasks.length > 0));
            console.log(`ç”Ÿæˆäº† ${slots.length} ä¸ªæ—¶é—´æ®µï¼Œå…¶ä¸­ ${tasksWithContent.length} ä¸ªæœ‰å†…å®¹`);
            
            return slots;
        }

        // ==================== æ—¥å†å¯¼èˆª ====================
        
        function navigateMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
            
            // å¯¼èˆªæ“ä½œä¸éœ€è¦é¢‘ç¹åŒæ­¥ï¼Œä»…ä¿å­˜åˆ°æœ¬åœ°
            saveToLocalStorage();
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}å¹´${month}æœˆ${day}æ—¥`;
        }

        function formatDateToId(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return year + month + day;
        }

        function getWeekday(date) {
            const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
            return weekdays[date.getDay()];
        }

        function showNotification(message, isSuccess = true) {
            // å°†é€šçŸ¥å‘é€åˆ°reportviewæ—¥å¿—è€Œä¸æ˜¯å¼¹çª—
            if (window.enhancedSync && window.enhancedSync.updateStatus) {
                const logType = isSuccess ? 'success' : 'error';
                window.enhancedSync.updateStatus(logType, message);
            } else {
                // å¦‚æœå¢å¼ºåŒæ­¥ç³»ç»ŸæœªåŠ è½½ï¼Œç›´æ¥æ·»åŠ åˆ°æ—¥å¿—å®¹å™¨
                const syncLogContainer = document.getElementById('syncLogContainer');
                if (syncLogContainer) {
                    const now = new Date();
                    const timestamp = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
                    
                    const logEntry = document.createElement('div');
                    logEntry.className = `log-entry log-${isSuccess ? 'success' : 'error'}`;
                    logEntry.innerHTML = `
                        <span class="log-timestamp">${timestamp}</span>
                        <span class="log-message">${message}</span>
                    `;
                    
                    syncLogContainer.appendChild(logEntry);
                    
                    // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€ä¸‹é¢
                    setTimeout(() => {
                        syncLogContainer.scrollTop = syncLogContainer.scrollHeight;
                    }, 50);
                    
                    // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡
                    while (syncLogContainer.children.length > 50) {
                        syncLogContainer.removeChild(syncLogContainer.firstChild);
                    }
                }
            }
        }

        function clearCache() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ—¥ç¨‹æ•°æ®å—ï¼Ÿï¼ˆæ¨¡æ¿æ•°æ®å°†è¢«ä¿ç•™ï¼‰')) {
                // å¤‡ä»½æ¨¡æ¿æ•°æ®
                const workdayTemplateBackup = { ...workdayTemplate };
                const nonWorkdayTemplateBackup = { ...nonWorkdayTemplate };
                
                // æ¸…ç©ºæ—¥ç¨‹ç›¸å…³çš„æœ¬åœ°å­˜å‚¨ï¼ˆä¿ç•™æ¨¡æ¿ï¼‰
                localStorage.removeItem('calendarSchedules');
                localStorage.removeItem('calendarCurrentDate');
                localStorage.removeItem('calendarSchedulesBackup');
                localStorage.removeItem('calendarSchedulesBackupTime');
                
                // é‡ç½®æ—¥ç¨‹ç›¸å…³çš„æœ¬åœ°å˜é‡ï¼ˆä¿ç•™æ¨¡æ¿ï¼‰
                schedules = [];
                selectedSchedule = null;
                currentDate = new Date();
                selectedDate = new Date();
                
                // æ¢å¤æ¨¡æ¿æ•°æ®
                workdayTemplate = workdayTemplateBackup;
                nonWorkdayTemplate = nonWorkdayTemplateBackup;
                
                // æ¸…ç©ºåŒæ­¥ç³»ç»Ÿçš„å¾…æäº¤åˆ—è¡¨
                if (typeof pendingChanges !== 'undefined') {
                    pendingChanges.clear();
                }
                
                // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œè¯¢é—®æ˜¯å¦æ¸…ç©ºäº‘ç«¯æ—¥ç¨‹æ•°æ®
                if (currentUser && confirm('æ˜¯å¦åŒæ—¶æ¸…ç©ºäº‘ç«¯æ—¥ç¨‹æ•°æ®ï¼Ÿï¼ˆäº‘ç«¯æ¨¡æ¿æ•°æ®å°†è¢«ä¿ç•™ï¼‰')) {
                    clearSupabaseSchedulesOnly();
                }
                
                renderCalendar();
                renderScheduleForDate();
                updateTemplateListDisplay();
                showNotification('æ—¥ç¨‹æ•°æ®å·²æ¸…ç©ºï¼Œæ¨¡æ¿æ•°æ®å·²ä¿ç•™', true);
            }
        }

        // æ–°å¢ï¼šåªæ¸…ç©ºäº‘ç«¯æ—¥ç¨‹æ•°æ®çš„å‡½æ•°
        async function clearSupabaseSchedulesOnly() {
            try {
                updateSyncIndicator('syncing');
                
                // åªåˆ é™¤æ—¥ç¨‹æ•°æ®ï¼Œä¿ç•™æ¨¡æ¿å’Œè®¾ç½®
                const { error } = await supabaseClient
                    .from('schedules')
                    .delete()
                    .eq('user_id', currentUser.id);
                
                if (error) throw error;
                
                updateSyncIndicator('synced');
                console.log('äº‘ç«¯æ—¥ç¨‹æ•°æ®å·²æ¸…ç©º');
                
            } catch (error) {
                console.error('æ¸…ç©ºäº‘ç«¯æ—¥ç¨‹æ•°æ®å¤±è´¥:', error);
                updateSyncIndicator('error');
                showNotification('æ¸…ç©ºäº‘ç«¯æ•°æ®å¤±è´¥: ' + error.message, false);
            }
        }
        
        // å®Œå…¨æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬æ¨¡æ¿ï¼‰
        function clearAllData() {
            if (confirm('âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬æ—¥ç¨‹å’Œæ¨¡æ¿ï¼‰ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                if (confirm('ğŸ”¥ æœ€åç¡®è®¤ï¼šæ‰€æœ‰æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ï¼ŒåŒ…æ‹¬æ‚¨ç²¾å¿ƒè®¾ç½®çš„æ¨¡æ¿ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                    // æ¸…ç©ºæ‰€æœ‰æœ¬åœ°å­˜å‚¨
                    localStorage.removeItem('calendarSchedules');
                    localStorage.removeItem('calendarCurrentDate');
                    localStorage.removeItem('calendarWorkdayTemplate');
                    localStorage.removeItem('calendarNonWorkdayTemplate');
                    localStorage.removeItem('calendarSchedulesBackup');
                    localStorage.removeItem('calendarSchedulesBackupTime');
                    
                    // é‡ç½®æ‰€æœ‰æœ¬åœ°å˜é‡
                    schedules = [];
                    workdayTemplate = {};
                    nonWorkdayTemplate = {};
                    selectedSchedule = null;
                    currentDate = new Date();
                    selectedDate = new Date();
                    
                    // æ¸…ç©ºåŒæ­¥ç³»ç»Ÿçš„å¾…æäº¤åˆ—è¡¨
                    if (typeof pendingChanges !== 'undefined') {
                        pendingChanges.clear();
                    }
                    
                    // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œä¹Ÿæ¸…ç©ºäº‘ç«¯æ‰€æœ‰æ•°æ®
                    if (currentUser && confirm('æ˜¯å¦åŒæ—¶æ¸…ç©ºäº‘ç«¯æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬æ¨¡æ¿ï¼‰ï¼Ÿ')) {
                        clearSupabaseData();
                    }
                    
                    renderCalendar();
                    renderScheduleForDate();
                    updateTemplateListDisplay();
                    showNotification('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º', false);
                }
            }
        }
        
        async function clearSupabaseData() {
            if (!currentUser) return;
            
            updateSyncStatus('syncing', 'æ¸…ç†ä¸­...');
            
            try {
                // åˆ é™¤æ‰€æœ‰æ—¥ç¨‹
                const { error: schedulesError } = await supabaseClient
                    .from('schedules')
                    .delete()
                    .eq('user_id', currentUser.id);
                
                if (schedulesError) throw schedulesError;
                
                // åˆ é™¤æ‰€æœ‰æ¨¡æ¿
                const { error: templatesError } = await supabaseClient
                    .from('templates')
                    .delete()
                    .eq('user_id', currentUser.id);
                
                if (templatesError) throw templatesError;
                
                // åˆ é™¤ç”¨æˆ·è®¾ç½®
                const { error: settingsError } = await supabaseClient
                    .from('user_settings')
                    .delete()
                    .eq('user_id', currentUser.id);
                
                if (settingsError) throw settingsError;
                
                updateSyncStatus('', 'å·²æ¸…ç†');
                showNotification('äº‘ç«¯æ•°æ®å·²æ¸…ç©º', true);
                
            } catch (error) {
                console.error('æ¸…ç†äº‘ç«¯æ•°æ®å¤±è´¥:', error);
                updateSyncStatus('offline', 'æ¸…ç†å¤±è´¥');
                showNotification('äº‘ç«¯æ•°æ®æ¸…ç†å¤±è´¥ï¼š' + error.message, false);
            }
        }

        // ==================== è™šæ‹Ÿå® ç‰©ç³»ç»Ÿ ====================
        
        // å® ç‰©æ•°æ®ç»“æ„
        let petData = {
            name: 'å°çŒ«å’ª',
            level: 1,
            xp: 0,
            maxXP: 100,
            mood: 'å¼€å¿ƒ',
            sprite: 'ğŸ±',
            totalTasksCompleted: 0,
            createdDate: new Date().toISOString(),
            lastFeedTime: null,
            evolution: 0 // è¿›åŒ–é˜¶æ®µï¼š0=å°çŒ«, 1=å¤§çŒ«, 2=è¶…çº§çŒ«
        };
        
        // å® ç‰©éŸ³æ•ˆï¼ˆç®€å•çš„éŸ³æ•ˆæ¨¡æ‹Ÿï¼‰
        const petSounds = {
            gainXP: () => playTone(200, 0.1),
            levelUp: () => {
                playTone(300, 0.1);
                setTimeout(() => playTone(400, 0.1), 100);
                setTimeout(() => playTone(500, 0.1), 200);
            },
            interaction: () => playTone(350, 0.05),
            evolve: () => {
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => playTone(400 + i * 50, 0.1), i * 100);
                }
            }
        };
        
        // æ’­æ”¾ç®€å•éŸ³è°ƒ
        function playTone(frequency, duration) {
            if (!window.AudioContext && !window.webkitAudioContext) return;
            
            try {
                const context = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = context.createOscillator();
                const gainNode = context.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(context.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + duration);
                
                oscillator.start(context.currentTime);
                oscillator.stop(context.currentTime + duration);
            } catch (error) {
                console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', error);
            }
        }
        
        // åˆå§‹åŒ–å® ç‰©ç³»ç»Ÿ
        function initPetSystem() {
            const savedPetData = localStorage.getItem('petData');
            if (savedPetData) {
                try {
                    petData = { ...petData, ...JSON.parse(savedPetData) };
                } catch (error) {
                    console.log('å® ç‰©æ•°æ®åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
                }
            }
            
            updatePetDisplay();
            
            // æ¯éš”ä¸€æ®µæ—¶é—´æ£€æŸ¥å® ç‰©çŠ¶æ€
            setInterval(updatePetMood, 30000); // 30ç§’æ›´æ–°ä¸€æ¬¡å¿ƒæƒ…
        }
        
        // æ›´æ–°å® ç‰©æ˜¾ç¤º
        function updatePetDisplay() {
            const petName = document.getElementById('petName');
            const petLevel = document.getElementById('petLevel');
            const petSprite = document.getElementById('petSprite');
            const petXPFill = document.getElementById('petXPFill');
            const petXPText = document.getElementById('petXPText');
            const petMood = document.getElementById('petMood');
            
            if (petName) petName.textContent = petData.name;
            if (petLevel) petLevel.textContent = `Lv.${petData.level}`;
            if (petXPFill) {
                const xpPercent = (petData.xp / petData.maxXP) * 100;
                petXPFill.style.width = `${xpPercent}%`;
            }
            if (petXPText) petXPText.textContent = `${petData.xp} / ${petData.maxXP} XP`;
            if (petMood) petMood.textContent = getPetMoodDisplay();
            
            // æ ¹æ®ç­‰çº§æ›´æ–°å® ç‰©å¤–è§‚
            if (petSprite) {
                const spriteEmoji = getPetSprite();
                const emojiElement = petSprite.childNodes[0];
                if (emojiElement && emojiElement.nodeType === Node.TEXT_NODE) {
                    emojiElement.textContent = spriteEmoji;
                }
            }
        }
        
        // è·å–å® ç‰©å¤–è§‚
        function getPetSprite() {
            const sprites = {
                0: { // å°çŒ«é˜¶æ®µ
                    1: 'ğŸ±', 5: 'ğŸ˜º', 10: 'ğŸ˜¸', 15: 'ğŸ˜»'
                },
                1: { // å¤§çŒ«é˜¶æ®µ
                    20: 'ğŸ¦', 25: 'ğŸ¯', 30: 'ğŸ†'
                },
                2: { // ä¼ è¯´é˜¶æ®µ
                    35: 'ğŸ¦„', 40: 'ğŸ‰', 50: 'ğŸ‘‘'
                }
            };
            
            const evolution = Math.floor(petData.level / 20);
            const evolutionSprites = sprites[Math.min(evolution, 2)];
            
            // æ‰¾åˆ°å½“å‰ç­‰çº§å¯¹åº”çš„æœ€é«˜å¤–è§‚
            let currentSprite = petData.sprite;
            for (const [levelThreshold, sprite] of Object.entries(evolutionSprites)) {
                if (petData.level >= parseInt(levelThreshold)) {
                    currentSprite = sprite;
                }
            }
            
            return currentSprite;
        }
        
        // è·å–å® ç‰©å¿ƒæƒ…æ˜¾ç¤º
        function getPetMoodDisplay() {
            const moods = [
                { threshold: 0, mood: 'ğŸ˜´ å›°å€¦', emoji: 'ğŸ˜´' },
                { threshold: 5, mood: 'ğŸ˜Š å¼€å¿ƒ', emoji: 'ğŸ˜Š' },
                { threshold: 10, mood: 'ğŸ˜† å…´å¥‹', emoji: 'ğŸ˜†' },
                { threshold: 20, mood: 'ğŸ¤© è¶…çº§å¼€å¿ƒ', emoji: 'ğŸ¤©' },
                { threshold: 30, mood: 'ğŸ‘‘ å¨ä¸¥', emoji: 'ğŸ‘‘' }
            ];
            
            for (let i = moods.length - 1; i >= 0; i--) {
                if (petData.level >= moods[i].threshold) {
                    return moods[i].mood;
                }
            }
            
            return 'ğŸ˜Š å¼€å¿ƒ';
        }
        
        // å® ç‰©è·å¾—ç»éªŒå€¼
        function petGainXP(xpAmount, source = 'å®Œæˆä»»åŠ¡') {
            console.log(`[å® ç‰©] ${petData.name} é€šè¿‡"${source}"è·å¾— ${xpAmount} ç»éªŒå€¼`);
            
            const oldLevel = petData.level;
            petData.xp += xpAmount;
            petData.totalTasksCompleted++;
            
            // æ’­æ”¾è·å¾—ç»éªŒéŸ³æ•ˆ
            petSounds.gainXP();
            
            // æ˜¾ç¤ºæµ®åŠ¨ç»éªŒå€¼
            showFloatingXP(xpAmount);
            
            // è§¦å‘å¼¹è·³åŠ¨ç”»
            const petSprite = document.getElementById('petSprite');
            if (petSprite) {
                petSprite.classList.add('bouncing');
                setTimeout(() => petSprite.classList.remove('bouncing'), 600);
            }
            
            // æ£€æŸ¥å‡çº§
            while (petData.xp >= petData.maxXP) {
                levelUp();
            }
            
            // æ›´æ–°æ˜¾ç¤º
            updatePetDisplay();
            savePetData();
            
            // å¦‚æœå‡çº§äº†ï¼Œæ˜¾ç¤ºç‰¹æ®Šæ¶ˆæ¯
            if (petData.level > oldLevel) {
                const levelDiff = petData.level - oldLevel;
                showNotification(`${petData.name} å‡çº§äº†ï¼ç°åœ¨æ˜¯ ${petData.level} çº§ï¼${levelDiff > 1 ? `è¿å‡${levelDiff}çº§ï¼` : ''}`, true);
            }
        }
        
        // å‡çº§å¤„ç†
        function levelUp() {
            petData.level++;
            petData.xp -= petData.maxXP;
            petData.maxXP = Math.floor(petData.maxXP * 1.2); // æ¯çº§ç»éªŒéœ€æ±‚å¢åŠ 20%
            
            console.log(`[å® ç‰©] ${petData.name} å‡çº§åˆ° ${petData.level} çº§ï¼`);
            
            // æ’­æ”¾å‡çº§éŸ³æ•ˆ
            petSounds.levelUp();
            
            // å‡çº§åŠ¨ç”»
            const petSprite = document.getElementById('petSprite');
            if (petSprite) {
                petSprite.classList.add('leveling');
                setTimeout(() => petSprite.classList.remove('leveling'), 1000);
            }
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦è¿›åŒ–
            const oldEvolution = Math.floor((petData.level - 1) / 20);
            const newEvolution = Math.floor(petData.level / 20);
            
            if (newEvolution > oldEvolution && newEvolution <= 2) {
                setTimeout(() => petEvolve(newEvolution), 1000);
            }
        }
        
        // å® ç‰©è¿›åŒ–
        function petEvolve(evolutionStage) {
            petData.evolution = evolutionStage;
            
            const evolutionNames = ['å°çŒ«å’ª', 'å¤§çŒ«å’ª', 'ä¼ è¯´çŒ«å’ª'];
            const newName = evolutionNames[evolutionStage] || petData.name;
            
            if (newName !== petData.name) {
                petData.name = newName;
                petSounds.evolve();
                
                showNotification(`ğŸ‰ è¿›åŒ–æˆåŠŸï¼${petData.name} è¿›åŒ–æˆäº† ${newName}ï¼`, true);
                
                // è¿›åŒ–ç‰¹æ•ˆ
                const petContainer = document.getElementById('petContainer');
                if (petContainer) {
                    petContainer.style.animation = 'petLevelUp 2s ease-in-out';
                    setTimeout(() => petContainer.style.animation = '', 2000);
                }
            }
        }
        
        // æ˜¾ç¤ºæµ®åŠ¨ç»éªŒå€¼
        function showFloatingXP(xpAmount) {
            const petContainer = document.getElementById('petContainer');
            if (!petContainer) return;
            
            const floatingXP = document.createElement('div');
            floatingXP.className = 'pet-floating-xp';
            floatingXP.textContent = `+${xpAmount} XP`;
            
            petContainer.appendChild(floatingXP);
            
            // 1.5ç§’åç§»é™¤
            setTimeout(() => {
                if (petContainer.contains(floatingXP)) {
                    petContainer.removeChild(floatingXP);
                }
            }, 1500);
        }
        
        // å® ç‰©äº¤äº’
        function petInteraction() {
            petSounds.interaction();
            
            const petSprite = document.getElementById('petSprite');
            if (petSprite) {
                petSprite.classList.add('bouncing');
                setTimeout(() => petSprite.classList.remove('bouncing'), 600);
            }
            
            const interactions = [
                'ä½ æ‘¸äº†æ‘¸å°çŒ«ï¼Œå®ƒå¾ˆå¼€å¿ƒï¼',
                'å°çŒ«å¯¹ä½ å–µäº†ä¸€å£°~',
                'å°çŒ«è¹­äº†è¹­ä½ çš„æ‰‹',
                'ä½ ç»™å°çŒ«æŒ äº†æŒ ä¸‹å·´',
                'å°çŒ«åœ¨ä½ æ‰‹å¿ƒé‡Œæ‰“å‘¼å™œ'
            ];
            
            const randomInteraction = interactions[Math.floor(Math.random() * interactions.length)];
            showNotification(randomInteraction, true);
            
            // å°æ¦‚ç‡è·å¾—ç»éªŒå€¼
            if (Math.random() < 0.3) {
                petGainXP(1, 'äº’åŠ¨');
            }
        }
        
        // åˆ‡æ¢å® ç‰©é¢æ¿æ”¶èµ·/å±•å¼€
        function togglePetCollapse() {
            const petContainer = document.getElementById('petContainer');
            if (petContainer) {
                petContainer.classList.toggle('pet-collapsed');
                
                // ä¿å­˜çŠ¶æ€
                const isCollapsed = petContainer.classList.contains('pet-collapsed');
                localStorage.setItem('petCollapsed', isCollapsed);
            }
        }
        
        // æ˜¾ç¤ºå® ç‰©è¯¦ç»†çŠ¶æ€
        function petStats() {
            const stats = `
            ğŸ± ${petData.name} çš„è¯¦ç»†çŠ¶æ€
            ç­‰çº§ï¼š${petData.level}
            ç»éªŒå€¼ï¼š${petData.xp} / ${petData.maxXP}
            æ€»å®Œæˆä»»åŠ¡ï¼š${petData.totalTasksCompleted}
            åˆ›å»ºæ—¥æœŸï¼š${new Date(petData.createdDate).toLocaleDateString()}
            è¿›åŒ–é˜¶æ®µï¼š${petData.evolution}
            
            ${getAchievementText()}
            `;
            
            showNotification('å® ç‰©çŠ¶æ€', true, stats);
        }
        
        // è·å–æˆå°±æ–‡æœ¬
        function getAchievementText() {
            const achievements = [];
            
            if (petData.totalTasksCompleted >= 10) achievements.push('ğŸ† ä»»åŠ¡æ–°æ‰‹');
            if (petData.totalTasksCompleted >= 50) achievements.push('ğŸ… ä»»åŠ¡ä¸“å®¶');
            if (petData.totalTasksCompleted >= 100) achievements.push('ğŸ‘‘ ä»»åŠ¡å¤§å¸ˆ');
            if (petData.level >= 10) achievements.push('â­ ç­‰çº§è¾¾äºº');
            if (petData.level >= 25) achievements.push('ğŸŒŸ ä¼ å¥‡å® ç‰©');
            if (petData.evolution >= 1) achievements.push('ğŸ¦‹ è¿›åŒ–æˆåŠŸ');
            
            return achievements.length > 0 ? 
                `æˆå°±ï¼š${achievements.join(' ')}` : 
                'ç»§ç»­å®Œæˆä»»åŠ¡æ¥è§£é”æˆå°±å§ï¼';
        }
        
        // æ›´æ–°å® ç‰©å¿ƒæƒ…
        function updatePetMood() {
            // æ ¹æ®æœ€è¿‘çš„ä»»åŠ¡å®Œæˆæƒ…å†µè°ƒæ•´å¿ƒæƒ…
            const now = new Date();
            const todaySchedule = schedules.find(s => {
                const scheduleDate = parseScheduleDate(s.date);
                return scheduleDate.toDateString() === now.toDateString();
            });
            
            if (todaySchedule) {
                const completedTasks = todaySchedule.items.filter(item => 
                    item.completed && item.task.trim() !== ''
                ).length;
                
                if (completedTasks > 0) {
                    petData.mood = 'å¼€å¿ƒ';
                } else if (now.getHours() > 18) {
                    petData.mood = 'æœ‰ç‚¹å›°';
                }
            }
            
            updatePetDisplay();
        }
        
        // ä¿å­˜å® ç‰©æ•°æ®
        function savePetData() {
            try {
                localStorage.setItem('petData', JSON.stringify(petData));
            } catch (error) {
                console.log('å® ç‰©æ•°æ®ä¿å­˜å¤±è´¥:', error);
            }
        }
        
        // ==================== åŠ¨æ€å® ç‰©ç³»ç»Ÿ - æ™ºèƒ½è·Ÿéš ====================
        
        let mousePosition = { x: 0, y: 0 };
        let petPosition = { x: window.innerWidth - 120, y: window.innerHeight - 120 };
        let isFollowing = false; // é»˜è®¤ä¸è·Ÿéšï¼Œé¿å…å¹²æ‰°æ“ä½œ
        let petAnimationFrame;
        let lastUserActivity = Date.now();
        let isUserInteracting = false;
        let idleTimeout = null;
        let interactionElements = [];
        
        // å®šä¹‰äº¤äº’å…ƒç´ é€‰æ‹©å™¨ï¼ˆè¿™äº›å…ƒç´ æ´»è·ƒæ—¶å® ç‰©åº”è¯¥åœæ­¢è·Ÿéšï¼‰
        const INTERACTIVE_SELECTORS = [
            'input', 'textarea', 'button', 'select', '.task', '.calendar-day',
            '.schedule-item', '.template-item', '.auth-input', '.context-menu-item'
        ];
        
        // æ™ºèƒ½é¼ æ ‡è·Ÿè¸ªç³»ç»Ÿ
        function initMouseTracking() {
            // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
            document.addEventListener('mousemove', (e) => {
                mousePosition.x = e.clientX;
                mousePosition.y = e.clientY;
                lastUserActivity = Date.now();
                
                // æ£€æŸ¥æ˜¯å¦åœ¨äº¤äº’å…ƒç´ ä¸Š
                const elementUnderMouse = document.elementFromPoint(e.clientX, e.clientY);
                const wasInteracting = isUserInteracting;
                isUserInteracting = checkIfInteracting(elementUnderMouse);
                
                // å¦‚æœä»äº¤äº’çŠ¶æ€å˜ä¸ºéäº¤äº’çŠ¶æ€ï¼Œå»¶è¿Ÿä¸€ä¸‹å†å¼€å§‹è·Ÿéš
                if (wasInteracting && !isUserInteracting) {
                    clearTimeout(idleTimeout);
                    idleTimeout = setTimeout(() => {
                        if (!isUserInteracting && isFollowing) {
                            updatePetPosition();
                        }
                    }, 1000); // 1ç§’å»¶è¿Ÿ
                } else if (isFollowing && !isUserInteracting) {
                    clearTimeout(idleTimeout);
                    updatePetPosition();
                }
                
                // å¦‚æœæ­£åœ¨äº¤äº’ï¼Œè§¦å‘å® ç‰©çš„äº’åŠ¨åŠ¨ç”»
                if (isUserInteracting) {
                    triggerContextualAnimation();
                }
            });
            
            // é¼ æ ‡ç‚¹å‡»äº‹ä»¶
            document.addEventListener('mousedown', (e) => {
                lastUserActivity = Date.now();
                isUserInteracting = true;
                
                // ç‚¹å‡»æ—¶è§¦å‘å® ç‰©å…³æ³¨åŠ¨ç”»
                const petSprite = document.querySelector('.pet-sprite');
                if (petSprite && !e.target.closest('.pet-container')) {
                    triggerAttentionAnimation();
                }
            });
            
            document.addEventListener('mouseup', () => {
                // å»¶è¿Ÿæ£€æŸ¥æ˜¯å¦è¿˜åœ¨äº¤äº’
                setTimeout(() => {
                    const elementUnderMouse = document.elementFromPoint(mousePosition.x, mousePosition.y);
                    isUserInteracting = checkIfInteracting(elementUnderMouse);
                }, 100);
            });
            
            // é”®ç›˜äº‹ä»¶ï¼ˆè¡¨ç¤ºç”¨æˆ·æ­£åœ¨è¾“å…¥ï¼‰
            document.addEventListener('keydown', () => {
                lastUserActivity = Date.now();
                isUserInteracting = true;
                triggerTypingAnimation();
            });
            
            document.addEventListener('keyup', () => {
                setTimeout(() => {
                    if (!document.activeElement || !checkIfInteracting(document.activeElement)) {
                        isUserInteracting = false;
                    }
                }, 500);
            });
            
            // ç„¦ç‚¹äº‹ä»¶
            document.addEventListener('focusin', (e) => {
                if (checkIfInteracting(e.target)) {
                    isUserInteracting = true;
                    lastUserActivity = Date.now();
                }
            });
            
            document.addEventListener('focusout', () => {
                setTimeout(() => {
                    if (!document.activeElement || !checkIfInteracting(document.activeElement)) {
                        isUserInteracting = false;
                    }
                }, 300);
            });
            
            // è§¦æ‘¸è®¾å¤‡æ”¯æŒ
            document.addEventListener('touchmove', (e) => {
                if (e.touches.length > 0) {
                    mousePosition.x = e.touches[0].clientX;
                    mousePosition.y = e.touches[0].clientY;
                    lastUserActivity = Date.now();
                    
                    if (isFollowing && !isUserInteracting) {
                        updatePetPosition();
                    }
                }
            });
            
            // å¼€å§‹å® ç‰©åŠ¨ç”»å¾ªç¯
            startPetAnimation();
        }
        
        // æ£€æŸ¥å…ƒç´ æ˜¯å¦æ˜¯äº¤äº’å…ƒç´ 
        function checkIfInteracting(element) {
            if (!element) return false;
            
            return INTERACTIVE_SELECTORS.some(selector => {
                return element.matches && element.matches(selector) || 
                       element.closest && element.closest(selector);
            });
        }
        
        // è§¦å‘ä¸Šä¸‹æ–‡ç›¸å…³åŠ¨ç”»
        function triggerContextualAnimation() {
            const petSprite = document.querySelector('.pet-sprite');
            if (petSprite && Math.random() < 0.1) { // 10%æ¦‚ç‡è§¦å‘
                const animations = ['idle-ear-wiggle', 'idle-blink'];
                const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
                
                petSprite.classList.add(randomAnimation);
                setTimeout(() => {
                    petSprite.classList.remove(randomAnimation);
                }, 800);
            }
        }
        
        // è§¦å‘æ³¨æ„åŠ›åŠ¨ç”»ï¼ˆç”¨æˆ·ç‚¹å‡»æ—¶ï¼‰
        function triggerAttentionAnimation() {
            const petSprite = document.querySelector('.pet-sprite');
            if (petSprite) {
                petSprite.classList.add('idle-ear-wiggle');
                setTimeout(() => {
                    petSprite.classList.remove('idle-ear-wiggle');
                }, 600);
            }
        }
        
        // è§¦å‘æ‰“å­—åŠ¨ç”»ï¼ˆç”¨æˆ·è¾“å…¥æ—¶ï¼‰
        function triggerTypingAnimation() {
            const petSprite = document.querySelector('.pet-sprite');
            if (petSprite && Math.random() < 0.3) { // 30%æ¦‚ç‡è§¦å‘
                petSprite.classList.add('idle-tail-wag');
                setTimeout(() => {
                    petSprite.classList.remove('idle-tail-wag');
                }, 1000);
            }
        }
        
        // æ›´æ–°å® ç‰©ä½ç½®ï¼ˆæ™ºèƒ½è·Ÿéšï¼‰
        function updatePetPosition() {
            const petContainer = document.getElementById('petContainer');
            if (!petContainer || !isFollowing || isUserInteracting) return;
            
            // è®¡ç®—ç›®æ ‡ä½ç½®ï¼ˆé¼ æ ‡ä½ç½®çš„åç§»ï¼‰
            const offsetX = -80; // å¢åŠ åç§»è·ç¦»ï¼Œé¿å…æŒ¡ä½é¼ æ ‡
            const offsetY = -80;
            const targetX = mousePosition.x + offsetX;
            const targetY = mousePosition.y + offsetY;
            
            // è¾¹ç•Œæ£€æŸ¥
            const maxX = window.innerWidth - 100;
            const maxY = window.innerHeight - 100;
            const boundedTargetX = Math.max(20, Math.min(targetX, maxX));
            const boundedTargetY = Math.max(20, Math.min(targetY, maxY));
            
            // è®¡ç®—è·ç¦»å’Œç§»åŠ¨é€Ÿåº¦
            const dx = boundedTargetX - petPosition.x;
            const dy = boundedTargetY - petPosition.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            // åªæœ‰è·ç¦»è¶³å¤Ÿå¤§æ—¶æ‰ç§»åŠ¨ï¼ˆé¿å…æŠ–åŠ¨ï¼‰
            if (distance > 10) { // å¢åŠ é˜ˆå€¼ï¼Œå‡å°‘é¢‘ç¹ç§»åŠ¨
                const speed = 0.05; // é™ä½ç§»åŠ¨é€Ÿåº¦ï¼Œæ›´æ¸©å’Œ
                const moveX = dx * speed;
                const moveY = dy * speed;
                
                petPosition.x += moveX;
                petPosition.y += moveY;
                
                // åº”ç”¨ä½ç½®
                petContainer.style.left = `${petPosition.x}px`;
                petContainer.style.top = `${petPosition.y}px`;
                
                // æ ¹æ®ç§»åŠ¨æ–¹å‘è°ƒæ•´å® ç‰©æœå‘
                const petSprite = document.querySelector('.pet-sprite');
                if (petSprite && Math.abs(dx) > 5) {
                    if (dx > 0) {
                        petSprite.style.transform = 'scaleX(1)'; // å‘å³
                    } else {
                        petSprite.style.transform = 'scaleX(-1)'; // å‘å·¦
                    }
                    
                    // ç§»åŠ¨æ—¶æ·»åŠ æ´»è·ƒçŠ¶æ€
                    petSprite.classList.add('moving');
                    clearTimeout(petSprite.moveTimeout);
                    petSprite.moveTimeout = setTimeout(() => {
                        petSprite.classList.remove('moving');
                        petSprite.style.transform = 'scaleX(1)'; // æ¢å¤é»˜è®¤æœå‘
                    }, 1000);
                }
            }
        }
        
        // è®©å® ç‰©å›åˆ°å›ºå®šä½ç½®
        function movePetToFixedPosition() {
            const petContainer = document.getElementById('petContainer');
            if (!petContainer) return;
            
            // å›ºå®šä½ç½®ï¼šå³ä¸‹è§’
            const fixedX = window.innerWidth - 120;
            const fixedY = window.innerHeight - 120;
            
            // å¹³æ»‘ç§»åŠ¨åˆ°å›ºå®šä½ç½®
            const duration = 800; // 800ms åŠ¨ç”»
            const startTime = Date.now();
            const startX = petPosition.x;
            const startY = petPosition.y;
            
            function animateToFixed() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // ç¼“åŠ¨å‡½æ•°
                const easeOut = 1 - Math.pow(1 - progress, 3);
                
                petPosition.x = startX + (fixedX - startX) * easeOut;
                petPosition.y = startY + (fixedY - startY) * easeOut;
                
                petContainer.style.left = `${petPosition.x}px`;
                petContainer.style.top = `${petPosition.y}px`;
                
                if (progress < 1) {
                    requestAnimationFrame(animateToFixed);
                }
            }
            
            requestAnimationFrame(animateToFixed);
        }
        
        // å® ç‰©åŠ¨ç”»å¾ªç¯ï¼ˆå‘¼å¸ã€çœ¨çœ¼ç­‰ï¼‰
        function startPetAnimation() {
            let animationState = 0;
            
            function animateLoop() {
                const petSprite = document.querySelector('.pet-sprite');
                if (petSprite && !document.hidden) {
                    animationState++;
                    
                    // æ¯2ç§’æ‰§è¡Œä¸€æ¬¡éšæœºåŠ¨ç”»
                    if (animationState % 120 === 0) { // 60fps * 2ç§’ = 120å¸§
                        triggerRandomAnimation();
                    }
                }
                
                petAnimationFrame = requestAnimationFrame(animateLoop);
            }
            
            animateLoop();
        }
        
        // è§¦å‘éšæœºåŠ¨ç”»
        function triggerRandomAnimation() {
            const petSprite = document.querySelector('.pet-sprite');
            if (!petSprite) return;
            
            const animations = ['idle-blink', 'idle-ear-wiggle', 'idle-tail-wag'];
            const randomAnimation = animations[Math.floor(Math.random() * animations.length)];
            
            petSprite.classList.add(randomAnimation);
            setTimeout(() => {
                petSprite.classList.remove(randomAnimation);
            }, 1000);
        }
        
        // æ˜¾ç¤ºå® ç‰©å³é”®èœå•
        function showPetContextMenu(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const contextMenu = document.getElementById('petContextMenu');
            const followText = document.getElementById('followText');
            
            // æ›´æ–°è·ŸéšçŠ¶æ€æ–‡æœ¬
            if (followText) {
                followText.textContent = isFollowing ? 'ğŸš« åœæ­¢æ™ºèƒ½è·Ÿéš' : 'ğŸ‘† å¼€å¯æ™ºèƒ½è·Ÿéš';
            }
            
            if (contextMenu) {
                contextMenu.style.display = 'block';
                contextMenu.style.left = `${event.pageX}px`;
                contextMenu.style.top = `${event.pageY}px`;
                
                // ç¡®ä¿èœå•åœ¨å±å¹•å†…
                const rect = contextMenu.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    contextMenu.style.left = `${event.pageX - rect.width}px`;
                }
                if (rect.bottom > window.innerHeight) {
                    contextMenu.style.top = `${event.pageY - rect.height}px`;
                }
            }
        }
        
        // éšè—å® ç‰©å³é”®èœå•
        function hidePetContextMenu() {
            const contextMenu = document.getElementById('petContextMenu');
            if (contextMenu) {
                contextMenu.style.display = 'none';
            }
        }
        
        // æ™ºèƒ½è·Ÿéšæ¨¡å¼åˆ‡æ¢
        function togglePetFollowing() {
            isFollowing = !isFollowing;
            
            const petContainer = document.getElementById('petContainer');
            const followText = document.getElementById('followText');
            
            if (petContainer) {
                if (isFollowing) {
                    petContainer.classList.remove('pet-static');
                    if (followText) followText.textContent = 'ğŸš« åœæ­¢è·Ÿéš';
                    showNotification('ğŸ± æ™ºèƒ½è·Ÿéšå·²å¼€å¯ - ç©ºé—²æ—¶å® ç‰©ä¼šè·Ÿéšé¼ æ ‡', true);
                } else {
                    petContainer.classList.add('pet-static');
                    if (followText) followText.textContent = 'ğŸ‘† æ™ºèƒ½è·Ÿéš';
                    showNotification('ğŸ± æ™ºèƒ½è·Ÿéšå·²å…³é—­ - å® ç‰©å°†å›ºå®šåœ¨å³ä¸‹è§’', true);
                    
                    // ç§»åŠ¨åˆ°å›ºå®šä½ç½®
                    movePetToFixedPosition();
                }
            }
            
            // ä¿å­˜è·ŸéšçŠ¶æ€
            localStorage.setItem('petFollowing', isFollowing);
            hidePetContextMenu();
        }
        
        // å® ç‰©ç¬ç§»åˆ°é¼ æ ‡ä½ç½®
        function petTeleport() {
            if (mousePosition.x === 0 && mousePosition.y === 0) {
                // å¦‚æœæ²¡æœ‰é¼ æ ‡ä½ç½®ï¼Œç¬ç§»åˆ°å±å¹•ä¸­å¤®
                mousePosition.x = window.innerWidth / 2;
                mousePosition.y = window.innerHeight / 2;
            }
            
            petPosition.x = mousePosition.x - 50;
            petPosition.y = mousePosition.y - 50;
            
            const petContainer = document.getElementById('petContainer');
            if (petContainer) {
                petContainer.style.left = `${petPosition.x}px`;
                petContainer.style.top = `${petPosition.y}px`;
                
                // ç¬ç§»ç‰¹æ•ˆ
                petContainer.style.animation = 'petTeleport 0.3s ease-out';
                setTimeout(() => {
                    petContainer.style.animation = '';
                }, 300);
            }
            
            petSounds.interaction();
            showNotification('å—–ï¼å® ç‰©ç¬ç§»è¿‡æ¥äº†ï¼', true);
            hidePetContextMenu();
        }
        
        // å® ç‰©äº¤äº’ï¼ˆæ›´æ–°ç‰ˆæœ¬ï¼‰
        function petInteraction() {
            petSounds.interaction();
            
            const petSprite = document.getElementById('petSprite');
            if (petSprite) {
                petSprite.classList.add('bouncing');
                setTimeout(() => petSprite.classList.remove('bouncing'), 600);
            }
            
            const interactions = [
                'ä½ æ‘¸äº†æ‘¸å°çŒ«ï¼Œå®ƒå¾ˆå¼€å¿ƒï¼',
                'å°çŒ«å¯¹ä½ å–µäº†ä¸€å£°~',
                'å°çŒ«è¹­äº†è¹­ä½ çš„æ‰‹',
                'ä½ ç»™å°çŒ«æŒ äº†æŒ ä¸‹å·´',
                'å°çŒ«åœ¨ä½ æ‰‹å¿ƒé‡Œæ‰“å‘¼å™œ'
            ];
            
            const randomInteraction = interactions[Math.floor(Math.random() * interactions.length)];
            showNotification(randomInteraction, true);
            
            // å°æ¦‚ç‡è·å¾—ç»éªŒå€¼
            if (Math.random() < 0.3) {
                petGainXP(1, 'äº’åŠ¨');
            }
        }
        
        // æ˜¾ç¤ºå® ç‰©è¯¦ç»†çŠ¶æ€ï¼ˆæ›´æ–°ç‰ˆæœ¬ï¼‰
        function petStats() {
            const stats = `ğŸ± ${petData.name} çš„è¯¦ç»†çŠ¶æ€
            
ç­‰çº§ï¼š${petData.level}
ç»éªŒå€¼ï¼š${petData.xp} / ${petData.maxXP}
æ€»å®Œæˆä»»åŠ¡ï¼š${petData.totalTasksCompleted}
åˆ›å»ºæ—¥æœŸï¼š${new Date(petData.createdDate).toLocaleDateString()}
è¿›åŒ–é˜¶æ®µï¼š${petData.evolution}

${getAchievementText()}

ğŸ’¡ å³é”®å® ç‰©å¯ä»¥æ§åˆ¶è·Ÿéšæ¨¡å¼`;
            
            showNotification(stats, true);
            hidePetContextMenu();
        }
        
        // é‡ç½®å® ç‰©ï¼ˆè°ƒè¯•ç”¨ï¼‰
        function resetPet() {
            if (confirm('ç¡®å®šè¦é‡ç½®å® ç‰©å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰è¿›åº¦ï¼')) {
                localStorage.removeItem('petData');
                localStorage.removeItem('petCollapsed');
                location.reload();
            }
        }
        
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('calendarTheme', newTheme);
            updateThemeIcon(newTheme);
            
            // åŒæ­¥ä¸»é¢˜è®¾ç½®åˆ°Supabase
            if (currentUser && isOnline) {
                saveUserSettingsToSupabase().catch(error => {
                    console.error('ä¸»é¢˜è®¾ç½®åŒæ­¥å¤±è´¥:', error);
                });
            }
            
            // å¼ºåˆ¶è®¾ç½®htmlèƒŒæ™¯è‰²
            if (newTheme === 'dark') {
                document.documentElement.style.backgroundColor = '#1a1a1a';
                document.documentElement.style.background = '#1a1a1a';
            } else {
                document.documentElement.style.backgroundColor = '#f0f2f5';
                document.documentElement.style.background = '#f0f2f5';
            }
            
            showNotification(`å·²åˆ‡æ¢åˆ°${newTheme === 'dark' ? 'æš—è‰²' : 'äº®è‰²'}ä¸»é¢˜`, true);
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('calendarTheme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            // å¼ºåˆ¶è®¾ç½®htmlèƒŒæ™¯è‰²
            if (savedTheme === 'dark') {
                document.documentElement.style.backgroundColor = '#1a1a1a';
                document.documentElement.style.background = '#1a1a1a';
            } else {
                document.documentElement.style.backgroundColor = '#f0f2f5';
                document.documentElement.style.background = '#f0f2f5';
            }
        }

        function updateThemeIcon(theme) {
            const themeToggle = document.getElementById('themeToggle');
            themeToggle.textContent = theme === 'dark' ? 'ğŸŒ™' : 'â˜€';
        }

        // ==================== å¼€å‘è€…è°ƒè¯•å·¥å…· ====================
        
        // åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­å¯ç”¨çš„è°ƒè¯•å‡½æ•°
        window.debugCalendar = {
            // æŸ¥çœ‹åŒæ­¥ç»Ÿè®¡
            stats: () => {
                console.table(getSyncStats());
                return getSyncStats();
            },
            
            // æŸ¥çœ‹å¾…åŒæ­¥åˆ—è¡¨
            pending: () => {
                console.log('å¾…åŒæ­¥çš„æ—¥ç¨‹ID:', Array.from(pendingChanges));
                return Array.from(pendingChanges);
            },
            
            // å¼ºåˆ¶åŒæ­¥
            sync: forceSyncAll,
            
            // æŸ¥çœ‹æœ¬åœ°æ•°æ®
            data: () => {
                console.log('æœ¬åœ°æ—¥ç¨‹æ•°æ®:', schedules);
                return schedules;
            },
            
            // æµ‹è¯•æ¨¡æ¿é€»è¾‘
            testTemplate: () => {
                console.log('ğŸ§ª æµ‹è¯•æ¨¡æ¿é€»è¾‘ï¼š');
                
                // æµ‹è¯•æœ¬å‘¨æ¯ä¸€å¤©
                const today = new Date();
                const thisWeekDates = [];
                
                // è·å–æœ¬å‘¨çš„å‘¨ä¸€
                const monday = new Date(today);
                monday.setDate(today.getDate() - today.getDay() + 1);
                
                // ç”Ÿæˆæœ¬å‘¨7å¤©
                for (let i = 0; i < 7; i++) {
                    const date = new Date(monday);
                    date.setDate(monday.getDate() + i);
                    thisWeekDates.push(date);
                }
                
                console.log('ğŸ“… æœ¬å‘¨å„å¤©çš„æ¨¡æ¿é€‰æ‹©ï¼š');
                thisWeekDates.forEach(date => {
                    const dayOfWeek = date.getDay();
                    const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                    const isWork = isWorkday(date);
                    const templateType = isWork ? 'å·¥ä½œæ—¥æ¨¡æ¿' : 'éå·¥ä½œæ—¥æ¨¡æ¿';
                    
                    console.log(`${formatDate(date)} (${dayNames[dayOfWeek]}) -> ${templateType}`);
                });
                
                console.log('\nğŸ“Š æ¨¡æ¿å†…å®¹ï¼š');
                console.log('å·¥ä½œæ—¥æ¨¡æ¿ä»»åŠ¡æ•°:', Object.keys(workdayTemplate).length, workdayTemplate);
                console.log('éå·¥ä½œæ—¥æ¨¡æ¿ä»»åŠ¡æ•°:', Object.keys(nonWorkdayTemplate).length, nonWorkdayTemplate);
                
                return {
                    weekDates: thisWeekDates.map(date => ({
                        date: formatDate(date),
                        dayOfWeek: date.getDay(),
                        isWorkday: isWorkday(date),
                        templateType: isWorkday(date) ? 'workday' : 'nonworkday'
                    })),
                    templates: {
                        workday: workdayTemplate,
                        nonworkday: nonWorkdayTemplate
                    }
                };
            },
            
            // æµ‹è¯•ä»»åŠ¡æµè½¬é€»è¾‘
            testTaskTransfer: () => {
                console.log('ğŸ”„ æµ‹è¯•ä»»åŠ¡æµè½¬é€»è¾‘ï¼š');
                
                const testCases = [
                    { from: '2025-08-14', to: '2025-08-15', desc: 'å‘¨å››åˆ°å‘¨äº”ï¼ˆå·¥ä½œæ—¥åˆ°å·¥ä½œæ—¥ï¼‰' },
                    { from: '2025-08-15', to: '2025-08-16', desc: 'å‘¨äº”åˆ°å‘¨å…­ï¼ˆå·¥ä½œæ—¥åˆ°éå·¥ä½œæ—¥ï¼‰' },
                    { from: '2025-08-16', to: '2025-08-17', desc: 'å‘¨å…­åˆ°å‘¨æ—¥ï¼ˆéå·¥ä½œæ—¥åˆ°éå·¥ä½œæ—¥ï¼‰' },
                    { from: '2025-08-17', to: '2025-08-18', desc: 'å‘¨æ—¥åˆ°å‘¨ä¸€ï¼ˆéå·¥ä½œæ—¥åˆ°å·¥ä½œæ—¥ï¼‰' },
                    { from: '2025-08-18', to: '2025-08-19', desc: 'å‘¨ä¸€åˆ°å‘¨äºŒï¼ˆå·¥ä½œæ—¥åˆ°å·¥ä½œæ—¥ï¼‰' }
                ];
                
                testCases.forEach(testCase => {
                    const fromDate = new Date(testCase.from);
                    const toDate = new Date(testCase.to);
                    const shouldTransfer = shouldTransferTasks(fromDate, toDate);
                    
                    console.log(`${testCase.desc}: ${shouldTransfer ? 'âœ… å…è®¸æµè½¬' : 'âŒ ç¦æ­¢æµè½¬'}`);
                });
                
                return testCases.map(testCase => ({
                    ...testCase,
                    shouldTransfer: shouldTransferTasks(new Date(testCase.from), new Date(testCase.to))
                }));
            },
            
            // æµ‹è¯•ç™»å½•æµç¨‹
            testLogin: () => {
                console.log('ğŸ” ç™»å½•æµç¨‹è¯Šæ–­ï¼š');
                
                // æ£€æŸ¥å…³é”®å…ƒç´ 
                const authForm = document.getElementById('authForm');
                const authEmail = document.getElementById('authEmail');
                const authPassword = document.getElementById('authPassword');
                const authSubmit = document.getElementById('authSubmit');
                const authModal = document.getElementById('authModal');
                
                console.log('ğŸ“‹ å…³é”®å…ƒç´ æ£€æŸ¥ï¼š');
                console.log('authForm:', authForm ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå¤±');
                console.log('authEmail:', authEmail ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå¤±');
                console.log('authPassword:', authPassword ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå¤±');
                console.log('authSubmit:', authSubmit ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå¤±');
                console.log('authModal:', authModal ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå¤±');
                
                // æ£€æŸ¥Supabaseå®¢æˆ·ç«¯
                console.log('ğŸ”Œ Supabaseå®¢æˆ·ç«¯:', typeof supabaseClient !== 'undefined' ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–');
                
                // æ£€æŸ¥è®¤è¯çŠ¶æ€
                console.log('ğŸ‘¤ å½“å‰ç”¨æˆ·:', currentUser ? `âœ… å·²ç™»å½• (${currentUser.email})` : 'âŒ æœªç™»å½•');
                
                // æ£€æŸ¥æ¨¡æ€æ¡†çŠ¶æ€
                const isModalHidden = authModal ? authModal.classList.contains('hidden') : 'unknown';
                console.log('ğŸªŸ ç™»å½•çª—å£çŠ¶æ€:', isModalHidden ? 'éšè—' : 'æ˜¾ç¤º');
                
                // æ£€æŸ¥è¡¨å•å€¼
                if (authEmail && authPassword) {
                    console.log('ğŸ“ è¡¨å•å†…å®¹:');
                    console.log('  é‚®ç®±:', authEmail.value || '(ç©º)');
                    console.log('  å¯†ç :', authPassword.value ? '***' : '(ç©º)');
                }
                
                return {
                    elementsExist: {
                        authForm: !!authForm,
                        authEmail: !!authEmail,
                        authPassword: !!authPassword,
                        authSubmit: !!authSubmit,
                        authModal: !!authModal
                    },
                    supabaseReady: typeof supabaseClient !== 'undefined',
                    currentUser: currentUser,
                    modalVisible: !isModalHidden
                };
            },
            
            // æŸ¥çœ‹æ¨¡æ¿
            templates: () => {
                console.log('å·¥ä½œæ—¥æ¨¡æ¿:', workdayTemplate);
                console.log('éå·¥ä½œæ—¥æ¨¡æ¿:', nonWorkdayTemplate);
                return { workday: workdayTemplate, nonworkday: nonWorkdayTemplate };
            },
            
            // æ¸…é™¤ç»Ÿè®¡
            clearStats: () => {
                syncStats = {
                    totalSyncs: 0,
                    incrementalSyncs: 0,
                    fullSyncs: 0,
                    failedSyncs: 0,
                    savedBytes: 0,
                    lastSyncTime: null
                };
                console.log('ç»Ÿè®¡æ•°æ®å·²æ¸…é™¤');
            },
            
            // æ¨¡æ‹Ÿç½‘ç»œé”™è¯¯
            simulateError: () => {
                const originalClient = supabaseClient;
                supabaseClient = {
                    ...originalClient,
                    from: () => ({
                        upsert: () => Promise.reject(new Error('æ¨¡æ‹Ÿç½‘ç»œé”™è¯¯'))
                    })
                };
                setTimeout(() => {
                    supabaseClient = originalClient;
                    console.log('ç½‘ç»œé”™è¯¯æ¨¡æ‹Ÿç»“æŸ');
                }, 5000);
                console.log('å¼€å§‹æ¨¡æ‹Ÿç½‘ç»œé”™è¯¯ï¼Œ5ç§’åæ¢å¤');
            }
        };
        
        console.log('ğŸš€ æ•°æ®åŒæ­¥ä¼˜åŒ–å®Œæˆï¼');
        console.log('ğŸ“Š åœ¨æ§åˆ¶å°è¾“å…¥ debugCalendar.stats() æŸ¥çœ‹åŒæ­¥ç»Ÿè®¡');
        console.log('ğŸ”§ å¯ç”¨è°ƒè¯•å‘½ä»¤:', Object.keys(window.debugCalendar));

        // ==================== ä¸»å¯¼èˆªTabç³»ç»Ÿ ====================
        
        function initMainTabs() {
            const scheduleTab = document.getElementById('scheduleTab');
            const goalTab = document.getElementById('goalTab');
            const scheduleContent = document.getElementById('scheduleContent');
            const goalContent = document.getElementById('goalContent');
            
            // åˆ‡æ¢åˆ°æ—¥ç¨‹ç®¡ç†
            scheduleTab.addEventListener('click', () => {
                switchToTab('schedule');
            });
            
            // åˆ‡æ¢åˆ°ç›®æ ‡ç®¡ç†
            goalTab.addEventListener('click', () => {
                switchToTab('goal');
            });
            
            // é»˜è®¤æ˜¾ç¤ºæ—¥ç¨‹ç®¡ç†
            switchToTab('schedule');
        }
        
        function switchToTab(tabName) {
            const scheduleTab = document.getElementById('scheduleTab');
            const goalTab = document.getElementById('goalTab');
            const scheduleContent = document.getElementById('scheduleContent');
            const goalContent = document.getElementById('goalContent');
            
            // é‡ç½®æ‰€æœ‰tabçŠ¶æ€
            scheduleTab.classList.remove('active');
            goalTab.classList.remove('active');
            scheduleContent.classList.remove('active');
            goalContent.classList.remove('active');
            
            if (tabName === 'schedule') {
                scheduleTab.classList.add('active');
                scheduleContent.classList.add('active');
                console.log('åˆ‡æ¢åˆ°æ—¥ç¨‹ç®¡ç†é¡µé¢');
            } else if (tabName === 'goal') {
                goalTab.classList.add('active');
                goalContent.classList.add('active');
                console.log('åˆ‡æ¢åˆ°ç›®æ ‡ç®¡ç†é¡µé¢');
                
                // åˆå§‹åŒ–ç›®æ ‡ç®¡ç†é¡µé¢åŠŸèƒ½
                initGoalManagement();
            }
        }

        // ç›®æ ‡ç®¡ç†åŠŸèƒ½åˆå§‹åŒ–
        function initGoalManagement() {
            // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œåˆ™è·³è¿‡
            if (window.goalManagementInitialized) return;
            window.goalManagementInitialized = true;

            // åˆå§‹åŒ–ç›®æ ‡æ•°æ®
            if (!window.goalsList) {
                window.goalsList = [];
            }
            
            // åŠ è½½ä¿å­˜çš„ç›®æ ‡æ•°æ®
            loadGoalsData();

            // ç»‘å®šäº‹ä»¶å¤„ç†å™¨
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('goal-expand-btn')) {
                    toggleGoalExpand(e.target);
                } else if (e.target.id === 'addGoal') {
                    addNewGoal();
                } else if (e.target.classList.contains('goal-import')) {
                    importSubtasksFromMD(e.target);
                } else if (e.target.classList.contains('goal-task')) {
                    addNewSubtask(e.target);
                } else if (e.target.classList.contains('goal-delete')) {
                    deleteGoal(e.target);
                } else if (e.target.classList.contains('subtask-delete')) {
                    deleteGoalSubtask(e.target);
                }
            });

            // ç»‘å®šåŒå‡»ç¼–è¾‘äº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
            document.addEventListener('dblclick', function(e) {
                if (e.target.classList.contains('goal-name')) {
                    const goalItem = e.target.closest('.goal-item');
                    const goalId = parseInt(goalItem.dataset.goalId);
                    makeEditable(e.target, 'name', goalId);
                } else if (e.target.classList.contains('subtask-text')) {
                    const subtaskItem = e.target.closest('.subtask-item');
                    const goalItem = e.target.closest('.goal-item');
                    const goalId = parseInt(goalItem.dataset.goalId);
                    const subtaskId = parseInt(subtaskItem.dataset.subtaskId);
                    makeEditable(e.target, 'subtask', goalId, subtaskId);
                }
            });

            // ç»‘å®šå­ä»»åŠ¡checkboxäº‹ä»¶
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('subtask-checkbox')) {
                    updateSubtaskStatus(e.target);
                }
            });

            // æ¸²æŸ“ç›®æ ‡åˆ—è¡¨
            renderGoalsList();
            
            console.log('ç›®æ ‡ç®¡ç†åŠŸèƒ½å·²åˆå§‹åŒ–');
        }

        // ä¿å­˜ç›®æ ‡æ•°æ®åˆ°localStorage
        function saveGoalsData() {
            try {
                // ä¿å­˜å¤‡ä»½
                const currentData = localStorage.getItem('calendarGoals');
                if (currentData) {
                    localStorage.setItem('calendarGoalsBackup', currentData);
                    localStorage.setItem('calendarGoalsBackupTime', new Date().toISOString());
                }
                
                localStorage.setItem('calendarGoals', JSON.stringify(window.goalsList));
                localStorage.setItem('calendarGoalsUpdateTime', new Date().toISOString());
                
                console.log('ç›®æ ‡æ•°æ®å·²ä¿å­˜åˆ°localStorage');
                
                // å°è¯•åŒæ­¥åˆ°äº‘ç«¯
                if (typeof enhancedSyncSystem !== 'undefined' && enhancedSyncSystem) {
                    enhancedSyncSystem.syncToCloud({
                        type: 'goals',
                        data: window.goalsList,
                        timestamp: new Date().toISOString()
                    });
                }
            } catch (error) {
                console.error('ä¿å­˜ç›®æ ‡æ•°æ®å¤±è´¥:', error);
            }
        }

        // ä»localStorageåŠ è½½ç›®æ ‡æ•°æ®
        function loadGoalsData() {
            try {
                const savedGoals = localStorage.getItem('calendarGoals');
                if (savedGoals) {
                    window.goalsList = JSON.parse(savedGoals);
                    console.log('ç›®æ ‡æ•°æ®å·²ä»localStorageåŠ è½½');
                } else {
                    window.goalsList = [];
                }
            } catch (error) {
                console.error('åŠ è½½ç›®æ ‡æ•°æ®å¤±è´¥:', error);
                window.goalsList = [];
            }
        }

        // æ·»åŠ æ–°ç›®æ ‡
        function addNewGoal() {
            const newGoal = {
                id: Date.now(),
                name: 'æ–°ç›®æ ‡',
                subtasks: [],
                expanded: true
            };

            window.goalsList.push(newGoal);
            saveGoalsData(); // ä¿å­˜æ•°æ®
            renderGoalsList();
            
            // èšç„¦åˆ°æ–°ç›®æ ‡çš„åç§°ç¼–è¾‘
            setTimeout(() => {
                const newGoalElement = document.querySelector(`[data-goal-id="${newGoal.id}"] .goal-name`);
                if (newGoalElement) {
                    makeEditable(newGoalElement, 'name', newGoal.id);
                }
            }, 100);
        }

        // ä»MDæ–‡ä»¶å¯¼å…¥å­ä»»åŠ¡
        function importSubtasksFromMD(button) {
            const goalItem = button.closest('.goal-item');
            const goalId = parseInt(goalItem.dataset.goalId);
            const goal = window.goalsList.find(g => g.id === goalId);
            
            if (!goal) return;

            // åˆ›å»ºæ–‡ä»¶è¾“å…¥å…ƒç´ 
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.md,.markdown,.txt';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const subtasks = parseMarkdownTasks(content);
                    
                    if (subtasks.length === 0) {
                        alert('æœªæ‰¾åˆ°æœ‰åºåˆ—è¡¨æ ¼å¼çš„ä»»åŠ¡ã€‚è¯·ç¡®ä¿ä»»åŠ¡ä»¥æœ‰åºåˆ—è¡¨å½¢å¼å­˜åœ¨ï¼ˆå¦‚ï¼š1. ä»»åŠ¡å†…å®¹ï¼‰');
                        return;
                    }

                    // æ‰¹é‡æ·»åŠ å­ä»»åŠ¡
                    subtasks.forEach(taskText => {
                        const newSubtask = {
                            id: Date.now() + Math.random(), // ç¡®ä¿å”¯ä¸€æ€§
                            text: taskText,
                            completed: false
                        };
                        goal.subtasks.push(newSubtask);
                    });

                    goal.expanded = true; // å±•å¼€ç›®æ ‡ä»¥æ˜¾ç¤ºæ–°å­ä»»åŠ¡
                    saveGoalsData(); // ä¿å­˜æ•°æ®
                    renderGoalsList();
                    
                    alert(`æˆåŠŸå¯¼å…¥ ${subtasks.length} ä¸ªå­ä»»åŠ¡`);
                };
                
                reader.onerror = function() {
                    alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
                };
                
                reader.readAsText(file, 'UTF-8');
            });
            
            // è§¦å‘æ–‡ä»¶é€‰æ‹©
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }

        // è§£æMarkdownæ–‡æ¡£ä¸­çš„æœ‰åºåˆ—è¡¨ä»»åŠ¡
        function parseMarkdownTasks(content) {
            const tasks = [];
            const lines = content.split('\n');
            
            for (let line of lines) {
                line = line.trim();
                
                // åŒ¹é…æœ‰åºåˆ—è¡¨æ ¼å¼ï¼š1. ä»»åŠ¡å†…å®¹ æˆ–è€… 1) ä»»åŠ¡å†…å®¹
                const orderedListMatch = line.match(/^\d+[.)]\s+(.+)$/);
                if (orderedListMatch) {
                    let taskText = orderedListMatch[1].trim();
                    
                    // ç§»é™¤Markdownæ ¼å¼æ ‡è®°
                    taskText = taskText
                        .replace(/^\*\*(.+)\*\*$/, '$1') // ç§»é™¤ç²—ä½“
                        .replace(/^\*(.+)\*$/, '$1')     // ç§»é™¤æ–œä½“
                        .replace(/^`(.+)`$/, '$1')       // ç§»é™¤è¡Œå†…ä»£ç 
                        .replace(/^\[(.+)\]\(.+\)$/, '$1') // ç§»é™¤é“¾æ¥ï¼Œä¿ç•™æ–‡æœ¬
                        .replace(/^~~(.+)~~$/, '$1');    // ç§»é™¤åˆ é™¤çº¿
                    
                    if (taskText.length > 0) {
                        tasks.push(taskText);
                    }
                }
                
                // ä¹Ÿæ”¯æŒæ— åºåˆ—è¡¨æ ¼å¼ï¼š- ä»»åŠ¡å†…å®¹ æˆ– * ä»»åŠ¡å†…å®¹
                const unorderedListMatch = line.match(/^[-*+]\s+(.+)$/);
                if (unorderedListMatch) {
                    let taskText = unorderedListMatch[1].trim();
                    
                    // ç§»é™¤Markdownæ ¼å¼æ ‡è®°
                    taskText = taskText
                        .replace(/^\*\*(.+)\*\*$/, '$1')
                        .replace(/^\*(.+)\*$/, '$1')
                        .replace(/^`(.+)`$/, '$1')
                        .replace(/^\[(.+)\]\(.+\)$/, '$1')
                        .replace(/^~~(.+)~~$/, '$1');
                    
                    if (taskText.length > 0) {
                        tasks.push(taskText);
                    }
                }
            }
            
            return tasks;
        }
        
        // æ·»åŠ æ–°å­ä»»åŠ¡
        function addNewSubtask(button) {
            const goalItem = button.closest('.goal-item');
            const goalId = parseInt(goalItem.dataset.goalId);
            const goal = window.goalsList.find(g => g.id === goalId);
            
            if (goal) {
                const newSubtask = {
                    id: Date.now(),
                    text: 'æ–°å­ä»»åŠ¡',
                    completed: false
                };
                
                goal.subtasks.push(newSubtask);
                goal.expanded = true; // å±•å¼€ç›®æ ‡ä»¥æ˜¾ç¤ºæ–°å­ä»»åŠ¡
                saveGoalsData(); // ä¿å­˜æ•°æ®
                renderGoalsList();
                
                // èšç„¦åˆ°æ–°å­ä»»åŠ¡çš„æ–‡æœ¬ç¼–è¾‘
                setTimeout(() => {
                    const newSubtaskElement = document.querySelector(`[data-subtask-id="${newSubtask.id}"] .subtask-text`);
                    if (newSubtaskElement) {
                        makeEditable(newSubtaskElement, 'subtask', goalId, newSubtask.id);
                    }
                }, 100);
            }
        }

        // åˆ é™¤ç›®æ ‡
        function deleteGoal(button) {
            const goalItem = button.closest('.goal-item');
            const goalId = parseInt(goalItem.dataset.goalId);
            
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç›®æ ‡å—ï¼Ÿ')) {
                window.goalsList = window.goalsList.filter(g => g.id !== goalId);
                saveGoalsData(); // ä¿å­˜æ•°æ®
                renderGoalsList();
            }
        }

        // åˆ é™¤ç›®æ ‡å­ä»»åŠ¡
        function deleteGoalSubtask(button) {
            const subtaskItem = button.closest('.subtask-item');
            const goalItem = button.closest('.goal-item');
            const goalId = parseInt(goalItem.dataset.goalId);
            const subtaskId = parseInt(subtaskItem.dataset.subtaskId);
            
            const goal = window.goalsList.find(g => g.id === goalId);
            if (goal) {
                goal.subtasks = goal.subtasks.filter(s => s.id !== subtaskId);
                saveGoalsData(); // ä¿å­˜æ•°æ®
                renderGoalsList();
            }
        }

        // æ›´æ–°å­ä»»åŠ¡å®ŒæˆçŠ¶æ€
        function updateSubtaskStatus(checkbox) {
            const subtaskItem = checkbox.closest('.subtask-item');
            const goalItem = checkbox.closest('.goal-item');
            const goalId = parseInt(goalItem.dataset.goalId);
            const subtaskId = parseInt(subtaskItem.dataset.subtaskId);
            
            const goal = window.goalsList.find(g => g.id === goalId);
            if (goal) {
                const subtask = goal.subtasks.find(s => s.id === subtaskId);
                if (subtask) {
                    subtask.completed = checkbox.checked;
                    
                    // åŒå‘åŒæ­¥ï¼šæ›´æ–°å½“å‰æ—¥ç¨‹ä¸­ç›¸åŒçš„å­ä»»åŠ¡çŠ¶æ€
                    const today = new Date();
                    const todayString = formatDate(today);
                    const todaySchedule = schedules.find(schedule => schedule.dayId === todayString);
                    
                    if (todaySchedule && todaySchedule.items) {
                        let syncedCount = 0;
                        todaySchedule.items.forEach(item => {
                            if (item.goalId == goalId && item.subtasks) {
                                item.subtasks.forEach(scheduleSubtask => {
                                    if (scheduleSubtask.id == subtaskId || scheduleSubtask.goalId == goalId) {
                                        if (scheduleSubtask.id == subtaskId) {
                                            scheduleSubtask.completed = subtask.completed;
                                            syncedCount++;
                                        }
                                    }
                                });
                            }
                        });
                        
                        if (syncedCount > 0) {
                            console.log(`[åŒå‘åŒæ­¥] å·²ä»ç›®æ ‡ ${goal.name} åŒæ­¥ ${syncedCount} ä¸ªå­ä»»åŠ¡åˆ°ä»Šæ—¥æ—¥ç¨‹`);
                            
                            // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯ä»Šå¤©çš„æ—¥ç¨‹ï¼Œåˆ·æ–°æ˜¾ç¤º
                            const isViewingToday = selectedDate.getFullYear() === today.getFullYear() &&
                                                   selectedDate.getMonth() === today.getMonth() &&
                                                   selectedDate.getDate() === today.getDate();
                            
                            if (isViewingToday && document.getElementById('scheduleManagement').classList.contains('active')) {
                                renderScheduleForDate();
                            }
                            
                            // ä¿å­˜æ—¥ç¨‹æ•°æ®
                            saveToSupabaseDebounced(todayString);
                        }
                    }
                    
                    saveGoalsData(); // ä¿å­˜æ•°æ®
                    renderGoalsList();
                }
            }
        }

        // æ¸²æŸ“ç›®æ ‡åˆ—è¡¨
        function renderGoalsList() {
            const goalList = document.getElementById('activeGoalsList');
            if (!goalList) return;

            if (window.goalsList.length === 0) {
                goalList.innerHTML = '<div class="empty-goals">æš‚æ— ç›®æ ‡ï¼Œç‚¹å‡»ä¸Šæ–¹ + æ–°ç›®æ ‡ æŒ‰é’®æ·»åŠ </div>';
                return;
            }

            goalList.innerHTML = window.goalsList.map(goal => {
                const completedSubtasks = goal.subtasks.filter(s => s.completed).length;
                const totalSubtasks = goal.subtasks.length;
                const progress = totalSubtasks > 0 ? Math.round((completedSubtasks / totalSubtasks) * 100) : 0;
                
                return `
                    <div class="goal-item ${goal.expanded ? 'expanded' : 'collapsed'}" data-goal-id="${goal.id}">
                        <div class="goal-item-header">
                            <button class="goal-expand-btn">${goal.expanded ? 'â–¼' : 'â–¶'}</button>
                            <span class="goal-name" contenteditable="false">${goal.name}</span>
                            <div class="goal-meta">
                                <button class="goal-action-btn goal-import">ğŸ“„ å¯¼å…¥</button>
                                <button class="goal-action-btn goal-task">å­ä»»åŠ¡</button>
                                <button class="goal-action-btn goal-delete">åˆ é™¤</button>
                            </div>
                        </div>
                        
                        <div class="goal-progress">
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${progress}%"></div>
                            </div>
                        </div>
                        
                        <div class="goal-subtasks" style="display: ${goal.expanded ? 'block' : 'none'};">
                            ${goal.subtasks.map(subtask => `
                                <div class="subtask-item ${subtask.completed ? 'completed' : ''}" data-subtask-id="${subtask.id}">
                                    <input type="checkbox" ${subtask.completed ? 'checked' : ''} class="subtask-checkbox">
                                    <span class="subtask-text" contenteditable="false">${subtask.text}</span>
                                    <button class="subtask-delete">åˆ é™¤</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ä½¿å…ƒç´ å¯ç¼–è¾‘
        function makeEditable(element, type, goalId, subtaskId = null) {
            element.contentEditable = true;
            element.focus();
            
            // é€‰ä¸­å…¨éƒ¨æ–‡æœ¬
            const range = document.createRange();
            range.selectNodeContents(element);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);

            const originalText = element.textContent;

            const finishEditing = () => {
                element.contentEditable = false;
                const newText = element.textContent.trim();
                
                if (newText && newText !== originalText) {
                    if (type === 'name') {
                        const goal = window.goalsList.find(g => g.id === goalId);
                        if (goal) {
                            goal.name = newText;
                            saveGoalsData(); // ä¿å­˜æ•°æ®
                        }
                    } else if (type === 'subtask') {
                        const goal = window.goalsList.find(g => g.id === goalId);
                        if (goal) {
                            const subtask = goal.subtasks.find(s => s.id === subtaskId);
                            if (subtask) {
                                subtask.text = newText;
                                saveGoalsData(); // ä¿å­˜æ•°æ®
                            }
                        }
                    }
                } else if (!newText) {
                    element.textContent = originalText;
                }
            };

            const addNewSubtaskAndEdit = () => {
                finishEditing();
                // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿å½“å‰ç¼–è¾‘å®Œæˆ
                setTimeout(() => {
                    // æ‰¾åˆ°å½“å‰ç›®æ ‡å¹¶æ·»åŠ æ–°å­ä»»åŠ¡
                    const goal = window.goalsList.find(g => g.id === goalId);
                    if (goal) {
                        const newSubtask = {
                            id: Date.now(),
                            text: 'æ–°å­ä»»åŠ¡',
                            completed: false
                        };
                        
                        goal.subtasks.push(newSubtask);
                        goal.expanded = true;
                        saveGoalsData(); // ä¿å­˜æ•°æ®
                        renderGoalsList();
                        
                        // èšç„¦åˆ°æ–°å­ä»»åŠ¡çš„æ–‡æœ¬ç¼–è¾‘
                        setTimeout(() => {
                            const newSubtaskElement = document.querySelector(`[data-subtask-id="${newSubtask.id}"] .subtask-text`);
                            if (newSubtaskElement) {
                                makeEditable(newSubtaskElement, 'subtask', goalId, newSubtask.id);
                            }
                        }, 100);
                    }
                }, 50);
            };

            element.addEventListener('blur', finishEditing, { once: true });
            element.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    finishEditing();
                } else if (e.key === 'Tab' && type === 'subtask') {
                    e.preventDefault();
                    addNewSubtaskAndEdit();
                }
            });
        }

        // åˆ‡æ¢ç›®æ ‡å±•å¼€æ”¶èµ·
        function toggleGoalExpand(button) {
            const goalItem = button.closest('.goal-item');
            const goalId = parseInt(goalItem.dataset.goalId);
            const goal = window.goalsList.find(g => g.id === goalId);
            
            if (goal) {
                goal.expanded = !goal.expanded;
                saveGoalsData(); // ä¿å­˜æ•°æ®
                renderGoalsList();
            }
        }

        // ==================== åˆå§‹åŒ– ====================
        
        document.addEventListener('DOMContentLoaded', async function() {
            // é¦–å…ˆåˆå§‹åŒ–ä¸»å¯¼èˆªTabç³»ç»Ÿ
            initMainTabs();
            
            // é¦–å…ˆåˆå§‹åŒ–Supabase
            console.log('å¼€å§‹åˆå§‹åŒ–Supabase...');
            await initializeSupabase();
            
            // åˆå§‹åŒ–ä¸»é¢˜
            initializeTheme();
            
            // åˆå§‹åŒ–å® ç‰©ç³»ç»Ÿ
            initPetSystem();
            
            // åˆå§‹åŒ–é¼ æ ‡è·Ÿè¸ªï¼ˆåŠ¨æ€å® ç‰©ï¼‰
            setTimeout(() => {
                initMouseTracking();
                
                // åŠ è½½å® ç‰©è·ŸéšçŠ¶æ€ï¼Œé»˜è®¤å…³é—­ä»¥é¿å…å¹²æ‰°
                const savedFollowing = localStorage.getItem('petFollowing');
                if (savedFollowing !== null) {
                    isFollowing = savedFollowing === 'true';
                } else {
                    isFollowing = false; // é»˜è®¤å…³é—­æ™ºèƒ½è·Ÿéš
                }
                
                // å¦‚æœè·Ÿéšå…³é—­ï¼Œç§»åŠ¨åˆ°å›ºå®šä½ç½®
                if (!isFollowing) {
                    movePetToFixedPosition();
                }
                
                // æ·»åŠ å…¨å±€ç‚¹å‡»äº‹ä»¶ä»¥éšè—å³é”®èœå•
                document.addEventListener('click', hidePetContextMenu);
                
                console.log('âœ… æ™ºèƒ½å® ç‰©ç³»ç»Ÿå·²å¯åŠ¨');
                console.log(`   - æ™ºèƒ½è·Ÿéšæ¨¡å¼: ${isFollowing ? 'å¼€å¯' : 'å…³é—­'}`);
                console.log('   - å³é”®å® ç‰©å¯åˆ‡æ¢è·Ÿéšæ¨¡å¼');
                console.log('   - ç¼–è¾‘æ—¶å® ç‰©ä¼šåšå‡ºäº’åŠ¨ååº”');
            }, 500);
            
            // æ£€æŸ¥å® ç‰©æ”¶èµ·çŠ¶æ€
            const petCollapsed = localStorage.getItem('petCollapsed');
            if (petCollapsed === 'true') {
                const petContainer = document.getElementById('petContainer');
                if (petContainer) {
                    petContainer.classList.add('pet-collapsed');
                }
            }
            
            // ç›‘å¬ç½‘ç»œçŠ¶æ€
            window.addEventListener('online', () => {
                isOnline = true;
                updateSyncStatus('', 'å·²è¿æ¥');
                updateManualSyncButtonState();
                if (currentUser && isSupabaseAvailable) {
                    syncDataFromServer();
                }
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateSyncStatus('offline', 'ç¦»çº¿æ¨¡å¼');
                updateManualSyncButtonState();
            });
            
            // åˆå§‹åŒ–è®¤è¯ç³»ç»Ÿ
            try {
                await initializeAuth();
            } catch (error) {
                console.error('è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                // Fallbackåˆ°ç¦»çº¿æ¨¡å¼
                showNotification('è®¤è¯ç³»ç»Ÿå¼‚å¸¸ï¼Œä½¿ç”¨ç¦»çº¿æ¨¡å¼', false);
                loadFromLocalStorage();
                loadTemplatesFromStorage();
                renderCalendar();
                renderScheduleForDate();
                updateTemplateListDisplay();
            }
            
            // äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // å¯ç”¨è‡ªåŠ¨å¤‡ä»½æœºåˆ¶
            enableAutoBackup();
        });
        
        function setupEventListeners() {
            // æ—¥å†å¯¼èˆª
            document.getElementById('prevMonth').addEventListener('click', () => navigateMonth(-1));
            document.getElementById('nextMonth').addEventListener('click', () => navigateMonth(1));
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            
            // å¿«é€Ÿæ“ä½œæŒ‰é’®
            document.getElementById('addTodaySchedule').addEventListener('click', goToToday);
            document.getElementById('addTomorrowSchedule').addEventListener('click', () => addDaySchedule(1));
            document.getElementById('addWeekSchedule').addEventListener('click', () => addWeekSchedules(false));
            document.getElementById('addNextWeekSchedule').addEventListener('click', () => addWeekSchedules(true));
            document.getElementById('manualSyncButton').addEventListener('click', handleManualSync);
            // ç§»é™¤äº†clearCacheå’ŒclearAllæŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨
            // ç§»é™¤äº†æ•°æ®å¤‡ä»½æ¢å¤å’Œå¼ºåˆ¶åŒæ­¥æŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨
            
            // åˆ é™¤æ—¥ç¨‹æŒ‰é’®
            document.getElementById('deleteSchedule').addEventListener('click', deleteCurrentSchedule);
            
            // æ¨¡æ¿è®¾ç½®çª—å£æŒ‰é’®
            document.getElementById('openTemplateModal').addEventListener('click', openTemplateModal);
            
            // æ¨¡æ¿çª—å£äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('templateModalClose').addEventListener('click', closeTemplateModal);
            document.getElementById('templateModalCancel').addEventListener('click', closeTemplateModal);
            document.getElementById('templateModalSave').addEventListener('click', saveTemplates);
            
            // æ¨¡æ¿æ ‡ç­¾é¡µåˆ‡æ¢
            document.getElementById('workdayTab').addEventListener('click', () => switchTemplateTab('workday'));
            document.getElementById('nonWorkdayTab').addEventListener('click', () => switchTemplateTab('nonworkday'));
            
            // ç‚¹å‡»æ¨¡æ¿çª—å£å¤–éƒ¨å…³é—­çª—å£
            document.getElementById('templateModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeTemplateModal();
                }
            });
            
            // è®¤è¯ç›¸å…³äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('authForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                console.log('è¡¨å•æäº¤äº‹ä»¶è§¦å‘');
                
                // ä¿å­˜è¾“å…¥æ¡†çš„å€¼ï¼Œé˜²æ­¢è¢«æ¸…ç©º
                const emailInput = document.getElementById('authEmail');
                const passwordInput = document.getElementById('authPassword');
                const email = emailInput.value.trim();
                const password = passwordInput.value;
                
                // ä¿å­˜åˆ°dataå±æ€§ä»¥å¤‡æ¢å¤
                emailInput.dataset.lastValue = email;
                passwordInput.dataset.lastValue = password;
                
                console.log('è·å–åˆ°è¡¨å•æ•°æ®:', { email: email, password: password ? '***' : 'ç©º' });
                
                if (!email || !password) {
                    showAuthError('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ');
                    return;
                }
                
                // åœ¨å¤„ç†è®¤è¯å‰ä¿å­˜å€¼ï¼Œé˜²æ­¢è¢«æ¸…ç©º
                const savedEmail = email;
                const savedPassword = password;
                
                try {
                    await handleEmailAuth(email, password);
                } catch (error) {
                    // å¦‚æœè®¤è¯å¤±è´¥ï¼Œæ¢å¤è¾“å…¥æ¡†çš„å€¼
                    console.log('è®¤è¯å¤„ç†å¤±è´¥ï¼Œæ¢å¤è¾“å…¥æ¡†å€¼');
                    emailInput.value = savedEmail;
                    passwordInput.value = savedPassword;
                    throw error;
                }
            });
            
            // æ·»åŠ è¾“å…¥æ¡†å€¼è‡ªåŠ¨ä¿å­˜
            document.getElementById('authEmail').addEventListener('input', function(e) {
                e.target.dataset.lastValue = e.target.value;
            });
            
            document.getElementById('authPassword').addEventListener('input', function(e) {
                e.target.dataset.lastValue = e.target.value;
            });
            
            document.getElementById('googleAuth').addEventListener('click', handleGoogleAuth);
            document.getElementById('authToggleLink').addEventListener('click', function(e) {
                e.preventDefault();
                toggleAuthMode();
            });
            
            document.getElementById('tooltipLogoutBtn').addEventListener('click', logout);
            
            // å¿«æ·é”®æ”¯æŒ
            document.addEventListener('keydown', function(event) {
                if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                // å¢å¼ºåŒæ­¥ç³»ç»Ÿå¿«æ·é”®
                if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 's') {
                    event.preventDefault();
                    console.log('âŒ¨ï¸ é”®ç›˜å¿«æ·é”®è§¦å‘å¼ºåˆ¶åŒæ­¥');
                    if (window.enhancedSync) {
                        window.enhancedSync.saveWithRetry(async () => {
                            if (!validateDataIntegrity()) {
                                throw new Error('æ•°æ®å®Œæ•´æ€§éªŒè¯å¤±è´¥');
                            }
                            await Promise.all([
                                saveSchedulesToSupabase(),
                                saveUserSettingsToSupabase()
                            ]);
                            return { success: true, timestamp: new Date().toISOString() };
                        }, { description: 'å¼ºåˆ¶ä¿å­˜æ‰€æœ‰æ•°æ®' }).catch(error => {
                            console.log('å¿«æ·é”®å¼ºåˆ¶åŒæ­¥å¤±è´¥:', error.message);
                        });
                    }
                    return;
                }
                
                if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key.toLowerCase() === 'r') {
                    event.preventDefault();
                    console.log('âŒ¨ï¸ é”®ç›˜å¿«æ·é”®è§¦å‘æ•°æ®é‡æ–°åŒæ­¥');
                    if (window.enhancedSync && typeof syncDataFromServer === 'function') {
                        window.enhancedSync.saveWithRetry(async () => {
                            await syncDataFromServer();
                            return { success: true, timestamp: new Date().toISOString() };
                        }, { description: 'é‡æ–°åŒæ­¥æ•°æ®', timeout: 20000 }).catch(error => {
                            console.log('å¿«æ·é”®é‡æ–°åŒæ­¥å¤±è´¥:', error.message);
                        });
                    }
                    return;
                }
                
                if (event.key.toLowerCase() === 't' && !event.ctrlKey && !event.altKey) {
                    event.preventDefault();
                    toggleTheme();
                }
                
                // æ–¹å‘é”®å¯¼èˆªæ—¥å†
                if (selectedDate) {
                    let newDate = null;
                    switch(event.key) {
                        case 'ArrowLeft':
                            event.preventDefault();
                            newDate = new Date(selectedDate);
                            newDate.setDate(newDate.getDate() - 1);
                            selectDate(newDate);
                            break;
                        case 'ArrowRight':
                            event.preventDefault();
                            newDate = new Date(selectedDate);
                            newDate.setDate(newDate.getDate() + 1);
                            selectDate(newDate);
                            break;
                        case 'ArrowUp':
                            event.preventDefault();
                            newDate = new Date(selectedDate);
                            newDate.setDate(newDate.getDate() - 7);
                            selectDate(newDate);
                            break;
                        case 'ArrowDown':
                            event.preventDefault();
                            newDate = new Date(selectedDate);
                            newDate.setDate(newDate.getDate() + 7);
                            selectDate(newDate);
                            break;
                    }
                }
            });
            
            // åˆå§‹åŒ–æ‰‹åŠ¨åŒæ­¥æŒ‰é’®çŠ¶æ€
            setTimeout(() => {
                updateManualSyncButtonState();
            }, 100);
        }
    </script>
</body>
</html>