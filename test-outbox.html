<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HabitTrack Outbox æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f7;
        }

        .test-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1, h2 {
            color: #1d1d1f;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }

        button:hover {
            background: #005bb5;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .log {
            background: #1d1d1f;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }

        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.info { background: #cce6ff; color: #004085; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007AFF;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin: 5px;
            width: 200px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸš€ HabitTrack Outbox åŒæ­¥ç³»ç»Ÿæµ‹è¯•</h1>
        
        <div id="system-status" class="status info">
            <strong>ç³»ç»ŸçŠ¶æ€:</strong> åˆå§‹åŒ–ä¸­...
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div id="total-mutations" class="stat-value">-</div>
                <div class="stat-label">æ€»å˜æ›´æ•°</div>
            </div>
            <div class="stat-card">
                <div id="pending-mutations" class="stat-value">-</div>
                <div class="stat-label">å¾…åŒæ­¥</div>
            </div>
            <div class="stat-card">
                <div id="failed-mutations" class="stat-value">-</div>
                <div class="stat-label">å¤±è´¥</div>
            </div>
            <div class="stat-card">
                <div id="delivered-mutations" class="stat-value">-</div>
                <div class="stat-label">å·²äº¤ä»˜</div>
            </div>
        </div>
    </div>

    <div class="test-container">
        <h2>ğŸ“ ä¹ æƒ¯æ“ä½œæµ‹è¯•</h2>
        
        <div class="test-section">
            <h3>åˆ›å»ºæµ‹è¯•ä¹ æƒ¯</h3>
            <input type="text" id="habit-name" placeholder="ä¹ æƒ¯åç§°" value="æµ‹è¯•ä¹ æƒ¯">
            <input type="text" id="habit-desc" placeholder="ä¹ æƒ¯æè¿°" value="è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ä¹ æƒ¯">
            <button onclick="createTestHabit()">åˆ›å»ºä¹ æƒ¯</button>
        </div>

        <div class="test-section">
            <h3>æ‰¹é‡æ“ä½œæµ‹è¯•</h3>
            <button onclick="createMultipleHabits(5)">åˆ›å»º 5 ä¸ªä¹ æƒ¯</button>
            <button onclick="toggleRandomCheckmarks(10)">éšæœºæ‰“å¡ 10 æ¬¡</button>
            <button onclick="deleteRandomHabits(2)">åˆ é™¤ 2 ä¸ªä¹ æƒ¯</button>
        </div>

        <div class="test-section">
            <h3>ç½‘ç»œæµ‹è¯•</h3>
            <button onclick="simulateOffline()">æ¨¡æ‹Ÿç¦»çº¿ (5ç§’)</button>
            <button onclick="forceSync()">å¼ºåˆ¶åŒæ­¥</button>
            <button onclick="clearOutbox()">æ¸…ç©º Outbox</button>
        </div>

        <div class="test-section">
            <h3>åŒæ­¥æ§åˆ¶</h3>
            <button onclick="window.outboxMonitor?.show()">æ‰“å¼€ç›‘æ§é¢æ¿</button>
            <button onclick="exportOutboxData()">å¯¼å‡º Outbox æ•°æ®</button>
            <button onclick="runStressTest()">å‹åŠ›æµ‹è¯• (100 æ“ä½œ)</button>
        </div>
    </div>

    <div class="test-container">
        <h2>ğŸ“Š æµ‹è¯•æ—¥å¿—</h2>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="test-log" class="log">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="outbox-system.js"></script>
    <script src="outbox-monitor.js"></script>
    
    <script>
        // ==================== æµ‹è¯•è„šæœ¬ ====================
        
        let testHabits = [];
        let isOfflineMode = false;

        // åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
        document.addEventListener('DOMContentLoaded', async () => {
            log('ğŸ”§ åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ...');
            
            // ç­‰å¾… outbox ç³»ç»Ÿåˆå§‹åŒ–
            await waitForOutboxSystem();
            
            // æ¨¡æ‹Ÿ Supabase å¯ç”¨æ€§
            window.isSupabaseAvailable = true;
            window.supabaseClient = createMockSupabase();
            
            // å¼€å§‹ç»Ÿè®¡åˆ·æ–°
            setInterval(updateStats, 2000);
            
            updateSystemStatus('success', 'ç³»ç»Ÿå·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•');
            log('âœ… æµ‹è¯•ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ');
        });

        async function waitForOutboxSystem() {
            let attempts = 0;
            while (!window.outboxSystem && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (!window.outboxSystem) {
                throw new Error('Outbox ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥');
            }
        }

        function createMockSupabase() {
            return {
                rpc: async (functionName, data) => {
                    log(`ğŸ”— è°ƒç”¨ RPC: ${functionName}`, data);
                    
                    if (isOfflineMode) {
                        throw new Error('ç½‘ç»œä¸å¯ç”¨ (æ¨¡æ‹Ÿç¦»çº¿)');
                    }
                    
                    // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
                    await new Promise(resolve => setTimeout(resolve, Math.random() * 1000 + 500));
                    
                    // æ¨¡æ‹Ÿéšæœºå¤±è´¥ (5% æ¦‚ç‡)
                    if (Math.random() < 0.05) {
                        throw new Error('éšæœºç½‘ç»œé”™è¯¯ (æµ‹è¯•ç”¨)');
                    }
                    
                    return { 
                        data: { success: true, mutation_id: data.mutation_id },
                        error: null 
                    };
                }
            };
        }

        // ==================== æµ‹è¯•å‡½æ•° ====================

        async function createTestHabit() {
            const name = document.getElementById('habit-name').value || 'æµ‹è¯•ä¹ æƒ¯';
            const description = document.getElementById('habit-desc').value || 'æµ‹è¯•æè¿°';
            
            const habit = {
                id: 'test-' + Date.now(),
                name,
                description,
                color: '#007AFF',
                checkmarks: {},
                weeklyHighest: 0,
                weeklyTarget: 1,
                weeklyRecords: {}
            };

            testHabits.push(habit);
            
            try {
                await window.outboxSystem.addMutation('create', 'habit', habit.id, habit);
                log(`âœ… åˆ›å»ºä¹ æƒ¯: ${name} (${habit.id})`);
            } catch (error) {
                log(`âŒ åˆ›å»ºä¹ æƒ¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function createMultipleHabits(count) {
            log(`ğŸ”„ æ‰¹é‡åˆ›å»º ${count} ä¸ªä¹ æƒ¯...`);
            
            for (let i = 0; i < count; i++) {
                const habit = {
                    id: 'batch-' + Date.now() + '-' + i,
                    name: `æ‰¹é‡ä¹ æƒ¯ ${i + 1}`,
                    description: `è¿™æ˜¯ç¬¬ ${i + 1} ä¸ªæ‰¹é‡åˆ›å»ºçš„ä¹ æƒ¯`,
                    color: ['#FF3B30', '#FF9500', '#FFCC00', '#34C759', '#007AFF'][i % 5],
                    checkmarks: {},
                    weeklyHighest: 0,
                    weeklyTarget: 1,
                    weeklyRecords: {}
                };

                testHabits.push(habit);
                await window.outboxSystem.addMutation('create', 'habit', habit.id, habit);
                
                // å°å»¶è¿Ÿé¿å…è¿‡å¿«
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            log(`âœ… æ‰¹é‡åˆ›å»ºå®Œæˆ: ${count} ä¸ªä¹ æƒ¯`);
        }

        async function toggleRandomCheckmarks(count) {
            if (testHabits.length === 0) {
                log('âŒ æ²¡æœ‰å¯ç”¨çš„æµ‹è¯•ä¹ æƒ¯ï¼Œè¯·å…ˆåˆ›å»ºä¹ æƒ¯', 'error');
                return;
            }

            log(`ğŸ”„ éšæœºæ‰“å¡ ${count} æ¬¡...`);

            for (let i = 0; i < count; i++) {
                const habit = testHabits[Math.floor(Math.random() * testHabits.length)];
                const dateStr = new Date().toISOString().split('T')[0];
                
                // åˆ‡æ¢æ‰“å¡çŠ¶æ€
                if (habit.checkmarks[dateStr]) {
                    delete habit.checkmarks[dateStr];
                } else {
                    habit.checkmarks[dateStr] = true;
                }

                await window.outboxSystem.addMutation('update', 'habit', habit.id, habit);
                await new Promise(resolve => setTimeout(resolve, 30));
            }

            log(`âœ… éšæœºæ‰“å¡å®Œæˆ: ${count} æ¬¡`);
        }

        async function deleteRandomHabits(count) {
            const availableHabits = testHabits.slice(); // å¤åˆ¶æ•°ç»„
            if (availableHabits.length === 0) {
                log('âŒ æ²¡æœ‰å¯åˆ é™¤çš„ä¹ æƒ¯', 'error');
                return;
            }

            const toDelete = Math.min(count, availableHabits.length);
            log(`ğŸ”„ éšæœºåˆ é™¤ ${toDelete} ä¸ªä¹ æƒ¯...`);

            for (let i = 0; i < toDelete; i++) {
                const index = Math.floor(Math.random() * availableHabits.length);
                const habit = availableHabits.splice(index, 1)[0];
                
                await window.outboxSystem.addMutation('delete', 'habit', habit.id, habit);
                
                // ä»æµ‹è¯•æ•°ç»„ä¸­ç§»é™¤
                testHabits = testHabits.filter(h => h.id !== habit.id);
                
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            log(`âœ… éšæœºåˆ é™¤å®Œæˆ: ${toDelete} ä¸ªä¹ æƒ¯`);
        }

        function simulateOffline() {
            isOfflineMode = true;
            updateSystemStatus('warning', 'æ¨¡æ‹Ÿç¦»çº¿æ¨¡å¼å·²å¯ç”¨ (5ç§’)');
            log('ğŸ“¡ æ¨¡æ‹Ÿç¦»çº¿æ¨¡å¼å¯ç”¨...');
            
            setTimeout(() => {
                isOfflineMode = false;
                updateSystemStatus('success', 'ç½‘ç»œå·²æ¢å¤');
                log('ğŸ“¡ ç½‘ç»œæ¢å¤ï¼Œå¼€å§‹é‡è¯•åŒæ­¥...');
                forceSync();
            }, 5000);
        }

        async function forceSync() {
            try {
                log('ğŸ”„ å¼ºåˆ¶åŒæ­¥ä¸­...');
                await window.outboxSystem.triggerSync();
                log('âœ… å¼ºåˆ¶åŒæ­¥å®Œæˆ');
            } catch (error) {
                log(`âŒ å¼ºåˆ¶åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function clearOutbox() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ Outbox æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰æœªåŒæ­¥çš„å˜æ›´ã€‚')) {
                return;
            }

            try {
                // è¿™é‡Œéœ€è¦æ·»åŠ æ¸…ç©º Outbox çš„æ–¹æ³•
                log('ğŸ—‘ï¸ æ¸…ç©º Outbox åŠŸèƒ½éœ€è¦å®ç°...');
            } catch (error) {
                log(`âŒ æ¸…ç©ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function exportOutboxData() {
            try {
                const stats = await window.outboxSystem.getStats();
                const data = {
                    stats,
                    timestamp: new Date().toISOString(),
                    testHabits: testHabits.length
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], {
                    type: 'application/json'
                });

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `outbox-data-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);

                log('ğŸ“ Outbox æ•°æ®å·²å¯¼å‡º');
            } catch (error) {
                log(`âŒ å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function runStressTest() {
            log('ğŸ”¥ å¼€å§‹å‹åŠ›æµ‹è¯• (100 ä¸ªæ“ä½œ)...');
            updateSystemStatus('warning', 'å‹åŠ›æµ‹è¯•è¿›è¡Œä¸­...');

            const operations = [];
            
            // ç”Ÿæˆ 100 ä¸ªéšæœºæ“ä½œ
            for (let i = 0; i < 100; i++) {
                const type = Math.random();
                if (type < 0.6) {
                    operations.push('create');
                } else if (type < 0.9) {
                    operations.push('update');
                } else {
                    operations.push('delete');
                }
            }

            let completed = 0;
            const startTime = Date.now();

            for (const operation of operations) {
                try {
                    if (operation === 'create') {
                        await createTestHabit();
                    } else if (operation === 'update' && testHabits.length > 0) {
                        await toggleRandomCheckmarks(1);
                    } else if (operation === 'delete' && testHabits.length > 0) {
                        await deleteRandomHabits(1);
                    }
                    
                    completed++;
                    
                    if (completed % 10 === 0) {
                        log(`â³ å‹åŠ›æµ‹è¯•è¿›åº¦: ${completed}/100`);
                    }
                    
                    // å°å»¶è¿Ÿé¿å…è¿‡è½½
                    await new Promise(resolve => setTimeout(resolve, 10));
                } catch (error) {
                    log(`âŒ å‹åŠ›æµ‹è¯•æ“ä½œå¤±è´¥: ${error.message}`);
                }
            }

            const duration = Date.now() - startTime;
            log(`ğŸ‰ å‹åŠ›æµ‹è¯•å®Œæˆï¼è€—æ—¶: ${duration}ms, å®Œæˆæ“ä½œ: ${completed}/100`);
            updateSystemStatus('success', `å‹åŠ›æµ‹è¯•å®Œæˆ (${duration}ms)`);
        }

        // ==================== è¾…åŠ©å‡½æ•° ====================

        async function updateStats() {
            if (!window.outboxSystem) return;

            try {
                const stats = await window.outboxSystem.getStats();
                document.getElementById('total-mutations').textContent = stats.total;
                document.getElementById('pending-mutations').textContent = stats.pending;
                document.getElementById('failed-mutations').textContent = stats.failed;
                document.getElementById('delivered-mutations').textContent = stats.delivered;
            } catch (error) {
                // é™é»˜å¤±è´¥
            }
        }

        function updateSystemStatus(type, message) {
            const statusEl = document.getElementById('system-status');
            statusEl.className = `status ${type}`;
            statusEl.innerHTML = `<strong>ç³»ç»ŸçŠ¶æ€:</strong> ${message}`;
        }

        function log(message, type = 'info') {
            const logEl = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'warning' ? '#ffa500' : '#00ff00';
            
            logEl.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = 'æ—¥å¿—å·²æ¸…ç©º...';
        }

        // æ·»åŠ é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'h':
                        e.preventDefault();
                        createTestHabit();
                        break;
                    case 's':
                        e.preventDefault();
                        forceSync();
                        break;
                    case 'l':
                        e.preventDefault();
                        clearLog();
                        break;
                }
            }
        });

        log('ğŸ® å¿«æ·é”®: Ctrl+H (åˆ›å»ºä¹ æƒ¯), Ctrl+S (åŒæ­¥), Ctrl+L (æ¸…ç©ºæ—¥å¿—)');
    </script>
</body>
</html>